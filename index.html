<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SweetPrinceLedger - ç‹å­ç”œç”œå¸³</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <!-- Lucide åœ–æ¨™ -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { 
            font-family: 'Noto Sans TC', 'Segoe UI Emoji', 'Noto Color Emoji', 'Apple Color Emoji', sans-serif; 
            background-color: #FDF2F8; 
            color: #1E293B;
        }
        .percento-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            transition: all 0.2s ease;
        }
        .modal-overlay { background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(8px); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 10px; }
        @keyframes princeFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }
        @keyframes princeSparkle {
            0%, 100% { opacity: 0.5; transform: scale(0.9); }
            50% { opacity: 1; transform: scale(1.08); }
        }
        @keyframes princeTalk {
            0% { transform: translateY(6px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        .prince-float { animation: princeFloat 3.2s ease-in-out infinite; }
        .prince-sparkle { animation: princeSparkle 1.8s ease-in-out infinite; }
        .prince-talk { animation: princeTalk .35s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const CURRENCIES = ['HKD', 'MOP', 'TWD', 'USD', 'CNY', 'JPY', 'EUR', 'GBP'];
        const DEFAULT_RATES = { HKD: 1, MOP: 1.03, TWD: 4.15, USD: 0.128, CNY: 0.92, JPY: 19.2, EUR: 0.118, GBP: 0.101 };
        const STORAGE_KEYS = {
            assets: 'assetTracker.assets.v2',
            displayCurrency: 'assetTracker.displayCurrency.v2',
            monthlySnapshots: 'assetTracker.monthlySnapshots.v2',
            currencyRates: 'assetTracker.currencyRates.v1',
            currencyRatesUpdatedAt: 'assetTracker.currencyRatesUpdatedAt.v1',
            cashflowEntries: 'assetTracker.cashflowEntries.v1',
            cashflowAppliedOccurrenceKeys: 'assetTracker.cashflowAppliedOccurrenceKeys.v1',
            cashflowLastAutoApplyDate: 'assetTracker.cashflowLastAutoApplyDate.v1',
            cashflowAppliedPostings: 'assetTracker.cashflowAppliedPostings.v1',
            pageLanguage: 'assetTracker.pageLanguage.v1'
        };
        const FIREBASE_CONFIG = window.__FIREBASE_CONFIG__ || {
            apiKey: 'AIzaSyBBXQq6K6dBZCL4t8ieyH_QB2TmAW4b8P0',
            authDomain: 'myassetmanagement-3acb9.firebaseapp.com',
            databaseURL: 'https://myassetmanagement-3acb9-default-rtdb.asia-southeast1.firebasedatabase.app',
            projectId: 'myassetmanagement-3acb9',
            storageBucket: 'myassetmanagement-3acb9.firebasestorage.app',
            messagingSenderId: '197674917932',
            appId: '1:197674917932:web:6aaa35121062d4b3f4b189',
            measurementId: 'G-R0BJT35WPE'
        };
        const CLOUD_COLLECTION = 'assetTrackerUsers';
        const hasFirebaseConfig = ['apiKey', 'authDomain', 'projectId', 'appId'].every(key => Boolean((FIREBASE_CONFIG[key] || '').trim()));
        const firebaseApp = (() => {
            if (!window.firebase || !hasFirebaseConfig) return null;
            try {
                return firebase.apps?.length ? firebase.app() : firebase.initializeApp(FIREBASE_CONFIG);
            } catch (error) {
                return null;
            }
        })();
        const firebaseAuth = firebaseApp ? firebase.auth() : null;
        const firebaseDB = firebaseApp ? firebase.firestore() : null;
        const isCloudEnabled = Boolean(firebaseAuth && firebaseDB);

        const CATEGORIES = {
            LIQUID: { label: 'æµå‹•è³‡é‡‘', color: 'text-emerald-500', bgColor: 'bg-emerald-50', icon: 'wallet', subtypes: ['ç¾é‡‘', 'é›»å­éŒ¢åŒ…', 'é‡‘èå¡', 'å…¶ä»–'] },
            INVEST: { label: 'æŠ•è³‡', color: 'text-blue-500', bgColor: 'bg-blue-50', icon: 'trending-up', subtypes: ['åŸºé‡‘', 'è‚¡ç¥¨', 'åŠ å¯†è²¨å¹£', 'éŠ€è¡Œç†è²¡', 'å®šæœŸå­˜æ¬¾', 'å…¶ä»–æŠ•è³‡'] },
            INSURANCE: { label: 'ä¿éšª', color: 'text-cyan-500', bgColor: 'bg-cyan-50', icon: 'shield', subtypes: ['æŠ•è³‡/æŠ•è³‡ç›¸é€£', 'äººå£½/ç´¯ç©è²¡å¯Œ', 'å¥åº·'] },
            FIXED: { label: 'å›ºå®šè³‡ç”¢', color: 'text-amber-500', bgColor: 'bg-amber-50', icon: 'home', subtypes: ['æˆ¿ç”¢', 'æ±½è»Š', 'å…¶ä»–å›ºå®šè³‡ç”¢'] },
            RECEIVABLE: { label: 'æ‡‰æ”¶æ¬¾', color: 'text-indigo-500', bgColor: 'bg-indigo-50', icon: 'hand-coins', subtypes: ['å€‹äººå€Ÿæ¬¾', 'å…¬å¸æ‡‰æ”¶', 'é€€ç¨…/è£œè²¼', 'ä¿è­‰é‡‘', 'ç§Ÿé‡‘', 'å…¶ä»–æ‡‰æ”¶'] },
            LIABILITY: { label: 'è² å‚µ', color: 'text-rose-500', bgColor: 'bg-rose-50', icon: 'credit-card', isNegative: true, subtypes: ['æˆ¿è²¸', 'ä¿¡ç”¨å¡', 'è²¸æ¬¾', 'æ‡‰ä»˜æ¬¾', 'å…¶ä»–è² å‚µ'] }
        };

        const CRYPTO_ID_MAP = {
            BTC: 'bitcoin', ETH: 'ethereum', SOL: 'solana', BNB: 'binancecoin', XRP: 'ripple', ADA: 'cardano', DOGE: 'dogecoin', DOT: 'polkadot', TRX: 'tron', LTC: 'litecoin'
        };

        const CATEGORY_MIX_STYLES = {
            LIQUID: { bg: 'bg-emerald-500', hex: '#10B981' },
            INVEST: { bg: 'bg-blue-500', hex: '#3B82F6' },
            INSURANCE: { bg: 'bg-cyan-500', hex: '#06B6D4' },
            FIXED: { bg: 'bg-amber-500', hex: '#F59E0B' },
            RECEIVABLE: { bg: 'bg-indigo-500', hex: '#6366F1' },
            LIABILITY: { bg: 'bg-rose-500', hex: '#F43F5E' }
        };
        const CATEGORY_KEYS = Object.keys(CATEGORIES);
        const INVEST_CHART_COLORS = ['#3B82F6', '#10B981', '#F59E0B', '#6366F1', '#F43F5E', '#0EA5E9', '#8B5CF6', '#14B8A6'];
        const CASHFLOW_TYPES = {
            INCOME: { label: 'æ”¶å…¥', tone: 'text-emerald-600' },
            EXPENSE: { label: 'æ”¯å‡º', tone: 'text-rose-600' }
        };
        const CASHFLOW_SCHEDULE_TYPES = [
            { value: 'ONE_TIME', label: 'å–®æ¬¡æ€§' },
            { value: 'RECURRING', label: 'å›ºå®š' }
        ];
        const CASHFLOW_FREQUENCIES = [
            { value: 'DAILY', label: 'æ¯æ—¥' },
            { value: 'WEEKLY', label: 'æ¯é€±' },
            { value: 'MONTHLY', label: 'æ¯æœˆ' },
            { value: 'YEARLY', label: 'æ¯å¹´' }
        ];
        const WEEKDAY_LABELS = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        const CASHFLOW_CATEGORY_OPTIONS = [
            'æ”¶å…¥-è–ªé‡‘',
            'æ”¶å…¥-çé‡‘',
            'æ”¶å…¥-ä½£é‡‘',
            'æ”¶å…¥-ç§Ÿé‡‘',
            'æ”¶å…¥-è‚¡æ¯',
            'æ”¶å…¥-åˆ©æ¯',
            'æ”¶å…¥-å…¼è·',
            'æ”¶å…¥-ç”Ÿæ„',
            'æ”¶å…¥-é€€æ¬¾/è£œè²¼',
            'æ”¶å…¥-å…¶ä»–',
            'è²»ç”¨-é¤é£²',
            'è²»ç”¨-äº¤é€š',
            'è²»ç”¨-é›»è²»',
            'è²»ç”¨-æ°´è²»',
            'è²»ç”¨-ç…¤æ°£è²»',
            'è²»ç”¨-ç¶²çµ¡/é›»è©±',
            'è²»ç”¨-æˆ¿ç§Ÿ/ç®¡ç†è²»',
            'è²»ç”¨-ä¿éšª',
            'è²»ç”¨-é†«ç™‚',
            'è²»ç”¨-æ•™è‚²',
            'è²»ç”¨-å¨›æ¨‚',
            'è²»ç”¨-è³¼ç‰©',
            'è²»ç”¨-å®¶åº­',
            'è²»ç”¨-ç¨…è²»',
            'è²»ç”¨-å…¶ä»–',
            'è½‰å¸³-å„²è“„'
        ];
        const CASHFLOW_CATEGORY_BY_TYPE = {
            INCOME: CASHFLOW_CATEGORY_OPTIONS.filter(item => item.startsWith('æ”¶å…¥-')),
            EXPENSE: CASHFLOW_CATEGORY_OPTIONS.filter(item => item.startsWith('è²»ç”¨-')).concat(['è½‰å¸³-å„²è“„'])
        };
        const getDefaultCashflowCategory = (type) => {
            const options = CASHFLOW_CATEGORY_BY_TYPE[type] || CASHFLOW_CATEGORY_BY_TYPE.EXPENSE;
            return options[0] || 'è²»ç”¨-å…¶ä»–';
        };
        const ONE_DAY_MS = 24 * 60 * 60 * 1000;
        const PAGE_LANGUAGE_OPTIONS = [
            { value: 'zh-Hant', label: 'ç¹é«”ä¸­æ–‡' },
            { value: 'en-US', label: 'English' },
            { value: 'ja-JP', label: 'æ—¥æœ¬èª' }
        ];
        const UI_TEXT = {
            'zh-Hant': {
                subtitle: 'æµå‹•è³‡é‡‘ã€æŠ•è³‡ã€å›ºå®šè³‡ç”¢ã€æ‡‰æ”¶æ¬¾ã€è² å‚µäº”å¤§é¡åˆ¥ä¸€ç«™ç®¡ç†ï¼Œé™ªä½ æ¯å¤©è¨˜å¸³å®ˆè­·è²¡å¯Œç‹åœ‹ã€‚ âœ¨ğŸ’–',
                idleTitle: 'Qç‰ˆå…¬ä»”é–’æš‡å£è™Ÿ',
                advanced: 'é€²éšåŠŸèƒ½',
                cloudAccount: 'é›²ç«¯å¸³è™Ÿ',
                displayCurrency: 'é¡¯ç¤ºå¹£ç¨®',
                pageLanguage: 'é é¢èªè¨€',
                addAsset: 'æ–°å¢è³‡ç”¢',
                resetData: 'é‡è¨­è³‡æ–™',
                loginLoading: 'å¸³è™Ÿè®€å–ä¸­...',
                login: 'Google ç™»å…¥',
                logout: 'Google ç™»å‡º',
                exportData: 'åŒ¯å‡ºè³‡æ–™',
                importData: 'åŒ¯å…¥è³‡æ–™',
                updatePrice: 'æ›´æ–°è‚¡åƒ¹/å¹£åƒ¹',
                updating: 'æ›´æ–°ä¸­...',
                updateFx: 'æ›´æ–°åŒ¯ç‡',
                sharePdf: 'åˆ†äº«è³‡ç”¢ï¼ˆPDFï¼‰',
                generatingPdf: 'PDF ç”¢ç”Ÿä¸­...',
                marketAutoUpdate: 'è¡Œæƒ…å°‡æ¯ 5 åˆ†é˜è‡ªå‹•æ›´æ–°ä¸€æ¬¡',
                lastUpdated: 'æœ€å¾Œæ›´æ–°',
                noPriceYet: 'å°šæœªæ›´æ–°è¡Œæƒ…',
                rateUpdated: 'åŒ¯ç‡æ›´æ–°',
                fxDefault: 'åŒ¯ç‡ä½¿ç”¨é è¨­å€¼',
                cloudSyncing: 'é›²ç«¯åŒæ­¥ä¸­...',
                overviewTitle: 'è³‡ç”¢ç¸½è¦½èˆ‡é…æ¯”',
                netWorth: 'æ·¨è³‡ç”¢',
                totalAssets: 'ç¸½è³‡ç”¢',
                totalLiabilities: 'ç¸½è² å‚µ',
                debtRatio: 'è² å‚µæ¯”',
                categoryMix: 'åˆ†é¡é…æ¯”',
                detailMix: 'ç´°é …ä½”æ¯”',
                noDetailItems: 'æ­¤åˆ†é¡å°šç„¡å¯è¨ˆç®—ç´°é …',
                tabAssetAccount: 'è³‡ç”¢å¸³æˆ¶ç®¡ç†',
                tabCashflow: 'ç¾é‡‘æµè¨˜å¸³èˆ‡æ”¶ç›Šæœˆæ›†',
                cashflowDesc: 'å¯è¨­å®šå›ºå®šæ”¶å…¥/æ”¯å‡ºè¦å‰‡ï¼ˆæ”¶ç§Ÿã€å…¼è·ã€é¤è²»ç­‰ï¼‰ï¼Œä¸¦æŸ¥çœ‹æ¯å¤©ã€æ¯æœˆã€æ¯å¹´æµæ°´ã€‚',
                prevMonth: 'ä¸Šæœˆ',
                nextMonth: 'ä¸‹æœˆ'
            },
            'en-US': {
                subtitle: 'Manage liquidity, investments, fixed assets, receivables, and liabilities in one place. âœ¨ğŸ’–',
                idleTitle: 'Chibi Prince Idle Motto',
                advanced: 'Advanced',
                cloudAccount: 'Cloud Account',
                displayCurrency: 'Display Currency',
                pageLanguage: 'Page Language',
                addAsset: 'Add Asset',
                resetData: 'Reset Data',
                loginLoading: 'Loading account...',
                login: 'Google Sign in',
                logout: 'Google Sign out',
                exportData: 'Export Data',
                importData: 'Import Data',
                updatePrice: 'Update Prices',
                updating: 'Updating...',
                updateFx: 'Update FX',
                sharePdf: 'Share Asset (PDF)',
                generatingPdf: 'Generating PDF...',
                marketAutoUpdate: 'Market prices auto-refresh every 5 minutes',
                lastUpdated: 'Last Update',
                noPriceYet: 'No market update yet',
                rateUpdated: 'FX Updated',
                fxDefault: 'Using default FX rates',
                cloudSyncing: 'Cloud syncing...',
                overviewTitle: 'Asset Overview & Allocation',
                netWorth: 'Net Worth',
                totalAssets: 'Total Assets',
                totalLiabilities: 'Total Liabilities',
                debtRatio: 'Debt Ratio',
                categoryMix: 'Category Mix',
                detailMix: 'Detail Mix',
                noDetailItems: 'No detail items in this category yet',
                tabAssetAccount: 'Asset Account Management',
                tabCashflow: 'Cashflow & Earnings Calendar',
                cashflowDesc: 'Set recurring income/expense rules and review daily, monthly, and yearly flows.',
                prevMonth: 'Prev',
                nextMonth: 'Next'
            },
            'ja-JP': {
                subtitle: 'æµå‹•è³‡é‡‘ãƒ»æŠ•è³‡ãƒ»å›ºå®šè³‡ç”£ãƒ»æœªåé‡‘ãƒ»è² å‚µã‚’ã¾ã¨ã‚ã¦ç®¡ç†ã€‚æ¯æ—¥ã®è¨˜å¸³ã‚’ç‹å­ãŒã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚ âœ¨ğŸ’–',
                idleTitle: 'ã¡ã³ç‹å­ã®ã²ã¨ã“ã¨',
                advanced: 'è©³ç´°è¨­å®š',
                cloudAccount: 'ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ',
                displayCurrency: 'è¡¨ç¤ºé€šè²¨',
                pageLanguage: 'ãƒšãƒ¼ã‚¸è¨€èª',
                addAsset: 'è³‡ç”£ã‚’è¿½åŠ ',
                resetData: 'ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ',
                loginLoading: 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆèª­è¾¼ä¸­...',
                login: 'Google ãƒ­ã‚°ã‚¤ãƒ³',
                logout: 'Google ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ',
                exportData: 'ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ',
                importData: 'ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ',
                updatePrice: 'ä¾¡æ ¼ã‚’æ›´æ–°',
                updating: 'æ›´æ–°ä¸­...',
                updateFx: 'ç‚ºæ›¿ã‚’æ›´æ–°',
                sharePdf: 'PDFã§å…±æœ‰',
                generatingPdf: 'PDFä½œæˆä¸­...',
                marketAutoUpdate: 'ç›¸å ´ã¯5åˆ†ã”ã¨ã«è‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã™',
                lastUpdated: 'æœ€çµ‚æ›´æ–°',
                noPriceYet: 'ç›¸å ´ã¯ã¾ã æ›´æ–°ã•ã‚Œã¦ã„ã¾ã›ã‚“',
                rateUpdated: 'ç‚ºæ›¿æ›´æ–°',
                fxDefault: 'æ—¢å®šã®ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨ä¸­',
                cloudSyncing: 'ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸä¸­...',
                overviewTitle: 'è³‡ç”£ã‚µãƒãƒªãƒ¼ã¨é…åˆ†',
                netWorth: 'ç´”è³‡ç”£',
                totalAssets: 'ç·è³‡ç”£',
                totalLiabilities: 'ç·è² å‚µ',
                debtRatio: 'è² å‚µæ¯”ç‡',
                categoryMix: 'ã‚«ãƒ†ã‚´ãƒªé…åˆ†',
                detailMix: 'å†…è¨³é…åˆ†',
                noDetailItems: 'ã“ã®ã‚«ãƒ†ã‚´ãƒªã«é›†è¨ˆã§ãã‚‹å†…è¨³ãŒã‚ã‚Šã¾ã›ã‚“',
                tabAssetAccount: 'è³‡ç”£å£åº§ç®¡ç†',
                tabCashflow: 'ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ã¨åç›Šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼',
                cashflowDesc: 'å›ºå®šã®åå…¥/æ”¯å‡ºãƒ«ãƒ¼ãƒ«ã‚’è¨­å®šã—ã€æ—¥æ¬¡ãƒ»æœˆæ¬¡ãƒ»å¹´æ¬¡ã®æµã‚Œã‚’ç¢ºèªã§ãã¾ã™ã€‚',
                prevMonth: 'å‰æœˆ',
                nextMonth: 'ç¿Œæœˆ'
            }
        };
        const HEADER_SLOGANS = {
            'zh-Hant': [
                'ğŸ‘‘ ç‹å­ä¾†å¹«ä½ å®ˆè­·è²¡å¯Œç‹åœ‹å•¦ï½',
                'ğŸ’° åœ¨å°ç‹å­çš„é­”æ³•ä¸‹ï¼ŒéŒ¢éŒ¢æ¯å¤©éƒ½è®Šå¤šâ™¡',
                'ğŸª„ ä½ çš„è²¡å¯Œï¼Œç”±ç‹å­è¦ªè‡ªæ‰“ç†ï¼',
                'âœ¨ ä»Šå¤©ä¹ŸæŠŠæ¯ä¸€ç­†æ”¶æ”¯ï¼Œè®Šæˆç‹åœ‹çš„åŠ›é‡ã€‚',
                'ğŸŒŸ ç©©ç©©è¨˜å¸³ï¼Œæ…¢æ…¢å¯Œæœ‰ï¼Œç‹å­æœƒä¸€ç›´é™ªä½ ã€‚',
                'ğŸ° ç‹åœ‹å¸³æœ¬æ›´æ–°ä¸­ï¼šä½ é›¢ç›®æ¨™åˆæ›´è¿‘ä¸€æ­¥ã€‚',
                'ğŸ’– å°æ­¥ç´¯ç©ï¼Œä¹Ÿèƒ½èµ°åˆ°çš‡å† ç´šè³‡ç”¢ã€‚',
                'ğŸ“˜ å…ˆè¨˜éŒ„ã€å†å„ªåŒ–ï¼Œç‹å­çš„è²¡å¯Œè¡“ç”Ÿæ•ˆä¸­ã€‚'
            ],
            'en-US': [
                'ğŸ‘‘ The Prince is guarding your wealth kingdom!',
                'ğŸ’° Under his magic, your money grows day by day.',
                'ğŸª„ Your fortune is managed by the Prince himself!',
                'âœ¨ Every record today becomes tomorrowâ€™s power.',
                'ğŸŒŸ Track steadily, grow steadily.',
                'ğŸ° Your kingdom ledger is getting stronger.',
                'ğŸ’– Tiny steps can still build royal wealth.',
                'ğŸ“˜ Log first, optimize next.'
            ],
            'ja-JP': [
                'ğŸ‘‘ ç‹å­ãŒã‚ãªãŸã®è²¡ç”£ç‹å›½ã‚’å®ˆã‚Šã¾ã™ï¼',
                'ğŸ’° ç‹å­ã®é­”æ³•ã§ã€ãŠé‡‘ã¯æ¯æ—¥è‚²ã£ã¦ã„ãã€‚',
                'ğŸª„ ã‚ãªãŸã®è³‡ç”£ã¯ç‹å­ãŒç›´ã€…ã«ç®¡ç†ï¼',
                'âœ¨ ä»Šæ—¥ã®è¨˜éŒ²ãŒæ˜æ—¥ã®åŠ›ã«ãªã‚‹ã€‚',
                'ğŸŒŸ ã‚³ãƒ„ã‚³ãƒ„è¨˜å¸³ã€ç€å®Ÿã«æˆé•·ã€‚',
                'ğŸ° ç‹å›½ã®å®¶è¨ˆç°¿ã€ä»Šæ—¥ã‚‚æ›´æ–°ä¸­ã€‚',
                'ğŸ’– å°ã•ãªç©ã¿é‡ã­ãŒå¤§ããªè³‡ç”£ã¸ã€‚',
                'ğŸ“˜ è¨˜éŒ²ã—ã¦ã€æ•´ãˆã¦ã€å‰ã«é€²ã‚‚ã†ã€‚'
            ]
        };
        const IDLE_HINT_LINES = {
            'zh-Hant': [
                'ğŸ‘‘ ç‹å­å·¡é‚ä¸­ï¼šä»Šå¤©ä¹Ÿè¦è®“è²¡å¯Œç‹åœ‹æ›´ç©©ï¼',
                'âœ¨ å°æé†’ï¼šå›ºå®šç¾é‡‘æµè¦å‰‡å¯è‡ªå‹•å…¥å¸³åˆ°æµå‹•è³‡é‡‘ã€‚',
                'ğŸ’– æ¯æ¬¡è¨˜å¸³ï¼Œéƒ½æ˜¯ç‹åœ‹å‡ç´šçš„ä¸€æ­¥ã€‚',
                'ğŸª„ å…ˆè¨˜éŒ„å†åˆ†æï¼Œç‹å­æœƒå¹«ä½ çœ‹æ¸…è³‡é‡‘èµ°å‘ã€‚',
                'ğŸ“… ç”¨æ”¶ç›Šæœˆæ›†å›çœ‹æ¯æœˆæ·¨æµï¼Œæœ€å®¹æ˜“çœ‹å‡ºç¯€å¥ã€‚',
                'ğŸ¦ æœ‰é–’ç½®ç¾é‡‘æ™‚ï¼Œè¨˜å¾—å®‰æ’å„²è“„æˆ–å®šå­˜ç­–ç•¥ã€‚',
                'ğŸ“ˆ æŠ•è³‡éƒ¨ä½å¯å®šæœŸæ›´æ–°åƒ¹æ ¼ï¼Œåˆ¤æ–·æ˜¯å¦åé›¢é…ç½®ã€‚',
                'ğŸ§¾ å»ºç«‹åˆ†é¡ç¿’æ…£ï¼Œç‹å­æ‰èƒ½çµ¦ä½ æ›´æº–ç¢ºçš„æç¤ºã€‚'
            ],
            'en-US': [
                'ğŸ‘‘ Patrol mode: letâ€™s keep your kingdom stable today.',
                'âœ¨ Reminder: recurring cashflow can auto-post to liquid assets.',
                'ğŸ’– Every entry is one step closer to growth.',
                'ğŸª„ Record first, analyze next.',
                'ğŸ“… Check monthly net flow from the calendar view.',
                'ğŸ¦ Put idle cash to work with savings plans.',
                'ğŸ“ˆ Refresh market prices to track allocation drift.',
                'ğŸ§¾ Better categories = smarter guidance.'
            ],
            'ja-JP': [
                'ğŸ‘‘ å·¡å›ä¸­ï¼šä»Šæ—¥ã‚‚ç‹å›½ã®è³‡ç”£ã‚’å®‰å®šã•ã›ã‚ˆã†ã€‚',
                'âœ¨ å›ºå®šã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ã¯è‡ªå‹•å…¥é‡‘ã«ä½¿ãˆã¾ã™ã€‚',
                'ğŸ’– è¨˜å¸³ã®ä¸€æ­©ãŒè³‡ç”£å½¢æˆã®ä¸€æ­©ã€‚',
                'ğŸª„ ã¾ãšè¨˜éŒ²ã€æ¬¡ã«åˆ†æã€‚',
                'ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§æœˆæ¬¡ã®ç´”ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç¢ºèªã€‚',
                'ğŸ¦ ä½™å‰°è³‡é‡‘ã¯è¨ˆç”»çš„ã«æ´»ç”¨ã—ã¾ã—ã‚‡ã†ã€‚',
                'ğŸ“ˆ ä¾¡æ ¼æ›´æ–°ã§é…åˆ†ã®ã‚ºãƒ¬ã‚’æŠŠæ¡ã€‚',
                'ğŸ§¾ åˆ†é¡ã‚’æ•´ãˆã‚‹ã»ã©ç²¾åº¦ãŒä¸ŠãŒã‚Šã¾ã™ã€‚'
            ]
        };
        const polarToCartesian = (centerX, centerY, radius, angleInDegrees) => {
            const angleInRadians = (angleInDegrees - 90) * Math.PI / 180;
            return {
                x: centerX + (radius * Math.cos(angleInRadians)),
                y: centerY + (radius * Math.sin(angleInRadians))
            };
        };

        const describeArc = (x, y, radius, startAngle, endAngle) => {
            const start = polarToCartesian(x, y, radius, endAngle);
            const end = polarToCartesian(x, y, radius, startAngle);
            const largeArcFlag = endAngle - startAngle <= 180 ? '0' : '1';
            return `M ${x} ${y} L ${start.x} ${start.y} A ${radius} ${radius} 0 ${largeArcFlag} 0 ${end.x} ${end.y} Z`;
        };

        const seedAssets = [
        ];

        const parseStorage = (key, fallback) => {
            try {
                const raw = localStorage.getItem(key);
                return raw ? JSON.parse(raw) : fallback;
            } catch (error) {
                return fallback;
            }
        };

        const sanitizeCurrencyRates = (rates) => {
            const next = { ...DEFAULT_RATES };
            if (!rates || typeof rates !== 'object') return next;
            CURRENCIES.forEach(currency => {
                const value = Number(rates[currency]);
                if (Number.isFinite(value) && value > 0) next[currency] = value;
            });
            next.HKD = 1;
            return next;
        };

        const toHKD = (amount, currency, rates = DEFAULT_RATES) => amount / (rates[currency] || 1);
        const fromHKD = (amountHKD, currency, rates = DEFAULT_RATES) => amountHKD * (rates[currency] || 1);
        const formatAmount = (value) => {
            const numeric = Number(value) || 0;
            return numeric.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };

        const getNetWorthTier = (netWorthHKD) => {
              const value = Number(netWorthHKD) || 0;
              if (value < 0) return { emoji: 'âš ï¸', label: 'è² è³‡ç”¢ - è¿·è·¯å­¸å¾’' };
              if (value < 100000) return { emoji: 'ğŸŒ±', label: 'åŸºå±¤ / ä¸‹å±¤éšå±¤ - å‹¤å‹‰æ–°å…µ' };
              if (value < 300000) return { emoji: 'ğŸ€', label: 'åˆå…¥ç¤¾æœƒ / å‰›èµ·æ­¥ - è¦‹ç¿’é¨å£«' };
              if (value < 780000) return { emoji: 'ğŸŒ¿', label: 'å°åº· / ç©©å®šç™¼å±• - åŸé®ç®¡å®¶' };
              if (value < 1000000) return { emoji: 'ğŸ§­', label: 'å¤§çœ¾å¯Œè£• / ä¸Šå±¤å·¥äººéšç´š - ç‹åœ‹å·¥åŒ ' };
              if (value < 2000000) return { emoji: 'ğŸš—', label: 'æ–°æ™‰ä¸­ç”¢ - éŠ€å¾½é¨å£«' };
              if (value < 5000000) return { emoji: 'ğŸ¡', label: 'ä¸­ç”¢éšç´š - é‡‘å¾½é¨å£«' };
              if (value < 8000000) return { emoji: 'ğŸ™ï¸', label: 'ä¸­ä¸Šéšå±¤ - ä¾¯çˆµç®¡å®¶' };
              if (value < 10000000) return { emoji: 'ğŸ’ ', label: 'å¯Œè£•éšå±¤ / ä¸­ä¸Šéšå±¤ - ç‹å®¤ç­–å£«' };
              if (value < 20000000) return { emoji: 'ğŸ’¼', label: 'æº–é«˜æ·¨å€¼äººå£« - ä¼¯çˆµç†è²¡å®˜' };
              if (value < 50000000) return { emoji: 'ğŸ’', label: 'é«˜æ·¨å€¼å¯Œè±ª - å…¬çˆµè²¡æ”¿å®˜' };
              if (value < 100000000) return { emoji: 'ğŸ°', label: 'è¶…é«˜æ·¨å€¼äººå£« - ç‹åŸå®ˆè­·è€…' };
              if (value < 500000000) return { emoji: 'ğŸ‘‘', label: 'è¶…ç´šå¯Œè±ªéšå±¤ - çš‡å† é ˜ä¸»' };
              return { emoji: 'ğŸŒ', label: 'é ‚ç´šå¯Œè±ª / ä¸–ç•Œç´š - æ˜Ÿæµ·å›ä¸»' };
        };

        const calculateMortgageMetrics = ({ propertyPrice, ltvRatio, annualInterestRate, mortgageYears, paidPeriods }) => {
            const price = Number(propertyPrice) || 0;
            const ltv = Number(ltvRatio) || 0;
            const annualRate = Number(annualInterestRate) || 0;
            const years = Number(mortgageYears) || 0;
            const rawPaidPeriods = Number(paidPeriods) || 0;

            if (price <= 0 || ltv <= 0 || ltv > 100 || years <= 0 || annualRate < 0) return null;

            const loanAmount = price * (ltv / 100);
            const downPayment = price - loanAmount;
            const totalPeriods = Math.max(1, Math.round(years * 12));
            const monthlyRate = annualRate / 100 / 12;

            let monthlyPayment = 0;
            if (monthlyRate === 0) {
                monthlyPayment = loanAmount / totalPeriods;
            } else {
                const factor = Math.pow(1 + monthlyRate, totalPeriods);
                monthlyPayment = loanAmount * monthlyRate * factor / (factor - 1);
            }

            const totalInterest = monthlyPayment * totalPeriods - loanAmount;
            const paidPeriodsClamped = Math.min(Math.max(Math.floor(rawPaidPeriods), 0), totalPeriods);

            let outstandingPrincipal = 0;
            if (monthlyRate === 0) {
                outstandingPrincipal = loanAmount - monthlyPayment * paidPeriodsClamped;
            } else {
                const paidFactor = Math.pow(1 + monthlyRate, paidPeriodsClamped);
                outstandingPrincipal = loanAmount * paidFactor - monthlyPayment * ((paidFactor - 1) / monthlyRate);
            }

            outstandingPrincipal = Math.max(0, outstandingPrincipal);
            const remainingPeriods = Math.max(0, totalPeriods - paidPeriodsClamped);

            return {
                propertyPrice: price,
                ltvRatio: ltv,
                annualInterestRate: annualRate,
                mortgageYears: years,
                paidPeriods: paidPeriodsClamped,
                totalPeriods,
                remainingPeriods,
                downPayment,
                loanAmount,
                totalInterest,
                monthlyPayment,
                outstandingPrincipal
            };
        };

        const calculateInstallmentLoanMetrics = ({ loanPrincipal, annualInterestRate, loanYears, paidPeriods }) => {
            const principal = Number(loanPrincipal) || 0;
            const annualRate = Number(annualInterestRate) || 0;
            const years = Number(loanYears) || 0;
            const rawPaidPeriods = Number(paidPeriods) || 0;

            if (principal <= 0 || years <= 0 || annualRate < 0) return null;

            const totalPeriods = Math.max(1, Math.round(years * 12));
            const monthlyRate = annualRate / 100 / 12;
            let monthlyPayment = 0;

            if (monthlyRate === 0) {
                monthlyPayment = principal / totalPeriods;
            } else {
                const factor = Math.pow(1 + monthlyRate, totalPeriods);
                monthlyPayment = principal * monthlyRate * factor / (factor - 1);
            }

            const totalInterest = monthlyPayment * totalPeriods - principal;
            const paidPeriodsClamped = Math.min(Math.max(Math.floor(rawPaidPeriods), 0), totalPeriods);

            let outstandingPrincipal = 0;
            if (monthlyRate === 0) {
                outstandingPrincipal = principal - monthlyPayment * paidPeriodsClamped;
            } else {
                const paidFactor = Math.pow(1 + monthlyRate, paidPeriodsClamped);
                outstandingPrincipal = principal * paidFactor - monthlyPayment * ((paidFactor - 1) / monthlyRate);
            }

            outstandingPrincipal = Math.max(0, outstandingPrincipal);
            const remainingPeriods = Math.max(0, totalPeriods - paidPeriodsClamped);

            return {
                loanPrincipal: principal,
                annualInterestRate: annualRate,
                loanYears: years,
                paidPeriods: paidPeriodsClamped,
                totalPeriods,
                remainingPeriods,
                totalInterest,
                monthlyPayment,
                outstandingPrincipal
            };
        };

        const calculateFixedDepositMetrics = ({ principal, annualInterestRate, months }) => {
            const principalValue = Number(principal) || 0;
            const annualRate = Number(annualInterestRate) || 0;
            const termMonths = Number(months) || 0;

            if (principalValue <= 0 || termMonths <= 0 || annualRate < 0) return null;

            const maturityAmount = principalValue * (1 + (annualRate / 100) * (termMonths / 12));
            const interestAmount = maturityAmount - principalValue;

            return {
                principal: principalValue,
                annualInterestRate: annualRate,
                months: termMonths,
                maturityAmount,
                interestAmount
            };
        };

        const pad2 = (value) => String(value).padStart(2, '0');
        const toDateKey = (date) => `${date.getFullYear()}-${pad2(date.getMonth() + 1)}-${pad2(date.getDate())}`;
        const toMonthKey = (date) => `${date.getFullYear()}-${pad2(date.getMonth() + 1)}`;
        const parseDateKey = (dateKey) => {
            if (!/^\d{4}-\d{2}-\d{2}$/.test(dateKey || '')) return null;
            const [year, month, day] = dateKey.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            if (date.getFullYear() !== year || date.getMonth() !== (month - 1) || date.getDate() !== day) return null;
            return date;
        };
        const normalizeDateKeyOrFallback = (rawValue, fallbackDate) => {
            const parsed = parseDateKey(rawValue || '');
            return parsed ? toDateKey(parsed) : toDateKey(fallbackDate);
        };
        const parseOccurrenceDateFromPostingKey = (occurrenceKey) => {
            if (typeof occurrenceKey !== 'string') return '';
            const parts = occurrenceKey.split('@');
            return parts.length >= 3 ? parts[1] : '';
        };

        const sanitizeCashflowEntries = (entries) => {
            if (!Array.isArray(entries)) return [];
            const validTypes = Object.keys(CASHFLOW_TYPES);
            const validFrequencies = CASHFLOW_FREQUENCIES.map(item => item.value);
            const validScheduleTypes = CASHFLOW_SCHEDULE_TYPES.map(item => item.value);

            return entries
                .filter(item => item && typeof item === 'object')
                .map(item => {
                    const amount = Number(item.amount);
                    const startDate = typeof item.startDate === 'string' ? item.startDate : '';
                    const parsedStart = parseDateKey(startDate);
                    if (!parsedStart || !Number.isFinite(amount) || amount <= 0) return null;

                    const type = validTypes.includes(item.type) ? item.type : 'EXPENSE';
                    const inferredScheduleType = item.frequency === 'ONE_TIME' ? 'ONE_TIME' : 'RECURRING';
                    const scheduleType = validScheduleTypes.includes(item.scheduleType) ? item.scheduleType : inferredScheduleType;
                    const frequency = scheduleType === 'ONE_TIME'
                        ? 'ONE_TIME'
                        : (validFrequencies.includes(item.frequency) && item.frequency !== 'ONE_TIME' ? item.frequency : 'MONTHLY');
                    const currency = CURRENCIES.includes(item.currency) ? item.currency : 'HKD';
                    const weekday = Number.isInteger(item.weekday) && item.weekday >= 0 && item.weekday <= 6
                        ? item.weekday
                        : parsedStart.getDay();
                    const monthday = Number.isInteger(item.monthday) && item.monthday >= 1 && item.monthday <= 31
                        ? item.monthday
                        : parsedStart.getDate();
                    const payday = Number.isInteger(item.payday) && item.payday >= 1 && item.payday <= 31
                        ? item.payday
                        : monthday;

                    let endDate = typeof item.endDate === 'string' ? item.endDate : '';
                    const parsedEnd = parseDateKey(endDate);
                    if (!parsedEnd || parsedEnd.getTime() < parsedStart.getTime()) endDate = '';

                    const categoryPool = CASHFLOW_CATEGORY_BY_TYPE[type] || CASHFLOW_CATEGORY_BY_TYPE.EXPENSE;
                    const rawCategory = typeof item.category === 'string' ? item.category.trim() : '';
                    const normalizedCategory = categoryPool.includes(rawCategory)
                        ? rawCategory
                        : getDefaultCashflowCategory(type);

                    return {
                        id: typeof item.id === 'string' && item.id ? item.id : `${Date.now()}-${Math.random().toString(16).slice(2)}`,
                        title: typeof item.title === 'string' && item.title.trim() ? item.title.trim() : 'æœªå‘½åç¾é‡‘æµ',
                        account: typeof item.account === 'string' ? item.account.trim() : '',
                        category: normalizedCategory,
                        note: typeof item.note === 'string' ? item.note.trim() : '',
                        type,
                        amount,
                        currency,
                        startDate,
                        endDate: scheduleType === 'ONE_TIME' ? '' : endDate,
                        scheduleType,
                        frequency,
                        weekday,
                        monthday,
                        payday,
                        targetLiquidAssetId: typeof item.targetLiquidAssetId === 'string' ? item.targetLiquidAssetId : ''
                    };
                })
                .filter(Boolean)
                .sort((a, b) => a.startDate.localeCompare(b.startDate));
        };

        const isEntryOnDate = (entry, date) => {
            const start = parseDateKey(entry.startDate);
            if (!start) return false;
            if (date.getTime() < start.getTime()) return false;

            const scheduleType = entry.scheduleType || (entry.frequency === 'ONE_TIME' ? 'ONE_TIME' : 'RECURRING');
            if (scheduleType === 'ONE_TIME') {
                return toDateKey(date) === entry.startDate;
            }

            const end = parseDateKey(entry.endDate);
            if (end && date.getTime() > end.getTime()) return false;

            if (entry.frequency === 'DAILY') return true;
            if (entry.frequency === 'WEEKLY') return date.getDay() === (Number(entry.weekday) || start.getDay());
            if (entry.frequency === 'MONTHLY') {
                const configuredDay = Number(entry.monthday) || start.getDate();
                const daysInCurrentMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
                const targetDay = Math.min(configuredDay, daysInCurrentMonth);
                return date.getDate() === targetDay;
            }
            if (entry.frequency === 'YEARLY') return date.getDate() === start.getDate() && date.getMonth() === start.getMonth();
            return false;
        };

        const findNextOccurrenceDateKey = (entry, fromDate = new Date(), maxLookAheadDays = 3650) => {
            const base = new Date(fromDate.getFullYear(), fromDate.getMonth(), fromDate.getDate());
            for (let offset = 0; offset <= maxLookAheadDays; offset += 1) {
                const candidate = new Date(base.getFullYear(), base.getMonth(), base.getDate() + offset);
                if (isEntryOnDate(entry, candidate)) return toDateKey(candidate);
            }
            return '';
        };

        const findLastOccurrenceDateKey = (entry, fromDate = new Date(), maxLookBackDays = 3650) => {
            const base = new Date(fromDate.getFullYear(), fromDate.getMonth(), fromDate.getDate());
            for (let offset = 0; offset <= maxLookBackDays; offset += 1) {
                const candidate = new Date(base.getFullYear(), base.getMonth(), base.getDate() - offset);
                if (isEntryOnDate(entry, candidate)) return toDateKey(candidate);
            }
            return '';
        };

        const normalizeYahooSymbol = (symbol) => {
            const clean = (symbol || '').trim().toUpperCase();
            if (/^\d{4,6}$/.test(clean)) return `${clean}.TW`;
            return clean;
        };

        const toStooqSymbol = (symbol) => {
            const upper = (symbol || '').trim().toUpperCase();
            if (/^\d{4,6}\.TW$/.test(upper)) return `${upper.replace('.TW', '')}.TW`;
            if (/^[A-Z]+$/.test(upper)) return `${upper}.US`;
            return upper;
        };

        async function fetchTextWithTimeout(url, timeoutMs = 12000) {
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), timeoutMs);
            try {
                const response = await fetch(url, { signal: controller.signal });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.text();
            } finally {
                clearTimeout(timeout);
            }
        }

        async function fetchJSONWithTimeout(url, timeoutMs = 12000) {
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), timeoutMs);
            try {
                const response = await fetch(url, { signal: controller.signal });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } finally {
                clearTimeout(timeout);
            }
        }

        async function ensureJsPdfReady() {
            if (window.jspdf?.jsPDF) return window.jspdf.jsPDF;

            const existing = document.getElementById('jspdf-runtime-loader');
            if (!existing) {
                await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.id = 'jspdf-runtime-loader';
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                    script.onload = resolve;
                    script.onerror = () => reject(new Error('jspdf load failed'));
                    document.head.appendChild(script);
                });
            } else {
                await new Promise((resolve, reject) => {
                    if (window.jspdf?.jsPDF) {
                        resolve();
                        return;
                    }
                    existing.addEventListener('load', resolve, { once: true });
                    existing.addEventListener('error', () => reject(new Error('jspdf load failed')), { once: true });
                });
            }

            if (!window.jspdf?.jsPDF) throw new Error('jspdf unavailable');
            return window.jspdf.jsPDF;
        }

        async function ensureHtml2CanvasReady() {
            if (window.html2canvas) return window.html2canvas;

            const existing = document.getElementById('html2canvas-runtime-loader');
            if (!existing) {
                await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.id = 'html2canvas-runtime-loader';
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                    script.onload = resolve;
                    script.onerror = () => reject(new Error('html2canvas load failed'));
                    document.head.appendChild(script);
                });
            } else {
                await new Promise((resolve, reject) => {
                    if (window.html2canvas) {
                        resolve();
                        return;
                    }
                    existing.addEventListener('load', resolve, { once: true });
                    existing.addEventListener('error', () => reject(new Error('html2canvas load failed')), { once: true });
                });
            }

            if (!window.html2canvas) throw new Error('html2canvas unavailable');
            return window.html2canvas;
        }

        async function fetchLatestCurrencyRates() {
            const sources = [
                'https://open.er-api.com/v6/latest/HKD',
                `https://api.allorigins.win/raw?url=${encodeURIComponent('https://open.er-api.com/v6/latest/HKD')}`
            ];

            for (const source of sources) {
                try {
                    const data = await fetchJSONWithTimeout(source);
                    const rawRates = data?.rates;
                    if (!rawRates || typeof rawRates !== 'object') continue;

                    const mapped = {};
                    CURRENCIES.forEach(currency => {
                        if (currency === 'HKD') {
                            mapped.HKD = 1;
                            return;
                        }
                        const value = Number(rawRates[currency]);
                        if (Number.isFinite(value) && value > 0) mapped[currency] = value;
                    });

                    const merged = sanitizeCurrencyRates(mapped);
                    const hasEnough = CURRENCIES.every(currency => Number.isFinite(merged[currency]) && merged[currency] > 0);
                    if (hasEnough) return merged;
                } catch (error) {}
            }

            throw new Error('fx source unavailable');
        }

        const parseYahooQuoteResponse = (data) => {
            const map = {};
            (data?.quoteResponse?.result || []).forEach(item => {
                if (item.symbol && typeof item.regularMarketPrice === 'number') {
                    map[item.symbol.toUpperCase()] = item.regularMarketPrice;
                }
            });
            return map;
        };

        const parseYahooChartResponse = (data) => {
            const price = data?.chart?.result?.[0]?.meta?.regularMarketPrice;
            return typeof price === 'number' ? price : null;
        };

        async function fetchYahooChartPrice(symbol) {
            const upper = symbol.toUpperCase();
            if (!/^[A-Z0-9.\-]+$/.test(upper)) return null;
            const base = `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(upper)}?interval=1d&range=1d`;
            const fallbackBase = `https://query2.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(upper)}?interval=1d&range=1d`;
            const sources = [
                `https://api.allorigins.win/raw?url=${encodeURIComponent(base)}`,
                `https://api.allorigins.win/raw?url=${encodeURIComponent(fallbackBase)}`
            ];

            for (const source of sources) {
                try {
                    const data = await fetchJSONWithTimeout(source);
                    const price = parseYahooChartResponse(data);
                    if (typeof price === 'number') return price;
                } catch (error) {}
            }

            return null;
        }

        async function fetchStooqQuotes(symbols) {
            const map = {};
            await Promise.all(symbols.map(async yahooSymbol => {
                const stooqSymbol = toStooqSymbol(yahooSymbol).toLowerCase();
                const stooqUrl = `https://stooq.com/q/l/?s=${encodeURIComponent(stooqSymbol)}&f=sd2t2ohlcv&h&e=csv`;
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(stooqUrl)}`;

                const tryParse = (csvText) => {
                    const lines = (csvText || '').trim().split('\n');
                    if (lines.length < 2) return null;
                    const columns = lines[1].split(',');
                    const close = Number(columns[6]);
                    return Number.isFinite(close) && close > 0 ? close : null;
                };

                try {
                    const directCsv = await fetchTextWithTimeout(stooqUrl);
                    const directPrice = tryParse(directCsv);
                    if (directPrice) {
                        map[yahooSymbol.toUpperCase()] = directPrice;
                        return;
                    }
                } catch (error) {}

                try {
                    const proxyCsv = await fetchTextWithTimeout(proxyUrl);
                    const proxyPrice = tryParse(proxyCsv);
                    if (proxyPrice) {
                        map[yahooSymbol.toUpperCase()] = proxyPrice;
                    }
                } catch (error) {}
            }));
            return map;
        }

        async function fetchYahooQuotes(symbols) {
            if (!symbols.length) return {};
            const base = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${encodeURIComponent(symbols.join(','))}`;
            const fallbackBase = `https://query2.finance.yahoo.com/v7/finance/quote?symbols=${encodeURIComponent(symbols.join(','))}`;
            const sources = [
                `https://api.allorigins.win/raw?url=${encodeURIComponent(base)}`,
                `https://api.allorigins.win/raw?url=${encodeURIComponent(fallbackBase)}`
            ];

            let results = {};
            for (const source of sources) {
                try {
                    const data = await fetchJSONWithTimeout(source);
                    const parsed = parseYahooQuoteResponse(data);
                    if (Object.keys(parsed).length) {
                        results = { ...results, ...parsed };
                    }
                } catch (error) {}
            }

            const missingSymbols = symbols.filter(symbol => !results[symbol.toUpperCase()]);
            if (missingSymbols.length) {
                const chartQuotes = await Promise.all(missingSymbols.map(async symbol => {
                    const price = await fetchYahooChartPrice(symbol);
                    return { symbol: symbol.toUpperCase(), price };
                }));
                chartQuotes.forEach(entry => {
                    if (typeof entry.price === 'number') results[entry.symbol] = entry.price;
                });
            }

            const stillMissing = symbols.filter(symbol => !results[symbol.toUpperCase()]);
            if (stillMissing.length) {
                const stooqQuotes = await fetchStooqQuotes(stillMissing);
                results = { ...results, ...stooqQuotes };
            }

            return results;
        }

        async function fetchCryptoQuotes(cryptoSymbols) {
            const ids = [...new Set(cryptoSymbols.map(symbol => CRYPTO_ID_MAP[symbol]).filter(Boolean))];
            if (!ids.length) return {};
            const baseUrl = `https://api.coingecko.com/api/v3/simple/price?ids=${ids.join(',')}&vs_currencies=usd`;
            const sources = [
                baseUrl,
                `https://api.allorigins.win/raw?url=${encodeURIComponent(baseUrl)}`
            ];

            let data = null;
            for (const source of sources) {
                try {
                    data = await fetchJSONWithTimeout(source);
                    if (data && typeof data === 'object') break;
                } catch (error) {}
            }

            if (!data) return {};

            try {
                const bySymbol = {};
                Object.entries(CRYPTO_ID_MAP).forEach(([symbol, id]) => {
                    if (data[id]?.usd) bySymbol[symbol] = data[id].usd;
                });
                return bySymbol;
            } catch (error) {
                return {};
            }
        }

        function App() {
            const [assets, setAssets] = useState(() => parseStorage(STORAGE_KEYS.assets, seedAssets));
            const [displayCurrency, setDisplayCurrency] = useState(() => parseStorage(STORAGE_KEYS.displayCurrency, 'HKD'));
            const [monthlySnapshots, setMonthlySnapshots] = useState(() => parseStorage(STORAGE_KEYS.monthlySnapshots, {}));
            const [cashflowEntries, setCashflowEntries] = useState(() => sanitizeCashflowEntries(parseStorage(STORAGE_KEYS.cashflowEntries, [])));
            const [cashflowAppliedOccurrenceKeys, setCashflowAppliedOccurrenceKeys] = useState(() => {
                const raw = parseStorage(STORAGE_KEYS.cashflowAppliedOccurrenceKeys, []);
                return Array.isArray(raw) ? raw.filter(item => typeof item === 'string') : [];
            });
            const [cashflowAppliedPostings, setCashflowAppliedPostings] = useState(() => {
                const raw = parseStorage(STORAGE_KEYS.cashflowAppliedPostings, {});
                if (!raw || typeof raw !== 'object' || Array.isArray(raw)) return {};
                const next = {};
                Object.entries(raw).forEach(([key, value]) => {
                    if (!key || !value || typeof value !== 'object') return;
                    const signedAmount = Number(value.signedAmount);
                    if (!Number.isFinite(signedAmount)) return;
                    next[key] = {
                        entryId: typeof value.entryId === 'string' ? value.entryId : '',
                        targetLiquidAssetId: typeof value.targetLiquidAssetId === 'string' ? value.targetLiquidAssetId : '',
                        signedAmount,
                        targetCurrency: typeof value.targetCurrency === 'string' ? value.targetCurrency : '',
                        type: value.type === 'INCOME' ? 'INCOME' : 'EXPENSE'
                    };
                });
                return next;
            });
            const [cashflowLastAutoApplyDate, setCashflowLastAutoApplyDate] = useState(() => normalizeDateKeyOrFallback(
                parseStorage(STORAGE_KEYS.cashflowLastAutoApplyDate, ''),
                new Date(Date.now() - ONE_DAY_MS)
            ));
            const [currencyRates, setCurrencyRates] = useState(() => sanitizeCurrencyRates(parseStorage(STORAGE_KEYS.currencyRates, DEFAULT_RATES)));
            const [lastRateUpdate, setLastRateUpdate] = useState(() => {
                const saved = Number(parseStorage(STORAGE_KEYS.currencyRatesUpdatedAt, 0));
                return Number.isFinite(saved) && saved > 0 ? new Date(saved) : null;
            });
            const [authUser, setAuthUser] = useState(null);
            const [isAuthLoading, setIsAuthLoading] = useState(isCloudEnabled);
            const [isCloudSyncing, setIsCloudSyncing] = useState(false);
            const [cloudStatus, setCloudStatus] = useState(isCloudEnabled ? 'å°šæœªç™»å…¥ Googleï¼Œè³‡æ–™åƒ…å­˜åœ¨æ­¤è£ç½®' : 'æœªè¨­å®š Firebaseï¼Œè³‡æ–™åƒ…å­˜åœ¨æ­¤è£ç½®');

            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [selectedCategories, setSelectedCategories] = useState(CATEGORY_KEYS);
            const [sortMode, setSortMode] = useState('AMOUNT_DESC');
            const [viewMode, setViewMode] = useState('DETAIL');
            const [isUpdatingPrice, setIsUpdatingPrice] = useState(false);
            const [isUpdatingRates, setIsUpdatingRates] = useState(false);
            const [isGeneratingPdf, setIsGeneratingPdf] = useState(false);
            const [priceStatus, setPriceStatus] = useState('');
            const [lastPriceUpdate, setLastPriceUpdate] = useState(null);
            const [showSettings, setShowSettings] = useState(false);
            const [pageLanguage, setPageLanguage] = useState(() => {
                const saved = parseStorage(STORAGE_KEYS.pageLanguage, 'zh-Hant');
                return PAGE_LANGUAGE_OPTIONS.some(item => item.value === saved) ? saved : 'zh-Hant';
            });
            const [headerSloganIndex, setHeaderSloganIndex] = useState(0);
            const [princeIdleIndex, setPrinceIdleIndex] = useState(0);
            const [selectedMixCategory, setSelectedMixCategory] = useState('INVEST');
            const [expandedAccounts, setExpandedAccounts] = useState({});
            const [selectedStatsCategory, setSelectedStatsCategory] = useState('INVEST');
            const [selectedStatsAccount, setSelectedStatsAccount] = useState('');
            const [selectedStatsSegmentKey, setSelectedStatsSegmentKey] = useState('');
            const [statsBreakdownMode, setStatsBreakdownMode] = useState('ACCOUNT');
            const [financeSectionTab, setFinanceSectionTab] = useState('ASSET_ACCOUNT');
            const [cashflowView, setCashflowView] = useState('MONTH');
            const [selectedCashflowMonth, setSelectedCashflowMonth] = useState(() => toMonthKey(new Date()));
            const [editingCashflowId, setEditingCashflowId] = useState('');
            const [cashflowRuleKeyword, setCashflowRuleKeyword] = useState('');
            const [cashflowRuleFilter, setCashflowRuleFilter] = useState('ALL');
            const [cashflowRuleSortMode, setCashflowRuleSortMode] = useState('START_DESC');
            const [cashflowRulesVisibleCount, setCashflowRulesVisibleCount] = useState(20);
            const [cashflowForm, setCashflowForm] = useState(() => {
                const today = toDateKey(new Date());
                return {
                    title: '',
                    account: '',
                    category: getDefaultCashflowCategory('INCOME'),
                    type: 'INCOME',
                    scheduleType: 'RECURRING',
                    amount: '',
                    currency: 'HKD',
                    frequency: 'MONTHLY',
                    startDate: today,
                    endDate: '',
                    payday: '25',
                    targetLiquidAssetId: '',
                    note: ''
                };
            });

            const [formData, setFormData] = useState({
                account: '',
                name: '',
                category: 'LIQUID',
                subtype: 'ç¾é‡‘',
                symbol: '',
                quantity: '',
                costBasis: '',
                currency: 'HKD',
                premiumAmount: '',
                premiumFrequency: 'monthly',
                premiumPaidCount: '',
                propertyPrice: '',
                ltvRatio: '',
                annualInterestRate: '',
                mortgageYears: '',
                paidPeriods: '',
                loanPrincipal: '',
                loanYears: '',
                loanPaidPeriods: '',
                loanAnnualInterestRate: '',
                creditCardBalance: '',
                creditCardMinPayment: '',
                creditCardDueDate: '',
                creditCardAnnualRate: '',
                payableAmount: '',
                payableDueDate: '',
                payableInstallments: '',
                otherOutstanding: '',
                otherAnnualRate: '',
                otherDueDate: '',
                receivableAmount: '',
                receivableDueDate: '',
                receivableInstallments: '',
                receivableParty: '',
                fixedPurchasePrice: '',
                fixedCurrentValue: '',
                fixedPurchaseDate: '',
                fixedNote: '',
                fixedDepositPrincipal: '',
                fixedDepositAnnualRate: '',
                fixedDepositMonths: '',
                fixedDepositStartDate: ''
            });
            const importInputRef = useRef(null);
            const cashflowFormRef = useRef(null);
            const cloudHydratedRef = useRef(false);
            const cloudSaveTimerRef = useRef(null);

            const isLiquidForm = formData.category === 'LIQUID';
            const isInvestForm = formData.category === 'INVEST';
            const isCryptoForm = isInvestForm && formData.subtype === 'åŠ å¯†è²¨å¹£';
            const isStockForm = isInvestForm && formData.subtype === 'è‚¡ç¥¨';
            const isFundForm = isInvestForm && formData.subtype === 'åŸºé‡‘';
            const isFixedDepositForm = isInvestForm && formData.subtype === 'å®šæœŸå­˜æ¬¾';
            const isInsuranceForm = formData.category === 'INSURANCE';
            const isLiabilityForm = formData.category === 'LIABILITY';
            const isReceivableForm = formData.category === 'RECEIVABLE';
            const isFixedForm = formData.category === 'FIXED';
            const isMortgageForm = isLiabilityForm && formData.subtype === 'æˆ¿è²¸';
            const isLoanForm = isLiabilityForm && formData.subtype === 'è²¸æ¬¾';
            const isCreditCardForm = isLiabilityForm && formData.subtype === 'ä¿¡ç”¨å¡';
            const isPayableForm = isLiabilityForm && formData.subtype === 'æ‡‰ä»˜æ¬¾';
            const isOtherLiabilityForm = isLiabilityForm && formData.subtype === 'å…¶ä»–è² å‚µ';
            const needsPremium = isInsuranceForm && ['äººå£½/ç´¯ç©è²¡å¯Œ', 'å¥åº·'].includes(formData.subtype);
            const premiumTotal = (Number(formData.premiumAmount) || 0) * (Number(formData.premiumPaidCount) || 0);
            const mortgageMetrics = isMortgageForm ? calculateMortgageMetrics(formData) : null;
            const loanMetrics = isLoanForm ? calculateInstallmentLoanMetrics({
                loanPrincipal: formData.loanPrincipal,
                annualInterestRate: formData.loanAnnualInterestRate,
                loanYears: formData.loanYears,
                paidPeriods: formData.loanPaidPeriods
            }) : null;
            const fixedDepositMetrics = isFixedDepositForm ? calculateFixedDepositMetrics({
                principal: formData.fixedDepositPrincipal,
                annualInterestRate: formData.fixedDepositAnnualRate,
                months: formData.fixedDepositMonths
            }) : null;

            const assetsRef = useRef(assets);
            useEffect(() => { assetsRef.current = assets; }, [assets]);
            const displayCurrencyRef = useRef(displayCurrency);
            useEffect(() => { displayCurrencyRef.current = displayCurrency; }, [displayCurrency]);
            const monthlySnapshotsRef = useRef(monthlySnapshots);
            useEffect(() => { monthlySnapshotsRef.current = monthlySnapshots; }, [monthlySnapshots]);
            const cashflowEntriesRef = useRef(cashflowEntries);
            useEffect(() => { cashflowEntriesRef.current = cashflowEntries; }, [cashflowEntries]);

            const toHKD = (amount, currency) => amount / (currencyRates[currency] || 1);
            const fromHKD = (amountHKD, currency) => amountHKD * (currencyRates[currency] || 1);

            useEffect(() => {
                localStorage.setItem(STORAGE_KEYS.assets, JSON.stringify(assets));
            }, [assets]);

            useEffect(() => {
                localStorage.setItem(STORAGE_KEYS.displayCurrency, JSON.stringify(displayCurrency));
            }, [displayCurrency]);

            useEffect(() => {
                localStorage.setItem(STORAGE_KEYS.currencyRates, JSON.stringify(currencyRates));
            }, [currencyRates]);

            useEffect(() => {
                localStorage.setItem(STORAGE_KEYS.cashflowEntries, JSON.stringify(cashflowEntries));
            }, [cashflowEntries]);

            useEffect(() => {
                localStorage.setItem(STORAGE_KEYS.cashflowAppliedOccurrenceKeys, JSON.stringify(cashflowAppliedOccurrenceKeys));
            }, [cashflowAppliedOccurrenceKeys]);

            useEffect(() => {
                localStorage.setItem(STORAGE_KEYS.cashflowAppliedPostings, JSON.stringify(cashflowAppliedPostings));
            }, [cashflowAppliedPostings]);

            useEffect(() => {
                localStorage.setItem(STORAGE_KEYS.cashflowLastAutoApplyDate, JSON.stringify(cashflowLastAutoApplyDate));
            }, [cashflowLastAutoApplyDate]);

            useEffect(() => {
                const stamp = lastRateUpdate instanceof Date ? lastRateUpdate.getTime() : 0;
                localStorage.setItem(STORAGE_KEYS.currencyRatesUpdatedAt, JSON.stringify(stamp));
            }, [lastRateUpdate]);

            useEffect(() => {
                localStorage.setItem(STORAGE_KEYS.pageLanguage, JSON.stringify(pageLanguage));
            }, [pageLanguage]);

            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [assets, isModalOpen, selectedCategories, sortMode, isUpdatingPrice]);

            useEffect(() => {
                return () => {
                    if (cloudSaveTimerRef.current) clearTimeout(cloudSaveTimerRef.current);
                };
            }, []);

            const pageText = useMemo(() => UI_TEXT[pageLanguage] || UI_TEXT['zh-Hant'], [pageLanguage]);
            const headerSlogans = useMemo(() => HEADER_SLOGANS[pageLanguage] || HEADER_SLOGANS['zh-Hant'], [pageLanguage]);
            const idleHintLines = useMemo(() => IDLE_HINT_LINES[pageLanguage] || IDLE_HINT_LINES['zh-Hant'], [pageLanguage]);
            const currentHeaderSlogan = headerSlogans[headerSloganIndex % Math.max(headerSlogans.length, 1)] || '';
            const currentIdleHint = idleHintLines[princeIdleIndex % Math.max(idleHintLines.length, 1)] || '';

            useEffect(() => {
                document.documentElement.lang = pageLanguage;
            }, [pageLanguage]);

            useEffect(() => {
                setHeaderSloganIndex(0);
                setPrinceIdleIndex(0);
            }, [pageLanguage]);

            useEffect(() => {
                const timer = setInterval(() => {
                    setHeaderSloganIndex(prev => (prev + 1) % Math.max(headerSlogans.length, 1));
                }, 5000);
                return () => clearInterval(timer);
            }, [headerSlogans]);

            useEffect(() => {
                const timer = setInterval(() => {
                    setPrinceIdleIndex(prev => (prev + 1) % Math.max(idleHintLines.length, 1));
                }, 8000);
                return () => clearInterval(timer);
            }, [idleHintLines]);

            const princeHintMessage = useMemo(() => {
                if (isGeneratingPdf) {
                    return pageLanguage === 'en-US' ? 'ğŸ“œ The Prince is preparing your PDF report...' : (pageLanguage === 'ja-JP' ? 'ğŸ“œ ç‹å­ãŒPDFãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆä¸­ã§ã™â€¦' : 'ğŸ“œ ç‹å­æ­£åœ¨æ•´ç†ä½ çš„ PDF å ±è¡¨ï¼Œè«‹ç¨å€™ï½');
                }
                if (isUpdatingPrice) {
                    return pageLanguage === 'en-US' ? 'ğŸ“ˆ Fetching latest market prices.' : (pageLanguage === 'ja-JP' ? 'ğŸ“ˆ æœ€æ–°ã®ä¾¡æ ¼ã‚’å–å¾—ä¸­ã§ã™ã€‚' : 'ğŸ“ˆ ç‹å­æ­£åœ¨å¬å–šæœ€æ–°è‚¡åƒ¹èˆ‡å¹£åƒ¹ã€‚');
                }
                if (isUpdatingRates) {
                    return pageLanguage === 'en-US' ? 'ğŸ’± Updating exchange rates.' : (pageLanguage === 'ja-JP' ? 'ğŸ’± ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆã‚’æ›´æ–°ä¸­ã§ã™ã€‚' : 'ğŸ’± ç‹å­æ­£åœ¨æ›´æ–°åŒ¯ç‡é­”æ³•ã€‚');
                }
                if (isCloudSyncing) {
                    return pageLanguage === 'en-US' ? 'â˜ï¸ Syncing data to cloud now.' : (pageLanguage === 'ja-JP' ? 'â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ã¸åŒæœŸä¸­ã§ã™ã€‚' : 'â˜ï¸ ç‹å­æ­£åœ¨æŠŠè³‡æ–™åŒæ­¥åˆ°é›²ç«¯ã€‚');
                }
                if (isModalOpen) {
                    return pageLanguage === 'en-US' ? 'ğŸ“ Fill the form and save the asset.' : (pageLanguage === 'ja-JP' ? 'ğŸ“ ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›å¾Œã«ä¿å­˜ã—ã¦ãã ã•ã„ã€‚' : 'ğŸ“ åœ¨è¡¨å–®å¡«å¥½è³‡æ–™å¾ŒæŒ‰ã€Œå„²å­˜è³‡ç”¢ã€å°±å®Œæˆå›‰ï¼');
                }
                if (editingCashflowId) {
                    return pageLanguage === 'en-US' ? 'ğŸ”§ You are editing a rule. Remember to save.' : (pageLanguage === 'ja-JP' ? 'ğŸ”§ ãƒ«ãƒ¼ãƒ«ç·¨é›†ä¸­ã§ã™ã€‚ä¿å­˜ã‚’å¿˜ã‚Œãšã«ã€‚' : 'ğŸ”§ ä½ æ­£åœ¨ç·¨è¼¯è¦å‰‡ï¼Œè¨˜å¾—ç¢ºèªå„²å­˜ã€‚');
                }
                if (showSettings) {
                    return pageLanguage === 'en-US' ? 'âš™ï¸ Settings opened. You can import/export and update data.' : (pageLanguage === 'ja-JP' ? 'âš™ï¸ è¨­å®šã‚’é–‹ãã¾ã—ãŸã€‚ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¯èƒ½ã§ã™ã€‚' : 'âš™ï¸ è¨­å®šé¸å–®å·²é–‹å•Ÿï¼Œå¯åŒ¯å…¥åŒ¯å‡ºèˆ‡æ›´æ–°è³‡æ–™ã€‚');
                }
                if (financeSectionTab === 'CASHFLOW') {
                    return pageLanguage === 'en-US' ? 'ğŸ“… Use cashflow rules for auto posting.' : (pageLanguage === 'ja-JP' ? 'ğŸ“… å›ºå®šãƒ«ãƒ¼ãƒ«ã§è‡ªå‹•è¨˜å¸³ã§ãã¾ã™ã€‚' : 'ğŸ“… åœ¨ç¾é‡‘æµåˆ†é å¯è¨­å®šå›ºå®šè¦å‰‡èˆ‡è‡ªå‹•å…¥å¸³ã€‚');
                }
                if (priceStatus) return `ğŸ“£ ${priceStatus}`;
                return currentIdleHint;
            }, [isGeneratingPdf, isUpdatingPrice, isUpdatingRates, isCloudSyncing, isModalOpen, editingCashflowId, showSettings, financeSectionTab, priceStatus, currentIdleHint, pageLanguage]);

            const totals = useMemo(() => {
                let assetsHKD = 0;
                let liabilitiesHKD = 0;
                const categoryBreakdownHKD = {};
                const investSubtypeHKD = {};

                assets.forEach(asset => {
                    const marketValueHKD = toHKD(asset.quantity * asset.currentPrice, asset.currency);
                    categoryBreakdownHKD[asset.category] = (categoryBreakdownHKD[asset.category] || 0) + marketValueHKD;
                    if (asset.category === 'INVEST') {
                        investSubtypeHKD[asset.subtype] = (investSubtypeHKD[asset.subtype] || 0) + marketValueHKD;
                    }
                    if (CATEGORIES[asset.category].isNegative) liabilitiesHKD += marketValueHKD;
                    else assetsHKD += marketValueHKD;
                });

                const investTotalHKD = Object.values(investSubtypeHKD).reduce((sum, value) => sum + value, 0);
                const debtRatio = assetsHKD > 0 ? (liabilitiesHKD / assetsHKD) * 100 : 0;

                return {
                    assetsHKD,
                    liabilitiesHKD,
                    netWorthHKD: assetsHKD - liabilitiesHKD,
                    debtRatio,
                    investTotalHKD,
                    categoryBreakdownHKD,
                    investSubtypeHKD,
                    assets: fromHKD(assetsHKD, displayCurrency),
                    liabilities: fromHKD(liabilitiesHKD, displayCurrency),
                    netWorth: fromHKD(assetsHKD - liabilitiesHKD, displayCurrency)
                };
            }, [assets, displayCurrency, currencyRates]);

            useEffect(() => {
                const monthKey = new Date().toISOString().slice(0, 7);
                setMonthlySnapshots(prev => {
                    const current = prev[monthKey];
                    const nextSnapshot = {
                        assetsHKD: Number(totals.assetsHKD.toFixed(2)),
                        liabilitiesHKD: Number(totals.liabilitiesHKD.toFixed(2)),
                        netWorthHKD: Number(totals.netWorthHKD.toFixed(2)),
                        debtRatio: Number(totals.debtRatio.toFixed(2)),
                        updatedAt: Date.now()
                    };
                    if (
                        current &&
                        current.assetsHKD === nextSnapshot.assetsHKD &&
                        current.liabilitiesHKD === nextSnapshot.liabilitiesHKD &&
                        current.netWorthHKD === nextSnapshot.netWorthHKD &&
                        current.debtRatio === nextSnapshot.debtRatio
                    ) {
                        return prev;
                    }
                    const next = { ...prev, [monthKey]: nextSnapshot };
                    localStorage.setItem(STORAGE_KEYS.monthlySnapshots, JSON.stringify(next));
                    return next;
                });
            }, [totals.assetsHKD, totals.liabilitiesHKD, totals.netWorthHKD, totals.debtRatio]);

            const groupedAssets = useMemo(() => {
                const groups = {};
                assets.forEach(asset => {
                    if (!selectedCategories.includes(asset.category)) return;
                    if (!groups[asset.category]) groups[asset.category] = {};
                    if (!groups[asset.category][asset.account]) groups[asset.category][asset.account] = [];
                    groups[asset.category][asset.account].push(asset);
                });

                const compareByName = (a, b) => a.localeCompare(b, 'zh-Hant', { numeric: true, sensitivity: 'base' });

                return CATEGORY_KEYS
                    .filter(categoryKey => groups[categoryKey])
                    .map(categoryKey => {
                        const accountMap = groups[categoryKey];
                        const accounts = Object.entries(accountMap).map(([accountName, items]) => {
                            const sortedItems = [...items].sort((a, b) => {
                                if (sortMode === 'NAME_ASC') {
                                    return compareByName(a.name || '', b.name || '');
                                }
                                const aValue = Math.abs(toHKD(a.quantity * a.currentPrice, a.currency));
                                const bValue = Math.abs(toHKD(b.quantity * b.currentPrice, b.currency));
                                return bValue - aValue;
                            });

                            const accountTotalHKD = sortedItems.reduce((sum, item) => {
                                return sum + Math.abs(toHKD(item.quantity * item.currentPrice, item.currency));
                            }, 0);

                            return {
                                accountName,
                                items: sortedItems,
                                accountTotalHKD
                            };
                        });

                        const sortedAccounts = [...accounts].sort((a, b) => {
                            if (sortMode === 'NAME_ASC') {
                                return compareByName(a.accountName, b.accountName);
                            }
                            return b.accountTotalHKD - a.accountTotalHKD;
                        });

                        return {
                            categoryKey,
                            accounts: sortedAccounts
                        };
                    });
            }, [assets, selectedCategories, sortMode, currencyRates]);

            const toggleCategory = (categoryKey) => {
                setSelectedCategories(prev => {
                    if (prev.includes(categoryKey)) {
                        if (prev.length === 1) return prev;
                        return prev.filter(key => key !== categoryKey);
                    }
                    return [...prev, categoryKey];
                });
            };

            useEffect(() => {
                const keys = [];
                groupedAssets.forEach(group => {
                    group.accounts.forEach(account => {
                        keys.push(`${group.categoryKey}::${account.accountName}`);
                    });
                });

                setExpandedAccounts(prev => {
                    const next = { ...prev };
                    keys.forEach(key => {
                        if (typeof next[key] === 'undefined') next[key] = true;
                    });
                    return next;
                });
            }, [groupedAssets]);

            const toggleAccountExpand = (categoryKey, accountName) => {
                const key = `${categoryKey}::${accountName}`;
                setExpandedAccounts(prev => ({
                    ...prev,
                    [key]: !(prev[key] ?? true)
                }));
            };

            const assetMix = useMemo(() => {
                const rows = Object.keys(CATEGORIES).map(categoryKey => {
                    const valueHKD = Math.abs(totals.categoryBreakdownHKD[categoryKey] || 0);
                    return {
                        categoryKey,
                        label: CATEGORIES[categoryKey].label,
                        valueHKD,
                        amount: fromHKD(valueHKD, displayCurrency),
                        ...CATEGORY_MIX_STYLES[categoryKey]
                    };
                });

                const totalMixHKD = rows.reduce((sum, row) => sum + row.valueHKD, 0);
                const rowsWithRatio = rows.map(row => ({
                    ...row,
                    ratio: totalMixHKD > 0 ? (row.valueHKD / totalMixHKD) * 100 : 0
                })).sort((a, b) => b.valueHKD - a.valueHKD);

                let cumulative = 0;
                const segments = rowsWithRatio
                    .filter(row => row.ratio > 0)
                    .map(row => {
                        const start = cumulative;
                        cumulative += row.ratio;
                        return `${row.hex} ${start}% ${cumulative}%`;
                    });

                return {
                    rows: rowsWithRatio,
                    gradient: segments.length ? `conic-gradient(${segments.join(', ')})` : 'conic-gradient(#E2E8F0 0% 100%)'
                };
            }, [totals.categoryBreakdownHKD, displayCurrency]);

            useEffect(() => {
                const selectedExists = assetMix.rows.some(row => row.categoryKey === selectedMixCategory);
                if (!selectedExists) {
                    const first = assetMix.rows[0]?.categoryKey || 'INVEST';
                    setSelectedMixCategory(first);
                }
            }, [assetMix.rows, selectedMixCategory]);

            const detailMix = useMemo(() => {
                const category = selectedMixCategory;
                const categoryAssets = assets.filter(item => item.category === category);
                const groupMap = {};

                categoryAssets.forEach(item => {
                    const key = category === 'LIQUID'
                        ? (item.currency || 'N/A')
                        : (item.subtype || 'å…¶ä»–');
                    const amountHKD = Math.abs(toHKD(item.quantity * item.currentPrice, item.currency));
                    groupMap[key] = (groupMap[key] || 0) + amountHKD;
                });

                const totalHKD = Object.values(groupMap).reduce((sum, value) => sum + value, 0);
                const palette = ['#3B82F6', '#10B981', '#F59E0B', '#6366F1', '#F43F5E', '#0EA5E9', '#8B5CF6', '#14B8A6'];

                const rows = Object.entries(groupMap)
                    .map(([label, valueHKD], idx) => ({
                        label,
                        valueHKD,
                        amount: fromHKD(valueHKD, displayCurrency),
                        ratio: totalHKD > 0 ? (valueHKD / totalHKD) * 100 : 0,
                        color: palette[idx % palette.length]
                    }))
                    .sort((a, b) => b.valueHKD - a.valueHKD);

                let cumulative = 0;
                const segments = rows
                    .filter(row => row.ratio > 0)
                    .map(row => {
                        const start = cumulative;
                        cumulative += row.ratio;
                        return `${row.color} ${start}% ${cumulative}%`;
                    });

                return {
                    categoryLabel: CATEGORIES[category]?.label || 'ç´°é …',
                    rows,
                    gradient: segments.length ? `conic-gradient(${segments.join(', ')})` : 'conic-gradient(#E2E8F0 0% 100%)'
                };
            }, [assets, selectedMixCategory, displayCurrency, currencyRates]);

            const accountStats = useMemo(() => {
                const category = selectedStatsCategory;
                const categoryAssets = assets.filter(item => item.category === category);

                const accountMap = {};
                categoryAssets.forEach(item => {
                    if (!accountMap[item.account]) accountMap[item.account] = [];
                    accountMap[item.account].push(item);
                });

                const accountNames = Object.keys(accountMap).sort((a, b) => a.localeCompare(b, 'zh-Hant'));
                const currentAccount = accountNames.includes(selectedStatsAccount) ? selectedStatsAccount : (accountNames[0] || '');
                const selectedAssets = statsBreakdownMode === 'ITEM' ? (accountMap[currentAccount] || []) : categoryAssets;

                const grouped = {};
                if (statsBreakdownMode === 'ACCOUNT') {
                    accountNames.forEach(accountName => {
                        const accountItems = accountMap[accountName] || [];
                        const valueDisplay = accountItems.reduce((sum, item) => {
                            return sum + fromHKD(toHKD(item.quantity * item.currentPrice, item.currency), displayCurrency);
                        }, 0);
                        grouped[`ACC:${accountName}`] = {
                            key: `ACC:${accountName}`,
                            label: accountName,
                            subtype: CATEGORIES[category].label,
                            symbol: '',
                            quantity: accountItems.length,
                            valueDisplay,
                            members: accountItems
                        };
                    });
                } else {
                    selectedAssets.forEach(item => {
                        const key = category === 'LIQUID'
                            ? `CUR:${item.currency}`
                            : `ASSET:${item.id}`;

                        if (!grouped[key]) {
                            grouped[key] = {
                                key,
                                label: category === 'LIQUID' ? item.currency : item.name,
                                subtype: item.subtype,
                                symbol: item.symbol,
                                quantity: 0,
                                valueDisplay: 0,
                                members: []
                            };
                        }

                        grouped[key].quantity += Number(item.quantity || 0);
                        grouped[key].valueDisplay += fromHKD(toHKD(item.quantity * item.currentPrice, item.currency), displayCurrency);
                        grouped[key].members.push(item);
                    });
                }

                const items = Object.values(grouped)
                    .map((entry, index) => ({
                        ...entry,
                        color: INVEST_CHART_COLORS[index % INVEST_CHART_COLORS.length]
                    }))
                    .sort((a, b) => b.valueDisplay - a.valueDisplay);

                const total = items.reduce((sum, item) => sum + item.valueDisplay, 0);
                const itemsWithRatio = items.map(item => ({
                    ...item,
                    ratio: total > 0 ? (item.valueDisplay / total) * 100 : 0
                }));

                let currentAngle = 0;
                const segments = itemsWithRatio.map(item => {
                    const segmentAngle = (item.ratio / 100) * 360;
                    const startAngle = currentAngle;
                    const endAngle = currentAngle + segmentAngle;
                    currentAngle = endAngle;
                    return {
                        ...item,
                        startAngle,
                        endAngle
                    };
                });

                const selectedItem = segments.find(item => item.key === selectedStatsSegmentKey) || segments[0] || null;

                return {
                    category,
                    accountNames,
                    currentAccount,
                    total,
                    segments,
                    selectedItem,
                    mode: statsBreakdownMode
                };
            }, [assets, displayCurrency, selectedStatsCategory, selectedStatsAccount, selectedStatsSegmentKey, statsBreakdownMode, currencyRates]);

            const liquidAssetOptions = useMemo(() => {
                return assets
                    .filter(item => item.category === 'LIQUID')
                    .map(item => ({
                        id: item.id,
                        account: item.account,
                        name: item.name,
                        currency: item.currency,
                        label: `${item.account}ï½œ${item.name}ï¼ˆ${item.currency}ï¼‰`
                    }))
                    .sort((a, b) => a.label.localeCompare(b.label, 'zh-Hant', { sensitivity: 'base' }));
            }, [assets]);

            const liquidAssetLabelById = useMemo(() => {
                const map = {};
                liquidAssetOptions.forEach(option => {
                    map[option.id] = option.label;
                });
                return map;
            }, [liquidAssetOptions]);

            const cashflowRulesByLiquidAssetId = useMemo(() => {
                const grouped = {};
                cashflowEntries.forEach(entry => {
                    if (!entry.targetLiquidAssetId) return;
                    if (!grouped[entry.targetLiquidAssetId]) grouped[entry.targetLiquidAssetId] = [];
                    grouped[entry.targetLiquidAssetId].push(entry);
                });
                Object.keys(grouped).forEach(key => {
                    grouped[key].sort((a, b) => a.title.localeCompare(b.title, 'zh-Hant', { sensitivity: 'base' }));
                });
                return grouped;
            }, [cashflowEntries]);

            const cashflowAutoRulesByLiquidAssetId = useMemo(() => {
                const grouped = {};
                cashflowEntries.forEach(entry => {
                    if (!entry.targetLiquidAssetId) return;
                    if (entry.scheduleType === 'ONE_TIME') return;
                    if (!grouped[entry.targetLiquidAssetId]) grouped[entry.targetLiquidAssetId] = [];
                    grouped[entry.targetLiquidAssetId].push(entry);
                });
                Object.keys(grouped).forEach(key => {
                    grouped[key].sort((a, b) => a.title.localeCompare(b.title, 'zh-Hant', { sensitivity: 'base' }));
                });
                return grouped;
            }, [cashflowEntries]);

            const cashflowAccountOptions = useMemo(() => {
                return [...new Set(assets.map(item => (item.account || '').trim()).filter(Boolean))]
                    .sort((a, b) => a.localeCompare(b, 'zh-Hant', { sensitivity: 'base' }));
            }, [assets]);

            const availableCashflowCategories = useMemo(() => {
                return CASHFLOW_CATEGORY_BY_TYPE[cashflowForm.type] || CASHFLOW_CATEGORY_BY_TYPE.EXPENSE;
            }, [cashflowForm.type]);

            const filteredCashflowEntries = useMemo(() => {
                const keyword = (cashflowRuleKeyword || '').trim().toLowerCase();
                const byFilter = cashflowEntries.filter(item => {
                    if (cashflowRuleFilter === 'ALL') return true;
                    if (cashflowRuleFilter === 'AUTO') return item.scheduleType !== 'ONE_TIME';
                    if (cashflowRuleFilter === 'ONE_TIME') return item.scheduleType === 'ONE_TIME';
                    if (cashflowRuleFilter === 'INCOME') return item.type === 'INCOME';
                    if (cashflowRuleFilter === 'EXPENSE') return item.type === 'EXPENSE';
                    return true;
                });

                const byKeyword = keyword
                    ? byFilter.filter(item => {
                        const fullText = [item.title, item.category, item.account, item.note, item.startDate, item.endDate]
                            .filter(Boolean)
                            .join(' ')
                            .toLowerCase();
                        return fullText.includes(keyword);
                    })
                    : byFilter;

                if (cashflowRuleSortMode === 'NEXT_TRIGGER_ASC') {
                    return [...byKeyword].sort((a, b) => {
                        const aNext = findNextOccurrenceDateKey(a, new Date());
                        const bNext = findNextOccurrenceDateKey(b, new Date());
                        if (!aNext && !bNext) return (a.title || '').localeCompare((b.title || ''), 'zh-Hant', { sensitivity: 'base' });
                        if (!aNext) return 1;
                        if (!bNext) return -1;
                        const byNext = aNext.localeCompare(bNext);
                        if (byNext !== 0) return byNext;
                        return (a.title || '').localeCompare((b.title || ''), 'zh-Hant', { sensitivity: 'base' });
                    });
                }

                return [...byKeyword].sort((a, b) => {
                    const byStart = b.startDate.localeCompare(a.startDate);
                    if (byStart !== 0) return byStart;
                    return (a.title || '').localeCompare((b.title || ''), 'zh-Hant', { sensitivity: 'base' });
                });
            }, [cashflowEntries, cashflowRuleFilter, cashflowRuleKeyword, cashflowRuleSortMode]);

            const cashflowTriggerInfoById = useMemo(() => {
                const map = {};
                const today = new Date();
                filteredCashflowEntries.slice(0, cashflowRulesVisibleCount).forEach(entry => {
                    const lastScheduled = findLastOccurrenceDateKey(entry, today);
                    const nextScheduled = findNextOccurrenceDateKey(entry, today);

                    let lastApplied = '';
                    Object.keys(cashflowAppliedPostings).forEach(postingKey => {
                        const posting = cashflowAppliedPostings[postingKey];
                        if (!posting || posting.entryId !== entry.id) return;
                        const dateKey = parseOccurrenceDateFromPostingKey(postingKey);
                        if (!dateKey) return;
                        if (!lastApplied || dateKey > lastApplied) lastApplied = dateKey;
                    });

                    map[entry.id] = {
                        lastDateKey: lastApplied || lastScheduled || '',
                        nextDateKey: nextScheduled || ''
                    };
                });
                return map;
            }, [filteredCashflowEntries, cashflowRulesVisibleCount, cashflowAppliedPostings]);

            useEffect(() => {
                setCashflowRulesVisibleCount(20);
            }, [cashflowRuleFilter, cashflowRuleKeyword, cashflowRuleSortMode]);

            useEffect(() => {
                if (availableCashflowCategories.includes(cashflowForm.category)) return;
                setCashflowForm(prev => ({
                    ...prev,
                    category: getDefaultCashflowCategory(prev.type)
                }));
            }, [availableCashflowCategories, cashflowForm.category]);

            useEffect(() => {
                if (!cashflowForm.targetLiquidAssetId) return;
                if (liquidAssetOptions.some(option => option.id === cashflowForm.targetLiquidAssetId)) return;
                setCashflowForm(prev => ({
                    ...prev,
                    targetLiquidAssetId: ''
                }));
            }, [cashflowForm.targetLiquidAssetId, liquidAssetOptions]);

            useEffect(() => {
                const todayKey = toDateKey(new Date());
                const lastAppliedDate = parseDateKey(cashflowLastAutoApplyDate) || new Date(Date.now() - ONE_DAY_MS);
                const todayDate = parseDateKey(todayKey);
                if (!todayDate) return;

                const targetEntries = cashflowEntries.filter(entry => entry.targetLiquidAssetId);
                if (!targetEntries.length) {
                    setCashflowLastAutoApplyDate(todayKey);
                    return;
                }

                const liquidAssetIndexMap = {};
                assets.forEach((asset, index) => {
                    if (asset.category === 'LIQUID') liquidAssetIndexMap[asset.id] = index;
                });

                const appliedKeySet = new Set(cashflowAppliedOccurrenceKeys);
                const appliedPostingKeySet = new Set(Object.keys(cashflowAppliedPostings));
                const nextAppliedPostings = { ...cashflowAppliedPostings };
                const nextAssets = [...assets];
                let updated = false;
                let appliedCount = 0;

                const shouldReplayFromTomorrow = lastAppliedDate.getTime() < todayDate.getTime();
                const cursor = shouldReplayFromTomorrow
                    ? new Date(lastAppliedDate.getFullYear(), lastAppliedDate.getMonth(), lastAppliedDate.getDate() + 1)
                    : new Date(todayDate.getFullYear(), todayDate.getMonth(), todayDate.getDate());
                while (cursor.getTime() <= todayDate.getTime()) {
                    const currentDate = new Date(cursor.getFullYear(), cursor.getMonth(), cursor.getDate());
                    const dateKey = toDateKey(currentDate);

                    targetEntries.forEach(entry => {
                        if (!isEntryOnDate(entry, currentDate)) return;

                        const targetIndex = liquidAssetIndexMap[entry.targetLiquidAssetId];
                        if (!Number.isInteger(targetIndex)) return;

                        const occurrenceKey = `${entry.id}@${dateKey}@${entry.targetLiquidAssetId}`;
                        if (appliedKeySet.has(occurrenceKey) || appliedPostingKeySet.has(occurrenceKey)) return;

                        const targetAsset = nextAssets[targetIndex];
                        if (!targetAsset || targetAsset.category !== 'LIQUID') return;

                        const amountHKD = toHKD(entry.amount, entry.currency);
                        const amountInTargetCurrency = fromHKD(amountHKD, targetAsset.currency);
                        const signedAmount = entry.type === 'INCOME' ? amountInTargetCurrency : -amountInTargetCurrency;
                        const nextQuantity = Number(targetAsset.quantity || 0) + signedAmount;

                        nextAssets[targetIndex] = {
                            ...targetAsset,
                            quantity: Number(nextQuantity.toFixed(6))
                        };

                        appliedKeySet.add(occurrenceKey);
                        nextAppliedPostings[occurrenceKey] = {
                            entryId: entry.id,
                            targetLiquidAssetId: entry.targetLiquidAssetId,
                            signedAmount: Number(signedAmount.toFixed(6)),
                            targetCurrency: targetAsset.currency,
                            type: entry.type
                        };
                        appliedCount += 1;
                        updated = true;
                    });

                    cursor.setDate(cursor.getDate() + 1);
                }

                if (updated) {
                    setAssets(nextAssets);
                    setCashflowAppliedOccurrenceKeys(Array.from(appliedKeySet));
                    setCashflowAppliedPostings(nextAppliedPostings);
                    setPriceStatus(`å·²è‡ªå‹•å…¥å¸³/æ‰£æ¬¾ ${appliedCount} ç­†ç¾é‡‘æµ`);
                }
                setCashflowLastAutoApplyDate(todayKey);
            }, [assets, cashflowEntries, cashflowAppliedOccurrenceKeys, cashflowAppliedPostings, cashflowLastAutoApplyDate, currencyRates]);

            const selectedCashflowDate = useMemo(() => {
                if (!/^\d{4}-\d{2}$/.test(selectedCashflowMonth || '')) return new Date(new Date().getFullYear(), new Date().getMonth(), 1);
                const [year, month] = selectedCashflowMonth.split('-').map(Number);
                return new Date(year, month - 1, 1);
            }, [selectedCashflowMonth]);

            const cashflowMonthData = useMemo(() => {
                const year = selectedCashflowDate.getFullYear();
                const month = selectedCashflowDate.getMonth();
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const dayRows = [];

                let monthIncomeHKD = 0;
                let monthExpenseHKD = 0;

                for (let day = 1; day <= daysInMonth; day += 1) {
                    const date = new Date(year, month, day);
                    const dateKey = toDateKey(date);
                    const rows = [];
                    let incomeHKD = 0;
                    let expenseHKD = 0;

                    cashflowEntries.forEach(entry => {
                        if (!isEntryOnDate(entry, date)) return;
                        const amountHKD = toHKD(entry.amount, entry.currency);
                        if (entry.type === 'INCOME') incomeHKD += amountHKD;
                        else expenseHKD += amountHKD;

                        rows.push({
                            id: `${entry.id}-${dateKey}`,
                            title: entry.title,
                            account: entry.account,
                            type: entry.type,
                            amountDisplay: fromHKD(amountHKD, displayCurrency),
                            currency: displayCurrency,
                            category: entry.category
                        });
                    });

                    monthIncomeHKD += incomeHKD;
                    monthExpenseHKD += expenseHKD;

                    dayRows.push({
                        dateKey,
                        day,
                        incomeDisplay: fromHKD(incomeHKD, displayCurrency),
                        expenseDisplay: fromHKD(expenseHKD, displayCurrency),
                        netDisplay: fromHKD(incomeHKD - expenseHKD, displayCurrency),
                        entries: rows.sort((a, b) => b.amountDisplay - a.amountDisplay)
                    });
                }

                return {
                    year,
                    month,
                    firstDay,
                    dayRows,
                    monthIncomeDisplay: fromHKD(monthIncomeHKD, displayCurrency),
                    monthExpenseDisplay: fromHKD(monthExpenseHKD, displayCurrency),
                    monthNetDisplay: fromHKD(monthIncomeHKD - monthExpenseHKD, displayCurrency)
                };
            }, [cashflowEntries, selectedCashflowDate, displayCurrency, currencyRates]);

            const cashflowYearData = useMemo(() => {
                const year = selectedCashflowDate.getFullYear();
                const months = [];
                let yearIncomeHKD = 0;
                let yearExpenseHKD = 0;

                for (let month = 0; month < 12; month += 1) {
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    let incomeHKD = 0;
                    let expenseHKD = 0;

                    for (let day = 1; day <= daysInMonth; day += 1) {
                        const date = new Date(year, month, day);
                        cashflowEntries.forEach(entry => {
                            if (!isEntryOnDate(entry, date)) return;
                            const amountHKD = toHKD(entry.amount, entry.currency);
                            if (entry.type === 'INCOME') incomeHKD += amountHKD;
                            else expenseHKD += amountHKD;
                        });
                    }

                    yearIncomeHKD += incomeHKD;
                    yearExpenseHKD += expenseHKD;

                    months.push({
                        month,
                        label: `${month + 1} æœˆ`,
                        incomeDisplay: fromHKD(incomeHKD, displayCurrency),
                        expenseDisplay: fromHKD(expenseHKD, displayCurrency),
                        netDisplay: fromHKD(incomeHKD - expenseHKD, displayCurrency)
                    });
                }

                return {
                    year,
                    months,
                    yearIncomeDisplay: fromHKD(yearIncomeHKD, displayCurrency),
                    yearExpenseDisplay: fromHKD(yearExpenseHKD, displayCurrency),
                    yearNetDisplay: fromHKD(yearIncomeHKD - yearExpenseHKD, displayCurrency)
                };
            }, [cashflowEntries, selectedCashflowDate, displayCurrency, currencyRates]);

            const moveCashflowMonth = (delta) => {
                const next = new Date(cashflowMonthData.year, cashflowMonthData.month + delta, 1);
                setSelectedCashflowMonth(toMonthKey(next));
            };

            const startEditCashflowEntry = (entry) => {
                setEditingCashflowId(entry.id);
                setCashflowForm({
                    title: entry.title || '',
                    account: entry.account || '',
                    category: entry.category || getDefaultCashflowCategory(entry.type || 'EXPENSE'),
                    type: entry.type || 'EXPENSE',
                    scheduleType: entry.scheduleType || (entry.frequency === 'ONE_TIME' ? 'ONE_TIME' : 'RECURRING'),
                    amount: String(Number(entry.amount || 0)),
                    currency: entry.currency || 'HKD',
                    frequency: entry.frequency === 'ONE_TIME' ? 'MONTHLY' : (entry.frequency || 'MONTHLY'),
                    startDate: entry.startDate || toDateKey(new Date()),
                    endDate: entry.endDate || '',
                    payday: String(entry.payday || entry.monthday || 1),
                    targetLiquidAssetId: entry.targetLiquidAssetId || '',
                    note: entry.note || ''
                });
                setFinanceSectionTab('CASHFLOW');
                setPriceStatus('å·²è¼‰å…¥è¦å‰‡ï¼Œå¯ä¿®æ”¹å¾Œå„²å­˜');
                requestAnimationFrame(() => {
                    cashflowFormRef.current?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            };

            const handleCashflowSubmit = (event) => {
                event.preventDefault();
                const title = (cashflowForm.title || '').trim();
                const selectedLiquidAsset = liquidAssetOptions.find(option => option.id === cashflowForm.targetLiquidAssetId) || null;
                const account = selectedLiquidAsset?.account || (cashflowForm.account || '').trim();
                const resolvedCategory = (cashflowForm.category || '').trim();
                const category = resolvedCategory || getDefaultCashflowCategory(cashflowForm.type);
                const note = (cashflowForm.note || '').trim();
                const amount = Number(cashflowForm.amount);
                const startDate = cashflowForm.startDate;
                const endDate = cashflowForm.endDate;
                const scheduleType = cashflowForm.scheduleType || 'RECURRING';
                const frequency = scheduleType === 'ONE_TIME' ? 'ONE_TIME' : cashflowForm.frequency;

                if (!title) {
                    alert('è«‹è¼¸å…¥ç¾é‡‘æµåç¨±');
                    return;
                }
                if (!Number.isFinite(amount) || amount <= 0) {
                    alert('è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡');
                    return;
                }

                const parsedStart = parseDateKey(startDate);
                if (!parsedStart) {
                    alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„é–‹å§‹æ—¥æœŸ');
                    return;
                }

                const parsedEnd = endDate ? parseDateKey(endDate) : null;
                if (scheduleType === 'RECURRING' && endDate && (!parsedEnd || parsedEnd.getTime() < parsedStart.getTime())) {
                    alert('çµæŸæ—¥æœŸä¸å¯æ—©æ–¼é–‹å§‹æ—¥æœŸ');
                    return;
                }

                let weekday = parsedStart.getDay();
                let monthday = parsedStart.getDate();
                let payday = Number(cashflowForm.payday || parsedStart.getDate());

                if (scheduleType === 'RECURRING' && frequency === 'WEEKLY') {
                    weekday = parsedStart.getDay();
                }

                if (scheduleType === 'RECURRING' && frequency === 'MONTHLY') {
                    if (!Number.isInteger(payday) || payday < 1 || payday > 31) {
                        alert('è«‹è¼¸å…¥æœ‰æ•ˆæ¯æœˆè¨˜éŒ„æ—¥ï¼ˆ1-31ï¼‰');
                        return;
                    }
                    monthday = payday;
                }

                const nextEntry = {
                    id: editingCashflowId || `${Date.now()}-${Math.random().toString(16).slice(2)}`,
                    title,
                    account,
                    category,
                    note,
                    type: cashflowForm.type,
                    amount,
                    currency: cashflowForm.currency,
                    scheduleType,
                    frequency,
                    startDate,
                    endDate: scheduleType === 'ONE_TIME' ? '' : (endDate || ''),
                    weekday,
                    monthday,
                    payday: scheduleType === 'RECURRING' && frequency === 'MONTHLY' ? payday : parsedStart.getDate(),
                    targetLiquidAssetId: selectedLiquidAsset?.id || ''
                };

                if (editingCashflowId) {
                    setCashflowEntries(prev => sanitizeCashflowEntries(prev.map(item => item.id === editingCashflowId ? nextEntry : item)));
                } else {
                    setCashflowEntries(prev => sanitizeCashflowEntries([...prev, nextEntry]));
                }
                setCashflowForm(prev => ({
                    ...prev,
                    title: '',
                    amount: '',
                    note: '',
                    targetLiquidAssetId: prev.targetLiquidAssetId || ''
                }));
                setEditingCashflowId('');

                if (selectedLiquidAsset && !editingCashflowId) {
                    const amountHKD = toHKD(amount, cashflowForm.currency);
                    const amountInTargetCurrency = fromHKD(amountHKD, selectedLiquidAsset.currency);
                    const direction = nextEntry.type === 'INCOME' ? 'å…¥å¸³' : 'æ‰£æ¬¾';
                    const todayDate = new Date();
                    const willApplyToday = isEntryOnDate(nextEntry, todayDate);
                    const whenText = willApplyToday ? 'ä»Šå¤©' : 'ä¸‹æ¬¡è§¸ç™¼æ™‚';
                    setPriceStatus(`è¦å‰‡å·²æ–°å¢ï¼ˆé è¦½ï¼‰ï¼š${whenText}å°‡${direction}è‡³ã€Œ${selectedLiquidAsset.label}ã€${formatAmount(amountInTargetCurrency)} ${selectedLiquidAsset.currency}`);
                } else if (!editingCashflowId) {
                    setPriceStatus('è¦å‰‡å·²æ–°å¢ï¼ˆé è¦½ï¼‰ï¼šç›®å‰åƒ…è¨˜éŒ„ç¾é‡‘æµï¼Œä¸æœƒè‡ªå‹•å…¥å¸³/æ‰£æ¬¾');
                } else {
                    setPriceStatus('è¦å‰‡å·²æ›´æ–°');
                }
            };

            const handleDeleteCashflowEntry = (id) => {
                const targetRule = cashflowEntries.find(item => item.id === id);
                const targetPostingKeys = Object.keys(cashflowAppliedPostings).filter(key => cashflowAppliedPostings[key]?.entryId === id);

                const rollbackPreviewLines = [];
                if (targetPostingKeys.length > 0) {
                    const rollbackByAsset = {};
                    targetPostingKeys.forEach(postingKey => {
                        const posting = cashflowAppliedPostings[postingKey];
                        if (!posting) return;
                        const assetId = posting.targetLiquidAssetId || 'UNKNOWN';
                        const currency = posting.targetCurrency || '';
                        const mapKey = `${assetId}::${currency}`;
                        if (!rollbackByAsset[mapKey]) {
                            rollbackByAsset[mapKey] = {
                                assetId,
                                currency,
                                amount: 0
                            };
                        }
                        rollbackByAsset[mapKey].amount += Number(posting.signedAmount || 0);
                    });

                    Object.values(rollbackByAsset).forEach(item => {
                        const label = liquidAssetLabelById[item.assetId] || 'å·²ç¶å®šå¸³æˆ¶';
                        const rollbackAmount = Number(item.amount || 0);
                        rollbackPreviewLines.push(`- ${label}ï¼š${rollbackAmount >= 0 ? '-' : '+'}${formatAmount(Math.abs(rollbackAmount))} ${item.currency}`);
                    });
                }

                const confirmMessage = rollbackPreviewLines.length > 0
                    ? `ç¢ºå®šè¦åˆªé™¤è¦å‰‡ã€Œ${targetRule?.title || 'æœªå‘½åè¦å‰‡'}ã€å—ï¼Ÿ\n\nå°‡åŒæ­¥æ²–éŠ·å·²è‡ªå‹•å…¥å¸³/æ‰£æ¬¾ï¼š\n${rollbackPreviewLines.join('\n')}\n\næ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚`
                    : `ç¢ºå®šè¦åˆªé™¤è¦å‰‡ã€Œ${targetRule?.title || 'æœªå‘½åè¦å‰‡'}ã€å—ï¼Ÿ`;

                if (!confirm(confirmMessage)) return;

                const nextAppliedPostings = { ...cashflowAppliedPostings };
                const nextAppliedKeySet = new Set(cashflowAppliedOccurrenceKeys);

                if (targetRule?.targetLiquidAssetId && targetPostingKeys.length > 0) {
                    const liquidAssetIndexMap = {};
                    assets.forEach((asset, index) => {
                        if (asset.category === 'LIQUID') liquidAssetIndexMap[asset.id] = index;
                    });

                    const nextAssets = [...assets];
                    let revertedCount = 0;

                    targetPostingKeys.forEach(postingKey => {
                        const posting = cashflowAppliedPostings[postingKey];
                        if (!posting) return;
                        const targetIndex = liquidAssetIndexMap[posting.targetLiquidAssetId];
                        if (!Number.isInteger(targetIndex)) return;
                        const targetAsset = nextAssets[targetIndex];
                        if (!targetAsset || targetAsset.category !== 'LIQUID') return;

                        const rollbackQuantity = Number(targetAsset.quantity || 0) - Number(posting.signedAmount || 0);
                        nextAssets[targetIndex] = {
                            ...targetAsset,
                            quantity: Number(rollbackQuantity.toFixed(6))
                        };

                        delete nextAppliedPostings[postingKey];
                        nextAppliedKeySet.delete(postingKey);
                        revertedCount += 1;
                    });

                    setAssets(nextAssets);
                    setCashflowAppliedPostings(nextAppliedPostings);
                    setCashflowAppliedOccurrenceKeys(Array.from(nextAppliedKeySet));
                    setPriceStatus(`è¦å‰‡å·²åˆªé™¤ï¼Œä¸¦å·²æ²–éŠ· ${revertedCount} ç­†å·²å…¥å¸³/æ‰£æ¬¾ç´€éŒ„`);
                } else {
                    if (targetPostingKeys.length > 0) {
                        targetPostingKeys.forEach(postingKey => {
                            delete nextAppliedPostings[postingKey];
                            nextAppliedKeySet.delete(postingKey);
                        });
                        setCashflowAppliedPostings(nextAppliedPostings);
                        setCashflowAppliedOccurrenceKeys(Array.from(nextAppliedKeySet));
                    }
                    setPriceStatus('è¦å‰‡å·²åˆªé™¤');
                }

                setCashflowEntries(prev => prev.filter(item => item.id !== id));
                if (editingCashflowId === id) {
                    setEditingCashflowId('');
                }
            };

            const isCashflowOneTime = cashflowForm.scheduleType === 'ONE_TIME';
            const isCashflowMonthlyRecurring = !isCashflowOneTime && cashflowForm.frequency === 'MONTHLY';

            const refreshCurrencyRates = async (showToast = true) => {
                setIsUpdatingRates(true);
                if (showToast) setPriceStatus('æ›´æ–°åŒ¯ç‡ä¸­...');
                try {
                    const nextRates = await fetchLatestCurrencyRates();
                    setCurrencyRates(nextRates);
                    const stamp = new Date();
                    setLastRateUpdate(stamp);
                    if (showToast) setPriceStatus('å·²æ›´æ–°æœ€æ–°åŒ¯ç‡');
                } catch (error) {
                    if (showToast) setPriceStatus('åŒ¯ç‡æ›´æ–°å¤±æ•—ï¼Œå·²ä½¿ç”¨ç›®å‰åŒ¯ç‡');
                } finally {
                    setIsUpdatingRates(false);
                }
            };

            useEffect(() => {
                if (!CATEGORY_KEYS.includes(selectedStatsCategory)) {
                    setSelectedStatsCategory('INVEST');
                }
            }, [selectedStatsCategory]);

            useEffect(() => {
                if (!accountStats.accountNames.length) {
                    setSelectedStatsAccount('');
                    setSelectedStatsSegmentKey('');
                    return;
                }

                if (!accountStats.accountNames.includes(selectedStatsAccount)) {
                    setSelectedStatsAccount(accountStats.accountNames[0]);
                }

                if (!accountStats.segments.some(item => item.key === selectedStatsSegmentKey)) {
                    setSelectedStatsSegmentKey(accountStats.segments[0]?.key || '');
                }
            }, [accountStats.accountNames, accountStats.segments, selectedStatsAccount, selectedStatsSegmentKey]);

            const updateMarketPrices = async (showToast) => {
                const latestAssets = assetsRef.current;
                const stockTargets = latestAssets.filter(a => a.category === 'INVEST' && ['è‚¡ç¥¨', 'åŸºé‡‘'].includes(a.subtype) && a.symbol);
                const cryptoTargets = latestAssets.filter(a => a.category === 'INVEST' && a.subtype === 'åŠ å¯†è²¨å¹£' && a.symbol);

                if (!stockTargets.length && !cryptoTargets.length) {
                    if (showToast) setPriceStatus('æ²’æœ‰å¯æ›´æ–°çš„è‚¡ç¥¨æˆ–åŠ å¯†è²¨å¹£ä»£è™Ÿ');
                    return;
                }

                setIsUpdatingPrice(true);
                setPriceStatus('æ›´æ–°è¡Œæƒ…ä¸­...');

                const stockSymbolMap = {};
                stockTargets.forEach(item => {
                    stockSymbolMap[item.id] = normalizeYahooSymbol(item.symbol);
                });
                const isValidYahooSymbol = (symbol) => /^[A-Z0-9\.\-]+$/.test(symbol || '');
                const stockSymbols = [...new Set(Object.values(stockSymbolMap))].filter(isValidYahooSymbol);
                const cryptoSymbols = [...new Set(cryptoTargets.map(item => item.symbol.trim().toUpperCase()))];

                const [stockQuotes, cryptoQuotesUSD] = await Promise.all([
                    fetchYahooQuotes(stockSymbols),
                    fetchCryptoQuotes(cryptoSymbols)
                ]);

                let updatedCount = 0;
                setAssets(prev => {
                    let hasChange = false;
                    const next = prev.map(item => {
                        let nextPrice = null;
                        if (item.category === 'INVEST' && ['è‚¡ç¥¨', 'åŸºé‡‘'].includes(item.subtype) && item.symbol) {
                            const normalized = stockSymbolMap[item.id];
                            const quotePrice = stockQuotes[normalized?.toUpperCase()];
                            if (typeof quotePrice === 'number' && quotePrice > 0) nextPrice = quotePrice;
                        }
                        if (item.category === 'INVEST' && item.subtype === 'åŠ å¯†è²¨å¹£' && item.symbol) {
                            const symbol = item.symbol.trim().toUpperCase();
                            const usdPrice = cryptoQuotesUSD[symbol];
                            if (typeof usdPrice === 'number' && usdPrice > 0) {
                                nextPrice = usdPrice * ((currencyRates[item.currency] || 1) / (currencyRates.USD || DEFAULT_RATES.USD));
                            }
                        }

                        if (typeof nextPrice === 'number' && Math.abs(nextPrice - item.currentPrice) > 0.000001) {
                            hasChange = true;
                            updatedCount += 1;
                            return { ...item, currentPrice: Number(nextPrice.toFixed(6)) };
                        }
                        return item;
                    });
                    return hasChange ? next : prev;
                });

                const stamp = new Date();
                setLastPriceUpdate(stamp);
                setIsUpdatingPrice(false);
                setPriceStatus(updatedCount > 0 ? `å·²æ›´æ–° ${updatedCount} ç­†è¡Œæƒ…` : 'è¡Œæƒ…å·²æ˜¯æœ€æ–°æˆ–è³‡æ–™æºæš«ä¸å¯ç”¨');
            };

            const isValidAssetRecord = (item) => {
                if (!item || typeof item !== 'object') return false;
                const hasCategory = typeof item.category === 'string' && CATEGORIES[item.category];
                const hasSubtype = typeof item.subtype === 'string';
                const hasCurrency = typeof item.currency === 'string' && CURRENCIES.includes(item.currency);
                const quantity = Number(item.quantity);
                const costBasis = Number(item.costBasis);
                const currentPrice = Number(item.currentPrice);
                return Boolean(
                    typeof item.id === 'string' && item.id &&
                    typeof item.account === 'string' &&
                    typeof item.name === 'string' &&
                    hasCategory &&
                    hasSubtype &&
                    hasCurrency &&
                    Number.isFinite(quantity) &&
                    Number.isFinite(costBasis) &&
                    Number.isFinite(currentPrice)
                );
            };

            const isValidCashflowRecord = (item) => {
                if (!item || typeof item !== 'object') return false;
                const amount = Number(item.amount);
                const startDate = parseDateKey(item.startDate || '');
                const typeValid = Object.keys(CASHFLOW_TYPES).includes(item.type);
                const scheduleType = item.scheduleType || (item.frequency === 'ONE_TIME' ? 'ONE_TIME' : 'RECURRING');
                const scheduleValid = CASHFLOW_SCHEDULE_TYPES.some(entry => entry.value === scheduleType);
                const freqValid = item.frequency === 'ONE_TIME' || CASHFLOW_FREQUENCIES.some(entry => entry.value === item.frequency);
                return Boolean(
                    typeof item.id === 'string' && item.id &&
                    typeof item.title === 'string' && item.title.trim() &&
                    CURRENCIES.includes(item.currency) &&
                    typeValid &&
                    scheduleValid &&
                    freqValid &&
                    startDate &&
                    Number.isFinite(amount) &&
                    amount > 0
                );
            };

            useEffect(() => {
                if (!isCloudEnabled) {
                    setIsAuthLoading(false);
                    return;
                }

                firebaseAuth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                    .catch(() => {
                        setCloudStatus('ç„¡æ³•å•Ÿç”¨ç™»å…¥æŒä¹…åŒ–ï¼Œè«‹å…è¨±ç¬¬ä¸‰æ–¹ Cookie æˆ–é—œé–‰éš±ç§é˜»æ“‹');
                    });

                firebaseAuth.getRedirectResult()
                    .then(result => {
                        if (result?.user) {
                            setCloudStatus(`å·²ç™»å…¥ Googleï¼ˆ${result.user.email || 'Google å¸³è™Ÿ'}ï¼‰`);
                        }
                    })
                    .catch(error => {
                        const code = error?.code || 'unknown';
                        setCloudStatus(`å°é ç™»å…¥å¤±æ•—ï¼ˆ${code}ï¼‰`);
                    });

                const unsubscribe = firebaseAuth.onAuthStateChanged(async (user) => {
                    setAuthUser(user || null);
                    setIsAuthLoading(false);

                    if (!user) {
                        cloudHydratedRef.current = false;
                        setCloudStatus('å·²ç™»å‡º Googleï¼Œè³‡æ–™åƒ…å­˜åœ¨æ­¤è£ç½®');
                        return;
                    }

                    setIsCloudSyncing(true);
                    setCloudStatus('æ­£åœ¨å¾é›²ç«¯åŒæ­¥è³‡æ–™...');

                    try {
                        const docRef = firebaseDB.collection(CLOUD_COLLECTION).doc(user.uid);
                        const snapshot = await docRef.get();
                        const cloudData = snapshot.exists ? (snapshot.data() || {}) : {};

                        if (Array.isArray(cloudData.assets) && cloudData.assets.every(isValidAssetRecord)) {
                            const nextAssets = cloudData.assets.map(item => ({
                                ...item,
                                quantity: Number(item.quantity),
                                costBasis: Number(item.costBasis),
                                currentPrice: Number(item.currentPrice),
                                symbol: (item.symbol || '').toString().toUpperCase().trim()
                            }));
                            const nextDisplayCurrency = typeof cloudData.displayCurrency === 'string' && CURRENCIES.includes(cloudData.displayCurrency)
                                ? cloudData.displayCurrency
                                : 'HKD';
                            const nextMonthlySnapshots = cloudData.monthlySnapshots && typeof cloudData.monthlySnapshots === 'object' && !Array.isArray(cloudData.monthlySnapshots)
                                ? cloudData.monthlySnapshots
                                : {};
                            const nextCashflowEntries = Array.isArray(cloudData.cashflowEntries) && cloudData.cashflowEntries.every(isValidCashflowRecord)
                                ? sanitizeCashflowEntries(cloudData.cashflowEntries)
                                : [];
                            const nextCashflowAppliedOccurrenceKeys = Array.isArray(cloudData.cashflowAppliedOccurrenceKeys)
                                ? cloudData.cashflowAppliedOccurrenceKeys.filter(item => typeof item === 'string')
                                : [];
                            const nextCashflowAppliedPostings = cloudData.cashflowAppliedPostings && typeof cloudData.cashflowAppliedPostings === 'object' && !Array.isArray(cloudData.cashflowAppliedPostings)
                                ? cloudData.cashflowAppliedPostings
                                : {};
                            const nextCashflowLastAutoApplyDate = normalizeDateKeyOrFallback(
                                cloudData.cashflowLastAutoApplyDate,
                                new Date(Date.now() - ONE_DAY_MS)
                            );

                            setAssets(nextAssets);
                            setDisplayCurrency(nextDisplayCurrency);
                            setMonthlySnapshots(nextMonthlySnapshots);
                            setCashflowEntries(nextCashflowEntries);
                            setCashflowAppliedOccurrenceKeys(nextCashflowAppliedOccurrenceKeys);
                            setCashflowAppliedPostings(nextCashflowAppliedPostings);
                            setCashflowLastAutoApplyDate(nextCashflowLastAutoApplyDate);
                            localStorage.setItem(STORAGE_KEYS.assets, JSON.stringify(nextAssets));
                            localStorage.setItem(STORAGE_KEYS.displayCurrency, JSON.stringify(nextDisplayCurrency));
                            localStorage.setItem(STORAGE_KEYS.monthlySnapshots, JSON.stringify(nextMonthlySnapshots));
                            localStorage.setItem(STORAGE_KEYS.cashflowEntries, JSON.stringify(nextCashflowEntries));
                            localStorage.setItem(STORAGE_KEYS.cashflowAppliedOccurrenceKeys, JSON.stringify(nextCashflowAppliedOccurrenceKeys));
                            localStorage.setItem(STORAGE_KEYS.cashflowAppliedPostings, JSON.stringify(nextCashflowAppliedPostings));
                            localStorage.setItem(STORAGE_KEYS.cashflowLastAutoApplyDate, JSON.stringify(nextCashflowLastAutoApplyDate));
                            setCloudStatus(`å·²åŒæ­¥é›²ç«¯è³‡æ–™ï¼ˆ${user.email || 'Google å¸³è™Ÿ'}ï¼‰`);
                        } else {
                            await docRef.set({
                                assets: assetsRef.current,
                                displayCurrency: displayCurrencyRef.current,
                                monthlySnapshots: monthlySnapshotsRef.current,
                                cashflowEntries: cashflowEntriesRef.current,
                                cashflowAppliedOccurrenceKeys,
                                cashflowAppliedPostings,
                                cashflowLastAutoApplyDate,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                email: user.email || ''
                            }, { merge: true });
                            setCloudStatus(`å·²å»ºç«‹é›²ç«¯å­˜æª”ï¼ˆ${user.email || 'Google å¸³è™Ÿ'}ï¼‰`);
                        }
                    } catch (error) {
                        setCloudStatus('é›²ç«¯åŒæ­¥å¤±æ•—ï¼Œå·²æ”¹ç”¨æœ¬æ©Ÿè³‡æ–™');
                    } finally {
                        cloudHydratedRef.current = true;
                        setIsCloudSyncing(false);
                    }
                });

                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!isCloudEnabled || !authUser || isAuthLoading || !cloudHydratedRef.current) return;

                if (cloudSaveTimerRef.current) clearTimeout(cloudSaveTimerRef.current);
                cloudSaveTimerRef.current = setTimeout(async () => {
                    setIsCloudSyncing(true);
                    try {
                        await firebaseDB.collection(CLOUD_COLLECTION).doc(authUser.uid).set({
                            assets,
                            displayCurrency,
                            monthlySnapshots,
                            cashflowEntries,
                            cashflowAppliedOccurrenceKeys,
                            cashflowAppliedPostings,
                            cashflowLastAutoApplyDate,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            email: authUser.email || ''
                        }, { merge: true });
                        setCloudStatus(`é›²ç«¯å·²åŒæ­¥ï¼š${new Date().toLocaleTimeString()}`);
                    } catch (error) {
                        setCloudStatus('é›²ç«¯å„²å­˜å¤±æ•—ï¼Œè³‡æ–™ä»ä¿ç•™åœ¨æœ¬æ©Ÿ');
                    } finally {
                        setIsCloudSyncing(false);
                    }
                }, 800);

                return () => {
                    if (cloudSaveTimerRef.current) clearTimeout(cloudSaveTimerRef.current);
                };
            }, [assets, displayCurrency, monthlySnapshots, cashflowEntries, cashflowAppliedOccurrenceKeys, cashflowAppliedPostings, cashflowLastAutoApplyDate, authUser, isAuthLoading]);

            const handleGoogleLogin = async () => {
                if (!isCloudEnabled) {
                    setCloudStatus('å°šæœªè¨­å®š Firebaseï¼Œè«‹å…ˆåœ¨ index.html å¡«å…¥ Firebase è¨­å®š');
                    return;
                }
                try {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    await firebaseAuth.signInWithPopup(provider);
                } catch (error) {
                    const code = error?.code || '';
                    if (code === 'auth/popup-blocked' || code === 'auth/popup-closed-by-user' || code === 'auth/cancelled-popup-request') {
                        try {
                            const provider = new firebase.auth.GoogleAuthProvider();
                            setCloudStatus('Popup å—é™ï¼Œæ”¹ç”¨å°é ç™»å…¥ä¸­...');
                            await firebaseAuth.signInWithRedirect(provider);
                            return;
                        } catch (redirectError) {
                            const redirectCode = redirectError?.code || 'unknown';
                            setCloudStatus(`Google ç™»å…¥å¤±æ•—ï¼ˆ${redirectCode}ï¼‰`);
                            return;
                        }
                    }

                    if (code === 'auth/unauthorized-domain') {
                        setCloudStatus('ç¶²åŸŸæœªæˆæ¬Šï¼šè«‹åˆ° Firebase Auth åŠ å…¥ localhostã€127.0.0.1ã€ivankaiwck.github.io');
                        return;
                    }

                    setCloudStatus(`Google ç™»å…¥å¤±æ•—ï¼ˆ${code || 'unknown'}ï¼‰`);
                }
            };

            const handleGoogleLogout = async () => {
                if (!isCloudEnabled) return;
                try {
                    await firebaseAuth.signOut();
                } catch (error) {
                    setCloudStatus('ç™»å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                }
            };

            const handleExportData = () => {
                try {
                    const payload = {
                        version: 1,
                        exportedAt: new Date().toISOString(),
                        data: {
                            assets,
                            displayCurrency,
                            monthlySnapshots,
                            cashflowEntries,
                            cashflowAppliedOccurrenceKeys,
                            cashflowAppliedPostings,
                            cashflowLastAutoApplyDate
                        }
                    };
                    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const fileName = `asset-tracker-backup-${new Date().toISOString().slice(0, 10)}.json`;
                    const anchor = document.createElement('a');
                    anchor.href = url;
                    anchor.download = fileName;
                    document.body.appendChild(anchor);
                    anchor.click();
                    anchor.remove();
                    URL.revokeObjectURL(url);
                    setPriceStatus('è³‡æ–™å·²æˆåŠŸåŒ¯å‡º');
                } catch (error) {
                    setPriceStatus('åŒ¯å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                }
            };

            const openImportPicker = () => {
                importInputRef.current?.click();
            };

            const handleShareApp = async () => {
                if (isGeneratingPdf) {
                    setPriceStatus('PDF ä»åœ¨ç”¢ç”Ÿä¸­ï¼Œè«‹ç¨å€™...');
                    return;
                }
                let reportRoot = null;
                let watchdogTimer = null;
                try {
                    setIsGeneratingPdf(true);
                    setPriceStatus('æ­£åœ¨æº–å‚™ PDF...');

                    watchdogTimer = setTimeout(() => {
                        setIsGeneratingPdf(false);
                        setPriceStatus('PDF ç”¢ç”Ÿé€¾æ™‚ï¼Œè«‹å†è©¦ä¸€æ¬¡');
                    }, 20000);

                    const jsPDF = await ensureJsPdfReady();
                    const html2canvas = await ensureHtml2CanvasReady();
                    setPriceStatus('æ­£åœ¨è½‰æ›å…§å®¹ç‚º PDF...');

                    reportRoot = document.createElement('div');
                    reportRoot.style.position = 'fixed';
                    reportRoot.style.left = '0';
                    reportRoot.style.top = '0';
                    reportRoot.style.width = '1024px';
                    reportRoot.style.background = '#ffffff';
                    reportRoot.style.color = '#0f172a';
                    reportRoot.style.padding = '24px';
                    reportRoot.style.fontFamily = "'Noto Sans TC', sans-serif";
                    reportRoot.style.opacity = '1';
                    reportRoot.style.pointerEvents = 'none';
                    reportRoot.style.zIndex = '99999';

                    const title = document.createElement('h1');
                    title.textContent = 'å€‹äººè³‡ç”¢åˆ†äº«å ±è¡¨';
                    title.style.fontSize = '24px';
                    title.style.fontWeight = '800';
                    title.style.margin = '0 0 8px 0';
                    reportRoot.appendChild(title);

                    const meta = document.createElement('div');
                    meta.textContent = `ç”¢ç”Ÿæ™‚é–“ï¼š${new Date().toLocaleString()} ï½œ é¡¯ç¤ºå¹£ç¨®ï¼š${displayCurrency}`;
                    meta.style.fontSize = '12px';
                    meta.style.color = '#475569';
                    meta.style.marginBottom = '16px';
                    reportRoot.appendChild(meta);

                    const summaryWrap = document.createElement('div');
                    summaryWrap.style.display = 'flex';
                    summaryWrap.style.gap = '18px';
                    summaryWrap.style.alignItems = 'flex-start';
                    summaryWrap.style.marginBottom = '14px';

                    const summary = document.createElement('div');
                    summary.style.flex = '1';
                    summary.style.fontSize = '12px';
                    summary.style.lineHeight = '1.7';
                    summary.innerHTML = [
                        `ç¸½è³‡ç”¢ï¼š${formatAmount(totals.assets)} ${displayCurrency}`,
                        `ç¸½è² å‚µï¼š${formatAmount(totals.liabilities)} ${displayCurrency}`,
                        `æ·¨è³‡ç”¢ï¼š${formatAmount(totals.netWorth)} ${displayCurrency}`,
                        `è² å‚µæ¯”ï¼š${totals.debtRatio.toFixed(2)}%`,
                        `è³‡ç”¢ç­†æ•¸ï¼š${assets.length} ç­†`
                    ].map(line => `<div>${line}</div>`).join('');
                    summaryWrap.appendChild(summary);

                    const chartCard = document.createElement('div');
                    chartCard.style.width = '300px';
                    chartCard.style.padding = '10px';
                    chartCard.style.border = '1px solid #e2e8f0';
                    chartCard.style.borderRadius = '10px';
                    chartCard.style.background = '#f8fafc';

                    const chartTitle = document.createElement('div');
                    chartTitle.textContent = 'è³‡ç”¢é…æ¯”';
                    chartTitle.style.fontSize = '12px';
                    chartTitle.style.fontWeight = '700';
                    chartTitle.style.marginBottom = '8px';
                    chartCard.appendChild(chartTitle);

                    const chartWrap = document.createElement('div');
                    chartWrap.style.display = 'flex';
                    chartWrap.style.alignItems = 'center';
                    chartWrap.style.gap = '10px';

                    const donut = document.createElement('div');
                    donut.style.width = '96px';
                    donut.style.height = '96px';
                    donut.style.borderRadius = '999px';
                    donut.style.flexShrink = '0';
                    donut.style.position = 'relative';
                    donut.style.background = assetMix.gradient;
                    const donutHole = document.createElement('div');
                    donutHole.style.position = 'absolute';
                    donutHole.style.inset = '22px';
                    donutHole.style.borderRadius = '999px';
                    donutHole.style.background = '#ffffff';
                    donut.appendChild(donutHole);
                    chartWrap.appendChild(donut);

                    const legend = document.createElement('div');
                    legend.style.flex = '1';
                    legend.style.display = 'grid';
                    legend.style.gap = '4px';
                    assetMix.rows
                        .filter(row => row.ratio > 0)
                        .slice(0, 6)
                        .forEach(row => {
                            const item = document.createElement('div');
                            item.style.display = 'flex';
                            item.style.alignItems = 'center';
                            item.style.justifyContent = 'space-between';
                            item.style.fontSize = '10px';

                            const left = document.createElement('div');
                            left.style.display = 'flex';
                            left.style.alignItems = 'center';
                            left.style.gap = '5px';
                            const dot = document.createElement('span');
                            dot.style.width = '8px';
                            dot.style.height = '8px';
                            dot.style.borderRadius = '999px';
                            dot.style.background = row.hex;
                            const label = document.createElement('span');
                            label.textContent = row.label;
                            left.appendChild(dot);
                            left.appendChild(label);

                            const value = document.createElement('span');
                            value.textContent = `${row.ratio.toFixed(1)}%`;

                            item.appendChild(left);
                            item.appendChild(value);
                            legend.appendChild(item);
                        });

                    chartWrap.appendChild(legend);
                    chartCard.appendChild(chartWrap);
                    summaryWrap.appendChild(chartCard);
                    reportRoot.appendChild(summaryWrap);

                    const createSectionTitle = (text) => {
                        const el = document.createElement('h2');
                        el.textContent = text;
                        el.style.fontSize = '14px';
                        el.style.fontWeight = '700';
                        el.style.margin = '16px 0 8px 0';
                        return el;
                    };

                    const createTable = (headers) => {
                        const tableEl = document.createElement('table');
                        tableEl.style.width = '100%';
                        tableEl.style.borderCollapse = 'collapse';
                        tableEl.style.fontSize = '11px';

                        const headerRow = document.createElement('tr');
                        headers.forEach(text => {
                            const th = document.createElement('th');
                            th.textContent = text;
                            th.style.border = '1px solid #cbd5e1';
                            th.style.background = '#f1f5f9';
                            th.style.padding = '6px 8px';
                            th.style.textAlign = ['#', 'ç­†æ•¸', 'é …ç›®æ•¸', 'ç¸½å¸‚å€¼', 'å¸‚å€¼'].includes(text) ? 'right' : 'left';
                            headerRow.appendChild(th);
                        });
                        tableEl.appendChild(headerRow);
                        return tableEl;
                    };

                    reportRoot.appendChild(createSectionTitle('æŒ‰å¸³æˆ¶åŒ¯ç¸½'));
                    const accountSummaryTable = createTable(['é¡åˆ¥', 'å¸³æˆ¶', 'ç­†æ•¸', 'ç¸½å¸‚å€¼']);
                    groupedAssets.forEach(group => {
                        group.accounts.forEach(account => {
                            const row = document.createElement('tr');
                            const valueDisplay = fromHKD(account.accountTotalHKD, displayCurrency);
                            const cells = [
                                CATEGORIES[group.categoryKey]?.label || group.categoryKey,
                                account.accountName,
                                String(account.items.length),
                                `${formatAmount(valueDisplay)} ${displayCurrency}`
                            ];
                            cells.forEach((value, idx) => {
                                const td = document.createElement('td');
                                td.textContent = value;
                                td.style.border = '1px solid #cbd5e1';
                                td.style.padding = '6px 8px';
                                td.style.textAlign = idx >= 2 ? 'right' : 'left';
                                row.appendChild(td);
                            });
                            accountSummaryTable.appendChild(row);
                        });
                    });
                    reportRoot.appendChild(accountSummaryTable);

                    reportRoot.appendChild(createSectionTitle('è³‡ç”¢æ˜ç´°'));

                    const table = document.createElement('table');
                    table.style.width = '100%';
                    table.style.borderCollapse = 'collapse';
                    table.style.fontSize = '11px';

                    const headRow = document.createElement('tr');
                    ['#', 'é¡åˆ¥', 'ç´°é …', 'å¸³æˆ¶', 'åç¨±', 'å¹£ç¨®', 'å¸‚å€¼'].forEach(text => {
                        const th = document.createElement('th');
                        th.textContent = text;
                        th.style.border = '1px solid #cbd5e1';
                        th.style.background = '#f1f5f9';
                        th.style.padding = '6px 8px';
                        th.style.textAlign = ['#', 'å¸‚å€¼'].includes(text) ? 'right' : 'left';
                        headRow.appendChild(th);
                    });
                    table.appendChild(headRow);

                    assets.forEach((item, index) => {
                        const row = document.createElement('tr');
                        const marketValueOrig = Number(item.quantity || 0) * Number(item.currentPrice || 0);
                        const marketValueDisplay = fromHKD(toHKD(marketValueOrig, item.currency), displayCurrency);
                        const cells = [
                            String(index + 1),
                            CATEGORIES[item.category]?.label || item.category,
                            item.subtype || '',
                            item.account || '',
                            item.name || '',
                            item.currency || '',
                            `${formatAmount(marketValueDisplay)} ${displayCurrency}`
                        ];
                        cells.forEach((value, i) => {
                            const td = document.createElement('td');
                            td.textContent = value;
                            td.style.border = '1px solid #cbd5e1';
                            td.style.padding = '6px 8px';
                            td.style.textAlign = (i === 0 || i === 6) ? 'right' : 'left';
                            row.appendChild(td);
                        });
                        table.appendChild(row);
                    });

                    reportRoot.appendChild(table);
                    document.body.appendChild(reportRoot);

                    await new Promise(resolve => requestAnimationFrame(() => requestAnimationFrame(resolve)));
                    const canvas = await html2canvas(reportRoot, {
                        scale: 2,
                        useCORS: true,
                        backgroundColor: '#ffffff'
                    });

                    const imgData = canvas.toDataURL('image/jpeg', 0.98);
                    const doc = new jsPDF({ unit: 'mm', format: 'a4', orientation: 'portrait' });
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    const margin = 8;
                    const contentWidth = pageWidth - margin * 2;
                    const contentHeight = pageHeight - margin * 2;
                    const imageHeight = (canvas.height * contentWidth) / canvas.width;

                    let rendered = 0;
                    while (rendered < imageHeight) {
                        if (rendered > 0) doc.addPage();
                        const y = margin - rendered;
                        doc.addImage(imgData, 'JPEG', margin, y, contentWidth, imageHeight, undefined, 'FAST');
                        rendered += contentHeight;
                    }

                    const fileName = `asset-report-${new Date().toISOString().slice(0, 10)}.pdf`;
                    const pdfBlob = doc.output('blob');
                    const downloadUrl = URL.createObjectURL(pdfBlob);
                    const anchor = document.createElement('a');
                    anchor.href = downloadUrl;
                    anchor.download = fileName;
                    document.body.appendChild(anchor);
                    anchor.click();
                    anchor.remove();
                    URL.revokeObjectURL(downloadUrl);

                    setPriceStatus('PDF å·²æˆåŠŸä¸‹è¼‰');
                } catch (error) {
                    setPriceStatus(`åˆ†äº« PDF å¤±æ•—ï¼š${error?.message || 'è«‹ç¨å¾Œå†è©¦'}`);
                } finally {
                    if (watchdogTimer) clearTimeout(watchdogTimer);
                    setIsGeneratingPdf(false);
                    if (reportRoot && reportRoot.parentNode) {
                        reportRoot.parentNode.removeChild(reportRoot);
                    }
                }
            };

            const handleImportData = async (event) => {
                const file = event.target.files?.[0];
                if (!file) return;

                try {
                    const text = await file.text();
                    const parsed = JSON.parse(text);
                    const imported = parsed?.data || parsed;
                    const nextAssets = Array.isArray(imported?.assets) ? imported.assets : null;
                    const nextDisplayCurrency = typeof imported?.displayCurrency === 'string' ? imported.displayCurrency : null;
                    const nextMonthlySnapshots = imported?.monthlySnapshots && typeof imported.monthlySnapshots === 'object'
                        ? imported.monthlySnapshots
                        : null;
                    const nextCashflowEntries = Array.isArray(imported?.cashflowEntries)
                        ? sanitizeCashflowEntries(imported.cashflowEntries)
                        : [];
                    const nextCashflowAppliedOccurrenceKeys = Array.isArray(imported?.cashflowAppliedOccurrenceKeys)
                        ? imported.cashflowAppliedOccurrenceKeys.filter(item => typeof item === 'string')
                        : [];
                    const nextCashflowAppliedPostings = imported?.cashflowAppliedPostings && typeof imported.cashflowAppliedPostings === 'object' && !Array.isArray(imported.cashflowAppliedPostings)
                        ? imported.cashflowAppliedPostings
                        : {};
                    const nextCashflowLastAutoApplyDate = normalizeDateKeyOrFallback(
                        imported?.cashflowLastAutoApplyDate,
                        new Date(Date.now() - ONE_DAY_MS)
                    );

                    if (!nextAssets || !nextAssets.every(isValidAssetRecord)) {
                        throw new Error('invalid assets format');
                    }

                    if (!nextDisplayCurrency || !CURRENCIES.includes(nextDisplayCurrency)) {
                        throw new Error('invalid display currency');
                    }

                    const safeSnapshots = nextMonthlySnapshots && !Array.isArray(nextMonthlySnapshots) ? nextMonthlySnapshots : {};

                    setAssets(nextAssets.map(item => ({
                        ...item,
                        quantity: Number(item.quantity),
                        costBasis: Number(item.costBasis),
                        currentPrice: Number(item.currentPrice),
                        symbol: (item.symbol || '').toString().toUpperCase().trim()
                    })));
                    setDisplayCurrency(nextDisplayCurrency);
                    setMonthlySnapshots(safeSnapshots);
                    setCashflowEntries(nextCashflowEntries);
                    setCashflowAppliedOccurrenceKeys(nextCashflowAppliedOccurrenceKeys);
                    setCashflowAppliedPostings(nextCashflowAppliedPostings);
                    setCashflowLastAutoApplyDate(nextCashflowLastAutoApplyDate);
                    localStorage.setItem(STORAGE_KEYS.monthlySnapshots, JSON.stringify(safeSnapshots));
                    localStorage.setItem(STORAGE_KEYS.cashflowEntries, JSON.stringify(nextCashflowEntries));
                    localStorage.setItem(STORAGE_KEYS.cashflowAppliedOccurrenceKeys, JSON.stringify(nextCashflowAppliedOccurrenceKeys));
                    localStorage.setItem(STORAGE_KEYS.cashflowAppliedPostings, JSON.stringify(nextCashflowAppliedPostings));
                    localStorage.setItem(STORAGE_KEYS.cashflowLastAutoApplyDate, JSON.stringify(nextCashflowLastAutoApplyDate));
                    setPriceStatus(`åŒ¯å…¥æˆåŠŸï¼š${nextAssets.length} ç­†è³‡ç”¢è³‡æ–™`);
                } catch (error) {
                    setPriceStatus('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼ä¸æ­£ç¢º');
                } finally {
                    event.target.value = '';
                }
            };

            // é‡è¨­ç‚ºç¯„ä¾‹è³‡æ–™ï¼ˆæœƒè¦†è“‹ localStorageï¼‰
            const resetToSeed = () => {
                if (!confirm('ç¢ºå®šè¦é‡è¨­ç‚ºç¯„ä¾‹è³‡æ–™ï¼Ÿæ­¤å‹•ä½œæœƒè¦†è“‹æœ¬åœ°å„²å­˜çš„è³‡æ–™ã€‚')) return;
                const normalized = seedAssets.map(item => ({
                    ...item,
                    quantity: Number(item.quantity || 0),
                    costBasis: Number(item.costBasis || 0),
                    currentPrice: Number(item.currentPrice || 0),
                    symbol: (item.symbol || '').toString().toUpperCase().trim()
                }));

                setAssets(normalized);
                setDisplayCurrency('HKD');
                setMonthlySnapshots({});
                setCashflowEntries([]);
                setCashflowAppliedOccurrenceKeys([]);
                setCashflowAppliedPostings({});
                setCashflowLastAutoApplyDate(toDateKey(new Date(Date.now() - ONE_DAY_MS)));

                // åŒæ­¥å¯«å…¥ localStorageï¼ˆuseEffect ä¹Ÿæœƒåœ¨ state è®Šæ›´æ™‚è¦†å¯«ï¼Œä½†é€™è£¡å…ˆå¯«ä»¥ç¢ºä¿ç«‹å³ä¸€è‡´ï¼‰
                try {
                    localStorage.setItem(STORAGE_KEYS.assets, JSON.stringify(normalized));
                    localStorage.setItem(STORAGE_KEYS.displayCurrency, JSON.stringify('HKD'));
                    localStorage.setItem(STORAGE_KEYS.monthlySnapshots, JSON.stringify({}));
                    localStorage.setItem(STORAGE_KEYS.cashflowEntries, JSON.stringify([]));
                    localStorage.setItem(STORAGE_KEYS.cashflowAppliedOccurrenceKeys, JSON.stringify([]));
                    localStorage.setItem(STORAGE_KEYS.cashflowAppliedPostings, JSON.stringify({}));
                    localStorage.setItem(STORAGE_KEYS.cashflowLastAutoApplyDate, JSON.stringify(toDateKey(new Date(Date.now() - ONE_DAY_MS))));
                } catch (e) {
                    // å¿½ç•¥ storage éŒ¯èª¤
                }

                setPriceStatus('å·²é‡è¨­ç‚ºç¯„ä¾‹è³‡æ–™');
            };

            useEffect(() => {
                updateMarketPrices(false);
                refreshCurrencyRates(false);
                const timer = setInterval(() => updateMarketPrices(false), 5 * 60 * 1000);
                const rateTimer = setInterval(() => refreshCurrencyRates(false), 30 * 60 * 1000);
                return () => {
                    clearInterval(timer);
                    clearInterval(rateTimer);
                };
            }, []);

            const openEdit = (asset) => {
                setEditingId(asset.id);
                setFormData({
                    ...asset,
                    premiumAmount: asset.premiumAmount ?? '',
                    premiumFrequency: asset.premiumFrequency ?? 'monthly',
                    premiumPaidCount: asset.premiumPaidCount ?? '',
                    propertyPrice: asset.propertyPrice ?? '',
                    ltvRatio: asset.ltvRatio ?? '',
                    annualInterestRate: asset.annualInterestRate ?? '',
                    mortgageYears: asset.mortgageYears ?? '',
                    paidPeriods: asset.paidPeriods ?? '',
                    loanPrincipal: asset.loanPrincipal ?? '',
                    loanYears: asset.loanYears ?? '',
                    loanPaidPeriods: asset.loanPaidPeriods ?? '',
                    loanAnnualInterestRate: asset.loanAnnualInterestRate ?? '',
                    creditCardBalance: asset.creditCardBalance ?? '',
                    creditCardMinPayment: asset.creditCardMinPayment ?? '',
                    creditCardDueDate: asset.creditCardDueDate ?? '',
                    creditCardAnnualRate: asset.creditCardAnnualRate ?? '',
                    payableAmount: asset.payableAmount ?? '',
                    payableDueDate: asset.payableDueDate ?? '',
                    payableInstallments: asset.payableInstallments ?? '',
                    otherOutstanding: asset.otherOutstanding ?? '',
                    otherAnnualRate: asset.otherAnnualRate ?? '',
                    otherDueDate: asset.otherDueDate ?? '',
                    receivableAmount: asset.receivableAmount ?? '',
                    receivableDueDate: asset.receivableDueDate ?? '',
                    receivableInstallments: asset.receivableInstallments ?? '',
                    receivableParty: asset.receivableParty ?? '',
                    fixedPurchasePrice: asset.fixedPurchasePrice ?? '',
                    fixedCurrentValue: asset.fixedCurrentValue ?? '',
                    fixedPurchaseDate: asset.fixedPurchaseDate ?? '',
                    fixedNote: asset.fixedNote ?? '',
                    fixedDepositPrincipal: asset.fixedDepositPrincipal ?? '',
                    fixedDepositAnnualRate: asset.fixedDepositAnnualRate ?? '',
                    fixedDepositMonths: asset.fixedDepositMonths ?? '',
                    fixedDepositStartDate: asset.fixedDepositStartDate ?? ''
                });
                setIsModalOpen(true);
            };

            const handleDelete = (id) => {
                if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è³‡ç”¢å—ï¼Ÿ')) {
                    setAssets(assets.filter(a => a.id !== id));
                    setIsModalOpen(false);
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                const baseCurrency = formData.currency || 'HKD';
                const resolvedName = isLiquidForm
                    ? ((editingId && (formData.name || '').trim()) || `${baseCurrency} ${formData.subtype}`)
                    : (formData.name || '').trim();
                const needsSymbol = isCryptoForm || isStockForm || isFundForm;

                let quantity = parseFloat(formData.quantity || 0);
                let costBasis = parseFloat(formData.costBasis || 0);
                let currentPrice = editingId ? parseFloat(formData.currentPrice || formData.costBasis || 0) : costBasis;

                if (isLiquidForm) {
                    quantity = parseFloat(formData.quantity || 0);
                    costBasis = 1;
                    currentPrice = 1;
                }

                let fixedDepositPayload = {};
                if (isFixedDepositForm) {
                    if (!fixedDepositMetrics) {
                        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„å®šæœŸå­˜æ¬¾è³‡æ–™ï¼ˆæœ¬é‡‘ã€å¹´åˆ©ç‡ã€æœŸæ•¸ï¼‰');
                        return;
                    }
                    quantity = 1;
                    costBasis = fixedDepositMetrics.principal;
                    currentPrice = fixedDepositMetrics.maturityAmount;
                    fixedDepositPayload = {
                        fixedDepositPrincipal: fixedDepositMetrics.principal,
                        fixedDepositAnnualRate: fixedDepositMetrics.annualInterestRate,
                        fixedDepositMonths: fixedDepositMetrics.months,
                        fixedDepositStartDate: formData.fixedDepositStartDate || '',
                        fixedDepositInterestAmount: fixedDepositMetrics.interestAmount,
                        fixedDepositMaturityAmount: fixedDepositMetrics.maturityAmount
                    };
                }

                if (needsPremium) {
                    const totalPremium = (Number(formData.premiumAmount) || 0) * (Number(formData.premiumPaidCount) || 0);
                    quantity = 1;
                    costBasis = totalPremium;
                    currentPrice = totalPremium;
                }

                let mortgagePayload = {};
                if (isMortgageForm) {
                    if (!mortgageMetrics) {
                        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æˆ¿è²¸è³‡æ–™ï¼ˆæ¨“åƒ¹ã€æŒ‰æ­æˆæ•¸ã€å¹´æ¯ã€é‚„æ¬¾å¹´é™ï¼‰');
                        return;
                    }
                    quantity = 1;
                    costBasis = mortgageMetrics.loanAmount;
                    currentPrice = mortgageMetrics.outstandingPrincipal;
                    mortgagePayload = {
                        propertyPrice: mortgageMetrics.propertyPrice,
                        ltvRatio: mortgageMetrics.ltvRatio,
                        annualInterestRate: mortgageMetrics.annualInterestRate,
                        mortgageYears: mortgageMetrics.mortgageYears,
                        paidPeriods: mortgageMetrics.paidPeriods,
                        totalPeriods: mortgageMetrics.totalPeriods,
                        remainingPeriods: mortgageMetrics.remainingPeriods,
                        downPayment: mortgageMetrics.downPayment,
                        loanAmount: mortgageMetrics.loanAmount,
                        totalInterest: mortgageMetrics.totalInterest,
                        monthlyPayment: mortgageMetrics.monthlyPayment,
                        outstandingPrincipal: mortgageMetrics.outstandingPrincipal
                    };
                }

                let loanPayload = {};
                if (isLoanForm) {
                    if (!loanMetrics) {
                        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„è²¸æ¬¾è³‡æ–™ï¼ˆè²¸æ¬¾æœ¬é‡‘ã€å¹´æ¯ã€é‚„æ¬¾å¹´é™ï¼‰');
                        return;
                    }
                    quantity = 1;
                    costBasis = loanMetrics.loanPrincipal;
                    currentPrice = loanMetrics.outstandingPrincipal;
                    loanPayload = {
                        loanPrincipal: loanMetrics.loanPrincipal,
                        loanAnnualInterestRate: loanMetrics.annualInterestRate,
                        loanYears: loanMetrics.loanYears,
                        loanPaidPeriods: loanMetrics.paidPeriods,
                        loanTotalPeriods: loanMetrics.totalPeriods,
                        loanRemainingPeriods: loanMetrics.remainingPeriods,
                        loanTotalInterest: loanMetrics.totalInterest,
                        loanMonthlyPayment: loanMetrics.monthlyPayment,
                        loanOutstandingPrincipal: loanMetrics.outstandingPrincipal
                    };
                }

                let creditCardPayload = {};
                if (isCreditCardForm) {
                    const balance = Number(formData.creditCardBalance) || 0;
                    if (balance <= 0) {
                        alert('è«‹è¼¸å…¥ä¿¡ç”¨å¡æœ¬æœŸçµæ¬ ');
                        return;
                    }
                    quantity = 1;
                    costBasis = balance;
                    currentPrice = balance;
                    creditCardPayload = {
                        creditCardBalance: balance,
                        creditCardMinPayment: Number(formData.creditCardMinPayment) || 0,
                        creditCardDueDate: formData.creditCardDueDate || '',
                        creditCardAnnualRate: Number(formData.creditCardAnnualRate) || 0
                    };
                }

                let payablePayload = {};
                if (isPayableForm) {
                    const amount = Number(formData.payableAmount) || 0;
                    if (amount <= 0) {
                        alert('è«‹è¼¸å…¥æ‡‰ä»˜æ¬¾é‡‘é¡');
                        return;
                    }
                    quantity = 1;
                    costBasis = amount;
                    currentPrice = amount;
                    payablePayload = {
                        payableAmount: amount,
                        payableDueDate: formData.payableDueDate || '',
                        payableInstallments: Number(formData.payableInstallments) || 0
                    };
                }

                let otherLiabilityPayload = {};
                if (isOtherLiabilityForm) {
                    const outstanding = Number(formData.otherOutstanding) || 0;
                    if (outstanding <= 0) {
                        alert('è«‹è¼¸å…¥æœªå„Ÿé‡‘é¡');
                        return;
                    }
                    quantity = 1;
                    costBasis = outstanding;
                    currentPrice = outstanding;
                    otherLiabilityPayload = {
                        otherOutstanding: outstanding,
                        otherAnnualRate: Number(formData.otherAnnualRate) || 0,
                        otherDueDate: formData.otherDueDate || ''
                    };
                }

                let receivablePayload = {};
                if (isReceivableForm) {
                    const amount = Number(formData.receivableAmount) || 0;
                    if (amount <= 0) {
                        alert('è«‹è¼¸å…¥æ‡‰æ”¶é‡‘é¡');
                        return;
                    }
                    quantity = 1;
                    costBasis = amount;
                    currentPrice = amount;
                    receivablePayload = {
                        receivableAmount: amount,
                        receivableDueDate: formData.receivableDueDate || '',
                        receivableInstallments: Number(formData.receivableInstallments) || 0,
                        receivableParty: (formData.receivableParty || '').trim()
                    };
                }

                let fixedPayload = {};
                if (isFixedForm) {
                    const purchasePrice = Number(formData.fixedPurchasePrice) || 0;
                    const currentValue = Number(formData.fixedCurrentValue) || 0;
                    if (purchasePrice <= 0 || currentValue <= 0) {
                        alert('è«‹è¼¸å…¥å›ºå®šè³‡ç”¢çš„è³¼å…¥æˆæœ¬èˆ‡ç›®å‰ä¼°å€¼');
                        return;
                    }
                    quantity = 1;
                    costBasis = purchasePrice;
                    currentPrice = currentValue;
                    fixedPayload = {
                        fixedPurchasePrice: purchasePrice,
                        fixedCurrentValue: currentValue,
                        fixedPurchaseDate: formData.fixedPurchaseDate || '',
                        fixedNote: (formData.fixedNote || '').trim()
                    };
                }

                const data = {
                    ...formData,
                    name: resolvedName,
                    symbol: needsSymbol ? (formData.symbol || '').toUpperCase().trim() : '',
                    quantity,
                    costBasis,
                    currentPrice,
                    currency: baseCurrency,
                    ...fixedDepositPayload,
                    ...mortgagePayload,
                    ...loanPayload,
                    ...creditCardPayload,
                    ...payablePayload,
                    ...otherLiabilityPayload,
                    ...receivablePayload,
                    ...fixedPayload
                };

                if (editingId) {
                    setAssets(assets.map(a => a.id === editingId ? { ...data, id: editingId } : a));
                } else {
                    setAssets([...assets, { ...data, id: Date.now().toString() }]);
                }

                setIsModalOpen(false);
                setEditingId(null);
                setFormData({
                    account: '',
                    name: '',
                    category: 'LIQUID',
                    subtype: 'ç¾é‡‘',
                    symbol: '',
                    quantity: '',
                    costBasis: '',
                    currency: 'HKD',
                    premiumAmount: '',
                    premiumFrequency: 'monthly',
                    premiumPaidCount: '',
                    propertyPrice: '',
                    ltvRatio: '',
                    annualInterestRate: '',
                    mortgageYears: '',
                    paidPeriods: '',
                    loanPrincipal: '',
                    loanYears: '',
                    loanPaidPeriods: '',
                    loanAnnualInterestRate: '',
                    creditCardBalance: '',
                    creditCardMinPayment: '',
                    creditCardDueDate: '',
                    creditCardAnnualRate: '',
                    payableAmount: '',
                    payableDueDate: '',
                    payableInstallments: '',
                    otherOutstanding: '',
                    otherAnnualRate: '',
                    otherDueDate: '',
                    receivableAmount: '',
                    receivableDueDate: '',
                    receivableInstallments: '',
                    receivableParty: '',
                    fixedPurchasePrice: '',
                    fixedCurrentValue: '',
                    fixedPurchaseDate: '',
                    fixedNote: '',
                    fixedDepositPrincipal: '',
                    fixedDepositAnnualRate: '',
                    fixedDepositMonths: '',
                    fixedDepositStartDate: ''
                });
            };

            const netWorthTier = getNetWorthTier(totals.netWorthHKD);

            return (
                <div className="max-w-6xl mx-auto p-4 md:p-8">
                    <header className="mb-6">
                        <div className="rounded-2xl border border-pink-100 bg-gradient-to-r from-pink-50 via-sky-50 to-amber-50 p-4 md:p-5 shadow-sm">
                            <div className="flex items-start gap-3">
                                <div className="w-11 h-11 bg-gradient-to-br from-amber-300 via-pink-300 to-sky-300 rounded-xl flex items-center justify-center text-white shadow-sm">
                                    <i data-lucide="crown" className="w-6 h-6"></i>
                                </div>
                                <div className="min-w-0 flex-1">
                                    <h1 className="text-2xl font-black text-slate-800 tracking-tight">SweetPrinceLedger - ç‹å­ç”œç”œå¸³</h1>
                                    <p className="text-xs text-slate-500 font-bold mt-1">{pageText.subtitle}</p>
                                </div>
                            </div>

                            <div className="mt-3 rounded-xl bg-white/80 border border-pink-100 px-3 py-3 flex items-center gap-3">
                                <div className="w-9 h-9 rounded-xl bg-gradient-to-br from-pink-200 via-amber-200 to-sky-200 flex items-center justify-center text-lg prince-float">ğŸ¤´ğŸ»</div>
                                <div className="min-w-0">
                                    <div className="text-xs font-black text-slate-600 prince-talk">{currentHeaderSlogan}</div>
                                </div>
                            </div>

                            <input
                                ref={importInputRef}
                                type="file"
                                accept="application/json,.json"
                                className="hidden"
                                onChange={handleImportData}
                            />
                            <div className="mt-4 pt-3 border-t border-white/70 flex flex-wrap items-center gap-2">
                                <select value={displayCurrency} onChange={e => setDisplayCurrency(e.target.value)} className="bg-white border border-slate-200 rounded-lg px-3 py-2 font-bold text-sm shadow-sm outline-none">
                                    {CURRENCIES.map(c => <option key={c} value={c}>{c}</option>)}
                                </select>

                                <button onClick={() => { setEditingId(null); setIsModalOpen(true); }} className="bg-slate-900 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-slate-800 transition-all shadow-md flex items-center gap-2">
                                    <i data-lucide="plus-circle" className="w-4 h-4"></i> {pageText.addAsset}
                                </button>

                                <button
                                    onClick={resetToSeed}
                                    className="bg-rose-500 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-rose-400 transition-all shadow-md"
                                >
                                    {pageText.resetData}
                                </button>

                                <div className="relative ml-auto">
                                    <button
                                        type="button"
                                        onClick={() => setShowSettings(prev => !prev)}
                                        className="bg-white border border-slate-200 rounded-lg px-3 py-2 font-black text-sm shadow-sm flex items-center gap-2"
                                    >
                                        <i data-lucide="settings" className="w-4 h-4"></i>
                                        {pageText.advanced}
                                    </button>
                                    {showSettings && (
                                        <div className="absolute right-0 mt-2 w-64 bg-white border border-slate-100 rounded-xl shadow-lg p-3 space-y-2 z-20">
                                            <div className="text-[10px] text-slate-400 font-black uppercase tracking-widest">{pageText.cloudAccount}</div>
                                            <div className="text-xs font-bold text-slate-600 bg-slate-50 rounded-lg px-2 py-1">
                                                {authUser ? (authUser.email || 'å·²ç™»å…¥ Google') : 'æœªç™»å…¥ Google'}
                                            </div>
                                            <button
                                                onClick={() => {
                                                    if (authUser) handleGoogleLogout();
                                                    else handleGoogleLogin();
                                                    setShowSettings(false);
                                                }}
                                                disabled={isAuthLoading || isCloudSyncing}
                                                className="w-full bg-slate-900 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-slate-800 transition-all disabled:opacity-60"
                                            >
                                                {isAuthLoading ? pageText.loginLoading : authUser ? pageText.logout : pageText.login}
                                            </button>
                                            <div className="text-[10px] text-slate-400 font-black uppercase tracking-widest">{pageText.displayCurrency}</div>
                                            <select
                                                value={displayCurrency}
                                                onChange={e => setDisplayCurrency(e.target.value)}
                                                className="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 font-bold text-sm shadow-sm outline-none"
                                            >
                                                {CURRENCIES.map(c => <option key={c} value={c}>{c}</option>)}
                                            </select>
                                            <div className="text-[10px] text-slate-400 font-black uppercase tracking-widest">{pageText.pageLanguage}</div>
                                            <select
                                                value={pageLanguage}
                                                onChange={e => setPageLanguage(e.target.value)}
                                                className="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 font-bold text-sm shadow-sm outline-none"
                                            >
                                                {PAGE_LANGUAGE_OPTIONS.map(option => <option key={option.value} value={option.value}>{option.label}</option>)}
                                            </select>
                                            <button
                                                onClick={() => { handleExportData(); setShowSettings(false); }}
                                                className="w-full bg-emerald-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-emerald-500 transition-all"
                                            >
                                                {pageText.exportData}
                                            </button>
                                            <button
                                                onClick={() => { openImportPicker(); setShowSettings(false); }}
                                                className="w-full bg-amber-500 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-amber-400 transition-all"
                                            >
                                                {pageText.importData}
                                            </button>
                                            <button
                                                onClick={() => { updateMarketPrices(true); setShowSettings(false); }}
                                                disabled={isUpdatingPrice}
                                                className="w-full bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-blue-500 transition-all disabled:opacity-60"
                                            >
                                                {isUpdatingPrice ? pageText.updating : pageText.updatePrice}
                                            </button>
                                            <button
                                                onClick={() => { refreshCurrencyRates(true); setShowSettings(false); }}
                                                disabled={isUpdatingRates}
                                                className="w-full bg-cyan-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-cyan-500 transition-all disabled:opacity-60"
                                            >
                                                {isUpdatingRates ? pageText.updating : pageText.updateFx}
                                            </button>
                                            <button
                                                onClick={() => { handleShareApp(); setShowSettings(false); }}
                                                disabled={isGeneratingPdf}
                                                className="w-full bg-violet-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-violet-500 transition-all disabled:opacity-60"
                                            >
                                                {isGeneratingPdf ? pageText.generatingPdf : pageText.sharePdf}
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </header>

                    <div className="mb-8 text-xs text-slate-500 font-bold flex flex-wrap gap-x-4 gap-y-1">
                        <span>{priceStatus || pageText.marketAutoUpdate}</span>
                        <span>{lastPriceUpdate ? `${pageText.lastUpdated}ï¼š${lastPriceUpdate.toLocaleString()}` : pageText.noPriceYet}</span>
                        <span>{lastRateUpdate ? `${pageText.rateUpdated}ï¼š${lastRateUpdate.toLocaleString()}` : pageText.fxDefault}</span>
                        <span>{isCloudSyncing ? pageText.cloudSyncing : cloudStatus}</span>
                    </div>

                    <section className="bg-white p-4 sm:p-6 rounded-2xl border border-slate-100 shadow-sm mb-8">
                        <div className="text-slate-800 font-black mb-4">{pageText.overviewTitle}</div>
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div className="space-y-4">
                                <div className="bg-indigo-600 p-5 rounded-2xl text-white shadow-lg">
                                    <div className="text-indigo-200 text-[10px] font-black uppercase tracking-widest mb-1">{pageText.netWorth} ({displayCurrency})</div>
                                    <div className="text-3xl font-black tracking-tighter">{formatAmount(totals.netWorth)}</div>
                                    <div className="text-xs font-black text-indigo-100 mt-2">{netWorthTier.emoji} {netWorthTier.label}</div>
                                </div>
                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 gap-3">
                                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-100">
                                        <div className="text-slate-400 text-[10px] font-black uppercase tracking-widest mb-1">{pageText.totalAssets}</div>
                                        <div className="text-xl font-black text-slate-800">{formatAmount(totals.assets)}</div>
                                    </div>
                                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-100">
                                        <div className="text-slate-400 text-[10px] font-black uppercase tracking-widest mb-1">{pageText.totalLiabilities}</div>
                                        <div className="text-xl font-black text-rose-500">{formatAmount(totals.liabilities)}</div>
                                        <div className="text-[10px] font-black text-slate-400 mt-1">{pageText.debtRatio} {totals.debtRatio.toFixed(1)}%</div>
                                    </div>
                                </div>
                            </div>

                            <div className="lg:col-span-2 grid grid-cols-1 xl:grid-cols-2 gap-6 items-center">
                                <details className="rounded-xl bg-slate-50/60 p-3 sm:p-0 sm:bg-transparent" open>
                                    <summary className="sm:hidden text-xs font-black text-slate-600 cursor-pointer list-none">{pageText.categoryMix}</summary>
                                    <div className="space-y-3 mt-3 sm:mt-0">
                                        {assetMix.rows.map(item => (
                                            <button
                                                type="button"
                                                key={item.categoryKey}
                                                onClick={() => setSelectedMixCategory(item.categoryKey)}
                                                className={`w-full text-left rounded-xl p-2 transition-all ${selectedMixCategory === item.categoryKey ? 'bg-slate-50 ring-1 ring-slate-200' : 'hover:bg-slate-50/70'}`}
                                            >
                                                <div className="flex justify-between text-xs font-black text-slate-500 mb-1">
                                                    <span>{item.label}</span>
                                                    <span>{item.ratio.toFixed(1)}% Â· {formatAmount(item.amount)} {displayCurrency}</span>
                                                </div>
                                                <div className="h-2 rounded-full bg-slate-100 overflow-hidden">
                                                    <div className={`h-full ${item.bg}`} style={{ width: `${item.ratio}%` }}></div>
                                                </div>
                                            </button>
                                        ))}
                                    </div>
                                </details>
                                <div className="space-y-4">
                                    <div className="flex items-center justify-center">
                                        <div className="w-44 h-44 sm:w-52 sm:h-52 rounded-full relative" style={{ background: detailMix.gradient }}>
                                            <div className="absolute inset-8 bg-white rounded-full border border-slate-100 flex items-center justify-center">
                                                <div className="text-center">
                                                    <div className="text-[10px] text-slate-400 font-black uppercase tracking-widest">{detailMix.categoryLabel}</div>
                                                    <div className="text-sm font-black text-slate-700">{pageText.detailMix}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <details className="rounded-xl bg-slate-50/60 p-3 sm:p-0 sm:bg-transparent" open>
                                        <summary className="sm:hidden text-xs font-black text-slate-600 cursor-pointer list-none">{pageText.detailMix}</summary>
                                        <div className="space-y-2 mt-3 sm:mt-0">
                                            {detailMix.rows.length ? detailMix.rows.map(row => (
                                                <div key={row.label} className="flex items-center justify-between text-xs font-black text-slate-500">
                                                    <div className="flex items-center gap-2">
                                                        <span className="w-2.5 h-2.5 rounded-full" style={{ backgroundColor: row.color }}></span>
                                                        <span>{row.label}</span>
                                                    </div>
                                                    <span>{row.ratio.toFixed(1)}% Â· {formatAmount(row.amount)} {displayCurrency}</span>
                                                </div>
                                            )) : (
                                                <p className="text-sm text-slate-400 font-bold text-center">{pageText.noDetailItems}</p>
                                            )}
                                        </div>
                                    </details>
                                </div>
                            </div>
                        </div>
                    </section>

                    <div className="mb-4 flex items-center gap-2">
                        <button
                            type="button"
                            onClick={() => setFinanceSectionTab('ASSET_ACCOUNT')}
                            className={`px-4 py-2 rounded-lg text-sm font-black border ${financeSectionTab === 'ASSET_ACCOUNT' ? 'bg-slate-900 text-white border-slate-900' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'}`}
                        >
                            {pageText.tabAssetAccount}
                        </button>
                        <button
                            type="button"
                            onClick={() => setFinanceSectionTab('CASHFLOW')}
                            className={`px-4 py-2 rounded-lg text-sm font-black border ${financeSectionTab === 'CASHFLOW' ? 'bg-slate-900 text-white border-slate-900' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'}`}
                        >
                            {pageText.tabCashflow}
                        </button>
                    </div>

                    {financeSectionTab === 'ASSET_ACCOUNT' && (
                    <section className="bg-white p-4 sm:p-6 rounded-2xl border border-slate-100 shadow-sm mb-8">
                        <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-3 mb-4">
                            <div className="text-slate-800 font-black">{pageText.tabAssetAccount}</div>
                            <div className="flex flex-col sm:flex-row flex-wrap items-stretch sm:items-center gap-2">
                                <select
                                    value={selectedStatsCategory}
                                    onChange={e => {
                                        setSelectedStatsCategory(e.target.value);
                                        setSelectedStatsAccount('');
                                        setSelectedStatsSegmentKey('');
                                    }}
                                    className="bg-white border border-slate-200 rounded-lg px-3 py-2 font-bold text-sm shadow-sm outline-none w-full sm:w-auto"
                                >
                                    {CATEGORY_KEYS.map(categoryKey => <option key={categoryKey} value={categoryKey}>{CATEGORIES[categoryKey].label}</option>)}
                                </select>
                                <select
                                    value={statsBreakdownMode}
                                    onChange={e => {
                                        setStatsBreakdownMode(e.target.value);
                                        setSelectedStatsSegmentKey('');
                                    }}
                                    className="bg-white border border-slate-200 rounded-lg px-3 py-2 font-bold text-sm shadow-sm outline-none w-full sm:w-auto"
                                >
                                    <option value="ACCOUNT">æŒ‰å¸³æˆ¶ä½”æ¯”</option>
                                    <option value="ITEM">æŒ‰å¸³æˆ¶å…§ç´°é …</option>
                                </select>
                                {statsBreakdownMode === 'ITEM' && (
                                    <select
                                        value={accountStats.currentAccount}
                                        onChange={e => {
                                            setSelectedStatsAccount(e.target.value);
                                            setSelectedStatsSegmentKey('');
                                        }}
                                        className="bg-white border border-slate-200 rounded-lg px-3 py-2 font-bold text-sm shadow-sm outline-none w-full sm:w-auto"
                                    >
                                        {accountStats.accountNames.length ? (
                                            accountStats.accountNames.map(account => <option key={account} value={account}>{account}</option>)
                                        ) : (
                                            <option value="">å°šç„¡å¸³æˆ¶</option>
                                        )}
                                    </select>
                                )}
                            </div>
                        </div>

                        {!accountStats.accountNames.length ? (
                            <p className="text-sm text-slate-400 font-bold">ç›®å‰æ­¤é¡åˆ¥æ²’æœ‰å¯çµ±è¨ˆè³‡æ–™</p>
                        ) : (
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
                                <div className="flex justify-center">
                                    <svg viewBox="0 0 260 260" className="w-48 h-48 sm:w-56 sm:h-56">
                                        {accountStats.segments.length === 1 ? (
                                            <circle
                                                cx="130"
                                                cy="130"
                                                r="110"
                                                fill={accountStats.segments[0].color}
                                                stroke="#ffffff"
                                                strokeWidth="2"
                                                className="cursor-pointer"
                                                onClick={() => setSelectedStatsSegmentKey(accountStats.segments[0].key)}
                                            />
                                        ) : (
                                            accountStats.segments.map(segment => (
                                                <path
                                                    key={segment.key}
                                                    d={describeArc(130, 130, 110, segment.startAngle, segment.endAngle)}
                                                    fill={segment.color}
                                                    stroke="#ffffff"
                                                    strokeWidth="2"
                                                    className="cursor-pointer"
                                                    opacity={accountStats.selectedItem?.key === segment.key ? 1 : 0.8}
                                                    onClick={() => setSelectedStatsSegmentKey(segment.key)}
                                                />
                                            ))
                                        )}
                                        <circle cx="130" cy="130" r="62" fill="#ffffff" />
                                        <text x="130" y="116" textAnchor="middle" className="fill-slate-400" style={{ fontSize: '10px', fontWeight: 800 }}>
                                            {accountStats.selectedItem ? accountStats.selectedItem.label : (statsBreakdownMode === 'ACCOUNT' ? CATEGORIES[selectedStatsCategory].label : accountStats.currentAccount)}
                                        </text>
                                        <text x="130" y="136" textAnchor="middle" className="fill-slate-700" style={{ fontSize: '13px', fontWeight: 900 }}>
                                            {accountStats.selectedItem ? `${formatAmount(accountStats.selectedItem.valueDisplay)} ${displayCurrency}` : `${formatAmount(accountStats.total)} ${displayCurrency}`}
                                        </text>
                                        <text x="130" y="154" textAnchor="middle" className="fill-slate-400" style={{ fontSize: '10px', fontWeight: 800 }}>
                                            {accountStats.selectedItem ? `${accountStats.selectedItem.ratio.toFixed(1)}%` : 'é»æ“Šå€å¡ŠæŸ¥çœ‹ä½”æ¯”'}
                                        </text>
                                    </svg>
                                </div>

                                <div className="lg:col-span-2 space-y-3">
                                    <div className="space-y-2">
                                        {accountStats.segments.map(segment => (
                                            <button
                                                key={segment.key}
                                                type="button"
                                                onClick={() => setSelectedStatsSegmentKey(segment.key)}
                                                className={`w-full flex items-center justify-between px-3 py-2 rounded-lg text-left border ${accountStats.selectedItem?.key === segment.key ? 'border-indigo-200 bg-indigo-50/60' : 'border-slate-100 bg-white'}`}
                                            >
                                                <div className="flex items-center gap-2 min-w-0">
                                                    <span className="w-2.5 h-2.5 rounded-full" style={{ backgroundColor: segment.color }}></span>
                                                    <span className="text-sm font-bold text-slate-700 truncate">{segment.label}</span>
                                                    <span className="text-[10px] text-slate-400 font-black">{segment.symbol ? `(${segment.symbol})` : ''}</span>
                                                </div>
                                                <div className="text-xs font-black text-slate-500 whitespace-nowrap text-right">
                                                    <div>{formatAmount(segment.valueDisplay)} {displayCurrency}</div>
                                                    <div>{segment.ratio.toFixed(1)}%</div>
                                                </div>
                                            </button>
                                        ))}
                                    </div>

                                    {accountStats.selectedItem && (
                                        <details className="rounded-xl border border-slate-100 bg-slate-50/60 p-4" open>
                                            <summary className="md:hidden text-xs text-slate-500 font-black cursor-pointer list-none">å·²é¸æ“‡é …ç›®ç´°ç¯€</summary>
                                            <div className="mt-3 md:mt-0">
                                                <div className="text-xs text-slate-400 font-black mb-2">å·²é¸æ“‡é …ç›®</div>
                                                <div className="text-base font-black text-slate-800 mb-1">{accountStats.selectedItem.label}</div>
                                                <div className="text-xs text-slate-500 font-bold mb-2">
                                                    {statsBreakdownMode === 'ACCOUNT' ? `å¸³æˆ¶è³‡ç”¢é …ç›®ï¼š${accountStats.selectedItem.members?.length || 0} ç­†` : (accountStats.selectedItem.subtype || CATEGORIES[selectedStatsCategory].label)}
                                                    {accountStats.selectedItem.symbol ? ` Â· ${accountStats.selectedItem.symbol}` : ''}
                                                </div>
                                                <div className="text-sm font-bold text-slate-700">åç¨±ï¼š{accountStats.selectedItem.label}</div>
                                                <div className="text-sm font-bold text-slate-700">é‡‘é¡ï¼š{formatAmount(accountStats.selectedItem.valueDisplay)} {displayCurrency}</div>
                                                <div className="text-sm font-bold text-slate-700">ç™¾åˆ†æ¯”ï¼š{accountStats.selectedItem.ratio.toFixed(2)}%</div>
                                            </div>
                                        </details>
                                    )}
                                </div>
                            </div>
                        )}
                    </section>
                    )}

                    {financeSectionTab === 'CASHFLOW' && (
                    <section className="bg-white p-4 sm:p-6 rounded-2xl border border-slate-100 shadow-sm mb-8">
                        <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-3 mb-4">
                            <div>
                                <div className="text-slate-800 font-black">{pageText.tabCashflow}</div>
                                <p className="text-xs text-slate-400 font-bold mt-1">{pageText.cashflowDesc}</p>
                            </div>
                            <div className="flex items-center gap-2">
                                <button
                                    type="button"
                                    onClick={() => moveCashflowMonth(-1)}
                                    className="px-3 py-2 rounded-lg border border-slate-200 text-xs font-black text-slate-600 hover:bg-slate-50"
                                >
                                    {pageText.prevMonth}
                                </button>
                                <input
                                    type="month"
                                    value={selectedCashflowMonth}
                                    onChange={e => setSelectedCashflowMonth(e.target.value || toMonthKey(new Date()))}
                                    className="px-3 py-2 rounded-lg border border-slate-200 text-xs font-black text-slate-700 outline-none"
                                />
                                <button
                                    type="button"
                                    onClick={() => moveCashflowMonth(1)}
                                    className="px-3 py-2 rounded-lg border border-slate-200 text-xs font-black text-slate-600 hover:bg-slate-50"
                                >
                                    {pageText.nextMonth}
                                </button>
                            </div>
                        </div>

                        <div className="flex flex-col gap-5">

                        <form ref={cashflowFormRef} onSubmit={handleCashflowSubmit} className="order-2 rounded-xl border border-slate-100 bg-slate-50/60 p-4 space-y-3">
                            {editingCashflowId && (
                                <div className="rounded-lg bg-indigo-50 border border-indigo-100 px-3 py-2 text-xs font-black text-indigo-600">
                                    æ­£åœ¨ç·¨è¼¯è¦å‰‡ï¼š{cashflowEntries.find(item => item.id === editingCashflowId)?.title || 'æœªå‘½åè¦å‰‡'}
                                </div>
                            )}
                            <datalist id="cashflow-account-options">
                                {cashflowAccountOptions.map(account => <option key={account} value={account} />)}
                            </datalist>
                            <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-6 gap-3">
                                <div className="space-y-1 xl:col-span-2">
                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">é …ç›®åç¨±</label>
                                    <input
                                        required
                                        type="text"
                                        placeholder="ä¾‹å¦‚ï¼šæ¯æœˆç§Ÿé‡‘ã€å…¼è·æ”¶å…¥ã€æ¯æ—¥åˆé¤"
                                        className="w-full p-3 bg-white rounded-xl font-bold outline-none ring-2 ring-transparent focus:ring-indigo-100"
                                        value={cashflowForm.title}
                                        onChange={e => setCashflowForm({ ...cashflowForm, title: e.target.value })}
                                    />
                                </div>
                                <div className="space-y-1">
                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">æ”¶æ”¯é¡å‹</label>
                                    <select
                                        value={cashflowForm.type}
                                        onChange={e => {
                                            const nextType = e.target.value;
                                            setCashflowForm({
                                                ...cashflowForm,
                                                type: nextType,
                                                category: getDefaultCashflowCategory(nextType)
                                            });
                                        }}
                                        className="w-full p-3 bg-white rounded-xl font-bold outline-none"
                                    >
                                        {Object.entries(CASHFLOW_TYPES).map(([key, item]) => (
                                            <option key={key} value={key}>{item.label}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="space-y-1">
                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">è¨˜éŒ„é¡å‹</label>
                                    <select
                                        value={cashflowForm.scheduleType}
                                        onChange={e => setCashflowForm({ ...cashflowForm, scheduleType: e.target.value })}
                                        className="w-full p-3 bg-white rounded-xl font-bold outline-none"
                                    >
                                        {CASHFLOW_SCHEDULE_TYPES.map(item => <option key={item.value} value={item.value}>{item.label}</option>)}
                                    </select>
                                </div>
                                <div className="space-y-1">
                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">å…¥å¸³/æ‰£æ¬¾å¸³æˆ¶ï¼ˆæµå‹•è³‡é‡‘ï¼‰</label>
                                    <select
                                        value={cashflowForm.targetLiquidAssetId}
                                        onChange={e => {
                                            const nextId = e.target.value;
                                            const selected = liquidAssetOptions.find(option => option.id === nextId) || null;
                                            setCashflowForm({
                                                ...cashflowForm,
                                                targetLiquidAssetId: nextId,
                                                account: selected?.account || cashflowForm.account
                                            });
                                        }}
                                        className="w-full p-3 bg-white rounded-xl font-bold outline-none"
                                    >
                                        <option value="">åªåšç¾é‡‘æµè¨˜éŒ„ï¼ˆä¸è‡ªå‹•å…¥å¸³ï¼‰</option>
                                        {liquidAssetOptions.map(option => <option key={option.id} value={option.id}>{option.label}</option>)}
                                    </select>
                                </div>
                                <div className="space-y-1">
                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">å¸³æˆ¶</label>
                                    <input
                                        type="text"
                                        list="cashflow-account-options"
                                        placeholder="å¯é¸ï¼Œåƒ…ç”¨æ–¼æ¨™è¨˜"
                                        className="w-full p-3 bg-white rounded-xl font-bold outline-none ring-2 ring-transparent focus:ring-indigo-100 disabled:bg-slate-100 disabled:text-slate-400"
                                        value={cashflowForm.account}
                                        onChange={e => setCashflowForm({ ...cashflowForm, account: e.target.value })}
                                        disabled={Boolean(cashflowForm.targetLiquidAssetId)}
                                    />
                                    {cashflowForm.targetLiquidAssetId && (
                                        <div className="text-[10px] text-slate-400 font-bold ml-1">å·²ç¶å®šæµå‹•è³‡é‡‘å¸³æˆ¶ï¼Œæœƒåœ¨ç¬¦åˆè¦å‰‡æ—¥æœŸæ™‚å…¥å¸³/æ‰£æ¬¾ï¼ˆå–®æ¬¡æˆ–å›ºå®šï¼‰ã€‚</div>
                                    )}
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-6 gap-3">
                                <div className="space-y-1">
                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">é‡‘é¡</label>
                                    <input
                                        required
                                        type="number"
                                        min="0"
                                        step="any"
                                        className="w-full p-3 bg-white rounded-xl font-bold outline-none"
                                        value={cashflowForm.amount}
                                        onChange={e => setCashflowForm({ ...cashflowForm, amount: e.target.value })}
                                    />
                                </div>
                                <div className="space-y-1">
                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">å¹£ç¨®</label>
                                    <select
                                        value={cashflowForm.currency}
                                        onChange={e => setCashflowForm({ ...cashflowForm, currency: e.target.value })}
                                        className="w-full p-3 bg-white rounded-xl font-bold outline-none"
                                    >
                                        {CURRENCIES.map(currency => <option key={currency} value={currency}>{currency}</option>)}
                                    </select>
                                </div>
                                {!isCashflowOneTime && (
                                    <div className="space-y-1">
                                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">é »ç‡</label>
                                        <select
                                            value={cashflowForm.frequency}
                                            onChange={e => setCashflowForm({ ...cashflowForm, frequency: e.target.value })}
                                            className="w-full p-3 bg-white rounded-xl font-bold outline-none"
                                        >
                                            {CASHFLOW_FREQUENCIES.map(item => <option key={item.value} value={item.value}>{item.label}</option>)}
                                        </select>
                                    </div>
                                )}
                                <div className="space-y-1">
                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">{isCashflowOneTime ? 'è¨˜éŒ„æ—¥æœŸ' : 'é–‹å§‹æ—¥æœŸ'}</label>
                                    <input
                                        required
                                        type="date"
                                        className="w-full p-3 bg-white rounded-xl font-bold outline-none"
                                        value={cashflowForm.startDate}
                                        onChange={e => setCashflowForm({ ...cashflowForm, startDate: e.target.value })}
                                    />
                                </div>
                                {isCashflowMonthlyRecurring && (
                                    <div className="space-y-1">
                                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">æ¯æœˆè¨˜éŒ„æ—¥</label>
                                        <input
                                            type="number"
                                            min="1"
                                            max="31"
                                            step="1"
                                            className="w-full p-3 bg-white rounded-xl font-bold outline-none"
                                            value={cashflowForm.payday}
                                            onChange={e => setCashflowForm({ ...cashflowForm, payday: e.target.value })}
                                        />
                                        <div className="text-[10px] text-slate-400 font-bold ml-1">è‹¥è¶…éç•¶æœˆå¤©æ•¸ï¼Œç³»çµ±æœƒè‡ªå‹•è¨˜éŒ„åœ¨æœˆåº•ã€‚</div>
                                    </div>
                                )}
                                {!isCashflowOneTime && (
                                    <div className="space-y-1">
                                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">çµæŸæ—¥æœŸ</label>
                                        <input
                                            type="date"
                                            className="w-full p-3 bg-white rounded-xl font-bold outline-none"
                                            value={cashflowForm.endDate}
                                            onChange={e => setCashflowForm({ ...cashflowForm, endDate: e.target.value })}
                                        />
                                    </div>
                                )}
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-3 items-end">
                                <div className="space-y-1">
                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">åˆ†é¡</label>
                                    <select
                                        value={cashflowForm.category}
                                        onChange={e => setCashflowForm({ ...cashflowForm, category: e.target.value })}
                                        className="w-full p-3 bg-white rounded-xl font-bold outline-none"
                                    >
                                        {availableCashflowCategories.map(item => <option key={item} value={item}>{item}</option>)}
                                    </select>
                                </div>
                                <div className="space-y-1 xl:col-span-2">
                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">å‚™è¨»</label>
                                    <input
                                        type="text"
                                        placeholder="ä¾‹å¦‚ï¼šæ¯æœˆ 25 è™Ÿå…¥å¸³ï¼æ‰£æ¬¾"
                                        className="w-full p-3 bg-white rounded-xl font-bold outline-none ring-2 ring-transparent focus:ring-indigo-100"
                                        value={cashflowForm.note}
                                        onChange={e => setCashflowForm({ ...cashflowForm, note: e.target.value })}
                                    />
                                </div>
                                <button
                                    type="submit"
                                    className="w-full bg-slate-900 text-white px-4 py-3 rounded-xl font-black text-sm hover:bg-slate-800 transition-all"
                                >
                                    {editingCashflowId ? 'å„²å­˜è¦å‰‡ä¿®æ”¹' : 'æ–°å¢ç¾é‡‘æµè¦å‰‡'}
                                </button>
                            </div>
                        </form>

                        <div className="order-1 grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div className="bg-emerald-50 rounded-xl border border-emerald-100 p-4">
                                <div className="text-[10px] text-emerald-500 font-black uppercase tracking-widest mb-1">æœ¬æœˆæ”¶å…¥</div>
                                <div className="text-xl font-black text-emerald-600">{formatAmount(cashflowMonthData.monthIncomeDisplay)} {displayCurrency}</div>
                            </div>
                            <div className="bg-rose-50 rounded-xl border border-rose-100 p-4">
                                <div className="text-[10px] text-rose-500 font-black uppercase tracking-widest mb-1">æœ¬æœˆæ”¯å‡º</div>
                                <div className="text-xl font-black text-rose-600">{formatAmount(cashflowMonthData.monthExpenseDisplay)} {displayCurrency}</div>
                            </div>
                            <div className="bg-indigo-50 rounded-xl border border-indigo-100 p-4">
                                <div className="text-[10px] text-indigo-500 font-black uppercase tracking-widest mb-1">æœ¬æœˆæ·¨æµ</div>
                                <div className={`text-xl font-black ${cashflowMonthData.monthNetDisplay >= 0 ? 'text-indigo-600' : 'text-rose-600'}`}>{cashflowMonthData.monthNetDisplay >= 0 ? '+' : ''}{formatAmount(cashflowMonthData.monthNetDisplay)} {displayCurrency}</div>
                            </div>
                        </div>

                        <div className="order-1 flex items-center gap-2">
                            <button
                                type="button"
                                onClick={() => setCashflowView('MONTH')}
                                className={`px-3 py-2 rounded-lg text-xs font-black border ${cashflowView === 'MONTH' ? 'bg-slate-900 text-white border-slate-900' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'}`}
                            >
                                æ¯æœˆæ—¥æ›†
                            </button>
                            <button
                                type="button"
                                onClick={() => setCashflowView('YEAR')}
                                className={`px-3 py-2 rounded-lg text-xs font-black border ${cashflowView === 'YEAR' ? 'bg-slate-900 text-white border-slate-900' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'}`}
                            >
                                æ¯å¹´å½™ç¸½
                            </button>
                        </div>

                        {cashflowView === 'MONTH' ? (
                            <div className="order-1 space-y-3">
                                <div className="grid grid-cols-7 gap-2">
                                    {WEEKDAY_LABELS.map(label => (
                                        <div key={label} className="text-center text-[10px] text-slate-400 font-black uppercase tracking-widest py-1">é€±{label}</div>
                                    ))}
                                </div>
                                <div className="grid grid-cols-7 gap-2">
                                    {Array.from({ length: cashflowMonthData.firstDay }).map((_, idx) => (
                                        <div key={`empty-${idx}`} className="h-24 rounded-xl bg-slate-50/40 border border-slate-100"></div>
                                    ))}
                                    {cashflowMonthData.dayRows.map(day => (
                                        <div key={day.dateKey} className="min-h-24 rounded-xl border border-slate-100 bg-white p-2 flex flex-col gap-1">
                                            <div className="flex items-center justify-between">
                                                <span className="text-xs font-black text-slate-700">{day.day}</span>
                                                <span className={`text-[10px] font-black ${day.netDisplay >= 0 ? 'text-emerald-500' : 'text-rose-500'}`}>{day.netDisplay >= 0 ? '+' : ''}{formatAmount(day.netDisplay)}</span>
                                            </div>
                                            {(day.incomeDisplay > 0 || day.expenseDisplay > 0) ? (
                                                <>
                                                    <div className="text-[10px] font-black text-emerald-500">æ”¶ +{formatAmount(day.incomeDisplay)}</div>
                                                    <div className="text-[10px] font-black text-rose-500">æ”¯ -{formatAmount(day.expenseDisplay)}</div>
                                                </>
                                            ) : (
                                                <div className="text-[10px] text-slate-300 font-black">ç„¡æµæ°´</div>
                                            )}
                                            <div className="space-y-0.5">
                                                {day.entries.slice(0, 2).map(entry => (
                                                    <div key={entry.id} className={`text-[10px] truncate font-bold ${entry.type === 'INCOME' ? 'text-emerald-600' : 'text-rose-600'}`}>
                                                        {entry.type === 'INCOME' ? '+' : '-'}{entry.title}
                                                    </div>
                                                ))}
                                                {day.entries.length > 2 && (
                                                    <div className="text-[10px] text-slate-400 font-black">+{day.entries.length - 2} ç­†</div>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ) : (
                            <div className="order-1 space-y-4">
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <div className="bg-emerald-50 rounded-xl border border-emerald-100 p-4">
                                        <div className="text-[10px] text-emerald-500 font-black uppercase tracking-widest mb-1">{cashflowYearData.year} å¹´æ”¶å…¥</div>
                                        <div className="text-xl font-black text-emerald-600">{formatAmount(cashflowYearData.yearIncomeDisplay)} {displayCurrency}</div>
                                    </div>
                                    <div className="bg-rose-50 rounded-xl border border-rose-100 p-4">
                                        <div className="text-[10px] text-rose-500 font-black uppercase tracking-widest mb-1">{cashflowYearData.year} å¹´æ”¯å‡º</div>
                                        <div className="text-xl font-black text-rose-600">{formatAmount(cashflowYearData.yearExpenseDisplay)} {displayCurrency}</div>
                                    </div>
                                    <div className="bg-indigo-50 rounded-xl border border-indigo-100 p-4">
                                        <div className="text-[10px] text-indigo-500 font-black uppercase tracking-widest mb-1">{cashflowYearData.year} å¹´æ·¨æµ</div>
                                        <div className={`text-xl font-black ${cashflowYearData.yearNetDisplay >= 0 ? 'text-indigo-600' : 'text-rose-600'}`}>{cashflowYearData.yearNetDisplay >= 0 ? '+' : ''}{formatAmount(cashflowYearData.yearNetDisplay)} {displayCurrency}</div>
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-3">
                                    {cashflowYearData.months.map(monthItem => (
                                        <div key={monthItem.label} className="rounded-xl border border-slate-100 bg-white p-3">
                                            <div className="text-sm font-black text-slate-700 mb-2">{monthItem.label}</div>
                                            <div className="text-xs font-bold text-emerald-600">æ”¶å…¥ +{formatAmount(monthItem.incomeDisplay)} {displayCurrency}</div>
                                            <div className="text-xs font-bold text-rose-600">æ”¯å‡º -{formatAmount(monthItem.expenseDisplay)} {displayCurrency}</div>
                                            <div className={`text-xs font-black mt-1 ${monthItem.netDisplay >= 0 ? 'text-indigo-600' : 'text-rose-600'}`}>æ·¨æµ {monthItem.netDisplay >= 0 ? '+' : ''}{formatAmount(monthItem.netDisplay)} {displayCurrency}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        <div className="order-3">
                            <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-2 mb-2">
                                <div className="text-xs text-slate-400 font-black uppercase tracking-widest">ç¾é‡‘æµè¦å‰‡æ¸…å–®</div>
                                <div className="text-[10px] text-slate-400 font-black">å…± {cashflowEntries.length} ç­† Â· ç¬¦åˆæ¢ä»¶ {filteredCashflowEntries.length} ç­†</div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-4 gap-2 mb-3">
                                <input
                                    type="text"
                                    placeholder="æœå°‹åç¨± / åˆ†é¡ / å¸³æˆ¶ / å‚™è¨»"
                                    className="w-full p-2.5 bg-white border border-slate-200 rounded-lg text-xs font-bold outline-none"
                                    value={cashflowRuleKeyword}
                                    onChange={e => setCashflowRuleKeyword(e.target.value)}
                                />
                                <select
                                    value={cashflowRuleFilter}
                                    onChange={e => setCashflowRuleFilter(e.target.value)}
                                    className="w-full p-2.5 bg-white border border-slate-200 rounded-lg text-xs font-bold outline-none"
                                >
                                    <option value="ALL">å…¨éƒ¨è¦å‰‡</option>
                                    <option value="AUTO">åƒ…å›ºå®šï¼ˆè‡ªå‹•ï¼‰</option>
                                    <option value="ONE_TIME">åƒ…å–®æ¬¡</option>
                                    <option value="INCOME">åƒ…æ”¶å…¥</option>
                                    <option value="EXPENSE">åƒ…æ”¯å‡º</option>
                                </select>
                                <select
                                    value={cashflowRuleSortMode}
                                    onChange={e => setCashflowRuleSortMode(e.target.value)}
                                    className="w-full p-2.5 bg-white border border-slate-200 rounded-lg text-xs font-bold outline-none"
                                >
                                    <option value="START_DESC">æŒ‰å»ºç«‹/é–‹å§‹æ—¥ï¼ˆæ–°åˆ°èˆŠï¼‰</option>
                                    <option value="NEXT_TRIGGER_ASC">æŒ‰ä¸‹æ¬¡è§¸ç™¼æ—¥ï¼ˆè¿‘æœŸå„ªå…ˆï¼‰</option>
                                </select>
                                <div className="flex items-center gap-2">
                                    {editingCashflowId ? (
                                        <button
                                            type="button"
                                            onClick={() => {
                                                setEditingCashflowId('');
                                                setCashflowForm(prev => ({
                                                    ...prev,
                                                    title: '',
                                                    amount: '',
                                                    note: ''
                                                }));
                                                setPriceStatus('å·²å–æ¶ˆç·¨è¼¯');
                                            }}
                                            className="w-full px-3 py-2.5 rounded-lg bg-slate-100 text-slate-600 text-xs font-black hover:bg-slate-200"
                                        >
                                            å–æ¶ˆç·¨è¼¯
                                        </button>
                                    ) : (
                                        <div className="w-full px-3 py-2.5 rounded-lg bg-slate-50 text-slate-400 text-xs font-black text-center">é»é¸è¦å‰‡å¯ç·¨è¼¯</div>
                                    )}
                                </div>
                            </div>

                            {!filteredCashflowEntries.length ? (
                                <p className="text-sm text-slate-400 font-bold">å°šæœªæ–°å¢ç¾é‡‘æµè¦å‰‡</p>
                            ) : (
                                <div className="space-y-2 max-h-72 overflow-y-auto pr-1 custom-scrollbar">
                                    {filteredCashflowEntries.slice(0, cashflowRulesVisibleCount).map(item => (
                                        <div key={item.id} className={`rounded-xl border p-3 flex items-center justify-between gap-3 ${editingCashflowId === item.id ? 'border-indigo-200 bg-indigo-50/40' : 'border-slate-100 bg-white'}`}>
                                            <div className="min-w-0">
                                                <div className="flex items-center gap-2">
                                                    <span className={`text-xs font-black ${item.type === 'INCOME' ? 'text-emerald-600' : 'text-rose-600'}`}>{CASHFLOW_TYPES[item.type].label}</span>
                                                    <span className="text-sm font-black text-slate-800 truncate">{item.title}</span>
                                                </div>
                                                <div className="text-[10px] text-slate-400 font-bold mt-1">
                                                    {item.account ? `å¸³æˆ¶ï¼š${item.account} Â· ` : ''}
                                                    {item.category} Â· {(item.scheduleType === 'ONE_TIME' ? 'å–®æ¬¡æ€§' : 'å›ºå®š')} Â· {(item.frequency === 'ONE_TIME' ? 'å–®æ¬¡' : (CASHFLOW_FREQUENCIES.find(entry => entry.value === item.frequency)?.label || item.frequency))}
                                                    {item.frequency === 'MONTHLY' ? `ï¼ˆæ¯æœˆ ${item.payday || item.monthday || '--'} è™Ÿï¼‰` : ''} Â· {item.startDate}{item.endDate ? ` ~ ${item.endDate}` : ''}
                                                </div>
                                                {item.targetLiquidAssetId && (
                                                    <div className="text-[10px] text-indigo-500 font-black mt-0.5">
                                                        {item.scheduleType === 'ONE_TIME' ? 'æœ¬æ¬¡å…¥å¸³/æ‰£æ¬¾ç›®æ¨™å¸³æˆ¶ï¼š' : 'è‡ªå‹•å…¥å¸³/æ‰£æ¬¾ç›®æ¨™å¸³æˆ¶ï¼š'}{liquidAssetLabelById[item.targetLiquidAssetId] || 'å·²ç¶å®šå¸³æˆ¶'}
                                                    </div>
                                                )}
                                                {item.note && <div className="text-[10px] text-slate-400 font-bold mt-0.5">{item.note}</div>}
                                                <div className="text-[10px] text-slate-400 font-black mt-1 flex flex-wrap gap-x-3 gap-y-1">
                                                    <span>æœ€å¾Œè§¸ç™¼ï¼š{cashflowTriggerInfoById[item.id]?.lastDateKey || '--'}</span>
                                                    <span>ä¸‹æ¬¡è§¸ç™¼ï¼š{cashflowTriggerInfoById[item.id]?.nextDateKey || '--'}</span>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-2 shrink-0">
                                                <div className={`text-sm font-black ${item.type === 'INCOME' ? 'text-emerald-600' : 'text-rose-600'}`}>{item.type === 'INCOME' ? '+' : '-'}{formatAmount(fromHKD(toHKD(item.amount, item.currency), displayCurrency))} {displayCurrency}</div>
                                                <button
                                                    type="button"
                                                    onClick={() => startEditCashflowEntry(item)}
                                                    className="px-2.5 py-1.5 rounded-lg bg-slate-100 text-slate-700 text-xs font-black hover:bg-slate-200"
                                                >
                                                    ç·¨è¼¯
                                                </button>
                                                <button
                                                    type="button"
                                                    onClick={() => handleDeleteCashflowEntry(item.id)}
                                                    className="px-2.5 py-1.5 rounded-lg bg-rose-50 text-rose-600 text-xs font-black hover:bg-rose-100"
                                                >
                                                    åˆªé™¤
                                                </button>
                                            </div>
                                        </div>
                                    ))}

                                    {filteredCashflowEntries.length > cashflowRulesVisibleCount && (
                                        <button
                                            type="button"
                                            onClick={() => setCashflowRulesVisibleCount(prev => prev + 20)}
                                            className="w-full mt-1 px-3 py-2 rounded-lg bg-white border border-slate-200 text-slate-600 text-xs font-black hover:bg-slate-50"
                                        >
                                            é¡¯ç¤ºæ›´å¤šï¼ˆå‰©é¤˜ {filteredCashflowEntries.length - cashflowRulesVisibleCount} ç­†ï¼‰
                                        </button>
                                    )}
                                </div>
                            )}
                        </div>
                        </div>
                    </section>
                    )}

                    <div className="mb-6 flex md:flex-wrap items-center gap-2 overflow-x-auto -mx-2 px-2">
                        <button
                            onClick={() => setSelectedCategories(CATEGORY_KEYS)}
                            className={`px-4 py-1.5 rounded-full text-xs font-black transition-all whitespace-nowrap shrink-0 ${selectedCategories.length === CATEGORY_KEYS.length ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-slate-500 hover:bg-slate-50 border border-slate-100'}`}
                        >
                            å…¨éƒ¨é …ç›®
                        </button>
                        {CATEGORY_KEYS.map(categoryKey => (
                            <button
                                key={categoryKey}
                                onClick={() => toggleCategory(categoryKey)}
                                className={`px-4 py-1.5 rounded-full text-xs font-black transition-all whitespace-nowrap shrink-0 ${selectedCategories.includes(categoryKey) ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-slate-500 hover:bg-slate-50 border border-slate-100'}`}
                            >
                                {CATEGORIES[categoryKey].label}
                            </button>
                        ))}
                        <select
                            value={sortMode}
                            onChange={e => setSortMode(e.target.value)}
                            className="bg-white border border-slate-200 rounded-lg px-3 py-1.5 font-bold text-xs shadow-sm outline-none shrink-0"
                        >
                            <option value="AMOUNT_DESC">æŒ‰é‡‘é¡æ’åºï¼ˆå¤§åˆ°å°ï¼‰</option>
                            <option value="NAME_ASC">æŒ‰åç¨±æ’åºï¼ˆA-Zï¼‰</option>
                        </select>
                        <select
                            value={viewMode}
                            onChange={e => setViewMode(e.target.value)}
                            className="bg-white border border-slate-200 rounded-lg px-3 py-1.5 font-bold text-xs shadow-sm outline-none shrink-0"
                        >
                            <option value="DETAIL">è©³ç´°æ¨¡å¼</option>
                            <option value="SUMMARY">åŒ¯ç¸½æ¨¡å¼</option>
                        </select>
                    </div>

                    {viewMode === 'SUMMARY' ? (
                        <div className="space-y-6">
                            {groupedAssets.map(({ categoryKey: catKey, accounts }) => {
                                const categoryTotalHKD = accounts.reduce((sum, account) => {
                                    const accountTotal = account.items.reduce((itemSum, item) => itemSum + toHKD(item.quantity * item.currentPrice, item.currency), 0);
                                    return sum + accountTotal;
                                }, 0);
                                const categoryTotalDisplay = fromHKD(categoryTotalHKD, displayCurrency);
                                const isLiabilityCategory = Boolean(CATEGORIES[catKey].isNegative);

                                return (
                                    <section key={catKey} className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
                                        <div className="px-6 py-4 border-b border-slate-100 flex items-center justify-between">
                                            <div className="flex items-center gap-2">
                                                <div className={`w-1.5 h-6 rounded-full ${CATEGORIES[catKey].color.replace('text', 'bg')}`}></div>
                                                <h2 className="text-base font-black text-slate-800">{CATEGORIES[catKey].label}</h2>
                                            </div>
                                            <div className={`text-sm font-black ${isLiabilityCategory ? 'text-rose-500' : 'text-slate-700'}`}>
                                                {isLiabilityCategory ? '-' : ''}{formatAmount(Math.abs(categoryTotalDisplay))} {displayCurrency}
                                            </div>
                                        </div>
                                        <div className="divide-y divide-slate-100">
                                            {accounts.map(({ accountName, items }) => {
                                                const accountTotalHKD = items.reduce((sum, item) => sum + toHKD(item.quantity * item.currentPrice, item.currency), 0);
                                                const accountTotalDisplay = fromHKD(accountTotalHKD, displayCurrency);
                                                return (
                                                    <div key={accountName} className="px-6 py-3 flex items-center justify-between">
                                                        <div className="text-sm font-bold text-slate-700">{accountName}</div>
                                                        <div className={`text-sm font-black ${isLiabilityCategory ? 'text-rose-500' : 'text-slate-700'}`}>
                                                            {isLiabilityCategory ? '-' : ''}{formatAmount(Math.abs(accountTotalDisplay))} {displayCurrency}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </section>
                                );
                            })}
                        </div>
                    ) : (
                        <div className="space-y-10">
                            {groupedAssets.map(({ categoryKey: catKey, accounts }) => (
                                <div key={catKey} className="space-y-4">
                                    <div className="flex items-center gap-2 px-2">
                                        <div className={`w-1.5 h-6 rounded-full ${CATEGORIES[catKey].color.replace('text', 'bg')}`}></div>
                                        <h2 className="text-lg font-black text-slate-800">{CATEGORIES[catKey].label}</h2>
                                    </div>

                                    {accounts.map(({ accountName, items }) => {
                                        const accountTotalHKD = items.reduce((sum, item) => sum + toHKD(item.quantity * item.currentPrice, item.currency), 0);
                                        const accountTotalDisplay = fromHKD(accountTotalHKD, displayCurrency);
                                        const isLiabilityCategory = Boolean(CATEGORIES[catKey].isNegative);
                                        const isInvestCategory = catKey === 'INVEST';
                                        const isLiquidCategory = catKey === 'LIQUID';
                                        const isInsuranceCategory = catKey === 'INSURANCE';
                                        const isReceivableCategory = catKey === 'RECEIVABLE';
                                        const isFixedCategory = catKey === 'FIXED';
                                        const accountKey = `${catKey}::${accountName}`;
                                        const isExpanded = expandedAccounts[accountKey] ?? true;

                                        return (
                                        <div key={accountName} className="bg-white rounded-2xl border border-slate-100 overflow-hidden shadow-sm">
                                            <button
                                                type="button"
                                                onClick={() => toggleAccountExpand(catKey, accountName)}
                                                className="w-full bg-slate-50/50 px-6 py-3 border-b border-slate-100 flex items-center justify-between gap-3 text-left"
                                            >
                                                <h3 className="text-xs font-black text-slate-500 uppercase tracking-widest">{accountName}</h3>
                                                <div className="text-right flex items-center gap-3">
                                                    <div>
                                                    <div className="text-[10px] font-black uppercase tracking-widest text-slate-400">å¸³æˆ¶åŒ¯ç¸½</div>
                                                    <div className={`text-sm font-black ${isLiabilityCategory ? 'text-rose-500' : 'text-slate-700'}`}>
                                                        {isLiabilityCategory ? '-' : ''}{formatAmount(Math.abs(accountTotalDisplay))} {displayCurrency}
                                                    </div>
                                                    </div>
                                                </div>
                                            </button>
                                            {isExpanded && (
                                            <>
                                                <div className="md:hidden px-4 pt-4 pb-4 space-y-3">
                                                    {items.map(item => {
                                                        const mktValOrig = item.quantity * item.currentPrice;
                                                        const mktValDisplay = fromHKD(toHKD(mktValOrig, item.currency), displayCurrency);
                                                        const isMortgageLiability = isLiabilityCategory && item.subtype === 'æˆ¿è²¸';
                                                        const isLoanLiability = isLiabilityCategory && item.subtype === 'è²¸æ¬¾';
                                                        const isCreditCardLiability = isLiabilityCategory && item.subtype === 'ä¿¡ç”¨å¡';
                                                        const isPayableLiability = isLiabilityCategory && item.subtype === 'æ‡‰ä»˜æ¬¾';
                                                        const isOtherLiability = isLiabilityCategory && item.subtype === 'å…¶ä»–è² å‚µ';
                                                        const isReceivableItem = isReceivableCategory;
                                                        const isFixedItem = isFixedCategory;
                                                        const amountPrefix = isLiabilityCategory ? '-' : '';
                                                        const highlightClass = isLiabilityCategory ? 'text-rose-500' : 'text-slate-800';

                                                        return (
                                                            <div key={item.id} onClick={() => openEdit(item)} className="rounded-xl border border-slate-100 bg-white shadow-sm p-4 space-y-2">
                                                                <div className="flex items-start justify-between gap-3">
                                                                    <div>
                                                                        <div className="font-black text-slate-800">{item.name}</div>
                                                                        <div className="text-[10px] text-slate-400 font-bold">{CATEGORIES[item.category].label} / {item.subtype}</div>
                                                                    </div>
                                                                    <div className={`text-base font-black ${highlightClass}`}>
                                                                        {amountPrefix}{formatAmount(mktValDisplay)} {displayCurrency}
                                                                    </div>
                                                                </div>
                                                                {isInsuranceCategory && (
                                                                    <div className="text-xs text-slate-500 font-bold">
                                                                        ä¿è²» {formatAmount(item.premiumAmount || 0)} {item.currency} Â· å·²ç¹³ {Number(item.premiumPaidCount || 0)} æœŸ
                                                                    </div>
                                                                )}
                                                                {isMortgageLiability && (
                                                                    <div className="text-xs text-slate-500 font-bold">
                                                                        æ¯æœˆé‚„æ¬¾ {formatAmount(item.monthlyPayment || 0)} {item.currency} Â· å·²é‚„ {Number(item.paidPeriods || 0)} æœŸ
                                                                    </div>
                                                                )}
                                                                {isLoanLiability && (
                                                                    <div className="text-xs text-slate-500 font-bold">
                                                                        æ¯æœˆé‚„æ¬¾ {formatAmount(item.loanMonthlyPayment || 0)} {item.currency} Â· å·²é‚„ {Number(item.loanPaidPeriods || 0)} æœŸ
                                                                    </div>
                                                                )}
                                                                {isCreditCardLiability && (
                                                                    <div className="text-xs text-slate-500 font-bold">
                                                                        æœ€ä½é‚„æ¬¾ {formatAmount(item.creditCardMinPayment || 0)} {item.currency} Â· åˆ°æœŸ {item.creditCardDueDate || 'æœªè¨­å®š'}
                                                                    </div>
                                                                )}
                                                                {isPayableLiability && (
                                                                    <div className="text-xs text-slate-500 font-bold">
                                                                        åˆ°æœŸ {item.payableDueDate || 'æœªè¨­å®š'} Â· {Number(item.payableInstallments || 0) ? `åˆ†æœŸ ${item.payableInstallments} æœŸ` : 'ä¸€æ¬¡æ€§'}
                                                                    </div>
                                                                )}
                                                                {isOtherLiability && (
                                                                    <div className="text-xs text-slate-500 font-bold">
                                                                        å¹´æ¯ {Number(item.otherAnnualRate || 0).toFixed(2)}% Â· åˆ°æœŸ {item.otherDueDate || 'æœªè¨­å®š'}
                                                                    </div>
                                                                )}
                                                                {isReceivableItem && (
                                                                    <div className="text-xs text-slate-500 font-bold">
                                                                        åˆ°æœŸ {item.receivableDueDate || 'æœªè¨­å®š'} Â· {item.receivableParty ? `å°è±¡ ${item.receivableParty}` : 'æœªå¡«å°è±¡'}
                                                                    </div>
                                                                )}
                                                                {isFixedItem && (
                                                                    <div className="text-xs text-slate-500 font-bold">
                                                                        è³¼å…¥ {item.fixedPurchaseDate || 'æœªè¨­å®š'} Â· {item.fixedNote ? item.fixedNote : 'æœªå¡«å‚™è¨»'}
                                                                    </div>
                                                                )}
                                                                {isLiquidCategory && (
                                                                    <div className="space-y-1">
                                                                        <div className="text-xs text-slate-500 font-bold flex items-center gap-2">
                                                                            <span>é¤˜é¡ {formatAmount(item.quantity)}</span>
                                                                            <span className="text-[10px] font-black uppercase tracking-widest px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-600">{item.currency}</span>
                                                                        </div>
                                                                        {cashflowAutoRulesByLiquidAssetId[item.id]?.length > 0 && (
                                                                            <div className="text-[10px] text-indigo-500 font-black">
                                                                                è‡ªå‹•è¦å‰‡ï¼š{cashflowAutoRulesByLiquidAssetId[item.id].slice(0, 2).map(rule => {
                                                                                    const modeLabel = rule.frequency === 'MONTHLY'
                                                                                        ? `æ¯æœˆ${rule.payday || rule.monthday || '--'}è™Ÿ`
                                                                                        : (rule.frequency === 'ONE_TIME' ? 'å–®æ¬¡' : (CASHFLOW_FREQUENCIES.find(entry => entry.value === rule.frequency)?.label || rule.frequency));
                                                                                    return `${rule.title}ï¼ˆ${modeLabel}ï¼‰`;
                                                                                }).join('ã€')}
                                                                                {cashflowAutoRulesByLiquidAssetId[item.id].length > 2 ? ` ç­‰ ${cashflowAutoRulesByLiquidAssetId[item.id].length} ç­†` : ''}
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                )}
                                                                {isInvestCategory && (() => {
                                                                    const costValOrig = item.quantity * item.costBasis;
                                                                    const profitOrig = mktValOrig - costValOrig;
                                                                    const profitDisplay = fromHKD(toHKD(profitOrig, item.currency), displayCurrency);
                                                                    const perf = costValOrig > 0 ? (profitOrig / costValOrig) * 100 : 0;
                                                                    const isFixedDepositItem = item.subtype === 'å®šæœŸå­˜æ¬¾';
                                                                    const fixedDepositMonths = Number(item.fixedDepositMonths || 0);
                                                                    const fixedDepositRate = Number(item.fixedDepositAnnualRate || 0);
                                                                    const fixedDepositStartDate = item.fixedDepositStartDate || '';

                                                                    return (
                                                                        <div className="space-y-1 text-xs font-bold">
                                                                            <div className="text-slate-500">å¸‚å€¼ {formatAmount(mktValDisplay)} {displayCurrency} Â· æ•¸é‡ {formatAmount(item.quantity)} {item.symbol ? `(${item.symbol})` : ''}</div>
                                                                            <div className="text-slate-500">ç¾åƒ¹ {formatAmount(item.currentPrice)} Â· æˆæœ¬ {formatAmount(item.costBasis)} {item.currency}</div>
                                                                            {isFixedDepositItem && (
                                                                                <div className="text-slate-500">å®šæœŸ {fixedDepositMonths || '--'} å€‹æœˆ Â· å¹´åˆ©ç‡ {fixedDepositRate.toFixed(2)}% {fixedDepositStartDate ? `Â· èµ·å­˜ ${fixedDepositStartDate}` : ''}</div>
                                                                            )}
                                                                            <div className={`${profitOrig >= 0 ? 'text-emerald-600' : 'text-rose-600'}`}>
                                                                                <div className="font-black text-sm">æŒå€‰ç›ˆè™§ {profitOrig >= 0 ? '+' : ''}{formatAmount(profitDisplay)} {displayCurrency}</div>
                                                                                <div className="font-bold text-xs">ç¸¾æ•ˆ {perf >= 0 ? '+' : ''}{perf.toFixed(2)}%</div>
                                                                            </div>
                                                                        </div>
                                                                    );
                                                                })()}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                                <div className="hidden md:block overflow-x-auto -mx-4 sm:mx-0">
                                                    <div className="px-4 sm:px-0">
                                                        <div className="text-[10px] text-slate-400 font-black uppercase tracking-widest mb-2 md:hidden">å·¦å³æ»‘å‹•æŸ¥çœ‹å®Œæ•´æ¬„ä½</div>
                                                <table className={`w-full text-left ${isInvestCategory ? 'min-w-[780px]' : isInsuranceCategory ? 'min-w-[700px]' : 'min-w-[620px]'}`}>
                                                    {isLiquidCategory && (
                                                        <colgroup>
                                                            <col style={{ width: '60%' }} />
                                                            <col style={{ width: '20%' }} />
                                                            <col style={{ width: '20%' }} />
                                                        </colgroup>
                                                    )}
                                                    {isInsuranceCategory && (
                                                        <colgroup>
                                                            <col style={{ width: '40%' }} />
                                                            <col style={{ width: '20%' }} />
                                                            <col style={{ width: '20%' }} />
                                                            <col style={{ width: '20%' }} />
                                                        </colgroup>
                                                    )}
                                                    {isInvestCategory && (
                                                        <colgroup>
                                                            <col style={{ width: '30%' }} />
                                                            <col style={{ width: '20%' }} />
                                                            <col style={{ width: '15%' }} />
                                                            <col style={{ width: '20%' }} />
                                                            <col style={{ width: '15%' }} />
                                                        </colgroup>
                                                    )}
                                                    <thead className="text-[10px] font-black text-slate-400 uppercase tracking-tighter bg-slate-50/30">
                                                        <tr>
                                                            <th className="px-6 py-3">åç¨± / ç´°é …</th>
                                                            <th className="px-6 py-3 text-right">{isInsuranceCategory ? 'ä¿è²»è¨­å®š' : isLiquidCategory ? 'æ•¸é‡ / å¹£åˆ¥' : isLiabilityCategory ? 'é‡‘é¡ / æœŸæ•¸' : isReceivableCategory ? 'æ‡‰æ”¶é‡‘é¡ / æœŸæ•¸' : isFixedCategory ? 'ä¼°å€¼ / æˆæœ¬' : 'å¸‚å€¼ / æ•¸é‡'}</th>
                                                            <th className="px-6 py-3 text-right">{isInsuranceCategory ? 'å·²ç¹³æœŸæ•¸' : isLiquidCategory ? 'é¤˜é¡' : isLiabilityCategory ? 'åˆ©ç‡ / åˆ°æœŸ' : isReceivableCategory ? 'åˆ°æœŸ / å°è±¡' : isFixedCategory ? 'è³¼å…¥æ—¥ / å‚™è¨»' : 'ç¾åƒ¹ / æˆæœ¬'}</th>
                                                            {isInsuranceCategory && <th className="px-6 py-3 text-right">ä¿å–®åƒ¹å€¼</th>}
                                                            {isInvestCategory && <th className="px-6 py-3 text-right">æŒå€‰ç›ˆè™§</th>}
                                                            {isInvestCategory && <th className="px-6 py-3 text-right">ç¸¾æ•ˆ</th>}
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y divide-slate-50">
                                                        {items.map(item => {
                                                            const mktValOrig = item.quantity * item.currentPrice;
                                                            const costValOrig = item.quantity * item.costBasis;
                                                            const profitOrig = mktValOrig - costValOrig;
                                                            const mktValDisplay = fromHKD(toHKD(mktValOrig, item.currency), displayCurrency);
                                                            const profitDisplay = fromHKD(toHKD(profitOrig, item.currency), displayCurrency);
                                                            const perf = costValOrig > 0 ? (profitOrig / costValOrig) * 100 : 0;
                                                            const premiumAmount = Number(item.premiumAmount || 0);
                                                            const premiumPaidCount = Number(item.premiumPaidCount || 0);
                                                            const hasPremiumPlan = premiumAmount > 0 && premiumPaidCount >= 0;
                                                            const premiumTotalOrig = premiumAmount * premiumPaidCount;
                                                            const premiumTotalDisplay = fromHKD(toHKD(premiumTotalOrig, item.currency), displayCurrency);
                                                            const isMortgageLiability = isLiabilityCategory && item.subtype === 'æˆ¿è²¸';
                                                            const isLoanLiability = isLiabilityCategory && item.subtype === 'è²¸æ¬¾';
                                                            const isCreditCardLiability = isLiabilityCategory && item.subtype === 'ä¿¡ç”¨å¡';
                                                            const isPayableLiability = isLiabilityCategory && item.subtype === 'æ‡‰ä»˜æ¬¾';
                                                            const isOtherLiability = isLiabilityCategory && item.subtype === 'å…¶ä»–è² å‚µ';
                                                            const isReceivableItem = isReceivableCategory;
                                                            const isFixedItem = isFixedCategory;
                                                            const mortgageDownPaymentDisplay = fromHKD(toHKD(Number(item.downPayment || 0), item.currency), displayCurrency);
                                                            const mortgageLoanDisplay = fromHKD(toHKD(Number(item.loanAmount || costValOrig), item.currency), displayCurrency);
                                                            const mortgageInterestDisplay = fromHKD(toHKD(Number(item.totalInterest || 0), item.currency), displayCurrency);
                                                            const mortgageMonthlyDisplay = fromHKD(toHKD(Number(item.monthlyPayment || 0), item.currency), displayCurrency);
                                                            const mortgageOutstandingDisplay = fromHKD(toHKD(Number(item.outstandingPrincipal || mktValOrig), item.currency), displayCurrency);
                                                            const mortgageAnnualRate = Number(item.annualInterestRate || 0);
                                                            const mortgagePaidPeriods = Number(item.paidPeriods || 0);
                                                            const mortgageTotalPeriods = Number(item.totalPeriods || 0);
                                                            const mortgageRemainingPeriods = Number(item.remainingPeriods || Math.max(0, mortgageTotalPeriods - mortgagePaidPeriods));
                                                            const loanMonthlyDisplay = fromHKD(toHKD(Number(item.loanMonthlyPayment || 0), item.currency), displayCurrency);
                                                            const loanOutstandingDisplay = fromHKD(toHKD(Number(item.loanOutstandingPrincipal || 0), item.currency), displayCurrency);
                                                            const loanTotalInterestDisplay = fromHKD(toHKD(Number(item.loanTotalInterest || 0), item.currency), displayCurrency);
                                                            const loanAnnualRate = Number(item.loanAnnualInterestRate || 0);
                                                            const loanPaidPeriods = Number(item.loanPaidPeriods || 0);
                                                            const loanTotalPeriods = Number(item.loanTotalPeriods || 0);
                                                            const loanRemainingPeriods = Number(item.loanRemainingPeriods || Math.max(0, loanTotalPeriods - loanPaidPeriods));
                                                            const creditCardBalanceDisplay = fromHKD(toHKD(Number(item.creditCardBalance || 0), item.currency), displayCurrency);
                                                            const creditCardMinPaymentDisplay = fromHKD(toHKD(Number(item.creditCardMinPayment || 0), item.currency), displayCurrency);
                                                            const creditCardAnnualRate = Number(item.creditCardAnnualRate || 0);
                                                            const payableAmountDisplay = fromHKD(toHKD(Number(item.payableAmount || 0), item.currency), displayCurrency);
                                                            const payableInstallments = Number(item.payableInstallments || 0);
                                                            const otherOutstandingDisplay = fromHKD(toHKD(Number(item.otherOutstanding || 0), item.currency), displayCurrency);
                                                            const otherAnnualRate = Number(item.otherAnnualRate || 0);
                                                            const receivableAmountDisplay = fromHKD(toHKD(Number(item.receivableAmount || mktValOrig), item.currency), displayCurrency);
                                                            const receivableInstallments = Number(item.receivableInstallments || 0);
                                                            const fixedPurchaseDisplay = fromHKD(toHKD(Number(item.fixedPurchasePrice || costValOrig), item.currency), displayCurrency);
                                                            const fixedCurrentDisplay = fromHKD(toHKD(Number(item.fixedCurrentValue || mktValOrig), item.currency), displayCurrency);
                                                            const isPerfPositive = perf > 0;
                                                            const isPerfNegative = perf < 0;
                                                            const perfClass = isPerfPositive
                                                                ? 'text-emerald-700 bg-emerald-50 ring-emerald-100'
                                                                : isPerfNegative
                                                                    ? 'text-rose-700 bg-rose-50 ring-rose-100'
                                                                    : 'text-slate-600 bg-slate-100 ring-slate-200';
                                                            const perfIcon = isPerfPositive ? 'â†—' : isPerfNegative ? 'â†˜' : 'â€¢';

                                                            return (
                                                                <tr key={item.id} onClick={() => openEdit(item)} className="hover:bg-indigo-50/30 cursor-pointer transition-colors group">
                                                                    <td className="px-6 py-4">
                                                                        <div className="font-bold text-slate-800">{item.name}</div>
                                                                        <div className="text-[10px] text-slate-400 font-medium">{CATEGORIES[item.category].label} / {item.subtype}</div>
                                                                        {isMortgageLiability && (
                                                                            <div className="text-[10px] text-slate-500 font-medium mt-1">
                                                                                é¦–æœŸ {formatAmount(mortgageDownPaymentDisplay)} {displayCurrency} Â· è²¸æ¬¾ {formatAmount(mortgageLoanDisplay)} {displayCurrency} Â· åˆ©æ¯ {formatAmount(mortgageInterestDisplay)} {displayCurrency}
                                                                            </div>
                                                                        )}
                                                                        {isLoanLiability && (
                                                                            <div className="text-[10px] text-slate-500 font-medium mt-1">
                                                                                æœªå„Ÿæœ¬é‡‘ {formatAmount(loanOutstandingDisplay)} {displayCurrency} Â· åˆ©æ¯ {formatAmount(loanTotalInterestDisplay)} {displayCurrency}
                                                                            </div>
                                                                        )}
                                                                        {isReceivableItem && (
                                                                            <div className="text-[10px] text-slate-500 font-medium mt-1">
                                                                                {item.receivableParty ? `å°è±¡ ${item.receivableParty}` : 'æœªå¡«å°è±¡'}
                                                                            </div>
                                                                        )}
                                                                        {isFixedItem && item.fixedNote && (
                                                                            <div className="text-[10px] text-slate-500 font-medium mt-1">
                                                                                {item.fixedNote}
                                                                            </div>
                                                                        )}
                                                                    </td>
                                                                    <td className="px-6 py-4 text-right">
                                                                        {isInsuranceCategory ? (
                                                                            hasPremiumPlan ? (
                                                                                <div className="font-bold text-slate-700">
                                                                                    {formatAmount(premiumAmount)} {item.currency}
                                                                                    <div className="text-[10px] text-slate-400">/{item.premiumFrequency === 'yearly' ? 'æ¯å¹´' : 'æ¯æœˆ'}</div>
                                                                                </div>
                                                                            ) : (
                                                                                <div className="font-bold text-slate-400">--</div>
                                                                            )
                                                                        ) : isLiquidCategory ? (
                                                                            <div className="flex items-center justify-end gap-2">
                                                                                <span className="font-bold text-slate-800 tabular-nums text-right">{formatAmount(item.quantity)}</span>
                                                                                <span className="text-[10px] font-black uppercase tracking-widest px-2 py-1 rounded-full bg-emerald-50 text-emerald-600 w-12 text-center">{item.currency}</span>
                                                                            </div>
                                                                        ) : isMortgageLiability ? (
                                                                            <>
                                                                                <div className="font-bold text-slate-800">{formatAmount(mortgageMonthlyDisplay)} <span className="text-[9px] text-slate-400">{displayCurrency}</span></div>
                                                                                <div className="text-[10px] text-slate-400">{formatAmount(Number(item.monthlyPayment || 0))} {item.currency} Â· å…± {mortgageTotalPeriods} æœŸ</div>
                                                                            </>
                                                                        ) : isLoanLiability ? (
                                                                            <>
                                                                                <div className="font-bold text-slate-800">{formatAmount(loanMonthlyDisplay)} <span className="text-[9px] text-slate-400">{displayCurrency}</span></div>
                                                                                <div className="text-[10px] text-slate-400">{formatAmount(Number(item.loanMonthlyPayment || 0))} {item.currency} Â· å…± {loanTotalPeriods} æœŸ</div>
                                                                            </>
                                                                        ) : isCreditCardLiability ? (
                                                                            <>
                                                                                <div className="font-bold text-slate-800">{formatAmount(creditCardBalanceDisplay)} <span className="text-[9px] text-slate-400">{displayCurrency}</span></div>
                                                                                <div className="text-[10px] text-slate-400">æœ€ä½é‚„æ¬¾ {formatAmount(creditCardMinPaymentDisplay)} {displayCurrency}</div>
                                                                            </>
                                                                        ) : isPayableLiability ? (
                                                                            <>
                                                                                <div className="font-bold text-slate-800">{formatAmount(payableAmountDisplay)} <span className="text-[9px] text-slate-400">{displayCurrency}</span></div>
                                                                                <div className="text-[10px] text-slate-400">{payableInstallments ? `åˆ†æœŸ ${payableInstallments} æœŸ` : 'ä¸€æ¬¡æ€§'}</div>
                                                                            </>
                                                                        ) : isOtherLiability ? (
                                                                            <>
                                                                                <div className="font-bold text-slate-800">{formatAmount(otherOutstandingDisplay)} <span className="text-[9px] text-slate-400">{displayCurrency}</span></div>
                                                                                <div className="text-[10px] text-slate-400">{item.otherDueDate ? `åˆ°æœŸ ${item.otherDueDate}` : 'æœªè¨­å®šåˆ°æœŸæ—¥'}</div>
                                                                            </>
                                                                        ) : isReceivableItem ? (
                                                                            <>
                                                                                <div className="font-bold text-slate-800">{formatAmount(receivableAmountDisplay)} <span className="text-[9px] text-slate-400">{displayCurrency}</span></div>
                                                                                <div className="text-[10px] text-slate-400">{receivableInstallments ? `åˆ†æœŸ ${receivableInstallments} æœŸ` : 'ä¸€æ¬¡æ€§'}</div>
                                                                            </>
                                                                        ) : isFixedItem ? (
                                                                            <>
                                                                                <div className="font-bold text-slate-800">{formatAmount(fixedCurrentDisplay)} <span className="text-[9px] text-slate-400">{displayCurrency}</span></div>
                                                                                <div className="text-[10px] text-slate-400">æˆæœ¬ {formatAmount(fixedPurchaseDisplay)} {displayCurrency}</div>
                                                                            </>
                                                                        ) : (
                                                                            <>
                                                                                <div className="font-bold text-slate-800">{formatAmount(mktValDisplay)} <span className="text-[9px] text-slate-400">{displayCurrency}</span></div>
                                                                                <div className="text-[10px] text-slate-400">{item.quantity.toLocaleString()} {item.symbol ? `(${item.symbol})` : ''}</div>
                                                                            </>
                                                                        )}
                                                                    </td>
                                                                    <td className="px-6 py-4 text-right">
                                                                        {isInsuranceCategory ? (
                                                                            hasPremiumPlan ? (
                                                                                <div className="font-medium text-slate-700">{premiumPaidCount.toLocaleString()} æœŸ</div>
                                                                            ) : (
                                                                                <div className="font-medium text-slate-400">--</div>
                                                                            )
                                                                        ) : isLiquidCategory ? (
                                                                            <>
                                                                                <div className="font-medium text-slate-700">{formatAmount(mktValDisplay)} <span className="text-[9px]">{displayCurrency}</span></div>
                                                                                {cashflowAutoRulesByLiquidAssetId[item.id]?.length > 0 && (
                                                                                    <div className="text-[10px] text-indigo-500 font-black mt-1">
                                                                                        å·²ç¶å®š {cashflowAutoRulesByLiquidAssetId[item.id].length} ç­†è‡ªå‹•å…¥å¸³/æ‰£æ¬¾è¦å‰‡
                                                                                    </div>
                                                                                )}
                                                                            </>
                                                                        ) : isMortgageLiability ? (
                                                                            <>
                                                                                <div className="font-medium text-slate-700">å¹´æ¯ {mortgageAnnualRate.toFixed(2)}%</div>
                                                                                <div className="text-[10px] text-slate-400">å·²é‚„ {mortgagePaidPeriods} æœŸ Â· å°šé¤˜ {mortgageRemainingPeriods} æœŸ</div>
                                                                                <div className="text-[10px] text-slate-400">æœªå„Ÿæœ¬é‡‘ {formatAmount(mortgageOutstandingDisplay)} {displayCurrency}</div>
                                                                            </>
                                                                        ) : isLoanLiability ? (
                                                                            <>
                                                                                <div className="font-medium text-slate-700">å¹´æ¯ {loanAnnualRate.toFixed(2)}%</div>
                                                                                <div className="text-[10px] text-slate-400">å·²é‚„ {loanPaidPeriods} æœŸ Â· å°šé¤˜ {loanRemainingPeriods} æœŸ</div>
                                                                                <div className="text-[10px] text-slate-400">æœªå„Ÿæœ¬é‡‘ {formatAmount(loanOutstandingDisplay)} {displayCurrency}</div>
                                                                            </>
                                                                        ) : isCreditCardLiability ? (
                                                                            <>
                                                                                <div className="font-medium text-slate-700">å¹´æ¯ {creditCardAnnualRate.toFixed(2)}%</div>
                                                                                <div className="text-[10px] text-slate-400">åˆ°æœŸ {item.creditCardDueDate || 'æœªè¨­å®š'}</div>
                                                                            </>
                                                                        ) : isPayableLiability ? (
                                                                            <>
                                                                                <div className="font-medium text-slate-700">åˆ°æœŸ {item.payableDueDate || 'æœªè¨­å®š'}</div>
                                                                                {payableInstallments ? (
                                                                                    <div className="text-[10px] text-slate-400">æ¯æœŸç´„ {formatAmount(payableAmountDisplay / payableInstallments)} {displayCurrency}</div>
                                                                                ) : (
                                                                                    <div className="text-[10px] text-slate-400">ä¸€æ¬¡æ€§æ”¯ä»˜</div>
                                                                                )}
                                                                            </>
                                                                        ) : isOtherLiability ? (
                                                                            <>
                                                                                <div className="font-medium text-slate-700">å¹´æ¯ {otherAnnualRate.toFixed(2)}%</div>
                                                                                <div className="text-[10px] text-slate-400">åˆ°æœŸ {item.otherDueDate || 'æœªè¨­å®š'}</div>
                                                                            </>
                                                                        ) : isReceivableItem ? (
                                                                            <>
                                                                                <div className="font-medium text-slate-700">åˆ°æœŸ {item.receivableDueDate || 'æœªè¨­å®š'}</div>
                                                                                <div className="text-[10px] text-slate-400">{item.receivableParty ? `å°è±¡ ${item.receivableParty}` : 'æœªå¡«å°è±¡'}</div>
                                                                            </>
                                                                        ) : isFixedItem ? (
                                                                            <>
                                                                                <div className="font-medium text-slate-700">è³¼å…¥ {item.fixedPurchaseDate || 'æœªè¨­å®š'}</div>
                                                                                <div className="text-[10px] text-slate-400">{item.fixedNote ? `å‚™è¨» ${item.fixedNote}` : 'æœªå¡«å‚™è¨»'}</div>
                                                                            </>
                                                                        ) : (
                                                                            <>
                                                                                <div className="font-medium text-slate-700">{formatAmount(item.currentPrice)}</div>
                                                                                <div className="text-[10px] text-slate-400">{formatAmount(item.costBasis)} <span className="text-[9px]">{item.currency}</span></div>
                                                                            </>
                                                                        )}
                                                                    </td>
                                                                    {isInsuranceCategory && (
                                                                        <td className="px-6 py-4 text-right">
                                                                            {hasPremiumPlan ? (
                                                                                <>
                                                                                    <div className="font-bold text-slate-800">{formatAmount(premiumTotalDisplay)} <span className="text-[9px] text-slate-400">{displayCurrency}</span></div>
                                                                                    <div className="text-[10px] text-slate-400">{formatAmount(premiumTotalOrig)} {item.currency}</div>
                                                                                </>
                                                                            ) : (
                                                                                <>
                                                                                    <div className="font-bold text-slate-800">{formatAmount(mktValDisplay)} <span className="text-[9px] text-slate-400">{displayCurrency}</span></div>
                                                                                    <div className="text-[10px] text-slate-400">{formatAmount(mktValOrig)} {item.currency}</div>
                                                                                </>
                                                                            )}
                                                                        </td>
                                                                    )}
                                                                    {isInvestCategory && (
                                                                        <td className="px-6 py-4 text-right">
                                                                            <>
                                                                                <div className={`font-bold ${profitOrig >= 0 ? 'text-emerald-500' : 'text-rose-500'}`}>
                                                                                    {profitOrig >= 0 ? '+' : ''}{formatAmount(profitOrig)} {item.currency}
                                                                                </div>
                                                                                <div className="text-[10px] text-slate-400">
                                                                                    ç´„ {formatAmount(profitDisplay)} {displayCurrency}
                                                                                </div>
                                                                            </>
                                                                        </td>
                                                                    )}
                                                                    {isInvestCategory && (
                                                                        <td className="px-6 py-4 text-right">
                                                                            <div className={`inline-flex items-center gap-1.5 text-xs font-black px-2.5 py-1.5 rounded-full ring-1 ${perfClass}`}>
                                                                                <span className="text-[11px] leading-none">{perfIcon}</span>
                                                                                <span>{perf >= 0 ? '+' : ''}{perf.toFixed(2)}%</span>
                                                                            </div>
                                                                        </td>
                                                                    )}
                                                                </tr>
                                                            );
                                                        })}
                                                    </tbody>
                                                </table>
                                                </div>
                                            </div>
                                            </>
                                            )}
                                        </div>
                                    )})}
                                </div>
                            ))}
                        </div>
                    )}

                    {isModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-stretch md:items-center justify-center p-0 md:p-4 modal-overlay">
                            <div className="bg-white w-full h-full md:h-auto md:max-w-xl md:rounded-3xl shadow-2xl overflow-hidden">
                                <div className="px-5 md:px-8 py-4 md:py-6 border-b border-slate-100 flex justify-between items-center sticky top-0 bg-white z-10">
                                    <h3 className="font-black text-xl text-slate-800">{editingId ? 'ç·¨è¼¯è³‡ç”¢' : 'æ–°å¢è³‡ç”¢'}</h3>
                                    <button onClick={() => setIsModalOpen(false)} className="text-slate-400"><i data-lucide="x"></i></button>
                                </div>
                                <form onSubmit={handleSubmit} className="p-5 md:p-8 space-y-4 h-[calc(100vh-96px)] md:h-auto md:max-h-[75vh] overflow-y-auto custom-scrollbar">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                                        <div className={`space-y-1 ${(isLiquidForm && !editingId) ? 'col-span-2' : ''}`}>
                                            <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">å¸³æˆ¶ / æ©Ÿæ§‹</label>
                                            <input required type="text" placeholder="ä¾‹å¦‚ï¼šå¯Œé€”ã€ä¸­éŠ€ã€å¤§è±" className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none ring-2 ring-transparent focus:ring-indigo-100" value={formData.account} onChange={e => setFormData({ ...formData, account: e.target.value })} />
                                            {isLiquidForm && !editingId && <div className="text-[10px] text-slate-400 font-bold">åç¨±å°‡ä¾å¹£ç¨®èˆ‡ç´°é …è‡ªå‹•ç”¢ç”Ÿ</div>}
                                        </div>
                                        {(!isLiquidForm || editingId) && (
                                            <div className="space-y-1">
                                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">è³‡ç”¢åç¨±{isLiquidForm && editingId ? ' (é¸å¡«)' : ''}</label>
                                                <input
                                                    required={!isLiquidForm}
                                                    type="text"
                                                    placeholder={isLiquidForm && editingId ? 'ç•™ç©ºå‰‡è‡ªå‹•ä»¥å¹£ç¨®/ç´°é …å‘½å' : 'ä¾‹å¦‚ï¼šAAPLã€å„²è“„å¸³æˆ¶'}
                                                    className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none ring-2 ring-transparent focus:ring-indigo-100"
                                                    value={formData.name}
                                                    onChange={e => setFormData({ ...formData, name: e.target.value })}
                                                />
                                            </div>
                                        )}
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                                        <div className="space-y-1">
                                            <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">é¡åˆ¥</label>
                                            <select
                                                className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none"
                                                value={formData.category}
                                                onChange={e => {
                                                    const nextCategory = e.target.value;
                                                    setFormData({
                                                        ...formData,
                                                        category: nextCategory,
                                                        subtype: CATEGORIES[nextCategory].subtypes[0],
                                                        symbol: '',
                                                        quantity: '',
                                                        costBasis: '',
                                                        premiumAmount: '',
                                                        premiumPaidCount: '',
                                                        premiumFrequency: 'monthly',
                                                        propertyPrice: '',
                                                        ltvRatio: '',
                                                        annualInterestRate: '',
                                                        mortgageYears: '',
                                                        paidPeriods: '',
                                                        loanPrincipal: '',
                                                        loanYears: '',
                                                        loanPaidPeriods: '',
                                                        loanAnnualInterestRate: '',
                                                        creditCardBalance: '',
                                                        creditCardMinPayment: '',
                                                        creditCardDueDate: '',
                                                        creditCardAnnualRate: '',
                                                        payableAmount: '',
                                                        payableDueDate: '',
                                                        payableInstallments: '',
                                                        otherOutstanding: '',
                                                        otherAnnualRate: '',
                                                        otherDueDate: '',
                                                        receivableAmount: '',
                                                        receivableDueDate: '',
                                                        receivableInstallments: '',
                                                        receivableParty: '',
                                                        fixedPurchasePrice: '',
                                                        fixedCurrentValue: '',
                                                        fixedPurchaseDate: '',
                                                        fixedNote: '',
                                                        fixedDepositPrincipal: '',
                                                        fixedDepositAnnualRate: '',
                                                        fixedDepositMonths: '',
                                                        fixedDepositStartDate: ''
                                                    });
                                                }}
                                            >
                                                {Object.entries(CATEGORIES).map(([key, value]) => <option key={key} value={key}>{value.label}</option>)}
                                            </select>
                                        </div>
                                        <div className="space-y-1">
                                            <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">ç´°é …</label>
                                            <select
                                                className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none"
                                                value={formData.subtype}
                                                onChange={e => {
                                                    const nextSubtype = e.target.value;
                                                    setFormData({
                                                        ...formData,
                                                        subtype: nextSubtype,
                                                        symbol: '',
                                                        premiumAmount: '',
                                                        premiumPaidCount: '',
                                                        premiumFrequency: 'monthly',
                                                        propertyPrice: '',
                                                        ltvRatio: '',
                                                        annualInterestRate: '',
                                                        mortgageYears: '',
                                                        paidPeriods: '',
                                                        loanPrincipal: '',
                                                        loanYears: '',
                                                        loanPaidPeriods: '',
                                                        loanAnnualInterestRate: '',
                                                        creditCardBalance: '',
                                                        creditCardMinPayment: '',
                                                        creditCardDueDate: '',
                                                        creditCardAnnualRate: '',
                                                        payableAmount: '',
                                                        payableDueDate: '',
                                                        payableInstallments: '',
                                                        otherOutstanding: '',
                                                        otherAnnualRate: '',
                                                        otherDueDate: '',
                                                        receivableAmount: '',
                                                        receivableDueDate: '',
                                                        receivableInstallments: '',
                                                        receivableParty: '',
                                                        fixedPurchasePrice: '',
                                                        fixedCurrentValue: '',
                                                        fixedPurchaseDate: '',
                                                        fixedNote: '',
                                                        fixedDepositPrincipal: '',
                                                        fixedDepositAnnualRate: '',
                                                        fixedDepositMonths: '',
                                                        fixedDepositStartDate: ''
                                                    });
                                                }}
                                            >
                                                {CATEGORIES[formData.category].subtypes.map(subtype => <option key={subtype} value={subtype}>{subtype}</option>)}
                                            </select>
                                        </div>
                                    </div>

                                    {!needsPremium && !isMortgageForm && !isLiabilityForm && !isReceivableForm && !isFixedForm && !isFixedDepositForm && (
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                                            <div className="space-y-1">
                                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">{isLiquidForm ? 'é‡‘é¡' : 'æ•¸é‡'}</label>
                                                <input required type="number" step="any" className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" value={formData.quantity} onChange={e => setFormData({ ...formData, quantity: e.target.value })} />
                                            </div>
                                            {!isLiquidForm && (
                                                <div className="space-y-1">
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">æˆæœ¬å–®åƒ¹</label>
                                                    <input required type="number" step="any" className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" value={formData.costBasis} onChange={e => setFormData({ ...formData, costBasis: e.target.value })} />
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {isFixedDepositForm && (
                                        <div className="space-y-4">
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                                                <div className="space-y-1">
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">æœ¬é‡‘</label>
                                                    <input required type="number" step="any" min="0" className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" value={formData.fixedDepositPrincipal} onChange={e => setFormData({ ...formData, fixedDepositPrincipal: e.target.value })} />
                                                </div>
                                                <div className="space-y-1">
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">å¹´åˆ©ç‡ (%)</label>
                                                    <input required type="number" step="any" min="0" className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" value={formData.fixedDepositAnnualRate} onChange={e => setFormData({ ...formData, fixedDepositAnnualRate: e.target.value })} />
                                                </div>
                                                <div className="space-y-1">
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">å­˜æœŸ (æœˆ)</label>
                                                    <input required type="number" step="1" min="1" className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" value={formData.fixedDepositMonths} onChange={e => setFormData({ ...formData, fixedDepositMonths: e.target.value })} />
                                                </div>
                                                <div className="space-y-1">
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">èµ·å­˜æ—¥ (é¸å¡«)</label>
                                                    <input type="date" className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" value={formData.fixedDepositStartDate} onChange={e => setFormData({ ...formData, fixedDepositStartDate: e.target.value })} />
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                                                <div className="space-y-1">
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">é ä¼°åˆ©æ¯</label>
                                                    <div className="w-full p-3 bg-slate-50 rounded-xl font-black text-slate-700">{fixedDepositMetrics ? `${formatAmount(fixedDepositMetrics.interestAmount)} ${formData.currency}` : '--'}</div>
                                                </div>
                                                <div className="space-y-1">
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">åˆ°æœŸæœ¬åˆ©å’Œ</label>
                                                    <div className="w-full p-3 bg-slate-50 rounded-xl font-black text-slate-700">{fixedDepositMetrics ? `${formatAmount(fixedDepositMetrics.maturityAmount)} ${formData.currency}` : '--'}</div>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {isMortgageForm && (
                                        <div className="space-y-4">
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                                                <div className="space-y-1">
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">æ¨“åƒ¹</label>
                                                    <input required type="number" step="any" min="0" className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" value={formData.propertyPrice} onChange={e => setFormData({ ...formData, propertyPrice: e.target.value })} />
                                                </div>
                                                <div className="space-y-1">
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">æŒ‰æ­æˆæ•¸ (%)</label>
                                                    <input required type="number" step="any" min="0" max="100" className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" value={formData.ltvRatio} onChange={e => setFormData({ ...formData, ltvRatio: e.target.value })} />
                                                </div>
                                                <div className="space-y-1">
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">å¹´æ¯ (%)</label>
                                                    <input required type="number" step="any" min="0" className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" value={formData.annualInterestRate} onChange={e => setFormData({ ...formData, annualInterestRate: e.target.value })} />
                                                </div>
                                                <div className="space-y-1">
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">é‚„æ¬¾å¹´é™ (å¹´)</label>
                                                    <input required type="number" step="1" min="1" className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" value={formData.mortgageYears} onChange={e => setFormData({ ...formData, mortgageYears: e.target.value })} />
                                                </div>
                                                <div className="space-y-1">
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">å·²é‚„æ¬¾æœŸæ•¸ (1å€‹æœˆ=1æœŸ)</label>
                                                    <input required type="number" step="1" min="0" className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" value={formData.paidPeriods} onChange={e => setFormData({ ...formData, paidPeriods: e.target.value })} />
                                                </div>
                                                <div className="space-y-1">
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">ç¸½æœŸæ•¸</label>
                                                    <div className="w-full p-3 bg-slate-50 rounded-xl font-black text-slate-700">{mortgageMetrics ? `${mortgageMetrics.totalPeriods} æœŸ` : '--'}</div>
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                                                <div className="space-y-1">
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">é¦–æœŸ</label>
                                                    <div className="w-full p-3 bg-slate-50 rounded-xl font-black text-slate-700">{mortgageMetrics ? `${formatAmount(mortgageMetrics.downPayment)} ${formData.currency}` : '--'}</div>
                                                </div>
                                                <div className="space-y-1">
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">è²¸æ¬¾</label>
                                                    <div className="w-full p-3 bg-slate-50 rounded-xl font-black text-slate-700">{mortgageMetrics ? `${formatAmount(mortgageMetrics.loanAmount)} ${formData.currency}` : '--'}</div>
                                                </div>
                                                <div className="space-y-1">
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">åˆ©æ¯</label>
                                                    <div className="w-full p-3 bg-slate-50 rounded-xl font-black text-slate-700">{mortgageMetrics ? `${formatAmount(mortgageMetrics.totalInterest)} ${formData.currency}` : '--'}</div>
                                                </div>
                                                <div className="space-y-1">
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">æ¯æœˆé‚„æ¬¾</label>
                                                    <div className="w-full p-3 bg-slate-50 rounded-xl font-black text-slate-700">{mortgageMetrics ? `${formatAmount(mortgageMetrics.monthlyPayment)} ${formData.currency}` : '--'}</div>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {isLoanForm && (
                                        <div className="space-y-4">
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                                                <div className="space-y-1">
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">è²¸æ¬¾æœ¬é‡‘</label>
                                                    <input required type="number" step="any" min="0" className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" value={formData.loanPrincipal} onChange={e => setFormData({ ...formData, loanPrincipal: e.target.value })} />
                                                </div>
                                                <div className="space-y-1">
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">å¹´æ¯ (%)</label>
                                                    <input required type="number" step="any" min="0" className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" value={formData.loanAnnualInterestRate} onChange={e => setFormData({ ...formData, loanAnnualInterestRate: e.target.value })} />
                                                </div>
                                                <div className="space-y-1">
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">é‚„æ¬¾å¹´é™ (å¹´)</label>
                                                    <input required type="number" step="1" min="1" className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" value={formData.loanYears} onChange={e => setFormData({ ...formData, loanYears: e.target.value })} />
                                                </div>
                                                <div className="space-y-1">
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">å·²é‚„æ¬¾æœŸæ•¸ (1å€‹æœˆ=1æœŸ)</label>
                                                    <input required type="number" step="1" min="0" className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" value={formData.loanPaidPeriods} onChange={e => setFormData({ ...formData, loanPaidPeriods: e.target.value })} />
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                                                <div className="space-y-1">
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">æ¯æœˆé‚„æ¬¾</label>
                                                    <div className="w-full p-3 bg-slate-50 rounded-xl font-black text-slate-700">{loanMetrics ? `${formatAmount(loanMetrics.monthlyPayment)} ${formData.currency}` : '--'}</div>
                                                </div>
                                                <div className="space-y-1">
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">æœªå„Ÿæœ¬é‡‘</label>
                                                    <div className="w-full p-3 bg-slate-50 rounded-xl font-black text-slate-700">{loanMetrics ? `${formatAmount(loanMetrics.outstandingPrincipal)} ${formData.currency}` : '--'}</div>
                                                </div>
                                                <div className="space-y-1">
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">ç¸½åˆ©æ¯</label>
                                                    <div className="w-full p-3 bg-slate-50 rounded-xl font-black text-slate-700">{loanMetrics ? `${formatAmount(loanMetrics.totalInterest)} ${formData.currency}` : '--'}</div>
                                                </div>
                                                <div className="space-y-1">
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">ç¸½æœŸæ•¸</label>
                                                    <div className="w-full p-3 bg-slate-50 rounded-xl font-black text-slate-700">{loanMetrics ? `${loanMetrics.totalPeriods} æœŸ` : '--'}</div>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {isCreditCardForm && (
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                                            <div className="space-y-1">
                                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">æœ¬æœŸçµæ¬ </label>
                                                <input required type="number" step="any" min="0" className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" value={formData.creditCardBalance} onChange={e => setFormData({ ...formData, creditCardBalance: e.target.value })} />
                                            </div>
                                            <div className="space-y-1">
                                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">æœ€ä½é‚„æ¬¾</label>
                                                <input type="number" step="any" min="0" className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" value={formData.creditCardMinPayment} onChange={e => setFormData({ ...formData, creditCardMinPayment: e.target.value })} />
                                            </div>
                                            <div className="space-y-1">
                                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">åˆ°æœŸæ—¥</label>
                                                <input type="date" className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" value={formData.creditCardDueDate} onChange={e => setFormData({ ...formData, creditCardDueDate: e.target.value })} />
                                            </div>
                                            <div className="space-y-1">
                                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">å¹´æ¯ (%)</label>
                                                <input type="number" step="any" min="0" className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" value={formData.creditCardAnnualRate} onChange={e => setFormData({ ...formData, creditCardAnnualRate: e.target.value })} />
                                            </div>
                                        </div>
                                    )}

                                    {isPayableForm && (
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                                            <div className="space-y-1">
                                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">æ‡‰ä»˜æ¬¾é‡‘é¡</label>
                                                <input required type="number" step="any" min="0" className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" value={formData.payableAmount} onChange={e => setFormData({ ...formData, payableAmount: e.target.value })} />
                                            </div>
                                            <div className="space-y-1">
                                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">åˆ°æœŸæ—¥</label>
                                                <input type="date" className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" value={formData.payableDueDate} onChange={e => setFormData({ ...formData, payableDueDate: e.target.value })} />
                                            </div>
                                            <div className="space-y-1">
                                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">åˆ†æœŸæœŸæ•¸ (é¸å¡«)</label>
                                                <input type="number" step="1" min="0" className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" value={formData.payableInstallments} onChange={e => setFormData({ ...formData, payableInstallments: e.target.value })} />
                                            </div>
                                        </div>
                                    )}

                                    {isOtherLiabilityForm && (
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                                            <div className="space-y-1">
                                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">æœªå„Ÿé‡‘é¡</label>
                                                <input required type="number" step="any" min="0" className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" value={formData.otherOutstanding} onChange={e => setFormData({ ...formData, otherOutstanding: e.target.value })} />
                                            </div>
                                            <div className="space-y-1">
                                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">å¹´æ¯ (%)</label>
                                                <input type="number" step="any" min="0" className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" value={formData.otherAnnualRate} onChange={e => setFormData({ ...formData, otherAnnualRate: e.target.value })} />
                                            </div>
                                            <div className="space-y-1">
                                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">åˆ°æœŸæ—¥</label>
                                                <input type="date" className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" value={formData.otherDueDate} onChange={e => setFormData({ ...formData, otherDueDate: e.target.value })} />
                                            </div>
                                        </div>
                                    )}

                                    {isReceivableForm && (
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                                            <div className="space-y-1">
                                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">æ‡‰æ”¶é‡‘é¡</label>
                                                <input required type="number" step="any" min="0" className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" value={formData.receivableAmount} onChange={e => setFormData({ ...formData, receivableAmount: e.target.value })} />
                                            </div>
                                            <div className="space-y-1">
                                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">åˆ°æœŸæ—¥</label>
                                                <input type="date" className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" value={formData.receivableDueDate} onChange={e => setFormData({ ...formData, receivableDueDate: e.target.value })} />
                                            </div>
                                            <div className="space-y-1">
                                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">åˆ†æœŸæœŸæ•¸ (é¸å¡«)</label>
                                                <input type="number" step="1" min="0" className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" value={formData.receivableInstallments} onChange={e => setFormData({ ...formData, receivableInstallments: e.target.value })} />
                                            </div>
                                            <div className="space-y-1">
                                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">å°è±¡ / å…¬å¸</label>
                                                <input type="text" placeholder="ä¾‹å¦‚ï¼šæŸå…¬å¸ / æŸäºº" className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" value={formData.receivableParty} onChange={e => setFormData({ ...formData, receivableParty: e.target.value })} />
                                            </div>
                                        </div>
                                    )}

                                    {isFixedForm && (
                                        <div className="space-y-4">
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                                                <div className="space-y-1">
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">è³¼å…¥æˆæœ¬</label>
                                                    <input required type="number" step="any" min="0" className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" value={formData.fixedPurchasePrice} onChange={e => setFormData({ ...formData, fixedPurchasePrice: e.target.value })} />
                                                </div>
                                                <div className="space-y-1">
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">ç›®å‰ä¼°å€¼</label>
                                                    <input required type="number" step="any" min="0" className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" value={formData.fixedCurrentValue} onChange={e => setFormData({ ...formData, fixedCurrentValue: e.target.value })} />
                                                </div>
                                                <div className="space-y-1">
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">è³¼å…¥æ—¥æœŸ</label>
                                                    <input type="date" className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" value={formData.fixedPurchaseDate} onChange={e => setFormData({ ...formData, fixedPurchaseDate: e.target.value })} />
                                                </div>
                                                <div className="space-y-1">
                                                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">å‚™è¨»</label>
                                                    <input type="text" placeholder="ä¾‹å¦‚ï¼šåœ°å€ã€è»Šç‰Œæˆ–å‚™è¨»" className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" value={formData.fixedNote} onChange={e => setFormData({ ...formData, fixedNote: e.target.value })} />
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {needsPremium && (
                                        <div className="grid grid-cols-2 gap-4">
                                            <div className="space-y-1">
                                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">æ¯æœŸä¿è²»</label>
                                                <input required type="number" step="any" className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" value={formData.premiumAmount} onChange={e => setFormData({ ...formData, premiumAmount: e.target.value })} />
                                            </div>
                                            <div className="space-y-1">
                                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">ç¹³è²»é€±æœŸ</label>
                                                <select className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" value={formData.premiumFrequency} onChange={e => setFormData({ ...formData, premiumFrequency: e.target.value })}>
                                                    <option value="monthly">æ¯æœˆ</option>
                                                    <option value="yearly">æ¯å¹´</option>
                                                </select>
                                            </div>
                                            <div className="space-y-1">
                                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">å·²ç¹³æœŸæ•¸</label>
                                                <input required type="number" step="1" min="0" className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" value={formData.premiumPaidCount} onChange={e => setFormData({ ...formData, premiumPaidCount: e.target.value })} />
                                            </div>
                                            <div className="space-y-1">
                                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">å·²ç¹³ç¸½ä¿è²»</label>
                                                <div className="w-full p-3 bg-slate-50 rounded-xl font-black text-slate-700">{formatAmount(premiumTotal)} {formData.currency}</div>
                                            </div>
                                        </div>
                                    )}

                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                                        <div className="space-y-1">
                                            <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">è¨ˆåƒ¹å¹£ç¨®</label>
                                            <select className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none" value={formData.currency} onChange={e => setFormData({ ...formData, currency: e.target.value })}>
                                                {CURRENCIES.map(currency => <option key={currency} value={currency}>{currency}</option>)}
                                            </select>
                                        </div>
                                        {(isInvestForm && (isCryptoForm || isStockForm || isFundForm)) && (
                                            <div className="space-y-1">
                                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">
                                                    {isCryptoForm ? 'å¹£ç¨®ä»£è™Ÿ (å¿…å¡«)' : isFundForm ? 'åŸºé‡‘ä»£è™Ÿ (å¿…å¡«)' : 'è‚¡ç¥¨ä»£è™Ÿ (å¿…å¡«)'}
                                                </label>
                                                <input
                                                    required
                                                    type="text"
                                                    placeholder={isCryptoForm ? 'BTC, ETH' : isFundForm ? 'VOO, 0050' : '2330, AAPL'}
                                                    className="w-full p-3 bg-slate-50 rounded-xl font-bold outline-none"
                                                    value={formData.symbol}
                                                    onChange={e => setFormData({ ...formData, symbol: e.target.value.toUpperCase() })}
                                                />
                                            </div>
                                        )}
                                    </div>

                                    {editingId && !isLiquidForm && !needsPremium && !isMortgageForm && !isLiabilityForm && !isReceivableForm && !isFixedForm && !isFixedDepositForm && (
                                        <div className="space-y-1">
                                            <label className="text-[10px] font-black text-indigo-500 uppercase tracking-widest ml-1">ç•¶å‰ç¾åƒ¹ (æ‰‹å‹•ä¿®æ­£)</label>
                                            <input type="number" step="any" className="w-full p-3 bg-indigo-50/50 rounded-xl font-bold outline-none ring-2 ring-indigo-100" value={formData.currentPrice} onChange={e => setFormData({ ...formData, currentPrice: e.target.value })} />
                                        </div>
                                    )}

                                    <div className="flex gap-3 pt-4">
                                        {editingId && (
                                            <button type="button" onClick={() => handleDelete(editingId)} className="flex-1 bg-rose-50 text-rose-600 py-4 rounded-xl font-black hover:bg-rose-100 transition-all">
                                                åˆªé™¤è³‡ç”¢
                                            </button>
                                        )}
                                        <button type="submit" className="flex-[2] bg-slate-900 text-white py-4 rounded-xl font-black hover:bg-indigo-600 transition-all shadow-lg shadow-indigo-100">
                                            {editingId ? 'ç¢ºèªä¿®æ”¹' : 'å„²å­˜è³‡ç”¢'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    <div className="hidden md:block fixed right-4 bottom-5 z-30 pointer-events-none">
                        <div className="max-w-[250px] rounded-2xl border border-pink-100 bg-white/90 backdrop-blur-sm shadow-lg px-3 py-2 prince-talk">
                            <div className="text-[11px] leading-5 font-black text-slate-600">{princeHintMessage}</div>
                        </div>
                        <div className="mt-2 flex items-end justify-end gap-1">
                            <div className="text-2xl prince-sparkle">âœ¨</div>
                            <div className="prince-float w-16 h-16 rounded-2xl bg-gradient-to-br from-pink-200 via-amber-200 to-sky-200 border border-white shadow-md flex items-center justify-center text-3xl">ğŸ¤´ğŸ»</div>
                        </div>
                    </div>

                    <footer className="mt-20 text-center text-pink-300 text-[10px] font-bold uppercase tracking-[0.22em] pb-10">
                        SweetPrinceLedger Â· ç‹å­ç”œç”œå¸³
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>