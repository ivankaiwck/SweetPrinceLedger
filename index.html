<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SweetPrinceLedger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="./constants.js"></script>
    <script src="./utils.js"></script>
    <script src="./market-api.js"></script>
    <script src="./data-utils.js"></script>
    <script src="./report-export.js"></script>
    <script src="./cloud-sync.js"></script>
    <script src="./cashflow-engine.js"></script>
    <script src="./cashflow-apply.js"></script>
    <script src="./cashflow-rules.js"></script>
    <script src="./cashflow-form.js"></script>
    <script src="./asset-actions.js"></script>
    <script type="text/babel" src="./cashflow-form-view.js"></script>
    <script type="text/babel" src="./cashflow-overview-view.js"></script>
    <script type="text/babel" src="./cashflow-rules-view.js"></script>
    <script type="text/babel" src="./asset-modal-view.js"></script>
    <script src="./market-sync.js"></script>
    <script src="./fx-sync.js"></script>
    <script src="./cloud-state-apply.js"></script>
    <script src="./theme-system.js"></script>
    <!-- Lucide åœ–æ¨™ -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="./i18n.js"></script>
    <link rel="stylesheet" href="./theme-bridge.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Comic+Neue:wght@400;700&display=swap');
        body { 
            font-family: 'Comic Neue', 'Noto Sans TC', 'Segoe UI Emoji', 'Noto Color Emoji', 'Apple Color Emoji', sans-serif; 
            background-color: var(--bg-page, #FFF9F5); 
            color: var(--text-main, #5A4A42);
        }
        .theme-header-card {
            border: 1px solid var(--header-border, #FFD1DC);
            background: linear-gradient(90deg, var(--header-bg-start, #FEF5F7), var(--header-bg-mid, #F2FBFD), var(--header-bg-end, #FFF7EC));
        }
        .theme-crown {
            background: linear-gradient(135deg, var(--gold, #E8C39E), var(--primary, #FFB6C1), var(--accent, #A7D8DE));
        }
        .theme-subcard {
            background-color: rgba(255, 255, 255, 0.92);
            border: 1px solid var(--header-border, #FFD1DC);
        }
        .theme-text-main { color: var(--text-main, #5A4A42); }
        .theme-text-sub { color: var(--text-sub, #8C7A6E); }
        .theme-btn-primary { background-color: var(--primary, #FFB6C1); }
        .theme-btn-primary:hover { background-color: var(--primary-hover, #FF9AB5); }
        .theme-btn-accent { background-color: var(--accent, #A7D8DE); }
        .theme-btn-accent:hover { background-color: var(--accent-hover, #8CCFD6); }
        .theme-btn-gold { background-color: var(--gold, #E8C39E); }
        .theme-btn-gold:hover { background-color: var(--gold-hover, #DDB88E); }
        .theme-btn-danger { background-color: var(--danger, #FFB3BA); }
        .theme-btn-danger:hover { background-color: var(--danger-hover, #FFA5AE); }
        .theme-networth-card {
            background: linear-gradient(90deg, var(--card-net-start, #FFB6C1), var(--card-net-mid, #C8B6FF), var(--card-net-end, #A7D8DE));
        }
        .theme-networth-caption { color: rgba(255, 255, 255, 0.88); }
        .theme-networth-card--danger {
            background: linear-gradient(90deg, color-mix(in srgb, var(--danger, #FFB3BA) 88%, #ffffff 12%), color-mix(in srgb, var(--danger, #FFB3BA) 70%, var(--primary, #FFB6C1) 30%));
        }
        .theme-networth-card--early {
            background: linear-gradient(90deg, color-mix(in srgb, var(--primary, #FFB6C1) 80%, #ffffff 20%), color-mix(in srgb, var(--accent, #A7D8DE) 55%, var(--primary, #FFB6C1) 45%));
        }
        .theme-networth-card--growth {
            background: linear-gradient(90deg, color-mix(in srgb, var(--accent, #A7D8DE) 72%, #ffffff 28%), color-mix(in srgb, var(--card-net-mid, #C8B6FF) 60%, var(--accent, #A7D8DE) 40%));
        }
        .theme-networth-card--elite {
            background: linear-gradient(90deg, color-mix(in srgb, var(--gold, #E8C39E) 76%, #ffffff 24%), color-mix(in srgb, var(--card-net-mid, #C8B6FF) 45%, var(--gold, #E8C39E) 55%));
        }
        .theme-summary-card {
            border: 1px solid var(--header-border, #FFD1DC);
            background-color: var(--panel-soft, #FEF5F7);
        }
        .theme-summary-card--danger {
            background-color: color-mix(in srgb, var(--danger, #FFB3BA) 18%, #ffffff 82%);
            border-color: color-mix(in srgb, var(--danger, #FFB3BA) 60%, #ffffff 40%);
        }
        .theme-summary-card--early {
            background-color: color-mix(in srgb, var(--primary, #FFB6C1) 15%, #ffffff 85%);
            border-color: color-mix(in srgb, var(--primary, #FFB6C1) 55%, #ffffff 45%);
        }
        .theme-summary-card--growth {
            background-color: color-mix(in srgb, var(--accent, #A7D8DE) 16%, #ffffff 84%);
            border-color: color-mix(in srgb, var(--accent, #A7D8DE) 50%, #ffffff 50%);
        }
        .theme-summary-card--elite {
            background-color: color-mix(in srgb, var(--gold, #E8C39E) 20%, #ffffff 80%);
            border-color: color-mix(in srgb, var(--gold, #E8C39E) 58%, #ffffff 42%);
        }
        .theme-mix-item {
            border: 1px solid transparent;
        }
        .theme-mix-item:hover {
            background-color: color-mix(in srgb, var(--panel-soft, #FEF5F7) 72%, #ffffff 28%);
        }
        .theme-mix-item--danger-selected {
            background-color: color-mix(in srgb, var(--danger, #FFB3BA) 20%, #ffffff 80%);
            box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--danger, #FFB3BA) 58%, #ffffff 42%);
        }
        .theme-mix-item--early-selected {
            background-color: color-mix(in srgb, var(--primary, #FFB6C1) 20%, #ffffff 80%);
            box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--primary, #FFB6C1) 58%, #ffffff 42%);
        }
        .theme-mix-item--growth-selected {
            background-color: color-mix(in srgb, var(--accent, #A7D8DE) 20%, #ffffff 80%);
            box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--accent, #A7D8DE) 58%, #ffffff 42%);
        }
        .theme-mix-item--elite-selected {
            background-color: color-mix(in srgb, var(--gold, #E8C39E) 22%, #ffffff 78%);
            box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--gold, #E8C39E) 60%, #ffffff 40%);
        }
        /* moved bridge and semantic theme utilities to theme-bridge.css */
        .theme-surface {
            background-color: var(--panel-bg, #FFFFFF);
            border: 1px solid var(--header-border, #FFD1DC);
        }
        .theme-soft-surface {
            background-color: var(--panel-soft, #FEF5F7);
            border: 1px solid var(--header-border, #FFD1DC);
        }
        .theme-input {
            background-color: var(--panel-bg, #FFFFFF);
            border: 1px solid var(--header-border, #FFD1DC);
            color: var(--text-main, #5A4A42);
        }
        .theme-input::placeholder {
            color: var(--text-sub, #8C7A6E);
        }
        .theme-modal-shell {
            background: linear-gradient(180deg, color-mix(in srgb, var(--panel-bg, #FFFFFF) 92%, var(--panel-soft, #FEF5F7) 8%), var(--panel-bg, #FFFFFF));
            border: 1px solid var(--header-border, #FFD1DC);
        }
        .theme-modal-header {
            background: linear-gradient(90deg, color-mix(in srgb, var(--primary, #FFB6C1) 16%, #ffffff 84%), color-mix(in srgb, var(--accent, #A7D8DE) 14%, #ffffff 86%));
            border-bottom: 1px solid var(--header-border, #FFD1DC);
        }
        .theme-modal-title { color: var(--text-main, #5A4A42); }
        .theme-modal-close {
            color: var(--text-sub, #8C7A6E);
            border: 1px solid var(--header-border, #FFD1DC);
            background-color: var(--panel-bg, #FFFFFF);
            border-radius: 12px;
            padding: 6px;
        }
        .theme-form-input {
            background-color: color-mix(in srgb, var(--panel-soft, #FEF5F7) 70%, #ffffff 30%);
            border: 1px solid var(--header-border, #FFD1DC);
            color: var(--text-main, #5A4A42);
        }
        .theme-form-input:focus {
            outline: none;
            border-color: var(--primary, #FFB6C1);
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--primary, #FFB6C1) 30%, transparent 70%);
        }
        .theme-form-output {
            background-color: color-mix(in srgb, var(--panel-soft, #FEF5F7) 78%, #ffffff 22%);
            border: 1px dashed color-mix(in srgb, var(--header-border, #FFD1DC) 80%, #ffffff 20%);
            color: var(--text-main, #5A4A42);
        }
        .theme-form-group {
            background-color: color-mix(in srgb, var(--panel-soft, #FEF5F7) 85%, #ffffff 15%);
            border: 1px solid color-mix(in srgb, var(--header-border, #FFD1DC) 88%, #ffffff 12%);
            border-radius: 1rem;
            padding: 0.9rem;
        }
        .theme-form-group-title {
            display: flex;
            align-items: center;
            gap: 0.45rem;
            font-size: 11px;
            font-weight: 900;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--text-sub, #8C7A6E);
            margin-bottom: 0.65rem;
        }
        .theme-form-group-icon {
            width: 1.4rem;
            height: 1.4rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.6rem;
            background-color: color-mix(in srgb, var(--primary, #FFB6C1) 18%, #ffffff 82%);
            border: 1px solid color-mix(in srgb, var(--header-border, #FFD1DC) 82%, #ffffff 18%);
            font-size: 0.8rem;
            line-height: 1;
        }
        .theme-tab-active {
            background-color: var(--primary, #FFB6C1);
            color: #ffffff;
            border: 1px solid var(--primary, #FFB6C1);
        }
        .theme-tab-inactive {
            background-color: var(--panel-bg, #FFFFFF);
            color: var(--text-sub, #8C7A6E);
            border: 1px solid var(--header-border, #FFD1DC);
        }
        .theme-tab-inactive:hover {
            background-color: var(--panel-soft, #FEF5F7);
        }
        .theme-chip-active {
            background-color: var(--accent, #A7D8DE);
            color: #ffffff;
            border: 1px solid var(--accent, #A7D8DE);
        }
        .theme-chip-inactive {
            background-color: var(--panel-bg, #FFFFFF);
            color: var(--text-sub, #8C7A6E);
            border: 1px solid var(--header-border, #FFD1DC);
        }
        .theme-chip-inactive:hover {
            background-color: var(--panel-soft, #FEF5F7);
        }
        .theme-income-card {
            background-color: color-mix(in srgb, var(--accent, #A7D8DE) 18%, #FFFFFF 82%);
            border: 1px solid color-mix(in srgb, var(--accent, #A7D8DE) 55%, #FFFFFF 45%);
        }
        .theme-expense-card {
            background-color: color-mix(in srgb, var(--danger, #FFB3BA) 18%, #FFFFFF 82%);
            border: 1px solid color-mix(in srgb, var(--danger, #FFB3BA) 55%, #FFFFFF 45%);
        }
        .theme-netflow-card {
            background-color: color-mix(in srgb, var(--primary, #FFB6C1) 16%, #FFFFFF 84%);
            border: 1px solid color-mix(in srgb, var(--primary, #FFB6C1) 55%, #FFFFFF 45%);
        }
        .percento-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            transition: all 0.2s ease;
        }
        .modal-overlay { background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(8px); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #E8C39E; border-radius: 10px; }
        @keyframes princeFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }
        @keyframes princeSparkle {
            0%, 100% { opacity: 0.5; transform: scale(0.9); }
            50% { opacity: 1; transform: scale(1.08); }
        }
        @keyframes princeTalk {
            0% { transform: translateY(6px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        .prince-float { animation: princeFloat 3.2s ease-in-out infinite; }
        .prince-sparkle { animation: princeSparkle 1.8s ease-in-out infinite; }
        .prince-talk { animation: princeTalk .35s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const {
            CURRENCIES,
            DEFAULT_RATES,
            STORAGE_KEYS,
            FIREBASE_CONFIG,
            CLOUD_COLLECTION,
            hasFirebaseConfig,
            firebaseApp,
            firebaseAuth,
            firebaseDB,
            isCloudEnabled,
            CATEGORIES,
            CRYPTO_ID_MAP,
            CATEGORY_MIX_STYLES,
            CATEGORY_KEYS,
            INVEST_CHART_COLORS,
            CASHFLOW_TYPES,
            CASHFLOW_SCHEDULE_TYPES,
            CASHFLOW_FREQUENCIES,
            WEEKDAY_LABELS,
            CASHFLOW_CATEGORY_OPTIONS,
            CASHFLOW_CATEGORY_BY_TYPE,
            getDefaultCashflowCategory,
            ONE_DAY_MS
        } = window.APP_CONSTANTS || {};
        if (!CURRENCIES || !DEFAULT_RATES || !STORAGE_KEYS || !CATEGORIES || !CASHFLOW_TYPES) {
            throw new Error('constants.js is missing or incomplete.');
        }
        const {
            PAGE_LANGUAGE_OPTIONS,
            UI_TEXT,
            FULL_PAGE_TEXT_MAP,
            HEADER_SLOGANS,
            IDLE_HINT_LINES
        } = window.APP_I18N || {};
        if (!PAGE_LANGUAGE_OPTIONS || !UI_TEXT || !FULL_PAGE_TEXT_MAP || !HEADER_SLOGANS || !IDLE_HINT_LINES) {
            throw new Error('i18n.js is missing or incomplete.');
        }
        const {
            polarToCartesian,
            describeArc,
            seedAssets,
            parseStorage,
            sanitizeCurrencyRates,
            toHKD,
            fromHKD,
            formatAmount,
            getNetWorthTier,
            calculateMortgageMetrics,
            calculateInstallmentLoanMetrics,
            calculateFixedDepositMetrics,
            pad2,
            toDateKey,
            toMonthKey,
            parseDateKey,
            normalizeDateKeyOrFallback,
            parseOccurrenceDateFromPostingKey,
            sanitizeCashflowEntries,
            isEntryOnDate,
            findNextOccurrenceDateKey,
            findLastOccurrenceDateKey,
            ensureJsPdfReady,
            ensureHtml2CanvasReady
        } = window.APP_UTILS || {};
        if (!polarToCartesian || !describeArc || !parseStorage || !sanitizeCurrencyRates || !toDateKey || !parseDateKey || !sanitizeCashflowEntries || !ensureJsPdfReady || !ensureHtml2CanvasReady) {
            throw new Error('utils.js is missing or incomplete.');
        }

        const {
            normalizeYahooSymbol,
            fetchLatestCurrencyRates,
            fetchYahooQuotes,
            fetchCryptoQuotes
        } = window.APP_MARKET_API || {};
        if (!normalizeYahooSymbol || !fetchLatestCurrencyRates || !fetchYahooQuotes || !fetchCryptoQuotes) {
            throw new Error('market-api.js is missing or incomplete.');
        }

        const {
            normalizeAssetRecord,
            isValidAssetRecord,
            isValidCashflowRecord,
            buildBackupPayload,
            downloadJsonFile,
            parseImportedBackup
        } = window.APP_DATA_UTILS || {};
        if (!normalizeAssetRecord || !isValidAssetRecord || !isValidCashflowRecord || !buildBackupPayload || !downloadJsonFile || !parseImportedBackup) {
            throw new Error('data-utils.js is missing or incomplete.');
        }

        const {
            exportAssetReportPdf
        } = window.APP_REPORT_EXPORT || {};
        if (!exportAssetReportPdf) {
            throw new Error('report-export.js is missing or incomplete.');
        }

        const {
            buildCloudSyncPayload,
            downloadCloudData,
            uploadCloudData,
            loginWithGoogle,
            logoutGoogle
        } = window.APP_CLOUD_SYNC || {};
        if (!buildCloudSyncPayload || !downloadCloudData || !uploadCloudData || !loginWithGoogle || !logoutGoogle) {
            throw new Error('cloud-sync.js is missing or incomplete.');
        }

        const {
            buildCashflowMonthData,
            buildCashflowYearData
        } = window.APP_CASHFLOW_ENGINE || {};
        if (!buildCashflowMonthData || !buildCashflowYearData) {
            throw new Error('cashflow-engine.js is missing or incomplete.');
        }

        const {
            applyAutoCashflowPostings
        } = window.APP_CASHFLOW_APPLY || {};
        if (!applyAutoCashflowPostings) {
            throw new Error('cashflow-apply.js is missing or incomplete.');
        }

        const {
            collectCashflowDeleteContext,
            rollbackCashflowPostingsOnLiquidAssets
        } = window.APP_CASHFLOW_RULES || {};
        if (!collectCashflowDeleteContext || !rollbackCashflowPostingsOnLiquidAssets) {
            throw new Error('cashflow-rules.js is missing or incomplete.');
        }

        const {
            buildCashflowSubmission,
            buildCashflowSubmitStatus,
            buildCashflowFormFromEntry
        } = window.APP_CASHFLOW_FORM || {};
        if (!buildCashflowSubmission || !buildCashflowSubmitStatus || !buildCashflowFormFromEntry) {
            throw new Error('cashflow-form.js is missing or incomplete.');
        }

        const {
            buildAssetSubmission,
            buildAssetDeleteResult
        } = window.APP_ASSET_ACTIONS || {};
        if (!buildAssetSubmission || !buildAssetDeleteResult) {
            throw new Error('asset-actions.js is missing or incomplete.');
        }

        const {
            CashflowRuleForm
        } = window.APP_CASHFLOW_FORM_VIEW || {};
        if (!CashflowRuleForm) {
            throw new Error('cashflow-form-view.js is missing or incomplete.');
        }

        const {
            CashflowOverviewView
        } = window.APP_CASHFLOW_OVERVIEW_VIEW || {};
        if (!CashflowOverviewView) {
            throw new Error('cashflow-overview-view.js is missing or incomplete.');
        }

        const {
            CashflowRulesView
        } = window.APP_CASHFLOW_RULES_VIEW || {};
        if (!CashflowRulesView) {
            throw new Error('cashflow-rules-view.js is missing or incomplete.');
        }

        const {
            AssetModalView
        } = window.APP_ASSET_MODAL_VIEW || {};
        if (!AssetModalView) {
            throw new Error('asset-modal-view.js is missing or incomplete.');
        }

        const {
            buildMarketTargets,
            applyQuotePricesToAssets
        } = window.APP_MARKET_SYNC || {};
        if (!buildMarketTargets || !applyQuotePricesToAssets) {
            throw new Error('market-sync.js is missing or incomplete.');
        }

        const {
            refreshCurrencyRatesWithStamp
        } = window.APP_FX_SYNC || {};
        if (!refreshCurrencyRatesWithStamp) {
            throw new Error('fx-sync.js is missing or incomplete.');
        }

        const {
            applyHydratedCloudSnapshot
        } = window.APP_CLOUD_STATE_APPLY || {};
        if (!applyHydratedCloudSnapshot) {
            throw new Error('cloud-state-apply.js is missing or incomplete.');
        }

        const {
            THEME_OPTIONS,
            applyTheme
        } = window.APP_THEME_SYSTEM || {};
        if (!THEME_OPTIONS || !applyTheme) {
            throw new Error('theme-system.js is missing or incomplete.');
        }

        function App() {
            const FIELD_LABEL_CLASS = 'text-[10px] font-black theme-text-sub uppercase tracking-widest ml-1';
            const CASHFLOW_INPUT_CLASS = 'w-full p-3 bg-white rounded-xl font-bold outline-none';
            const CASHFLOW_INPUT_FOCUS_CLASS = `${CASHFLOW_INPUT_CLASS} ring-2 ring-transparent focus:ring-indigo-100`;
            const MODAL_INPUT_CLASS = 'w-full p-3 theme-form-input rounded-xl font-bold';
            const MODAL_INPUT_FOCUS_CLASS = MODAL_INPUT_CLASS;
            const MODAL_OUTPUT_CLASS = 'w-full p-3 theme-form-output rounded-xl font-black';
            const MODAL_GROUP_CLASS = 'theme-form-group';
            const updateFormField = (field) => (event) => setFormData(prev => ({ ...prev, [field]: event.target.value }));
            const updateFormFieldUpper = (field) => (event) => setFormData(prev => ({ ...prev, [field]: event.target.value.toUpperCase() }));

            const createInitialAssetFormData = () => ({
                account: '',
                name: '',
                category: 'LIQUID',
                subtype: 'ç¾é‡‘',
                symbol: '',
                quantity: '',
                costBasis: '',
                currency: 'HKD',
                premiumAmount: '',
                premiumFrequency: 'monthly',
                premiumPaidCount: '',
                propertyPrice: '',
                ltvRatio: '',
                annualInterestRate: '',
                mortgageYears: '',
                paidPeriods: '',
                loanPrincipal: '',
                loanYears: '',
                loanPaidPeriods: '',
                loanAnnualInterestRate: '',
                creditCardBalance: '',
                creditCardMinPayment: '',
                creditCardDueDate: '',
                creditCardAnnualRate: '',
                payableAmount: '',
                payableDueDate: '',
                payableInstallments: '',
                otherOutstanding: '',
                otherAnnualRate: '',
                otherDueDate: '',
                receivableAmount: '',
                receivableDueDate: '',
                receivableInstallments: '',
                receivableParty: '',
                fixedPurchasePrice: '',
                fixedCurrentValue: '',
                fixedPurchaseDate: '',
                fixedNote: '',
                fixedDepositPrincipal: '',
                fixedDepositAnnualRate: '',
                fixedDepositMonths: '',
                fixedDepositStartDate: ''
            });
            const ASSET_FORM_DETAIL_RESET_FIELDS = {
                symbol: '',
                quantity: '',
                costBasis: '',
                premiumAmount: '',
                premiumPaidCount: '',
                premiumFrequency: 'monthly',
                propertyPrice: '',
                ltvRatio: '',
                annualInterestRate: '',
                mortgageYears: '',
                paidPeriods: '',
                loanPrincipal: '',
                loanYears: '',
                loanPaidPeriods: '',
                loanAnnualInterestRate: '',
                creditCardBalance: '',
                creditCardMinPayment: '',
                creditCardDueDate: '',
                creditCardAnnualRate: '',
                payableAmount: '',
                payableDueDate: '',
                payableInstallments: '',
                otherOutstanding: '',
                otherAnnualRate: '',
                otherDueDate: '',
                receivableAmount: '',
                receivableDueDate: '',
                receivableInstallments: '',
                receivableParty: '',
                fixedPurchasePrice: '',
                fixedCurrentValue: '',
                fixedPurchaseDate: '',
                fixedNote: '',
                fixedDepositPrincipal: '',
                fixedDepositAnnualRate: '',
                fixedDepositMonths: '',
                fixedDepositStartDate: ''
            };
            const buildFormDataFromAsset = (asset) => ({
                ...createInitialAssetFormData(),
                ...asset,
                premiumFrequency: asset?.premiumFrequency ?? 'monthly'
            });

            const [assets, setAssets] = useState(() => parseStorage(STORAGE_KEYS.assets, seedAssets));
            const [displayCurrency, setDisplayCurrency] = useState(() => parseStorage(STORAGE_KEYS.displayCurrency, 'HKD'));
            const [monthlySnapshots, setMonthlySnapshots] = useState(() => parseStorage(STORAGE_KEYS.monthlySnapshots, {}));
            const [cashflowEntries, setCashflowEntries] = useState(() => sanitizeCashflowEntries(parseStorage(STORAGE_KEYS.cashflowEntries, [])));
            const [cashflowAppliedOccurrenceKeys, setCashflowAppliedOccurrenceKeys] = useState(() => {
                const raw = parseStorage(STORAGE_KEYS.cashflowAppliedOccurrenceKeys, []);
                return Array.isArray(raw) ? raw.filter(item => typeof item === 'string') : [];
            });
            const [cashflowAppliedPostings, setCashflowAppliedPostings] = useState(() => {
                const raw = parseStorage(STORAGE_KEYS.cashflowAppliedPostings, {});
                if (!raw || typeof raw !== 'object' || Array.isArray(raw)) return {};
                const next = {};
                Object.entries(raw).forEach(([key, value]) => {
                    if (!key || !value || typeof value !== 'object') return;
                    const signedAmount = Number(value.signedAmount);
                    if (!Number.isFinite(signedAmount)) return;
                    next[key] = {
                        entryId: typeof value.entryId === 'string' ? value.entryId : '',
                        targetLiquidAssetId: typeof value.targetLiquidAssetId === 'string' ? value.targetLiquidAssetId : '',
                        signedAmount,
                        targetCurrency: typeof value.targetCurrency === 'string' ? value.targetCurrency : '',
                        type: value.type === 'INCOME' ? 'INCOME' : 'EXPENSE'
                    };
                });
                return next;
            });
            const [cashflowLastAutoApplyDate, setCashflowLastAutoApplyDate] = useState(() => normalizeDateKeyOrFallback(
                parseStorage(STORAGE_KEYS.cashflowLastAutoApplyDate, ''),
                new Date(Date.now() - ONE_DAY_MS)
            ));
            const [currencyRates, setCurrencyRates] = useState(() => sanitizeCurrencyRates(parseStorage(STORAGE_KEYS.currencyRates, DEFAULT_RATES)));
            const [lastRateUpdate, setLastRateUpdate] = useState(() => {
                const saved = Number(parseStorage(STORAGE_KEYS.currencyRatesUpdatedAt, 0));
                return Number.isFinite(saved) && saved > 0 ? new Date(saved) : null;
            });
            const [authUser, setAuthUser] = useState(null);
            const [isAuthLoading, setIsAuthLoading] = useState(isCloudEnabled);
            const [isCloudSyncing, setIsCloudSyncing] = useState(false);
            const [cloudStatus, setCloudStatus] = useState(isCloudEnabled ? 'å°šæœªç™»å…¥ Googleï¼Œè³‡æ–™åƒ…å­˜åœ¨æ­¤è£ç½®' : 'æœªè¨­å®š Firebaseï¼Œè³‡æ–™åƒ…å­˜åœ¨æ­¤è£ç½®');

            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [selectedCategories, setSelectedCategories] = useState(CATEGORY_KEYS);
            const [sortMode, setSortMode] = useState('AMOUNT_DESC');
            const [viewMode, setViewMode] = useState('DETAIL');
            const [isUpdatingPrice, setIsUpdatingPrice] = useState(false);
            const [isUpdatingRates, setIsUpdatingRates] = useState(false);
            const [isGeneratingPdf, setIsGeneratingPdf] = useState(false);
            const [priceStatus, setPriceStatus] = useState('');
            const [lastPriceUpdate, setLastPriceUpdate] = useState(null);
            const [showSettings, setShowSettings] = useState(false);
            const [pageLanguage, setPageLanguage] = useState(() => {
                const saved = parseStorage(STORAGE_KEYS.pageLanguage, 'zh-Hant');
                return PAGE_LANGUAGE_OPTIONS.some(item => item.value === saved) ? saved : 'zh-Hant';
            });
            const [themeId, setThemeId] = useState(() => {
                const saved = parseStorage(STORAGE_KEYS.themeId, 'macaron-prince');
                return THEME_OPTIONS.some(item => item.value === saved) ? saved : 'macaron-prince';
            });
            const [headerSloganIndex, setHeaderSloganIndex] = useState(0);
            const [princeIdleIndex, setPrinceIdleIndex] = useState(0);
            const [selectedMixCategory, setSelectedMixCategory] = useState('INVEST');
            const [expandedAccounts, setExpandedAccounts] = useState({});
            const [selectedStatsCategory, setSelectedStatsCategory] = useState('INVEST');
            const [selectedStatsAccount, setSelectedStatsAccount] = useState('');
            const [selectedStatsSegmentKey, setSelectedStatsSegmentKey] = useState('');
            const [statsBreakdownMode, setStatsBreakdownMode] = useState('ACCOUNT');
            const [financeSectionTab, setFinanceSectionTab] = useState('ASSET_ACCOUNT');
            const [cashflowView, setCashflowView] = useState('MONTH');
            const [selectedCashflowMonth, setSelectedCashflowMonth] = useState(() => toMonthKey(new Date()));
            const [editingCashflowId, setEditingCashflowId] = useState('');
            const [cashflowRuleKeyword, setCashflowRuleKeyword] = useState('');
            const [cashflowRuleFilter, setCashflowRuleFilter] = useState('ALL');
            const [cashflowRuleSortMode, setCashflowRuleSortMode] = useState('START_DESC');
            const [cashflowRulesVisibleCount, setCashflowRulesVisibleCount] = useState(20);
            const [cashflowForm, setCashflowForm] = useState(() => {
                const today = toDateKey(new Date());
                return {
                    title: '',
                    account: '',
                    category: getDefaultCashflowCategory('INCOME'),
                    type: 'INCOME',
                    scheduleType: 'RECURRING',
                    amount: '',
                    currency: 'HKD',
                    frequency: 'MONTHLY',
                    startDate: today,
                    endDate: '',
                    payday: '25',
                    targetLiquidAssetId: '',
                    note: ''
                };
            });
            const updateCashflowField = (field) => (event) => setCashflowForm(prev => ({ ...prev, [field]: event.target.value }));
            const updateCashflowType = (event) => {
                const nextType = event.target.value;
                setCashflowForm(prev => ({
                    ...prev,
                    type: nextType,
                    category: getDefaultCashflowCategory(nextType)
                }));
            };
            const updateCashflowTargetLiquidAsset = (event) => {
                const nextId = event.target.value;
                const selected = liquidAssetOptions.find(option => option.id === nextId) || null;
                setCashflowForm(prev => ({
                    ...prev,
                    targetLiquidAssetId: nextId,
                    account: selected?.account || prev.account
                }));
            };

            const [formData, setFormData] = useState(() => createInitialAssetFormData());
            const importInputRef = useRef(null);
            const cashflowFormRef = useRef(null);

            const handleAssetCategoryChange = (event) => {
                const nextCategory = event.target.value;
                setFormData(prev => ({
                    ...prev,
                    category: nextCategory,
                    subtype: CATEGORIES[nextCategory].subtypes[0],
                    ...ASSET_FORM_DETAIL_RESET_FIELDS
                }));
            };

            const handleAssetSubtypeChange = (event) => {
                const nextSubtype = event.target.value;
                setFormData(prev => ({
                    ...prev,
                    subtype: nextSubtype,
                    ...ASSET_FORM_DETAIL_RESET_FIELDS
                }));
            };

            const isLiquidForm = formData.category === 'LIQUID';
            const isInvestForm = formData.category === 'INVEST';
            const isCryptoForm = isInvestForm && formData.subtype === 'åŠ å¯†è²¨å¹£';
            const isStockForm = isInvestForm && formData.subtype === 'è‚¡ç¥¨';
            const isFundForm = isInvestForm && formData.subtype === 'åŸºé‡‘';
            const isFixedDepositForm = isInvestForm && formData.subtype === 'å®šæœŸå­˜æ¬¾';
            const isInsuranceForm = formData.category === 'INSURANCE';
            const isLiabilityForm = formData.category === 'LIABILITY';
            const isReceivableForm = formData.category === 'RECEIVABLE';
            const isFixedForm = formData.category === 'FIXED';
            const isMortgageForm = isLiabilityForm && formData.subtype === 'æˆ¿è²¸';
            const isLoanForm = isLiabilityForm && formData.subtype === 'è²¸æ¬¾';
            const isCreditCardForm = isLiabilityForm && formData.subtype === 'ä¿¡ç”¨å¡';
            const isPayableForm = isLiabilityForm && formData.subtype === 'æ‡‰ä»˜æ¬¾';
            const isOtherLiabilityForm = isLiabilityForm && formData.subtype === 'å…¶ä»–è² å‚µ';
            const needsPremium = isInsuranceForm && ['äººå£½/ç´¯ç©è²¡å¯Œ', 'å¥åº·'].includes(formData.subtype);
            const premiumTotal = (Number(formData.premiumAmount) || 0) * (Number(formData.premiumPaidCount) || 0);
            const mortgageMetrics = isMortgageForm ? calculateMortgageMetrics(formData) : null;
            const loanMetrics = isLoanForm ? calculateInstallmentLoanMetrics({
                loanPrincipal: formData.loanPrincipal,
                annualInterestRate: formData.loanAnnualInterestRate,
                loanYears: formData.loanYears,
                paidPeriods: formData.loanPaidPeriods
            }) : null;
            const fixedDepositMetrics = isFixedDepositForm ? calculateFixedDepositMetrics({
                principal: formData.fixedDepositPrincipal,
                annualInterestRate: formData.fixedDepositAnnualRate,
                months: formData.fixedDepositMonths
            }) : null;

            const assetsRef = useRef(assets);
            useEffect(() => { assetsRef.current = assets; }, [assets]);

            const toHKD = (amount, currency) => amount / (currencyRates[currency] || 1);
            const fromHKD = (amountHKD, currency) => amountHKD * (currencyRates[currency] || 1);

            useEffect(() => {
                localStorage.setItem(STORAGE_KEYS.assets, JSON.stringify(assets));
            }, [assets]);

            useEffect(() => {
                localStorage.setItem(STORAGE_KEYS.displayCurrency, JSON.stringify(displayCurrency));
            }, [displayCurrency]);

            useEffect(() => {
                localStorage.setItem(STORAGE_KEYS.currencyRates, JSON.stringify(currencyRates));
            }, [currencyRates]);

            useEffect(() => {
                localStorage.setItem(STORAGE_KEYS.cashflowEntries, JSON.stringify(cashflowEntries));
            }, [cashflowEntries]);

            useEffect(() => {
                localStorage.setItem(STORAGE_KEYS.cashflowAppliedOccurrenceKeys, JSON.stringify(cashflowAppliedOccurrenceKeys));
            }, [cashflowAppliedOccurrenceKeys]);

            useEffect(() => {
                localStorage.setItem(STORAGE_KEYS.cashflowAppliedPostings, JSON.stringify(cashflowAppliedPostings));
            }, [cashflowAppliedPostings]);

            useEffect(() => {
                localStorage.setItem(STORAGE_KEYS.cashflowLastAutoApplyDate, JSON.stringify(cashflowLastAutoApplyDate));
            }, [cashflowLastAutoApplyDate]);

            useEffect(() => {
                const stamp = lastRateUpdate instanceof Date ? lastRateUpdate.getTime() : 0;
                localStorage.setItem(STORAGE_KEYS.currencyRatesUpdatedAt, JSON.stringify(stamp));
            }, [lastRateUpdate]);

            useEffect(() => {
                localStorage.setItem(STORAGE_KEYS.pageLanguage, JSON.stringify(pageLanguage));
            }, [pageLanguage]);

            useEffect(() => {
                const appliedThemeId = applyTheme(themeId);
                if (appliedThemeId !== themeId) {
                    setThemeId(appliedThemeId);
                    return;
                }
                localStorage.setItem(STORAGE_KEYS.themeId, JSON.stringify(appliedThemeId));
            }, [themeId]);

            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [assets, isModalOpen, selectedCategories, sortMode, isUpdatingPrice]);

            const pageText = useMemo(() => UI_TEXT[pageLanguage] || UI_TEXT['zh-Hant'], [pageLanguage]);
            const tByLang = (zh, en, ja) => (pageLanguage === 'en-US' ? en : (pageLanguage === 'ja-JP' ? ja : zh));
            const appName = useMemo(() => {
                if (pageLanguage === 'zh-Hant') return 'çŽ‹å­ç”œç”œå¸³';
                if (pageLanguage === 'ja-JP') return 'çŽ‹å­ã‚ã¾å¸³';
                return 'SweetPrinceLedger';
            }, [pageLanguage]);
            const headerSlogans = useMemo(() => HEADER_SLOGANS[pageLanguage] || HEADER_SLOGANS['zh-Hant'], [pageLanguage]);
            const idleHintLines = useMemo(() => IDLE_HINT_LINES[pageLanguage] || IDLE_HINT_LINES['zh-Hant'], [pageLanguage]);
            const currentHeaderSlogan = headerSlogans[headerSloganIndex % Math.max(headerSlogans.length, 1)] || '';
            const currentIdleHint = idleHintLines[princeIdleIndex % Math.max(idleHintLines.length, 1)] || '';

            useEffect(() => {
                document.documentElement.lang = pageLanguage;
            }, [pageLanguage]);

            useEffect(() => {
                document.title = appName;
            }, [appName]);

            useEffect(() => {
                if (pageLanguage === 'zh-Hant') return;
                const root = document.getElementById('root');
                if (!root) return;

                const dictionary = FULL_PAGE_TEXT_MAP[pageLanguage] || {};
                if (!Object.keys(dictionary).length) return;

                let applying = false;
                const applyFullPageTranslation = () => {
                    if (applying) return;
                    applying = true;

                    const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT);
                    const textNodes = [];
                    let current = walker.nextNode();
                    while (current) {
                        textNodes.push(current);
                        current = walker.nextNode();
                    }

                    textNodes.forEach(node => {
                        if (!node || !node.nodeValue) return;
                        const original = node.nodeValue;
                        const trimmed = original.trim();
                        if (!trimmed) return;
                        const translated = dictionary[trimmed];
                        if (!translated || translated === trimmed) return;
                        const leading = original.match(/^\s*/)?.[0] || '';
                        const trailing = original.match(/\s*$/)?.[0] || '';
                        node.nodeValue = `${leading}${translated}${trailing}`;
                    });

                    root.querySelectorAll('[placeholder]').forEach(el => {
                        const val = el.getAttribute('placeholder') || '';
                        const translated = dictionary[val.trim()];
                        if (translated) el.setAttribute('placeholder', translated);
                    });

                    root.querySelectorAll('[title]').forEach(el => {
                        const val = el.getAttribute('title') || '';
                        const translated = dictionary[val.trim()];
                        if (translated) el.setAttribute('title', translated);
                    });

                    root.querySelectorAll('[aria-label]').forEach(el => {
                        const val = el.getAttribute('aria-label') || '';
                        const translated = dictionary[val.trim()];
                        if (translated) el.setAttribute('aria-label', translated);
                    });

                    applying = false;
                };

                applyFullPageTranslation();
                const observer = new MutationObserver(() => applyFullPageTranslation());
                observer.observe(root, { childList: true, subtree: true, characterData: true, attributes: true, attributeFilter: ['placeholder', 'title', 'aria-label'] });
                return () => observer.disconnect();
            }, [pageLanguage, assets, cashflowEntries, financeSectionTab, isModalOpen, editingId, editingCashflowId, showSettings]);

            useEffect(() => {
                setHeaderSloganIndex(0);
                setPrinceIdleIndex(0);
            }, [pageLanguage]);

            useEffect(() => {
                const timer = setInterval(() => {
                    setHeaderSloganIndex(prev => (prev + 1) % Math.max(headerSlogans.length, 1));
                }, 5000);
                return () => clearInterval(timer);
            }, [headerSlogans]);

            useEffect(() => {
                const timer = setInterval(() => {
                    setPrinceIdleIndex(prev => (prev + 1) % Math.max(idleHintLines.length, 1));
                }, 8000);
                return () => clearInterval(timer);
            }, [idleHintLines]);

            const princeHintMessage = useMemo(() => {
                if (isGeneratingPdf) {
                    return pageLanguage === 'en-US' ? 'ðŸ“œ The Prince is preparing your PDF report...' : (pageLanguage === 'ja-JP' ? 'ðŸ“œ çŽ‹å­ãŒPDFãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆä¸­ã§ã™â€¦' : 'ðŸ“œ çŽ‹å­æ­£åœ¨æ•´ç†ä½ çš„ PDF å ±è¡¨ï¼Œè«‹ç¨å€™ï½ž');
                }
                if (isUpdatingPrice) {
                    return pageLanguage === 'en-US' ? 'ðŸ“ˆ Fetching latest market prices.' : (pageLanguage === 'ja-JP' ? 'ðŸ“ˆ æœ€æ–°ã®ä¾¡æ ¼ã‚’å–å¾—ä¸­ã§ã™ã€‚' : 'ðŸ“ˆ çŽ‹å­æ­£åœ¨å¬å–šæœ€æ–°è‚¡åƒ¹èˆ‡å¹£åƒ¹ã€‚');
                }
                if (isUpdatingRates) {
                    return pageLanguage === 'en-US' ? 'ðŸ’± Updating exchange rates.' : (pageLanguage === 'ja-JP' ? 'ðŸ’± ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆã‚’æ›´æ–°ä¸­ã§ã™ã€‚' : 'ðŸ’± çŽ‹å­æ­£åœ¨æ›´æ–°åŒ¯çŽ‡é­”æ³•ã€‚');
                }
                if (isCloudSyncing) {
                    return pageLanguage === 'en-US' ? 'â˜ï¸ Syncing data to cloud now.' : (pageLanguage === 'ja-JP' ? 'â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ã¸åŒæœŸä¸­ã§ã™ã€‚' : 'â˜ï¸ çŽ‹å­æ­£åœ¨æŠŠè³‡æ–™åŒæ­¥åˆ°é›²ç«¯ã€‚');
                }
                if (isModalOpen) {
                    return pageLanguage === 'en-US' ? 'ðŸ“ Fill the form and save the asset.' : (pageLanguage === 'ja-JP' ? 'ðŸ“ ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›å¾Œã«ä¿å­˜ã—ã¦ãã ã•ã„ã€‚' : 'ðŸ“ åœ¨è¡¨å–®å¡«å¥½è³‡æ–™å¾ŒæŒ‰ã€Œå„²å­˜è³‡ç”¢ã€å°±å®Œæˆå›‰ï¼');
                }
                if (editingCashflowId) {
                    return pageLanguage === 'en-US' ? 'ðŸ”§ You are editing a rule. Remember to save.' : (pageLanguage === 'ja-JP' ? 'ðŸ”§ ãƒ«ãƒ¼ãƒ«ç·¨é›†ä¸­ã§ã™ã€‚ä¿å­˜ã‚’å¿˜ã‚Œãšã«ã€‚' : 'ðŸ”§ ä½ æ­£åœ¨ç·¨è¼¯è¦å‰‡ï¼Œè¨˜å¾—ç¢ºèªå„²å­˜ã€‚');
                }
                if (showSettings) {
                    return pageLanguage === 'en-US' ? 'âš™ï¸ Settings opened. You can import/export and update data.' : (pageLanguage === 'ja-JP' ? 'âš™ï¸ è¨­å®šã‚’é–‹ãã¾ã—ãŸã€‚ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¯èƒ½ã§ã™ã€‚' : 'âš™ï¸ è¨­å®šé¸å–®å·²é–‹å•Ÿï¼Œå¯åŒ¯å…¥åŒ¯å‡ºèˆ‡æ›´æ–°è³‡æ–™ã€‚');
                }
                if (financeSectionTab === 'CASHFLOW') {
                    return pageLanguage === 'en-US' ? 'ðŸ“… Use cashflow rules for auto posting.' : (pageLanguage === 'ja-JP' ? 'ðŸ“… å›ºå®šãƒ«ãƒ¼ãƒ«ã§è‡ªå‹•è¨˜å¸³ã§ãã¾ã™ã€‚' : 'ðŸ“… åœ¨ç¾é‡‘æµåˆ†é å¯è¨­å®šå›ºå®šè¦å‰‡èˆ‡è‡ªå‹•å…¥å¸³ã€‚');
                }
                if (priceStatus) return `ðŸ“£ ${priceStatus}`;
                return currentIdleHint;
            }, [isGeneratingPdf, isUpdatingPrice, isUpdatingRates, isCloudSyncing, isModalOpen, editingCashflowId, showSettings, financeSectionTab, priceStatus, currentIdleHint, pageLanguage]);

            const totals = useMemo(() => {
                let assetsHKD = 0;
                let liabilitiesHKD = 0;
                const categoryBreakdownHKD = {};
                const investSubtypeHKD = {};

                assets.forEach(asset => {
                    const marketValueHKD = toHKD(asset.quantity * asset.currentPrice, asset.currency);
                    categoryBreakdownHKD[asset.category] = (categoryBreakdownHKD[asset.category] || 0) + marketValueHKD;
                    if (asset.category === 'INVEST') {
                        investSubtypeHKD[asset.subtype] = (investSubtypeHKD[asset.subtype] || 0) + marketValueHKD;
                    }
                    if (CATEGORIES[asset.category].isNegative) liabilitiesHKD += marketValueHKD;
                    else assetsHKD += marketValueHKD;
                });

                const investTotalHKD = Object.values(investSubtypeHKD).reduce((sum, value) => sum + value, 0);
                const debtRatio = assetsHKD > 0 ? (liabilitiesHKD / assetsHKD) * 100 : 0;

                return {
                    assetsHKD,
                    liabilitiesHKD,
                    netWorthHKD: assetsHKD - liabilitiesHKD,
                    debtRatio,
                    investTotalHKD,
                    categoryBreakdownHKD,
                    investSubtypeHKD,
                    assets: fromHKD(assetsHKD, displayCurrency),
                    liabilities: fromHKD(liabilitiesHKD, displayCurrency),
                    netWorth: fromHKD(assetsHKD - liabilitiesHKD, displayCurrency)
                };
            }, [assets, displayCurrency, currencyRates]);

            useEffect(() => {
                const monthKey = new Date().toISOString().slice(0, 7);
                setMonthlySnapshots(prev => {
                    const current = prev[monthKey];
                    const nextSnapshot = {
                        assetsHKD: Number(totals.assetsHKD.toFixed(2)),
                        liabilitiesHKD: Number(totals.liabilitiesHKD.toFixed(2)),
                        netWorthHKD: Number(totals.netWorthHKD.toFixed(2)),
                        debtRatio: Number(totals.debtRatio.toFixed(2)),
                        updatedAt: Date.now()
                    };
                    if (
                        current &&
                        current.assetsHKD === nextSnapshot.assetsHKD &&
                        current.liabilitiesHKD === nextSnapshot.liabilitiesHKD &&
                        current.netWorthHKD === nextSnapshot.netWorthHKD &&
                        current.debtRatio === nextSnapshot.debtRatio
                    ) {
                        return prev;
                    }
                    const next = { ...prev, [monthKey]: nextSnapshot };
                    localStorage.setItem(STORAGE_KEYS.monthlySnapshots, JSON.stringify(next));
                    return next;
                });
            }, [totals.assetsHKD, totals.liabilitiesHKD, totals.netWorthHKD, totals.debtRatio]);

            const groupedAssets = useMemo(() => {
                const groups = {};
                assets.forEach(asset => {
                    if (!selectedCategories.includes(asset.category)) return;
                    if (!groups[asset.category]) groups[asset.category] = {};
                    if (!groups[asset.category][asset.account]) groups[asset.category][asset.account] = [];
                    groups[asset.category][asset.account].push(asset);
                });

                const compareByName = (a, b) => a.localeCompare(b, 'zh-Hant', { numeric: true, sensitivity: 'base' });

                return CATEGORY_KEYS
                    .filter(categoryKey => groups[categoryKey])
                    .map(categoryKey => {
                        const accountMap = groups[categoryKey];
                        const accounts = Object.entries(accountMap).map(([accountName, items]) => {
                            const sortedItems = [...items].sort((a, b) => {
                                if (sortMode === 'NAME_ASC') {
                                    return compareByName(a.name || '', b.name || '');
                                }
                                const aValue = Math.abs(toHKD(a.quantity * a.currentPrice, a.currency));
                                const bValue = Math.abs(toHKD(b.quantity * b.currentPrice, b.currency));
                                return bValue - aValue;
                            });

                            const accountTotalHKD = sortedItems.reduce((sum, item) => {
                                return sum + Math.abs(toHKD(item.quantity * item.currentPrice, item.currency));
                            }, 0);

                            return {
                                accountName,
                                items: sortedItems,
                                accountTotalHKD
                            };
                        });

                        const sortedAccounts = [...accounts].sort((a, b) => {
                            if (sortMode === 'NAME_ASC') {
                                return compareByName(a.accountName, b.accountName);
                            }
                            return b.accountTotalHKD - a.accountTotalHKD;
                        });

                        return {
                            categoryKey,
                            accounts: sortedAccounts
                        };
                    });
            }, [assets, selectedCategories, sortMode, currencyRates]);

            const toggleCategory = (categoryKey) => {
                setSelectedCategories(prev => {
                    if (prev.includes(categoryKey)) {
                        if (prev.length === 1) return prev;
                        return prev.filter(key => key !== categoryKey);
                    }
                    return [...prev, categoryKey];
                });
            };

            useEffect(() => {
                const keys = [];
                groupedAssets.forEach(group => {
                    group.accounts.forEach(account => {
                        keys.push(`${group.categoryKey}::${account.accountName}`);
                    });
                });

                setExpandedAccounts(prev => {
                    const next = { ...prev };
                    keys.forEach(key => {
                        if (typeof next[key] === 'undefined') next[key] = true;
                    });
                    return next;
                });
            }, [groupedAssets]);

            const toggleAccountExpand = (categoryKey, accountName) => {
                const key = `${categoryKey}::${accountName}`;
                setExpandedAccounts(prev => ({
                    ...prev,
                    [key]: !(prev[key] ?? true)
                }));
            };

            const assetMix = useMemo(() => {
                const rows = Object.keys(CATEGORIES).map(categoryKey => {
                    const valueHKD = Math.abs(totals.categoryBreakdownHKD[categoryKey] || 0);
                    return {
                        categoryKey,
                        label: CATEGORIES[categoryKey].label,
                        valueHKD,
                        amount: fromHKD(valueHKD, displayCurrency),
                        ...CATEGORY_MIX_STYLES[categoryKey]
                    };
                });

                const totalMixHKD = rows.reduce((sum, row) => sum + row.valueHKD, 0);
                const rowsWithRatio = rows.map(row => ({
                    ...row,
                    ratio: totalMixHKD > 0 ? (row.valueHKD / totalMixHKD) * 100 : 0
                })).sort((a, b) => b.valueHKD - a.valueHKD);

                let cumulative = 0;
                const segments = rowsWithRatio
                    .filter(row => row.ratio > 0)
                    .map(row => {
                        const start = cumulative;
                        cumulative += row.ratio;
                        return `${row.hex} ${start}% ${cumulative}%`;
                    });

                return {
                    rows: rowsWithRatio,
                    gradient: segments.length ? `conic-gradient(${segments.join(', ')})` : 'conic-gradient(#FCE7F3 0% 100%)'
                };
            }, [totals.categoryBreakdownHKD, displayCurrency]);

            useEffect(() => {
                const selectedExists = assetMix.rows.some(row => row.categoryKey === selectedMixCategory);
                if (!selectedExists) {
                    const first = assetMix.rows[0]?.categoryKey || 'INVEST';
                    setSelectedMixCategory(first);
                }
            }, [assetMix.rows, selectedMixCategory]);

            const detailMix = useMemo(() => {
                const category = selectedMixCategory;
                const categoryAssets = assets.filter(item => item.category === category);
                const groupMap = {};

                categoryAssets.forEach(item => {
                    const key = category === 'LIQUID'
                        ? (item.currency || 'N/A')
                        : (item.subtype || 'å…¶ä»–');
                    const amountHKD = Math.abs(toHKD(item.quantity * item.currentPrice, item.currency));
                    groupMap[key] = (groupMap[key] || 0) + amountHKD;
                });

                const totalHKD = Object.values(groupMap).reduce((sum, value) => sum + value, 0);
                const palette = INVEST_CHART_COLORS;

                const rows = Object.entries(groupMap)
                    .map(([label, valueHKD], idx) => ({
                        label,
                        valueHKD,
                        amount: fromHKD(valueHKD, displayCurrency),
                        ratio: totalHKD > 0 ? (valueHKD / totalHKD) * 100 : 0,
                        color: palette[idx % palette.length]
                    }))
                    .sort((a, b) => b.valueHKD - a.valueHKD);

                let cumulative = 0;
                const segments = rows
                    .filter(row => row.ratio > 0)
                    .map(row => {
                        const start = cumulative;
                        cumulative += row.ratio;
                        return `${row.color} ${start}% ${cumulative}%`;
                    });

                return {
                    categoryLabel: CATEGORIES[category]?.label || 'ç´°é …',
                    rows,
                    gradient: segments.length ? `conic-gradient(${segments.join(', ')})` : 'conic-gradient(#FCE7F3 0% 100%)'
                };
            }, [assets, selectedMixCategory, displayCurrency, currencyRates]);

            const accountStats = useMemo(() => {
                const category = selectedStatsCategory;
                const categoryAssets = assets.filter(item => item.category === category);

                const accountMap = {};
                categoryAssets.forEach(item => {
                    if (!accountMap[item.account]) accountMap[item.account] = [];
                    accountMap[item.account].push(item);
                });

                const accountNames = Object.keys(accountMap).sort((a, b) => a.localeCompare(b, 'zh-Hant'));
                const currentAccount = accountNames.includes(selectedStatsAccount) ? selectedStatsAccount : (accountNames[0] || '');
                const selectedAssets = statsBreakdownMode === 'ITEM' ? (accountMap[currentAccount] || []) : categoryAssets;

                const grouped = {};
                if (statsBreakdownMode === 'ACCOUNT') {
                    accountNames.forEach(accountName => {
                        const accountItems = accountMap[accountName] || [];
                        const valueDisplay = accountItems.reduce((sum, item) => {
                            return sum + fromHKD(toHKD(item.quantity * item.currentPrice, item.currency), displayCurrency);
                        }, 0);
                        grouped[`ACC:${accountName}`] = {
                            key: `ACC:${accountName}`,
                            label: accountName,
                            subtype: CATEGORIES[category].label,
                            symbol: '',
                            quantity: accountItems.length,
                            valueDisplay,
                            members: accountItems
                        };
                    });
                } else {
                    selectedAssets.forEach(item => {
                        const key = category === 'LIQUID'
                            ? `CUR:${item.currency}`
                            : `ASSET:${item.id}`;

                        if (!grouped[key]) {
                            grouped[key] = {
                                key,
                                label: category === 'LIQUID' ? item.currency : item.name,
                                subtype: item.subtype,
                                symbol: item.symbol,
                                quantity: 0,
                                valueDisplay: 0,
                                members: []
                            };
                        }

                        grouped[key].quantity += Number(item.quantity || 0);
                        grouped[key].valueDisplay += fromHKD(toHKD(item.quantity * item.currentPrice, item.currency), displayCurrency);
                        grouped[key].members.push(item);
                    });
                }

                const items = Object.values(grouped)
                    .map((entry, index) => ({
                        ...entry,
                        color: INVEST_CHART_COLORS[index % INVEST_CHART_COLORS.length]
                    }))
                    .sort((a, b) => b.valueDisplay - a.valueDisplay);

                const total = items.reduce((sum, item) => sum + item.valueDisplay, 0);
                const itemsWithRatio = items.map(item => ({
                    ...item,
                    ratio: total > 0 ? (item.valueDisplay / total) * 100 : 0
                }));

                let currentAngle = 0;
                const segments = itemsWithRatio.map(item => {
                    const segmentAngle = (item.ratio / 100) * 360;
                    const startAngle = currentAngle;
                    const endAngle = currentAngle + segmentAngle;
                    currentAngle = endAngle;
                    return {
                        ...item,
                        startAngle,
                        endAngle
                    };
                });

                const selectedItem = segments.find(item => item.key === selectedStatsSegmentKey) || segments[0] || null;

                return {
                    category,
                    accountNames,
                    currentAccount,
                    total,
                    segments,
                    selectedItem,
                    mode: statsBreakdownMode
                };
            }, [assets, displayCurrency, selectedStatsCategory, selectedStatsAccount, selectedStatsSegmentKey, statsBreakdownMode, currencyRates]);

            const liquidAssetOptions = useMemo(() => {
                return assets
                    .filter(item => item.category === 'LIQUID')
                    .map(item => ({
                        id: item.id,
                        account: item.account,
                        name: item.name,
                        currency: item.currency,
                        label: `${item.account}ï½œ${item.name}ï¼ˆ${item.currency}ï¼‰`
                    }))
                    .sort((a, b) => a.label.localeCompare(b.label, 'zh-Hant', { sensitivity: 'base' }));
            }, [assets]);

            const liquidAssetLabelById = useMemo(() => {
                const map = {};
                liquidAssetOptions.forEach(option => {
                    map[option.id] = option.label;
                });
                return map;
            }, [liquidAssetOptions]);

            const cashflowRulesByLiquidAssetId = useMemo(() => {
                const grouped = {};
                cashflowEntries.forEach(entry => {
                    if (!entry.targetLiquidAssetId) return;
                    if (!grouped[entry.targetLiquidAssetId]) grouped[entry.targetLiquidAssetId] = [];
                    grouped[entry.targetLiquidAssetId].push(entry);
                });
                Object.keys(grouped).forEach(key => {
                    grouped[key].sort((a, b) => a.title.localeCompare(b.title, 'zh-Hant', { sensitivity: 'base' }));
                });
                return grouped;
            }, [cashflowEntries]);

            const cashflowAutoRulesByLiquidAssetId = useMemo(() => {
                const grouped = {};
                cashflowEntries.forEach(entry => {
                    if (!entry.targetLiquidAssetId) return;
                    if (entry.scheduleType === 'ONE_TIME') return;
                    if (!grouped[entry.targetLiquidAssetId]) grouped[entry.targetLiquidAssetId] = [];
                    grouped[entry.targetLiquidAssetId].push(entry);
                });
                Object.keys(grouped).forEach(key => {
                    grouped[key].sort((a, b) => a.title.localeCompare(b.title, 'zh-Hant', { sensitivity: 'base' }));
                });
                return grouped;
            }, [cashflowEntries]);

            const cashflowAccountOptions = useMemo(() => {
                return [...new Set(assets.map(item => (item.account || '').trim()).filter(Boolean))]
                    .sort((a, b) => a.localeCompare(b, 'zh-Hant', { sensitivity: 'base' }));
            }, [assets]);

            const availableCashflowCategories = useMemo(() => {
                return CASHFLOW_CATEGORY_BY_TYPE[cashflowForm.type] || CASHFLOW_CATEGORY_BY_TYPE.EXPENSE;
            }, [cashflowForm.type]);

            const filteredCashflowEntries = useMemo(() => {
                const keyword = (cashflowRuleKeyword || '').trim().toLowerCase();
                const byFilter = cashflowEntries.filter(item => {
                    if (cashflowRuleFilter === 'ALL') return true;
                    if (cashflowRuleFilter === 'AUTO') return item.scheduleType !== 'ONE_TIME';
                    if (cashflowRuleFilter === 'ONE_TIME') return item.scheduleType === 'ONE_TIME';
                    if (cashflowRuleFilter === 'INCOME') return item.type === 'INCOME';
                    if (cashflowRuleFilter === 'EXPENSE') return item.type === 'EXPENSE';
                    return true;
                });

                const byKeyword = keyword
                    ? byFilter.filter(item => {
                        const fullText = [item.title, item.category, item.account, item.note, item.startDate, item.endDate]
                            .filter(Boolean)
                            .join(' ')
                            .toLowerCase();
                        return fullText.includes(keyword);
                    })
                    : byFilter;

                if (cashflowRuleSortMode === 'NEXT_TRIGGER_ASC') {
                    return [...byKeyword].sort((a, b) => {
                        const aNext = findNextOccurrenceDateKey(a, new Date());
                        const bNext = findNextOccurrenceDateKey(b, new Date());
                        if (!aNext && !bNext) return (a.title || '').localeCompare((b.title || ''), 'zh-Hant', { sensitivity: 'base' });
                        if (!aNext) return 1;
                        if (!bNext) return -1;
                        const byNext = aNext.localeCompare(bNext);
                        if (byNext !== 0) return byNext;
                        return (a.title || '').localeCompare((b.title || ''), 'zh-Hant', { sensitivity: 'base' });
                    });
                }

                return [...byKeyword].sort((a, b) => {
                    const byStart = b.startDate.localeCompare(a.startDate);
                    if (byStart !== 0) return byStart;
                    return (a.title || '').localeCompare((b.title || ''), 'zh-Hant', { sensitivity: 'base' });
                });
            }, [cashflowEntries, cashflowRuleFilter, cashflowRuleKeyword, cashflowRuleSortMode]);

            const cashflowTriggerInfoById = useMemo(() => {
                const map = {};
                const today = new Date();
                filteredCashflowEntries.slice(0, cashflowRulesVisibleCount).forEach(entry => {
                    const lastScheduled = findLastOccurrenceDateKey(entry, today);
                    const nextScheduled = findNextOccurrenceDateKey(entry, today);

                    let lastApplied = '';
                    Object.keys(cashflowAppliedPostings).forEach(postingKey => {
                        const posting = cashflowAppliedPostings[postingKey];
                        if (!posting || posting.entryId !== entry.id) return;
                        const dateKey = parseOccurrenceDateFromPostingKey(postingKey);
                        if (!dateKey) return;
                        if (!lastApplied || dateKey > lastApplied) lastApplied = dateKey;
                    });

                    map[entry.id] = {
                        lastDateKey: lastApplied || lastScheduled || '',
                        nextDateKey: nextScheduled || ''
                    };
                });
                return map;
            }, [filteredCashflowEntries, cashflowRulesVisibleCount, cashflowAppliedPostings]);

            useEffect(() => {
                setCashflowRulesVisibleCount(20);
            }, [cashflowRuleFilter, cashflowRuleKeyword, cashflowRuleSortMode]);

            useEffect(() => {
                if (availableCashflowCategories.includes(cashflowForm.category)) return;
                setCashflowForm(prev => ({
                    ...prev,
                    category: getDefaultCashflowCategory(prev.type)
                }));
            }, [availableCashflowCategories, cashflowForm.category]);

            useEffect(() => {
                if (!cashflowForm.targetLiquidAssetId) return;
                if (liquidAssetOptions.some(option => option.id === cashflowForm.targetLiquidAssetId)) return;
                setCashflowForm(prev => ({
                    ...prev,
                    targetLiquidAssetId: ''
                }));
            }, [cashflowForm.targetLiquidAssetId, liquidAssetOptions]);

            useEffect(() => {
                const result = applyAutoCashflowPostings({
                    assets,
                    cashflowEntries,
                    cashflowAppliedOccurrenceKeys,
                    cashflowAppliedPostings,
                    cashflowLastAutoApplyDate,
                    toHKD,
                    fromHKD
                });
                if (!result) return;

                if (result.updated) {
                    setAssets(result.nextAssets);
                    setCashflowAppliedOccurrenceKeys(result.nextAppliedOccurrenceKeys);
                    setCashflowAppliedPostings(result.nextAppliedPostings);
                    setPriceStatus(`å·²è‡ªå‹•å…¥å¸³/æ‰£æ¬¾ ${result.appliedCount} ç­†ç¾é‡‘æµ`);
                }
                setCashflowLastAutoApplyDate(result.todayKey);
            }, [assets, cashflowEntries, cashflowAppliedOccurrenceKeys, cashflowAppliedPostings, cashflowLastAutoApplyDate, currencyRates]);

            const selectedCashflowDate = useMemo(() => {
                if (!/^\d{4}-\d{2}$/.test(selectedCashflowMonth || '')) return new Date(new Date().getFullYear(), new Date().getMonth(), 1);
                const [year, month] = selectedCashflowMonth.split('-').map(Number);
                return new Date(year, month - 1, 1);
            }, [selectedCashflowMonth]);

            const cashflowMonthData = useMemo(() => {
                return buildCashflowMonthData({
                    cashflowEntries,
                    selectedCashflowDate,
                    displayCurrency,
                    toHKD,
                    fromHKD
                });
            }, [cashflowEntries, selectedCashflowDate, displayCurrency, currencyRates]);

            const cashflowYearData = useMemo(() => {
                return buildCashflowYearData({
                    cashflowEntries,
                    selectedCashflowDate,
                    displayCurrency,
                    toHKD,
                    fromHKD
                });
            }, [cashflowEntries, selectedCashflowDate, displayCurrency, currencyRates]);

            const moveCashflowMonth = (delta) => {
                const next = new Date(cashflowMonthData.year, cashflowMonthData.month + delta, 1);
                setSelectedCashflowMonth(toMonthKey(next));
            };

            const startEditCashflowEntry = (entry) => {
                setEditingCashflowId(entry.id);
                setCashflowForm(buildCashflowFormFromEntry({
                    entry,
                    getDefaultCashflowCategory,
                    toDateKey
                }));
                setFinanceSectionTab('CASHFLOW');
                setPriceStatus('å·²è¼‰å…¥è¦å‰‡ï¼Œå¯ä¿®æ”¹å¾Œå„²å­˜');
                requestAnimationFrame(() => {
                    cashflowFormRef.current?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            };

            const handleCashflowSubmit = (event) => {
                event.preventDefault();
                const submission = buildCashflowSubmission({
                    cashflowForm,
                    editingCashflowId,
                    liquidAssetOptions,
                    parseDateKey,
                    getDefaultCashflowCategory
                });

                if (!submission.ok) {
                    alert(submission.error);
                    return;
                }

                if (submission.isEditing) {
                    setCashflowEntries(prev => sanitizeCashflowEntries(prev.map(item => item.id === editingCashflowId ? submission.nextEntry : item)));
                } else {
                    setCashflowEntries(prev => sanitizeCashflowEntries([...prev, submission.nextEntry]));
                }
                setCashflowForm(prev => ({
                    ...prev,
                    title: '',
                    amount: '',
                    note: '',
                    targetLiquidAssetId: prev.targetLiquidAssetId || ''
                }));
                setEditingCashflowId('');

                const statusMessage = buildCashflowSubmitStatus({
                    isEditing: submission.isEditing,
                    selectedLiquidAsset: submission.selectedLiquidAsset,
                    nextEntry: submission.nextEntry,
                    amount: submission.amount,
                    cashflowCurrency: cashflowForm.currency,
                    toHKD,
                    fromHKD,
                    formatAmount,
                    isEntryOnDate
                });
                setPriceStatus(statusMessage);
            };

            const handleDeleteCashflowEntry = (id) => {
                const {
                    targetRule,
                    targetPostingKeys,
                    rollbackByAsset
                } = collectCashflowDeleteContext({
                    ruleId: id,
                    cashflowEntries,
                    cashflowAppliedPostings
                });

                const rollbackPreviewLines = [];
                if (targetPostingKeys.length > 0) {
                    rollbackByAsset.forEach(item => {
                        const label = liquidAssetLabelById[item.assetId] || 'å·²ç¶å®šå¸³æˆ¶';
                        const rollbackAmount = Number(item.amount || 0);
                        rollbackPreviewLines.push(`- ${label}ï¼š${rollbackAmount >= 0 ? '-' : '+'}${formatAmount(Math.abs(rollbackAmount))} ${item.currency}`);
                    });
                }

                const confirmMessage = rollbackPreviewLines.length > 0
                    ? `ç¢ºå®šè¦åˆªé™¤è¦å‰‡ã€Œ${targetRule?.title || 'æœªå‘½åè¦å‰‡'}ã€å—Žï¼Ÿ\n\nå°‡åŒæ­¥æ²–éŠ·å·²è‡ªå‹•å…¥å¸³/æ‰£æ¬¾ï¼š\n${rollbackPreviewLines.join('\n')}\n\næ­¤å‹•ä½œç„¡æ³•å¾©åŽŸã€‚`
                    : `ç¢ºå®šè¦åˆªé™¤è¦å‰‡ã€Œ${targetRule?.title || 'æœªå‘½åè¦å‰‡'}ã€å—Žï¼Ÿ`;

                if (!confirm(confirmMessage)) return;

                const nextAppliedPostings = { ...cashflowAppliedPostings };
                const nextAppliedKeySet = new Set(cashflowAppliedOccurrenceKeys);

                if (targetRule?.targetLiquidAssetId && targetPostingKeys.length > 0) {
                    const { nextAssets, revertedCount } = rollbackCashflowPostingsOnLiquidAssets({
                        assets,
                        cashflowAppliedPostings,
                        targetPostingKeys
                    });
                    targetPostingKeys.forEach(postingKey => {
                        delete nextAppliedPostings[postingKey];
                        nextAppliedKeySet.delete(postingKey);
                    });

                    setAssets(nextAssets);
                    setCashflowAppliedPostings(nextAppliedPostings);
                    setCashflowAppliedOccurrenceKeys(Array.from(nextAppliedKeySet));
                    setPriceStatus(`è¦å‰‡å·²åˆªé™¤ï¼Œä¸¦å·²æ²–éŠ· ${revertedCount} ç­†å·²å…¥å¸³/æ‰£æ¬¾ç´€éŒ„`);
                } else {
                    if (targetPostingKeys.length > 0) {
                        targetPostingKeys.forEach(postingKey => {
                            delete nextAppliedPostings[postingKey];
                            nextAppliedKeySet.delete(postingKey);
                        });
                        setCashflowAppliedPostings(nextAppliedPostings);
                        setCashflowAppliedOccurrenceKeys(Array.from(nextAppliedKeySet));
                    }
                    setPriceStatus('è¦å‰‡å·²åˆªé™¤');
                }

                setCashflowEntries(prev => prev.filter(item => item.id !== id));
                if (editingCashflowId === id) {
                    setEditingCashflowId('');
                }
            };

            const cancelCashflowEdit = () => {
                setEditingCashflowId('');
                setCashflowForm(prev => ({
                    ...prev,
                    title: '',
                    amount: '',
                    note: ''
                }));
                setPriceStatus('å·²å–æ¶ˆç·¨è¼¯');
            };

            const isCashflowOneTime = cashflowForm.scheduleType === 'ONE_TIME';
            const isCashflowMonthlyRecurring = !isCashflowOneTime && cashflowForm.frequency === 'MONTHLY';

            const refreshCurrencyRates = async (showToast = true) => {
                setIsUpdatingRates(true);
                if (showToast) setPriceStatus('æ›´æ–°åŒ¯çŽ‡ä¸­...');
                try {
                    const { nextRates, stamp } = await refreshCurrencyRatesWithStamp({ fetchLatestCurrencyRates });
                    setCurrencyRates(nextRates);
                    setLastRateUpdate(stamp);
                    if (showToast) setPriceStatus('å·²æ›´æ–°æœ€æ–°åŒ¯çŽ‡');
                } catch (error) {
                    if (showToast) setPriceStatus('åŒ¯çŽ‡æ›´æ–°å¤±æ•—ï¼Œå·²ä½¿ç”¨ç›®å‰åŒ¯çŽ‡');
                } finally {
                    setIsUpdatingRates(false);
                }
            };

            useEffect(() => {
                if (!CATEGORY_KEYS.includes(selectedStatsCategory)) {
                    setSelectedStatsCategory('INVEST');
                }
            }, [selectedStatsCategory]);

            useEffect(() => {
                if (!accountStats.accountNames.length) {
                    setSelectedStatsAccount('');
                    setSelectedStatsSegmentKey('');
                    return;
                }

                if (!accountStats.accountNames.includes(selectedStatsAccount)) {
                    setSelectedStatsAccount(accountStats.accountNames[0]);
                }

                if (!accountStats.segments.some(item => item.key === selectedStatsSegmentKey)) {
                    setSelectedStatsSegmentKey(accountStats.segments[0]?.key || '');
                }
            }, [accountStats.accountNames, accountStats.segments, selectedStatsAccount, selectedStatsSegmentKey]);

            const updateMarketPrices = async (showToast) => {
                const latestAssets = assetsRef.current;
                const {
                    stockTargets,
                    cryptoTargets,
                    stockSymbolMap,
                    stockSymbols,
                    cryptoSymbols
                } = buildMarketTargets({ assets: latestAssets, normalizeYahooSymbol });

                if (!stockTargets.length && !cryptoTargets.length) {
                    if (showToast) setPriceStatus(tByLang('æ²’æœ‰å¯æ›´æ–°çš„è‚¡ç¥¨æˆ–åŠ å¯†è²¨å¹£ä»£è™Ÿ', 'No stock or crypto symbols available to update', 'æ›´æ–°å¯èƒ½ãªæ ªå¼ãƒ»æš—å·è³‡ç”£ã‚·ãƒ³ãƒœãƒ«ãŒã‚ã‚Šã¾ã›ã‚“'));
                    return;
                }

                setIsUpdatingPrice(true);
                setPriceStatus(tByLang('æ›´æ–°è¡Œæƒ…ä¸­...', 'Updating market prices...', 'ç›¸å ´ã‚’æ›´æ–°ä¸­...'));

                const [stockQuotes, cryptoQuotesUSD] = await Promise.all([
                    fetchYahooQuotes(stockSymbols),
                    fetchCryptoQuotes(cryptoSymbols)
                ]);

                let finalUpdatedCount = 0;
                setAssets(prev => {
                    const {
                        nextAssets,
                        updatedCount
                    } = applyQuotePricesToAssets({
                        assets: prev,
                        stockSymbolMap,
                        stockQuotes,
                        cryptoQuotesUSD,
                        currencyRates,
                        defaultUsdRate: DEFAULT_RATES.USD
                    });
                    finalUpdatedCount = updatedCount;
                    return updatedCount > 0 ? nextAssets : prev;
                });

                const stamp = new Date();
                setLastPriceUpdate(stamp);
                setIsUpdatingPrice(false);
                setPriceStatus(finalUpdatedCount > 0
                    ? tByLang(`å·²æ›´æ–° ${finalUpdatedCount} ç­†è¡Œæƒ…`, `Updated ${finalUpdatedCount} market entries`, `${finalUpdatedCount}ä»¶ã®ç›¸å ´ã‚’æ›´æ–°ã—ã¾ã—ãŸ`)
                    : tByLang('è¡Œæƒ…å·²æ˜¯æœ€æ–°æˆ–è³‡æ–™æºæš«ä¸å¯ç”¨', 'Market data is already up to date or source is temporarily unavailable', 'ç›¸å ´ã¯æœ€æ–°ã€ã¾ãŸã¯ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ãŒä¸€æ™‚åˆ©ç”¨ä¸å¯ã§ã™'));
            };

            useEffect(() => {
                if (!isCloudEnabled) {
                    setIsAuthLoading(false);
                    return;
                }

                firebaseAuth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                    .catch(() => {
                        setCloudStatus('ç„¡æ³•å•Ÿç”¨ç™»å…¥æŒä¹…åŒ–ï¼Œè«‹å…è¨±ç¬¬ä¸‰æ–¹ Cookie æˆ–é—œé–‰éš±ç§é˜»æ“‹');
                    });

                firebaseAuth.getRedirectResult()
                    .then(result => {
                        if (result?.user) {
                            setCloudStatus(`å·²ç™»å…¥ Googleï¼ˆ${result.user.email || 'Google å¸³è™Ÿ'}ï¼‰`);
                        }
                    })
                    .catch(error => {
                        const code = error?.code || 'unknown';
                        setCloudStatus(`å°Žé ç™»å…¥å¤±æ•—ï¼ˆ${code}ï¼‰`);
                    });

                const unsubscribe = firebaseAuth.onAuthStateChanged(async (user) => {
                    setAuthUser(user || null);
                    setIsAuthLoading(false);

                    if (!user) {
                        setCloudStatus('å·²ç™»å‡º Googleï¼Œè³‡æ–™åƒ…å­˜åœ¨æ­¤è£ç½®');
                        return;
                    }

                    setCloudStatus(tByLang(
                        `å·²ç™»å…¥ Googleï¼ˆ${user.email || 'Google å¸³è™Ÿ'}ï¼‰ï¼Œè«‹æ‰‹å‹•åŒæ­¥`,
                        `Signed in as ${user.email || 'Google Account'}, sync manually`,
                        `${user.email || 'Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ'} ã§ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã€‚æ‰‹å‹•ã§åŒæœŸã—ã¦ãã ã•ã„`
                    ));
                });

                return () => unsubscribe();
            }, []);

            const handleCloudDownload = async () => {
                if (!isCloudEnabled) {
                    setCloudStatus('å°šæœªè¨­å®š Firebaseï¼Œè«‹å…ˆåœ¨ index.html å¡«å…¥ Firebase è¨­å®š');
                    return;
                }
                if (!authUser) {
                    setCloudStatus('è«‹å…ˆç™»å…¥ Google å¾Œå†åŒæ­¥');
                    return;
                }

                setIsCloudSyncing(true);
                setCloudStatus(tByLang('ä¸‹è¼‰é›²ç«¯ä¸­...', 'Downloading from cloud...', 'ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...'));

                try {
                    const result = await downloadCloudData({
                        firebaseDB,
                        collectionName: CLOUD_COLLECTION,
                        user: authUser,
                    });

                    if (result.hydrated) {
                        const hydrated = result.hydrated;
                        applyHydratedCloudSnapshot({
                            hydrated,
                            storageKeys: STORAGE_KEYS,
                            setAssets,
                            setDisplayCurrency,
                            setMonthlySnapshots,
                            setCashflowEntries,
                            setCashflowAppliedOccurrenceKeys,
                            setCashflowAppliedPostings,
                            setCashflowLastAutoApplyDate
                        });
                        setCloudStatus(tByLang(
                            `å·²ä¸‹è¼‰é›²ç«¯è³‡æ–™ï¼ˆ${authUser.email || 'Google å¸³è™Ÿ'}ï¼‰`,
                            `Cloud data downloaded (${authUser.email || 'Google Account'})`,
                            `ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼ˆ${authUser.email || 'Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ'}ï¼‰`
                        ));
                    } else if (result.hasSnapshot) {
                        setCloudStatus(tByLang(
                            'é›²ç«¯è³‡æ–™æ ¼å¼ä¸å®Œæ•´ï¼Œæœªè¦†è“‹æœ¬æ©Ÿ',
                            'Cloud data is invalid, local data kept',
                            'ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒä¸æ­£ã®ãŸã‚ã€ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ç¶­æŒã—ã¾ã—ãŸ'
                        ));
                    } else {
                        setCloudStatus(tByLang(
                            'é›²ç«¯ç›®å‰æ²’æœ‰å¯ä¸‹è¼‰è³‡æ–™',
                            'No cloud data available to download',
                            'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½ãªã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'
                        ));
                    }
                } catch (error) {
                    setCloudStatus('é›²ç«¯ä¸‹è¼‰å¤±æ•—ï¼Œè³‡æ–™ä»ä¿ç•™åœ¨æœ¬æ©Ÿ');
                } finally {
                    setIsCloudSyncing(false);
                }
            };

            const handleCloudUpload = async () => {
                if (!isCloudEnabled) {
                    setCloudStatus('å°šæœªè¨­å®š Firebaseï¼Œè«‹å…ˆåœ¨ index.html å¡«å…¥ Firebase è¨­å®š');
                    return;
                }
                if (!authUser) {
                    setCloudStatus('è«‹å…ˆç™»å…¥ Google å¾Œå†åŒæ­¥');
                    return;
                }

                setIsCloudSyncing(true);
                setCloudStatus(tByLang('ä¸Šè¼‰é›²ç«¯ä¸­...', 'Uploading to cloud...', 'ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...'));

                try {
                    const payload = buildCloudSyncPayload({
                        assets,
                        displayCurrency,
                        monthlySnapshots,
                        cashflowEntries,
                        cashflowAppliedOccurrenceKeys,
                        cashflowAppliedPostings,
                        cashflowLastAutoApplyDate
                    });

                    await uploadCloudData({
                        firebaseDB,
                        collectionName: CLOUD_COLLECTION,
                        user: authUser,
                        firebase,
                        localPayload: payload
                    });

                    setCloudStatus(tByLang(
                        `å·²ä¸Šè¼‰æœ¬æ©Ÿè³‡æ–™åˆ°é›²ç«¯ï¼ˆ${authUser.email || 'Google å¸³è™Ÿ'}ï¼‰`,
                        `Local data uploaded to cloud (${authUser.email || 'Google Account'})`,
                        `ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼ˆ${authUser.email || 'Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ'}ï¼‰`
                    ));
                } catch (error) {
                    setCloudStatus('é›²ç«¯ä¸Šè¼‰å¤±æ•—ï¼Œè³‡æ–™ä»ä¿ç•™åœ¨æœ¬æ©Ÿ');
                } finally {
                    setIsCloudSyncing(false);
                }
            };

            const handleGoogleLogin = async () => {
                await loginWithGoogle({ isCloudEnabled, firebaseAuth, firebase, onStatus: setCloudStatus });
            };

            const handleGoogleLogout = async () => {
                await logoutGoogle({ isCloudEnabled, firebaseAuth, onStatus: setCloudStatus });
            };

            const handleExportData = () => {
                try {
                    const payload = buildBackupPayload({
                        assets,
                        displayCurrency,
                        monthlySnapshots,
                        cashflowEntries,
                        cashflowAppliedOccurrenceKeys,
                        cashflowAppliedPostings,
                        cashflowLastAutoApplyDate
                    });
                    const fileName = `asset-tracker-backup-${new Date().toISOString().slice(0, 10)}.json`;
                    downloadJsonFile(payload, fileName);
                    setPriceStatus('è³‡æ–™å·²æˆåŠŸåŒ¯å‡º');
                } catch (error) {
                    setPriceStatus('åŒ¯å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                }
            };

            const openImportPicker = () => {
                importInputRef.current?.click();
            };

            const handleShareApp = async () => {
                if (isGeneratingPdf) {
                    setPriceStatus('PDF ä»åœ¨ç”¢ç”Ÿä¸­ï¼Œè«‹ç¨å€™...');
                    return;
                }
                let watchdogTimer = null;
                try {
                    setIsGeneratingPdf(true);

                    watchdogTimer = setTimeout(() => {
                        setIsGeneratingPdf(false);
                        setPriceStatus('PDF ç”¢ç”Ÿé€¾æ™‚ï¼Œè«‹å†è©¦ä¸€æ¬¡');
                    }, 20000);

                    await exportAssetReportPdf({
                        assets,
                        displayCurrency,
                        totals,
                        assetMix,
                        groupedAssets,
                        categories: CATEGORIES,
                        formatAmount,
                        toHKD,
                        fromHKD,
                        ensureJsPdfReady,
                        ensureHtml2CanvasReady,
                        onProgress: (message) => setPriceStatus(message)
                    });

                    setPriceStatus('PDF å·²æˆåŠŸä¸‹è¼‰');
                } catch (error) {
                    setPriceStatus(`åˆ†äº« PDF å¤±æ•—ï¼š${error?.message || 'è«‹ç¨å¾Œå†è©¦'}`);
                } finally {
                    if (watchdogTimer) clearTimeout(watchdogTimer);
                    setIsGeneratingPdf(false);
                }
            };

            const handleImportData = async (event) => {
                const file = event.target.files?.[0];
                if (!file) return;

                try {
                    const text = await file.text();
                    const parsed = JSON.parse(text);
                    const {
                        nextAssets,
                        nextDisplayCurrency,
                        safeSnapshots,
                        nextCashflowEntries,
                        nextCashflowAppliedOccurrenceKeys,
                        nextCashflowAppliedPostings,
                        nextCashflowLastAutoApplyDate
                    } = parseImportedBackup(parsed, new Date(Date.now() - ONE_DAY_MS));

                    if (!nextAssets || !nextAssets.every(isValidAssetRecord)) {
                        throw new Error('invalid assets format');
                    }

                    if (!nextDisplayCurrency || !CURRENCIES.includes(nextDisplayCurrency)) {
                        throw new Error('invalid display currency');
                    }

                    setAssets(nextAssets.map(normalizeAssetRecord));
                    setDisplayCurrency(nextDisplayCurrency);
                    setMonthlySnapshots(safeSnapshots);
                    setCashflowEntries(nextCashflowEntries);
                    setCashflowAppliedOccurrenceKeys(nextCashflowAppliedOccurrenceKeys);
                    setCashflowAppliedPostings(nextCashflowAppliedPostings);
                    setCashflowLastAutoApplyDate(nextCashflowLastAutoApplyDate);
                    localStorage.setItem(STORAGE_KEYS.monthlySnapshots, JSON.stringify(safeSnapshots));
                    localStorage.setItem(STORAGE_KEYS.cashflowEntries, JSON.stringify(nextCashflowEntries));
                    localStorage.setItem(STORAGE_KEYS.cashflowAppliedOccurrenceKeys, JSON.stringify(nextCashflowAppliedOccurrenceKeys));
                    localStorage.setItem(STORAGE_KEYS.cashflowAppliedPostings, JSON.stringify(nextCashflowAppliedPostings));
                    localStorage.setItem(STORAGE_KEYS.cashflowLastAutoApplyDate, JSON.stringify(nextCashflowLastAutoApplyDate));
                    setPriceStatus(`åŒ¯å…¥æˆåŠŸï¼š${nextAssets.length} ç­†è³‡ç”¢è³‡æ–™`);
                } catch (error) {
                    setPriceStatus('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼ä¸æ­£ç¢º');
                } finally {
                    event.target.value = '';
                }
            };

            // é‡è¨­ç‚ºç¯„ä¾‹è³‡æ–™ï¼ˆæœƒè¦†è“‹ localStorageï¼‰
            const resetToSeed = () => {
                if (!confirm('è¦æŠŠå°çŽ‹å­çš„å¸³æœ¬é‡è¨­æˆç¯„ä¾‹è³‡æ–™å—Žï¼Ÿ\né€™æœƒæ¸…ç©ºä½ ç›®å‰çš„è³‡ç”¢ã€ç¾é‡‘æµèˆ‡æœˆåº¦å¿«ç…§ï¼ˆæœ¬æ©Ÿè³‡æ–™æœƒè¢«è¦†è“‹ï¼‰ã€‚')) return;
                const normalized = seedAssets.map(normalizeAssetRecord);

                setAssets(normalized);
                setDisplayCurrency('HKD');
                setMonthlySnapshots({});
                setCashflowEntries([]);
                setCashflowAppliedOccurrenceKeys([]);
                setCashflowAppliedPostings({});
                setCashflowLastAutoApplyDate(toDateKey(new Date(Date.now() - ONE_DAY_MS)));

                // åŒæ­¥å¯«å…¥ localStorageï¼ˆuseEffect ä¹Ÿæœƒåœ¨ state è®Šæ›´æ™‚è¦†å¯«ï¼Œä½†é€™è£¡å…ˆå¯«ä»¥ç¢ºä¿ç«‹å³ä¸€è‡´ï¼‰
                try {
                    localStorage.setItem(STORAGE_KEYS.assets, JSON.stringify(normalized));
                    localStorage.setItem(STORAGE_KEYS.displayCurrency, JSON.stringify('HKD'));
                    localStorage.setItem(STORAGE_KEYS.monthlySnapshots, JSON.stringify({}));
                    localStorage.setItem(STORAGE_KEYS.cashflowEntries, JSON.stringify([]));
                    localStorage.setItem(STORAGE_KEYS.cashflowAppliedOccurrenceKeys, JSON.stringify([]));
                    localStorage.setItem(STORAGE_KEYS.cashflowAppliedPostings, JSON.stringify({}));
                    localStorage.setItem(STORAGE_KEYS.cashflowLastAutoApplyDate, JSON.stringify(toDateKey(new Date(Date.now() - ONE_DAY_MS))));
                } catch (e) {
                    // å¿½ç•¥ storage éŒ¯èª¤
                }

                setPriceStatus('å·²é‡è¨­è³‡æ–™ï¼Œæº–å‚™é‡æ–°é–‹å§‹è¨˜å¸³å›‰ âœ¨');
            };

            useEffect(() => {
                updateMarketPrices(false);
                refreshCurrencyRates(false);
                const timer = setInterval(() => updateMarketPrices(false), 5 * 60 * 1000);
                const rateTimer = setInterval(() => refreshCurrencyRates(false), 30 * 60 * 1000);
                return () => {
                    clearInterval(timer);
                    clearInterval(rateTimer);
                };
            }, []);

            const openEdit = (asset) => {
                setEditingId(asset.id);
                setFormData(buildFormDataFromAsset(asset));
                setIsModalOpen(true);
            };

            const handleDelete = (id) => {
                const result = buildAssetDeleteResult({ assets, id });
                if (!result.ok) return;
                setAssets(result.nextAssets);
                setIsModalOpen(false);
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                const submission = buildAssetSubmission({
                    formData,
                    editingId,
                    isLiquidForm,
                    isCryptoForm,
                    isStockForm,
                    isFundForm,
                    isFixedDepositForm,
                    fixedDepositMetrics,
                    needsPremium,
                    isMortgageForm,
                    mortgageMetrics,
                    isLoanForm,
                    loanMetrics,
                    isCreditCardForm,
                    isPayableForm,
                    isOtherLiabilityForm,
                    isReceivableForm,
                    isFixedForm
                });

                if (!submission.ok) {
                    alert(submission.error);
                    return;
                }

                const data = submission.data;

                if (editingId) {
                    setAssets(assets.map(a => a.id === editingId ? { ...data, id: editingId } : a));
                } else {
                    setAssets([...assets, { ...data, id: Date.now().toString() }]);
                }

                setIsModalOpen(false);
                setEditingId(null);
                setFormData(createInitialAssetFormData());
            };

            const netWorthTier = getNetWorthTier(totals.netWorthHKD, themeId);
            const wealthStyleLevel = totals.netWorthHKD < 0
                ? 'danger'
                : totals.netWorthHKD < 1000000
                    ? 'early'
                    : totals.netWorthHKD < 10000000
                        ? 'growth'
                        : 'elite';

            return (
                <div className="max-w-6xl mx-auto p-4 md:p-8">
                    <header className="mb-6">
                        <div className="theme-header-card rounded-2xl p-4 md:p-5 shadow-sm">
                            <div className="flex items-start gap-3">
                                <div className="theme-crown w-11 h-11 rounded-xl flex items-center justify-center text-white shadow-sm">
                                    <i data-lucide="crown" className="w-6 h-6"></i>
                                </div>
                                <div className="min-w-0 flex-1">
                                    <h1 className="theme-text-main text-2xl font-black tracking-tight">{appName}</h1>
                                    <p className="theme-text-sub text-xs font-bold mt-1">{pageText.subtitle}</p>
                                </div>
                            </div>

                            <div className="theme-subcard mt-3 rounded-xl px-3 py-3 flex items-center gap-3">
                                <div className="theme-crown w-9 h-9 rounded-xl flex items-center justify-center text-lg prince-float">ðŸ¤´ðŸ»</div>
                                <div className="min-w-0">
                                    <div className="theme-text-sub text-xs font-black prince-talk">{currentHeaderSlogan}</div>
                                </div>
                            </div>

                            <input
                                ref={importInputRef}
                                type="file"
                                accept="application/json,.json"
                                className="hidden"
                                onChange={handleImportData}
                            />
                            <div className="mt-4 pt-3 border-t border-white/70 flex flex-wrap items-center gap-2">
                                <button onClick={() => { setEditingId(null); setIsModalOpen(true); }} className="bg-slate-900 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-slate-800 transition-all shadow-md flex items-center gap-2">
                                    <i data-lucide="plus-circle" className="w-4 h-4"></i> {pageText.addAsset}
                                </button>

                                <button
                                    onClick={resetToSeed}
                                    title={tByLang('å¯æ„›é‡è¨­ï¼šæ¸…ç©ºç›®å‰è³‡æ–™ä¸¦å›žåˆ°ç¯„ä¾‹å¸³æœ¬', 'Cute reset: clear current data and restore sample ledger', 'ã‹ã‚ã„ããƒªã‚»ãƒƒãƒˆï¼šç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆåŽ»ã—ã¦ã‚µãƒ³ãƒ—ãƒ«å°å¸³ã«æˆ»ã—ã¾ã™')}
                                    className="theme-btn-danger text-white px-4 py-2 rounded-lg font-bold text-sm transition-all shadow-md"
                                >
                                    {pageText.resetData}
                                </button>

                                <div className="relative ml-auto">
                                    <button
                                        type="button"
                                        onClick={() => setShowSettings(prev => !prev)}
                                        className="bg-white border border-slate-200 rounded-lg px-3 py-2 font-black text-sm shadow-sm flex items-center gap-2"
                                    >
                                        <i data-lucide="settings" className="w-4 h-4"></i>
                                        {pageText.advanced}
                                    </button>
                                    {showSettings && (
                                        <div className="absolute right-0 mt-2 w-64 bg-white border border-slate-100 rounded-xl shadow-lg p-3 space-y-2 z-20">
                                            <div className="text-[10px] text-slate-400 font-black uppercase tracking-widest">{pageText.cloudAccount}</div>
                                            <div className="text-xs font-bold text-slate-600 bg-slate-50 rounded-lg px-2 py-1">
                                                {authUser ? (authUser.email || 'å·²ç™»å…¥ Google') : 'æœªç™»å…¥ Google'}
                                            </div>
                                            <button
                                                onClick={() => {
                                                    if (authUser) handleGoogleLogout();
                                                    else handleGoogleLogin();
                                                    setShowSettings(false);
                                                }}
                                                disabled={isAuthLoading || isCloudSyncing}
                                                className="w-full bg-slate-900 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-slate-800 transition-all disabled:opacity-60"
                                            >
                                                {isAuthLoading ? pageText.loginLoading : authUser ? pageText.logout : pageText.login}
                                            </button>
                                            <button
                                                onClick={() => { handleCloudDownload(); setShowSettings(false); }}
                                                disabled={!authUser || isAuthLoading || isCloudSyncing}
                                                className="theme-btn-accent w-full text-white px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-60"
                                            >
                                                {isCloudSyncing
                                                    ? tByLang('åŒæ­¥ä¸­...', 'Syncing...', 'åŒæœŸä¸­...')
                                                    : tByLang('ä¸‹è¼‰é›²ç«¯è³‡æ–™', 'Download Cloud Data', 'ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰')}
                                            </button>
                                            <button
                                                onClick={() => { handleCloudUpload(); setShowSettings(false); }}
                                                disabled={!authUser || isAuthLoading || isCloudSyncing}
                                                className="theme-btn-accent w-full text-white px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-60"
                                            >
                                                {isCloudSyncing
                                                    ? tByLang('åŒæ­¥ä¸­...', 'Syncing...', 'åŒæœŸä¸­...')
                                                    : tByLang('ä¸Šè¼‰æœ¬æ©Ÿè³‡æ–™', 'Upload Local Data', 'ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰')}
                                            </button>
                                            <div className="text-[10px] text-slate-400 font-black uppercase tracking-widest">{pageText.displayCurrency}</div>
                                            <select
                                                value={displayCurrency}
                                                onChange={e => setDisplayCurrency(e.target.value)}
                                                className="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 font-bold text-sm shadow-sm outline-none"
                                            >
                                                {CURRENCIES.map(c => <option key={c} value={c}>{c}</option>)}
                                            </select>
                                            <div className="text-[10px] text-slate-400 font-black uppercase tracking-widest">{pageText.pageLanguage}</div>
                                            <select
                                                value={pageLanguage}
                                                onChange={e => setPageLanguage(e.target.value)}
                                                className="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 font-bold text-sm shadow-sm outline-none"
                                            >
                                                {PAGE_LANGUAGE_OPTIONS.map(option => <option key={option.value} value={option.value}>{option.label}</option>)}
                                            </select>
                                            <div className="text-[10px] text-slate-400 font-black uppercase tracking-widest">ä¸»é¡Œ Theme</div>
                                            <select
                                                value={themeId}
                                                onChange={e => setThemeId(e.target.value)}
                                                className="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 font-bold text-sm shadow-sm outline-none"
                                            >
                                                {THEME_OPTIONS.map(option => <option key={option.value} value={option.value}>{option.label}</option>)}
                                            </select>
                                            <button
                                                onClick={() => { handleExportData(); setShowSettings(false); }}
                                                className="theme-btn-gold w-full text-white px-4 py-2 rounded-lg font-bold text-sm transition-all"
                                            >
                                                {pageText.exportData}
                                            </button>
                                            <button
                                                onClick={() => { openImportPicker(); setShowSettings(false); }}
                                                className="w-full theme-tab-inactive px-4 py-2 rounded-lg font-bold text-sm transition-all"
                                            >
                                                {pageText.importData}
                                            </button>
                                            <button
                                                onClick={() => { updateMarketPrices(true); setShowSettings(false); }}
                                                disabled={isUpdatingPrice}
                                                className="theme-btn-accent w-full text-white px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-60"
                                            >
                                                {isUpdatingPrice ? pageText.updating : pageText.updatePrice}
                                            </button>
                                            <button
                                                onClick={() => { refreshCurrencyRates(true); setShowSettings(false); }}
                                                disabled={isUpdatingRates}
                                                className="theme-btn-accent w-full text-white px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-60"
                                            >
                                                {isUpdatingRates ? pageText.updating : pageText.updateFx}
                                            </button>
                                            <button
                                                onClick={() => { handleShareApp(); setShowSettings(false); }}
                                                disabled={isGeneratingPdf}
                                                className="w-full theme-btn-primary text-white px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-60"
                                            >
                                                {isGeneratingPdf ? pageText.generatingPdf : pageText.sharePdf}
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </header>

                    <div className="mb-8 text-xs text-slate-500 font-bold flex flex-wrap gap-x-4 gap-y-1">
                        <span>{priceStatus || pageText.marketAutoUpdate}</span>
                        <span>{lastPriceUpdate ? `${pageText.lastUpdated}ï¼š${lastPriceUpdate.toLocaleString()}` : pageText.noPriceYet}</span>
                        <span>{lastRateUpdate ? `${pageText.rateUpdated}ï¼š${lastRateUpdate.toLocaleString()}` : pageText.fxDefault}</span>
                        <span>{isCloudSyncing ? pageText.cloudSyncing : cloudStatus}</span>
                    </div>

                    <section className="theme-surface p-4 sm:p-6 rounded-2xl shadow-sm mb-8">
                        <div className="text-slate-800 font-black mb-4">{pageText.overviewTitle}</div>
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div className="space-y-4">
                                <div className={`theme-networth-card theme-networth-card--${wealthStyleLevel} p-5 rounded-2xl text-white shadow-lg`}>
                                    <div className="theme-networth-caption text-[10px] font-black uppercase tracking-widest mb-1">{pageText.netWorth} ({displayCurrency})</div>
                                    <div className="text-3xl font-black tracking-tighter">{formatAmount(totals.netWorth)}</div>
                                    <div className="text-xs font-black theme-networth-caption mt-2">{netWorthTier.emoji} {netWorthTier.label}</div>
                                </div>
                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 gap-3">
                                    <div className={`theme-summary-card theme-summary-card--${wealthStyleLevel} p-4 rounded-xl`}>
                                        <div className="theme-text-sub text-[10px] font-black uppercase tracking-widest mb-1">{pageText.totalAssets}</div>
                                        <div className="text-xl font-black theme-text-main">{formatAmount(totals.assets)}</div>
                                    </div>
                                    <div className={`theme-summary-card ${wealthStyleLevel === 'danger' ? 'theme-summary-card--danger' : `theme-summary-card--${wealthStyleLevel}`} p-4 rounded-xl`}>
                                        <div className="theme-text-sub text-[10px] font-black uppercase tracking-widest mb-1">{pageText.totalLiabilities}</div>
                                        <div className="text-xl font-black theme-negative">{formatAmount(totals.liabilities)}</div>
                                        <div className="text-[10px] font-black theme-text-sub mt-1">{pageText.debtRatio} {totals.debtRatio.toFixed(1)}%</div>
                                    </div>
                                </div>
                            </div>

                            <div className="lg:col-span-2 grid grid-cols-1 xl:grid-cols-2 gap-6 items-center">
                                <details className={`rounded-xl p-3 theme-summary-card theme-summary-card--${wealthStyleLevel}`} open>
                                    <summary className="sm:hidden text-xs font-black theme-text-sub cursor-pointer list-none">{pageText.categoryMix}</summary>
                                    <div className="space-y-3 mt-3 sm:mt-0">
                                        {assetMix.rows.map(item => (
                                            <button
                                                type="button"
                                                key={item.categoryKey}
                                                onClick={() => setSelectedMixCategory(item.categoryKey)}
                                                className={`w-full text-left rounded-xl p-2 transition-all theme-mix-item ${selectedMixCategory === item.categoryKey ? `theme-mix-item--${wealthStyleLevel}-selected` : ''}`}
                                            >
                                                <div className="flex justify-between text-xs font-black theme-text-sub mb-1">
                                                    <span>{item.label}</span>
                                                    <span>{item.ratio.toFixed(1)}% Â· {formatAmount(item.amount)} {displayCurrency}</span>
                                                </div>
                                                <div className="h-2 rounded-full bg-slate-100 overflow-hidden">
                                                    <div className={`h-full ${item.bg}`} style={{ width: `${item.ratio}%` }}></div>
                                                </div>
                                            </button>
                                        ))}
                                    </div>
                                </details>
                                <div className="space-y-4">
                                    <div className="flex items-center justify-center">
                                        <div className="w-44 h-44 sm:w-52 sm:h-52 rounded-full relative" style={{ background: detailMix.gradient }}>
                                            <div className={`absolute inset-8 rounded-full flex items-center justify-center theme-summary-card theme-summary-card--${wealthStyleLevel}`}>
                                                <div className="text-center">
                                                    <div className="text-[10px] theme-text-sub font-black uppercase tracking-widest">{detailMix.categoryLabel}</div>
                                                    <div className="text-sm font-black theme-text-main">{pageText.detailMix}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <details className={`rounded-xl p-3 theme-summary-card theme-summary-card--${wealthStyleLevel}`} open>
                                        <summary className="sm:hidden text-xs font-black theme-text-sub cursor-pointer list-none">{pageText.detailMix}</summary>
                                        <div className="space-y-2 mt-3 sm:mt-0">
                                            {detailMix.rows.length ? detailMix.rows.map(row => (
                                                <div key={row.label} className="flex items-center justify-between text-xs font-black theme-text-sub">
                                                    <div className="flex items-center gap-2">
                                                        <span className="w-2.5 h-2.5 rounded-full" style={{ backgroundColor: row.color }}></span>
                                                        <span>{row.label}</span>
                                                    </div>
                                                    <span>{row.ratio.toFixed(1)}% Â· {formatAmount(row.amount)} {displayCurrency}</span>
                                                </div>
                                            )) : (
                                                <p className="text-sm theme-text-sub font-bold text-center">{pageText.noDetailItems}</p>
                                            )}
                                        </div>
                                    </details>
                                </div>
                            </div>
                        </div>
                    </section>

                    <div className="mb-4 flex items-center gap-2">
                        <button
                            type="button"
                            onClick={() => setFinanceSectionTab('ASSET_ACCOUNT')}
                            className={`px-4 py-2 rounded-lg text-sm font-black ${financeSectionTab === 'ASSET_ACCOUNT' ? 'theme-tab-active' : 'theme-tab-inactive'}`}
                        >
                            {pageText.tabAssetAccount}
                        </button>
                        <button
                            type="button"
                            onClick={() => setFinanceSectionTab('CASHFLOW')}
                            className={`px-4 py-2 rounded-lg text-sm font-black ${financeSectionTab === 'CASHFLOW' ? 'theme-tab-active' : 'theme-tab-inactive'}`}
                        >
                            {pageText.tabCashflow}
                        </button>
                    </div>

                    {financeSectionTab === 'ASSET_ACCOUNT' && (
                    <section className="theme-surface p-4 sm:p-6 rounded-2xl shadow-sm mb-8">
                        <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-3 mb-4">
                            <div className="text-slate-800 font-black">{pageText.tabAssetAccount}</div>
                            <div className="flex flex-col sm:flex-row flex-wrap items-stretch sm:items-center gap-2">
                                <select
                                    value={selectedStatsCategory}
                                    onChange={e => {
                                        setSelectedStatsCategory(e.target.value);
                                        setSelectedStatsAccount('');
                                        setSelectedStatsSegmentKey('');
                                    }}
                                    className="theme-input rounded-lg px-3 py-2 font-bold text-sm shadow-sm outline-none w-full sm:w-auto"
                                >
                                    {CATEGORY_KEYS.map(categoryKey => <option key={categoryKey} value={categoryKey}>{CATEGORIES[categoryKey].label}</option>)}
                                </select>
                                <select
                                    value={statsBreakdownMode}
                                    onChange={e => {
                                        setStatsBreakdownMode(e.target.value);
                                        setSelectedStatsSegmentKey('');
                                    }}
                                    className="theme-input rounded-lg px-3 py-2 font-bold text-sm shadow-sm outline-none w-full sm:w-auto"
                                >
                                    <option value="ACCOUNT">æŒ‰å¸³æˆ¶ä½”æ¯”</option>
                                    <option value="ITEM">æŒ‰å¸³æˆ¶å…§ç´°é …</option>
                                </select>
                                {statsBreakdownMode === 'ITEM' && (
                                    <select
                                        value={accountStats.currentAccount}
                                        onChange={e => {
                                            setSelectedStatsAccount(e.target.value);
                                            setSelectedStatsSegmentKey('');
                                        }}
                                        className="theme-input rounded-lg px-3 py-2 font-bold text-sm shadow-sm outline-none w-full sm:w-auto"
                                    >
                                        {accountStats.accountNames.length ? (
                                            accountStats.accountNames.map(account => <option key={account} value={account}>{account}</option>)
                                        ) : (
                                            <option value="">å°šç„¡å¸³æˆ¶</option>
                                        )}
                                    </select>
                                )}
                            </div>
                        </div>

                        {!accountStats.accountNames.length ? (
                            <p className="text-sm text-slate-400 font-bold">ç›®å‰æ­¤é¡žåˆ¥æ²’æœ‰å¯çµ±è¨ˆè³‡æ–™</p>
                        ) : (
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
                                <div className="flex justify-center">
                                    <svg viewBox="0 0 260 260" className="w-48 h-48 sm:w-56 sm:h-56">
                                        {accountStats.segments.length === 1 ? (
                                            <circle
                                                cx="130"
                                                cy="130"
                                                r="110"
                                                fill={accountStats.segments[0].color}
                                                stroke="#ffffff"
                                                strokeWidth="2"
                                                className="cursor-pointer"
                                                onClick={() => setSelectedStatsSegmentKey(accountStats.segments[0].key)}
                                            />
                                        ) : (
                                            accountStats.segments.map(segment => (
                                                <path
                                                    key={segment.key}
                                                    d={describeArc(130, 130, 110, segment.startAngle, segment.endAngle)}
                                                    fill={segment.color}
                                                    stroke="#ffffff"
                                                    strokeWidth="2"
                                                    className="cursor-pointer"
                                                    opacity={accountStats.selectedItem?.key === segment.key ? 1 : 0.8}
                                                    onClick={() => setSelectedStatsSegmentKey(segment.key)}
                                                />
                                            ))
                                        )}
                                        <circle cx="130" cy="130" r="62" fill="#ffffff" />
                                        <text x="130" y="116" textAnchor="middle" className="fill-slate-400" style={{ fontSize: '10px', fontWeight: 800 }}>
                                            {accountStats.selectedItem ? accountStats.selectedItem.label : (statsBreakdownMode === 'ACCOUNT' ? CATEGORIES[selectedStatsCategory].label : accountStats.currentAccount)}
                                        </text>
                                        <text x="130" y="136" textAnchor="middle" className="fill-slate-700" style={{ fontSize: '13px', fontWeight: 900 }}>
                                            {accountStats.selectedItem ? `${formatAmount(accountStats.selectedItem.valueDisplay)} ${displayCurrency}` : `${formatAmount(accountStats.total)} ${displayCurrency}`}
                                        </text>
                                        <text x="130" y="154" textAnchor="middle" className="fill-slate-400" style={{ fontSize: '10px', fontWeight: 800 }}>
                                            {accountStats.selectedItem ? `${accountStats.selectedItem.ratio.toFixed(1)}%` : tByLang('é»žæ“Šå€å¡ŠæŸ¥çœ‹ä½”æ¯”', 'Click a segment to view ratio', 'ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ¯”çŽ‡ã‚’è¡¨ç¤º')}
                                        </text>
                                    </svg>
                                </div>

                                <div className="lg:col-span-2 space-y-3">
                                    <div className="space-y-2">
                                        {accountStats.segments.map(segment => (
                                            <button
                                                key={segment.key}
                                                type="button"
                                                onClick={() => setSelectedStatsSegmentKey(segment.key)}
                                                className={`w-full flex items-center justify-between px-3 py-2 rounded-lg text-left transition-all ${accountStats.selectedItem?.key === segment.key ? `theme-mix-item theme-mix-item--${wealthStyleLevel}-selected` : 'theme-surface theme-mix-item'}`}
                                            >
                                                <div className="flex items-center gap-2 min-w-0">
                                                    <span className="w-2.5 h-2.5 rounded-full" style={{ backgroundColor: segment.color }}></span>
                                                    <span className="text-sm font-bold theme-text-main truncate">{segment.label}</span>
                                                    <span className="text-[10px] theme-text-sub font-black">{segment.symbol ? `(${segment.symbol})` : ''}</span>
                                                </div>
                                                <div className="text-xs font-black theme-text-sub whitespace-nowrap text-right">
                                                    <div>{formatAmount(segment.valueDisplay)} {displayCurrency}</div>
                                                    <div>{segment.ratio.toFixed(1)}%</div>
                                                </div>
                                            </button>
                                        ))}
                                    </div>

                                    {accountStats.selectedItem && (
                                        <details className={`rounded-xl p-4 theme-summary-card theme-summary-card--${wealthStyleLevel}`} open>
                                            <summary className="md:hidden text-xs theme-text-sub font-black cursor-pointer list-none">å·²é¸æ“‡é …ç›®ç´°ç¯€</summary>
                                            <div className="mt-3 md:mt-0">
                                                <div className="text-xs theme-text-sub font-black mb-2">å·²é¸æ“‡é …ç›®</div>
                                                <div className="text-base font-black theme-text-main mb-1">{accountStats.selectedItem.label}</div>
                                                <div className="text-xs theme-text-sub font-bold mb-2">
                                                    {statsBreakdownMode === 'ACCOUNT'
                                                        ? tByLang(
                                                            `å¸³æˆ¶è³‡ç”¢é …ç›®ï¼š${accountStats.selectedItem.members?.length || 0} ç­†`,
                                                            `Account Asset Items: ${accountStats.selectedItem.members?.length || 0}`,
                                                            `å£åº§è³‡ç”£é …ç›®ï¼š${accountStats.selectedItem.members?.length || 0}ä»¶`
                                                        )
                                                        : (accountStats.selectedItem.subtype || CATEGORIES[selectedStatsCategory].label)}
                                                    {accountStats.selectedItem.symbol ? ` Â· ${accountStats.selectedItem.symbol}` : ''}
                                                </div>
                                                <div className="text-sm font-bold theme-text-main">åç¨±ï¼š{accountStats.selectedItem.label}</div>
                                                <div className="text-sm font-bold theme-text-main">é‡‘é¡ï¼š{formatAmount(accountStats.selectedItem.valueDisplay)} {displayCurrency}</div>
                                                <div className="text-sm font-bold theme-text-main">ç™¾åˆ†æ¯”ï¼š{accountStats.selectedItem.ratio.toFixed(2)}%</div>
                                            </div>
                                        </details>
                                    )}
                                </div>
                            </div>
                        )}
                    </section>
                    )}

                    {financeSectionTab === 'CASHFLOW' && (
                    <section className="theme-surface p-4 sm:p-6 rounded-2xl shadow-sm mb-8">
                        <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-3 mb-4">
                            <div>
                                <div className="text-slate-800 font-black">{pageText.tabCashflow}</div>
                                <p className="text-xs text-slate-400 font-bold mt-1">{pageText.cashflowDesc}</p>
                            </div>
                            <div className="flex items-center gap-2">
                                <button
                                    type="button"
                                    onClick={() => moveCashflowMonth(-1)}
                                    className="px-3 py-2 rounded-lg text-xs font-black theme-tab-inactive"
                                >
                                    {pageText.prevMonth}
                                </button>
                                <input
                                    type="month"
                                    value={selectedCashflowMonth}
                                    onChange={e => setSelectedCashflowMonth(e.target.value || toMonthKey(new Date()))}
                                    className="px-3 py-2 rounded-lg text-xs font-black theme-input outline-none"
                                />
                                <button
                                    type="button"
                                    onClick={() => moveCashflowMonth(1)}
                                    className="px-3 py-2 rounded-lg text-xs font-black theme-tab-inactive"
                                >
                                    {pageText.nextMonth}
                                </button>
                            </div>
                        </div>

                        <div className="flex flex-col gap-5">

                        <CashflowRuleForm
                            cashflowFormRef={cashflowFormRef}
                            handleCashflowSubmit={handleCashflowSubmit}
                            editingCashflowId={editingCashflowId}
                            cashflowEntries={cashflowEntries}
                            cashflowAccountOptions={cashflowAccountOptions}
                            FIELD_LABEL_CLASS={FIELD_LABEL_CLASS}
                            CASHFLOW_INPUT_CLASS={CASHFLOW_INPUT_CLASS}
                            CASHFLOW_INPUT_FOCUS_CLASS={CASHFLOW_INPUT_FOCUS_CLASS}
                            cashflowForm={cashflowForm}
                            updateCashflowField={updateCashflowField}
                            updateCashflowType={updateCashflowType}
                            updateCashflowTargetLiquidAsset={updateCashflowTargetLiquidAsset}
                            CASHFLOW_TYPES={CASHFLOW_TYPES}
                            CASHFLOW_SCHEDULE_TYPES={CASHFLOW_SCHEDULE_TYPES}
                            liquidAssetOptions={liquidAssetOptions}
                            CURRENCIES={CURRENCIES}
                            isCashflowOneTime={isCashflowOneTime}
                            isCashflowMonthlyRecurring={isCashflowMonthlyRecurring}
                            CASHFLOW_FREQUENCIES={CASHFLOW_FREQUENCIES}
                            availableCashflowCategories={availableCashflowCategories}
                        />

                        <CashflowOverviewView
                            cashflowMonthData={cashflowMonthData}
                            cashflowYearData={cashflowYearData}
                            displayCurrency={displayCurrency}
                            formatAmount={formatAmount}
                            cashflowView={cashflowView}
                            setCashflowView={setCashflowView}
                            WEEKDAY_LABELS={WEEKDAY_LABELS}
                        />

                        <CashflowRulesView
                            cashflowEntries={cashflowEntries}
                            filteredCashflowEntries={filteredCashflowEntries}
                            cashflowRuleKeyword={cashflowRuleKeyword}
                            setCashflowRuleKeyword={setCashflowRuleKeyword}
                            cashflowRuleFilter={cashflowRuleFilter}
                            setCashflowRuleFilter={setCashflowRuleFilter}
                            cashflowRuleSortMode={cashflowRuleSortMode}
                            setCashflowRuleSortMode={setCashflowRuleSortMode}
                            editingCashflowId={editingCashflowId}
                            cancelCashflowEdit={cancelCashflowEdit}
                            setCashflowRulesVisibleCount={setCashflowRulesVisibleCount}
                            cashflowRulesVisibleCount={cashflowRulesVisibleCount}
                            CASHFLOW_TYPES={CASHFLOW_TYPES}
                            CASHFLOW_FREQUENCIES={CASHFLOW_FREQUENCIES}
                            liquidAssetLabelById={liquidAssetLabelById}
                            cashflowTriggerInfoById={cashflowTriggerInfoById}
                            formatAmount={formatAmount}
                            fromHKD={fromHKD}
                            toHKD={toHKD}
                            displayCurrency={displayCurrency}
                            startEditCashflowEntry={startEditCashflowEntry}
                            handleDeleteCashflowEntry={handleDeleteCashflowEntry}
                        />
                        </div>
                    </section>
                    )}

                    <div className="mb-6 flex md:flex-wrap items-center gap-2 overflow-x-auto -mx-2 px-2">
                        <button
                            onClick={() => setSelectedCategories(CATEGORY_KEYS)}
                            className={`px-4 py-1.5 rounded-full text-xs font-black transition-all whitespace-nowrap shrink-0 ${selectedCategories.length === CATEGORY_KEYS.length ? 'theme-chip-active shadow-md' : 'theme-chip-inactive'}`}
                        >
                            å…¨éƒ¨é …ç›®
                        </button>
                        {CATEGORY_KEYS.map(categoryKey => (
                            <button
                                key={categoryKey}
                                onClick={() => toggleCategory(categoryKey)}
                                className={`px-4 py-1.5 rounded-full text-xs font-black transition-all whitespace-nowrap shrink-0 ${selectedCategories.includes(categoryKey) ? 'theme-chip-active shadow-md' : 'theme-chip-inactive'}`}
                            >
                                {CATEGORIES[categoryKey].label}
                            </button>
                        ))}
                        <select
                            value={sortMode}
                            onChange={e => setSortMode(e.target.value)}
                            className="theme-input rounded-lg px-3 py-1.5 font-bold text-xs shadow-sm outline-none shrink-0"
                        >
                            <option value="AMOUNT_DESC">æŒ‰é‡‘é¡æŽ’åºï¼ˆå¤§åˆ°å°ï¼‰</option>
                            <option value="NAME_ASC">æŒ‰åç¨±æŽ’åºï¼ˆA-Zï¼‰</option>
                        </select>
                        <select
                            value={viewMode}
                            onChange={e => setViewMode(e.target.value)}
                            className="theme-input rounded-lg px-3 py-1.5 font-bold text-xs shadow-sm outline-none shrink-0"
                        >
                            <option value="DETAIL">è©³ç´°æ¨¡å¼</option>
                            <option value="SUMMARY">åŒ¯ç¸½æ¨¡å¼</option>
                        </select>
                    </div>

                    {viewMode === 'SUMMARY' ? (
                        <div className="space-y-6">
                            {groupedAssets.map(({ categoryKey: catKey, accounts }) => {
                                const categoryTotalHKD = accounts.reduce((sum, account) => {
                                    const accountTotal = account.items.reduce((itemSum, item) => itemSum + toHKD(item.quantity * item.currentPrice, item.currency), 0);
                                    return sum + accountTotal;
                                }, 0);
                                const categoryTotalDisplay = fromHKD(categoryTotalHKD, displayCurrency);
                                const isLiabilityCategory = Boolean(CATEGORIES[catKey].isNegative);

                                return (
                                    <section key={catKey} className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
                                        <div className="px-6 py-4 border-b border-slate-100 flex items-center justify-between">
                                            <div className="flex items-center gap-2">
                                                <div className={`w-1.5 h-6 rounded-full ${CATEGORIES[catKey].color.replace('text', 'bg')}`}></div>
                                                <h2 className="text-base font-black text-slate-800">{CATEGORIES[catKey].label}</h2>
                                            </div>
                                            <div className={`text-sm font-black ${isLiabilityCategory ? 'text-rose-500' : 'text-slate-700'}`}>
                                                {isLiabilityCategory ? '-' : ''}{formatAmount(Math.abs(categoryTotalDisplay))} {displayCurrency}
                                            </div>
                                        </div>
                                        <div className="divide-y divide-slate-100">
                                            {accounts.map(({ accountName, items }) => {
                                                const accountTotalHKD = items.reduce((sum, item) => sum + toHKD(item.quantity * item.currentPrice, item.currency), 0);
                                                const accountTotalDisplay = fromHKD(accountTotalHKD, displayCurrency);
                                                return (
                                                    <div key={accountName} className="px-6 py-3 flex items-center justify-between">
                                                        <div className="text-sm font-bold text-slate-700">{accountName}</div>
                                                        <div className={`text-sm font-black ${isLiabilityCategory ? 'text-rose-500' : 'text-slate-700'}`}>
                                                            {isLiabilityCategory ? '-' : ''}{formatAmount(Math.abs(accountTotalDisplay))} {displayCurrency}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </section>
                                );
                            })}
                        </div>
                    ) : (
                        <div className="space-y-10">
                            {groupedAssets.map(({ categoryKey: catKey, accounts }) => (
                                <div key={catKey} className="space-y-4">
                                    <div className="flex items-center gap-2 px-2">
                                        <div className={`w-1.5 h-6 rounded-full ${CATEGORIES[catKey].color.replace('text', 'bg')}`}></div>
                                        <h2 className="text-lg font-black text-slate-800">{CATEGORIES[catKey].label}</h2>
                                    </div>

                                    {accounts.map(({ accountName, items }) => {
                                        const accountTotalHKD = items.reduce((sum, item) => sum + toHKD(item.quantity * item.currentPrice, item.currency), 0);
                                        const accountTotalDisplay = fromHKD(accountTotalHKD, displayCurrency);
                                        const isLiabilityCategory = Boolean(CATEGORIES[catKey].isNegative);
                                        const isInvestCategory = catKey === 'INVEST';
                                        const isLiquidCategory = catKey === 'LIQUID';
                                        const isInsuranceCategory = catKey === 'INSURANCE';
                                        const isReceivableCategory = catKey === 'RECEIVABLE';
                                        const isFixedCategory = catKey === 'FIXED';
                                        const accountKey = `${catKey}::${accountName}`;
                                        const isExpanded = expandedAccounts[accountKey] ?? true;

                                        return (
                                        <div key={accountName} className="bg-white rounded-2xl border border-slate-100 overflow-hidden shadow-sm">
                                            <button
                                                type="button"
                                                onClick={() => toggleAccountExpand(catKey, accountName)}
                                                className="w-full bg-slate-50/50 px-6 py-3 border-b border-slate-100 flex items-center justify-between gap-3 text-left"
                                            >
                                                <h3 className="text-xs font-black text-slate-500 uppercase tracking-widest">{accountName}</h3>
                                                <div className="text-right flex items-center gap-3">
                                                    <div>
                                                    <div className="text-[10px] font-black uppercase tracking-widest text-slate-400">å¸³æˆ¶åŒ¯ç¸½</div>
                                                    <div className={`text-sm font-black ${isLiabilityCategory ? 'text-rose-500' : 'text-slate-700'}`}>
                                                        {isLiabilityCategory ? '-' : ''}{formatAmount(Math.abs(accountTotalDisplay))} {displayCurrency}
                                                    </div>
                                                    </div>
                                                </div>
                                            </button>
                                            {isExpanded && (
                                            <>
                                                <div className="md:hidden px-4 pt-4 pb-4 space-y-3">
                                                    {items.map(item => {
                                                        const mktValOrig = item.quantity * item.currentPrice;
                                                        const mktValDisplay = fromHKD(toHKD(mktValOrig, item.currency), displayCurrency);
                                                        const isMortgageLiability = isLiabilityCategory && item.subtype === 'æˆ¿è²¸';
                                                        const isLoanLiability = isLiabilityCategory && item.subtype === 'è²¸æ¬¾';
                                                        const isCreditCardLiability = isLiabilityCategory && item.subtype === 'ä¿¡ç”¨å¡';
                                                        const isPayableLiability = isLiabilityCategory && item.subtype === 'æ‡‰ä»˜æ¬¾';
                                                        const isOtherLiability = isLiabilityCategory && item.subtype === 'å…¶ä»–è² å‚µ';
                                                        const isReceivableItem = isReceivableCategory;
                                                        const isFixedItem = isFixedCategory;
                                                        const amountPrefix = isLiabilityCategory ? '-' : '';
                                                        const highlightClass = isLiabilityCategory ? 'text-rose-500' : 'text-slate-800';

                                                        return (
                                                            <div key={item.id} onClick={() => openEdit(item)} className="rounded-xl border border-slate-100 bg-white shadow-sm p-4 space-y-2">
                                                                <div className="flex items-start justify-between gap-3">
                                                                    <div>
                                                                        <div className="font-black text-slate-800">{item.name}</div>
                                                                        <div className="text-[10px] text-slate-400 font-bold">{CATEGORIES[item.category].label} / {item.subtype}</div>
                                                                    </div>
                                                                    <div className={`text-base font-black ${highlightClass}`}>
                                                                        {amountPrefix}{formatAmount(mktValDisplay)} {displayCurrency}
                                                                    </div>
                                                                </div>
                                                                {isInsuranceCategory && (
                                                                    <div className="text-xs text-slate-500 font-bold">
                                                                        ä¿è²» {formatAmount(item.premiumAmount || 0)} {item.currency} Â· å·²ç¹³ {Number(item.premiumPaidCount || 0)} æœŸ
                                                                    </div>
                                                                )}
                                                                {isMortgageLiability && (
                                                                    <div className="text-xs text-slate-500 font-bold">
                                                                        æ¯æœˆé‚„æ¬¾ {formatAmount(item.monthlyPayment || 0)} {item.currency} Â· å·²é‚„ {Number(item.paidPeriods || 0)} æœŸ
                                                                    </div>
                                                                )}
                                                                {isLoanLiability && (
                                                                    <div className="text-xs text-slate-500 font-bold">
                                                                        æ¯æœˆé‚„æ¬¾ {formatAmount(item.loanMonthlyPayment || 0)} {item.currency} Â· å·²é‚„ {Number(item.loanPaidPeriods || 0)} æœŸ
                                                                    </div>
                                                                )}
                                                                {isCreditCardLiability && (
                                                                    <div className="text-xs text-slate-500 font-bold">
                                                                        æœ€ä½Žé‚„æ¬¾ {formatAmount(item.creditCardMinPayment || 0)} {item.currency} Â· åˆ°æœŸ {item.creditCardDueDate || 'æœªè¨­å®š'}
                                                                    </div>
                                                                )}
                                                                {isPayableLiability && (
                                                                    <div className="text-xs text-slate-500 font-bold">
                                                                        åˆ°æœŸ {item.payableDueDate || 'æœªè¨­å®š'} Â· {Number(item.payableInstallments || 0) ? `åˆ†æœŸ ${item.payableInstallments} æœŸ` : 'ä¸€æ¬¡æ€§'}
                                                                    </div>
                                                                )}
                                                                {isOtherLiability && (
                                                                    <div className="text-xs text-slate-500 font-bold">
                                                                        å¹´æ¯ {Number(item.otherAnnualRate || 0).toFixed(2)}% Â· åˆ°æœŸ {item.otherDueDate || 'æœªè¨­å®š'}
                                                                    </div>
                                                                )}
                                                                {isReceivableItem && (
                                                                    <div className="text-xs text-slate-500 font-bold">
                                                                        åˆ°æœŸ {item.receivableDueDate || 'æœªè¨­å®š'} Â· {item.receivableParty ? `å°è±¡ ${item.receivableParty}` : 'æœªå¡«å°è±¡'}
                                                                    </div>
                                                                )}
                                                                {isFixedItem && (
                                                                    <div className="text-xs text-slate-500 font-bold">
                                                                        è³¼å…¥ {item.fixedPurchaseDate || 'æœªè¨­å®š'} Â· {item.fixedNote ? item.fixedNote : 'æœªå¡«å‚™è¨»'}
                                                                    </div>
                                                                )}
                                                                {isLiquidCategory && (
                                                                    <div className="space-y-1">
                                                                        <div className="text-xs text-slate-500 font-bold flex items-center gap-2">
                                                                            <span>é¤˜é¡ {formatAmount(item.quantity)}</span>
                                                                            <span className="text-[10px] font-black uppercase tracking-widest px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-600">{item.currency}</span>
                                                                        </div>
                                                                        {cashflowAutoRulesByLiquidAssetId[item.id]?.length > 0 && (
                                                                            <div className="text-[10px] text-indigo-500 font-black">
                                                                                è‡ªå‹•è¦å‰‡ï¼š{cashflowAutoRulesByLiquidAssetId[item.id].slice(0, 2).map(rule => {
                                                                                    const modeLabel = rule.frequency === 'MONTHLY'
                                                                                        ? `æ¯æœˆ${rule.payday || rule.monthday || '--'}è™Ÿ`
                                                                                        : (rule.frequency === 'ONE_TIME' ? 'å–®æ¬¡' : (CASHFLOW_FREQUENCIES.find(entry => entry.value === rule.frequency)?.label || rule.frequency));
                                                                                    return `${rule.title}ï¼ˆ${modeLabel}ï¼‰`;
                                                                                }).join('ã€')}
                                                                                {cashflowAutoRulesByLiquidAssetId[item.id].length > 2 ? ` ç­‰ ${cashflowAutoRulesByLiquidAssetId[item.id].length} ç­†` : ''}
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                )}
                                                                {isInvestCategory && (() => {
                                                                    const costValOrig = item.quantity * item.costBasis;
                                                                    const profitOrig = mktValOrig - costValOrig;
                                                                    const profitDisplay = fromHKD(toHKD(profitOrig, item.currency), displayCurrency);
                                                                    const perf = costValOrig > 0 ? (profitOrig / costValOrig) * 100 : 0;
                                                                    const isFixedDepositItem = item.subtype === 'å®šæœŸå­˜æ¬¾';
                                                                    const fixedDepositMonths = Number(item.fixedDepositMonths || 0);
                                                                    const fixedDepositRate = Number(item.fixedDepositAnnualRate || 0);
                                                                    const fixedDepositStartDate = item.fixedDepositStartDate || '';

                                                                    return (
                                                                        <div className="space-y-1 text-xs font-bold">
                                                                            <div className="text-slate-500">å¸‚å€¼ {formatAmount(mktValDisplay)} {displayCurrency} Â· æ•¸é‡ {formatAmount(item.quantity)} {item.symbol ? `(${item.symbol})` : ''}</div>
                                                                            <div className="text-slate-500">ç¾åƒ¹ {formatAmount(item.currentPrice)} Â· æˆæœ¬ {formatAmount(item.costBasis)} {item.currency}</div>
                                                                            {isFixedDepositItem && (
                                                                                <div className="text-slate-500">å®šæœŸ {fixedDepositMonths || '--'} å€‹æœˆ Â· å¹´åˆ©çŽ‡ {fixedDepositRate.toFixed(2)}% {fixedDepositStartDate ? `Â· èµ·å­˜ ${fixedDepositStartDate}` : ''}</div>
                                                                            )}
                                                                            <div className={`${profitOrig >= 0 ? 'text-emerald-600' : 'text-rose-600'}`}>
                                                                                <div className="font-black text-sm">æŒå€‰ç›ˆè™§ {profitOrig >= 0 ? '+' : ''}{formatAmount(profitDisplay)} {displayCurrency}</div>
                                                                                <div className="font-bold text-xs">ç¸¾æ•ˆ {perf >= 0 ? '+' : ''}{perf.toFixed(2)}%</div>
                                                                            </div>
                                                                        </div>
                                                                    );
                                                                })()}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                                <div className="hidden md:block overflow-x-auto -mx-4 sm:mx-0">
                                                    <div className="px-4 sm:px-0">
                                                        <div className="text-[10px] text-slate-400 font-black uppercase tracking-widest mb-2 md:hidden">å·¦å³æ»‘å‹•æŸ¥çœ‹å®Œæ•´æ¬„ä½</div>
                                                <table className={`w-full text-left ${isInvestCategory ? 'min-w-[780px]' : isInsuranceCategory ? 'min-w-[700px]' : 'min-w-[620px]'}`}>
                                                    {isLiquidCategory && (
                                                        <colgroup>
                                                            <col style={{ width: '60%' }} />
                                                            <col style={{ width: '20%' }} />
                                                            <col style={{ width: '20%' }} />
                                                        </colgroup>
                                                    )}
                                                    {isInsuranceCategory && (
                                                        <colgroup>
                                                            <col style={{ width: '40%' }} />
                                                            <col style={{ width: '20%' }} />
                                                            <col style={{ width: '20%' }} />
                                                            <col style={{ width: '20%' }} />
                                                        </colgroup>
                                                    )}
                                                    {isInvestCategory && (
                                                        <colgroup>
                                                            <col style={{ width: '30%' }} />
                                                            <col style={{ width: '20%' }} />
                                                            <col style={{ width: '15%' }} />
                                                            <col style={{ width: '20%' }} />
                                                            <col style={{ width: '15%' }} />
                                                        </colgroup>
                                                    )}
                                                    <thead className="text-[10px] font-black text-slate-400 uppercase tracking-tighter bg-slate-50/30">
                                                        <tr>
                                                            <th className="px-6 py-3">åç¨± / ç´°é …</th>
                                                            <th className="px-6 py-3 text-right">{isInsuranceCategory ? 'ä¿è²»è¨­å®š' : isLiquidCategory ? 'æ•¸é‡ / å¹£åˆ¥' : isLiabilityCategory ? 'é‡‘é¡ / æœŸæ•¸' : isReceivableCategory ? 'æ‡‰æ”¶é‡‘é¡ / æœŸæ•¸' : isFixedCategory ? 'ä¼°å€¼ / æˆæœ¬' : 'å¸‚å€¼ / æ•¸é‡'}</th>
                                                            <th className="px-6 py-3 text-right">{isInsuranceCategory ? 'å·²ç¹³æœŸæ•¸' : isLiquidCategory ? 'é¤˜é¡' : isLiabilityCategory ? 'åˆ©çŽ‡ / åˆ°æœŸ' : isReceivableCategory ? 'åˆ°æœŸ / å°è±¡' : isFixedCategory ? 'è³¼å…¥æ—¥ / å‚™è¨»' : 'ç¾åƒ¹ / æˆæœ¬'}</th>
                                                            {isInsuranceCategory && <th className="px-6 py-3 text-right">ä¿å–®åƒ¹å€¼</th>}
                                                            {isInvestCategory && <th className="px-6 py-3 text-right">æŒå€‰ç›ˆè™§</th>}
                                                            {isInvestCategory && <th className="px-6 py-3 text-right">ç¸¾æ•ˆ</th>}
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y divide-slate-50">
                                                        {items.map(item => {
                                                            const mktValOrig = item.quantity * item.currentPrice;
                                                            const costValOrig = item.quantity * item.costBasis;
                                                            const profitOrig = mktValOrig - costValOrig;
                                                            const mktValDisplay = fromHKD(toHKD(mktValOrig, item.currency), displayCurrency);
                                                            const profitDisplay = fromHKD(toHKD(profitOrig, item.currency), displayCurrency);
                                                            const perf = costValOrig > 0 ? (profitOrig / costValOrig) * 100 : 0;
                                                            const premiumAmount = Number(item.premiumAmount || 0);
                                                            const premiumPaidCount = Number(item.premiumPaidCount || 0);
                                                            const hasPremiumPlan = premiumAmount > 0 && premiumPaidCount >= 0;
                                                            const premiumTotalOrig = premiumAmount * premiumPaidCount;
                                                            const premiumTotalDisplay = fromHKD(toHKD(premiumTotalOrig, item.currency), displayCurrency);
                                                            const isMortgageLiability = isLiabilityCategory && item.subtype === 'æˆ¿è²¸';
                                                            const isLoanLiability = isLiabilityCategory && item.subtype === 'è²¸æ¬¾';
                                                            const isCreditCardLiability = isLiabilityCategory && item.subtype === 'ä¿¡ç”¨å¡';
                                                            const isPayableLiability = isLiabilityCategory && item.subtype === 'æ‡‰ä»˜æ¬¾';
                                                            const isOtherLiability = isLiabilityCategory && item.subtype === 'å…¶ä»–è² å‚µ';
                                                            const isReceivableItem = isReceivableCategory;
                                                            const isFixedItem = isFixedCategory;
                                                            const mortgageDownPaymentDisplay = fromHKD(toHKD(Number(item.downPayment || 0), item.currency), displayCurrency);
                                                            const mortgageLoanDisplay = fromHKD(toHKD(Number(item.loanAmount || costValOrig), item.currency), displayCurrency);
                                                            const mortgageInterestDisplay = fromHKD(toHKD(Number(item.totalInterest || 0), item.currency), displayCurrency);
                                                            const mortgageMonthlyDisplay = fromHKD(toHKD(Number(item.monthlyPayment || 0), item.currency), displayCurrency);
                                                            const mortgageOutstandingDisplay = fromHKD(toHKD(Number(item.outstandingPrincipal || mktValOrig), item.currency), displayCurrency);
                                                            const mortgageAnnualRate = Number(item.annualInterestRate || 0);
                                                            const mortgagePaidPeriods = Number(item.paidPeriods || 0);
                                                            const mortgageTotalPeriods = Number(item.totalPeriods || 0);
                                                            const mortgageRemainingPeriods = Number(item.remainingPeriods || Math.max(0, mortgageTotalPeriods - mortgagePaidPeriods));
                                                            const loanMonthlyDisplay = fromHKD(toHKD(Number(item.loanMonthlyPayment || 0), item.currency), displayCurrency);
                                                            const loanOutstandingDisplay = fromHKD(toHKD(Number(item.loanOutstandingPrincipal || 0), item.currency), displayCurrency);
                                                            const loanTotalInterestDisplay = fromHKD(toHKD(Number(item.loanTotalInterest || 0), item.currency), displayCurrency);
                                                            const loanAnnualRate = Number(item.loanAnnualInterestRate || 0);
                                                            const loanPaidPeriods = Number(item.loanPaidPeriods || 0);
                                                            const loanTotalPeriods = Number(item.loanTotalPeriods || 0);
                                                            const loanRemainingPeriods = Number(item.loanRemainingPeriods || Math.max(0, loanTotalPeriods - loanPaidPeriods));
                                                            const creditCardBalanceDisplay = fromHKD(toHKD(Number(item.creditCardBalance || 0), item.currency), displayCurrency);
                                                            const creditCardMinPaymentDisplay = fromHKD(toHKD(Number(item.creditCardMinPayment || 0), item.currency), displayCurrency);
                                                            const creditCardAnnualRate = Number(item.creditCardAnnualRate || 0);
                                                            const payableAmountDisplay = fromHKD(toHKD(Number(item.payableAmount || 0), item.currency), displayCurrency);
                                                            const payableInstallments = Number(item.payableInstallments || 0);
                                                            const otherOutstandingDisplay = fromHKD(toHKD(Number(item.otherOutstanding || 0), item.currency), displayCurrency);
                                                            const otherAnnualRate = Number(item.otherAnnualRate || 0);
                                                            const receivableAmountDisplay = fromHKD(toHKD(Number(item.receivableAmount || mktValOrig), item.currency), displayCurrency);
                                                            const receivableInstallments = Number(item.receivableInstallments || 0);
                                                            const fixedPurchaseDisplay = fromHKD(toHKD(Number(item.fixedPurchasePrice || costValOrig), item.currency), displayCurrency);
                                                            const fixedCurrentDisplay = fromHKD(toHKD(Number(item.fixedCurrentValue || mktValOrig), item.currency), displayCurrency);
                                                            const isPerfPositive = perf > 0;
                                                            const isPerfNegative = perf < 0;
                                                            const perfClass = isPerfPositive
                                                                ? 'text-emerald-700 bg-emerald-50 ring-emerald-100'
                                                                : isPerfNegative
                                                                    ? 'text-rose-700 bg-rose-50 ring-rose-100'
                                                                    : 'text-slate-600 bg-slate-100 ring-slate-200';
                                                            const perfIcon = isPerfPositive ? 'â†—' : isPerfNegative ? 'â†˜' : 'â€¢';

                                                            return (
                                                                <tr key={item.id} onClick={() => openEdit(item)} className="hover:bg-indigo-50/30 cursor-pointer transition-colors group">
                                                                    <td className="px-6 py-4">
                                                                        <div className="font-bold text-slate-800">{item.name}</div>
                                                                        <div className="text-[10px] text-slate-400 font-medium">{CATEGORIES[item.category].label} / {item.subtype}</div>
                                                                        {isMortgageLiability && (
                                                                            <div className="text-[10px] text-slate-500 font-medium mt-1">
                                                                                é¦–æœŸ {formatAmount(mortgageDownPaymentDisplay)} {displayCurrency} Â· è²¸æ¬¾ {formatAmount(mortgageLoanDisplay)} {displayCurrency} Â· åˆ©æ¯ {formatAmount(mortgageInterestDisplay)} {displayCurrency}
                                                                            </div>
                                                                        )}
                                                                        {isLoanLiability && (
                                                                            <div className="text-[10px] text-slate-500 font-medium mt-1">
                                                                                æœªå„Ÿæœ¬é‡‘ {formatAmount(loanOutstandingDisplay)} {displayCurrency} Â· åˆ©æ¯ {formatAmount(loanTotalInterestDisplay)} {displayCurrency}
                                                                            </div>
                                                                        )}
                                                                        {isReceivableItem && (
                                                                            <div className="text-[10px] text-slate-500 font-medium mt-1">
                                                                                {item.receivableParty ? `å°è±¡ ${item.receivableParty}` : 'æœªå¡«å°è±¡'}
                                                                            </div>
                                                                        )}
                                                                        {isFixedItem && item.fixedNote && (
                                                                            <div className="text-[10px] text-slate-500 font-medium mt-1">
                                                                                {item.fixedNote}
                                                                            </div>
                                                                        )}
                                                                    </td>
                                                                    <td className="px-6 py-4 text-right">
                                                                        {isInsuranceCategory ? (
                                                                            hasPremiumPlan ? (
                                                                                <div className="font-bold text-slate-700">
                                                                                    {formatAmount(premiumAmount)} {item.currency}
                                                                                    <div className="text-[10px] text-slate-400">/{item.premiumFrequency === 'yearly' ? 'æ¯å¹´' : 'æ¯æœˆ'}</div>
                                                                                </div>
                                                                            ) : (
                                                                                <div className="font-bold text-slate-400">--</div>
                                                                            )
                                                                        ) : isLiquidCategory ? (
                                                                            <div className="flex items-center justify-end gap-2">
                                                                                <span className="font-bold text-slate-800 tabular-nums text-right">{formatAmount(item.quantity)}</span>
                                                                                <span className="text-[10px] font-black uppercase tracking-widest px-2 py-1 rounded-full bg-emerald-50 text-emerald-600 w-12 text-center">{item.currency}</span>
                                                                            </div>
                                                                        ) : isMortgageLiability ? (
                                                                            <>
                                                                                <div className="font-bold text-slate-800">{formatAmount(mortgageMonthlyDisplay)} <span className="text-[9px] text-slate-400">{displayCurrency}</span></div>
                                                                                <div className="text-[10px] text-slate-400">{formatAmount(Number(item.monthlyPayment || 0))} {item.currency} Â· å…± {mortgageTotalPeriods} æœŸ</div>
                                                                            </>
                                                                        ) : isLoanLiability ? (
                                                                            <>
                                                                                <div className="font-bold text-slate-800">{formatAmount(loanMonthlyDisplay)} <span className="text-[9px] text-slate-400">{displayCurrency}</span></div>
                                                                                <div className="text-[10px] text-slate-400">{formatAmount(Number(item.loanMonthlyPayment || 0))} {item.currency} Â· å…± {loanTotalPeriods} æœŸ</div>
                                                                            </>
                                                                        ) : isCreditCardLiability ? (
                                                                            <>
                                                                                <div className="font-bold text-slate-800">{formatAmount(creditCardBalanceDisplay)} <span className="text-[9px] text-slate-400">{displayCurrency}</span></div>
                                                                                <div className="text-[10px] text-slate-400">æœ€ä½Žé‚„æ¬¾ {formatAmount(creditCardMinPaymentDisplay)} {displayCurrency}</div>
                                                                            </>
                                                                        ) : isPayableLiability ? (
                                                                            <>
                                                                                <div className="font-bold text-slate-800">{formatAmount(payableAmountDisplay)} <span className="text-[9px] text-slate-400">{displayCurrency}</span></div>
                                                                                <div className="text-[10px] text-slate-400">{payableInstallments ? `åˆ†æœŸ ${payableInstallments} æœŸ` : 'ä¸€æ¬¡æ€§'}</div>
                                                                            </>
                                                                        ) : isOtherLiability ? (
                                                                            <>
                                                                                <div className="font-bold text-slate-800">{formatAmount(otherOutstandingDisplay)} <span className="text-[9px] text-slate-400">{displayCurrency}</span></div>
                                                                                <div className="text-[10px] text-slate-400">{item.otherDueDate ? `åˆ°æœŸ ${item.otherDueDate}` : 'æœªè¨­å®šåˆ°æœŸæ—¥'}</div>
                                                                            </>
                                                                        ) : isReceivableItem ? (
                                                                            <>
                                                                                <div className="font-bold text-slate-800">{formatAmount(receivableAmountDisplay)} <span className="text-[9px] text-slate-400">{displayCurrency}</span></div>
                                                                                <div className="text-[10px] text-slate-400">{receivableInstallments ? `åˆ†æœŸ ${receivableInstallments} æœŸ` : 'ä¸€æ¬¡æ€§'}</div>
                                                                            </>
                                                                        ) : isFixedItem ? (
                                                                            <>
                                                                                <div className="font-bold text-slate-800">{formatAmount(fixedCurrentDisplay)} <span className="text-[9px] text-slate-400">{displayCurrency}</span></div>
                                                                                <div className="text-[10px] text-slate-400">æˆæœ¬ {formatAmount(fixedPurchaseDisplay)} {displayCurrency}</div>
                                                                            </>
                                                                        ) : (
                                                                            <>
                                                                                <div className="font-bold text-slate-800">{formatAmount(mktValDisplay)} <span className="text-[9px] text-slate-400">{displayCurrency}</span></div>
                                                                                <div className="text-[10px] text-slate-400">{item.quantity.toLocaleString()} {item.symbol ? `(${item.symbol})` : ''}</div>
                                                                            </>
                                                                        )}
                                                                    </td>
                                                                    <td className="px-6 py-4 text-right">
                                                                        {isInsuranceCategory ? (
                                                                            hasPremiumPlan ? (
                                                                                <div className="font-medium text-slate-700">{premiumPaidCount.toLocaleString()} æœŸ</div>
                                                                            ) : (
                                                                                <div className="font-medium text-slate-400">--</div>
                                                                            )
                                                                        ) : isLiquidCategory ? (
                                                                            <>
                                                                                <div className="font-medium text-slate-700">{formatAmount(mktValDisplay)} <span className="text-[9px]">{displayCurrency}</span></div>
                                                                                {cashflowAutoRulesByLiquidAssetId[item.id]?.length > 0 && (
                                                                                    <div className="text-[10px] text-indigo-500 font-black mt-1">
                                                                                        å·²ç¶å®š {cashflowAutoRulesByLiquidAssetId[item.id].length} ç­†è‡ªå‹•å…¥å¸³/æ‰£æ¬¾è¦å‰‡
                                                                                    </div>
                                                                                )}
                                                                            </>
                                                                        ) : isMortgageLiability ? (
                                                                            <>
                                                                                <div className="font-medium text-slate-700">å¹´æ¯ {mortgageAnnualRate.toFixed(2)}%</div>
                                                                                <div className="text-[10px] text-slate-400">å·²é‚„ {mortgagePaidPeriods} æœŸ Â· å°šé¤˜ {mortgageRemainingPeriods} æœŸ</div>
                                                                                <div className="text-[10px] text-slate-400">æœªå„Ÿæœ¬é‡‘ {formatAmount(mortgageOutstandingDisplay)} {displayCurrency}</div>
                                                                            </>
                                                                        ) : isLoanLiability ? (
                                                                            <>
                                                                                <div className="font-medium text-slate-700">å¹´æ¯ {loanAnnualRate.toFixed(2)}%</div>
                                                                                <div className="text-[10px] text-slate-400">å·²é‚„ {loanPaidPeriods} æœŸ Â· å°šé¤˜ {loanRemainingPeriods} æœŸ</div>
                                                                                <div className="text-[10px] text-slate-400">æœªå„Ÿæœ¬é‡‘ {formatAmount(loanOutstandingDisplay)} {displayCurrency}</div>
                                                                            </>
                                                                        ) : isCreditCardLiability ? (
                                                                            <>
                                                                                <div className="font-medium text-slate-700">å¹´æ¯ {creditCardAnnualRate.toFixed(2)}%</div>
                                                                                <div className="text-[10px] text-slate-400">åˆ°æœŸ {item.creditCardDueDate || 'æœªè¨­å®š'}</div>
                                                                            </>
                                                                        ) : isPayableLiability ? (
                                                                            <>
                                                                                <div className="font-medium text-slate-700">åˆ°æœŸ {item.payableDueDate || 'æœªè¨­å®š'}</div>
                                                                                {payableInstallments ? (
                                                                                    <div className="text-[10px] text-slate-400">æ¯æœŸç´„ {formatAmount(payableAmountDisplay / payableInstallments)} {displayCurrency}</div>
                                                                                ) : (
                                                                                    <div className="text-[10px] text-slate-400">ä¸€æ¬¡æ€§æ”¯ä»˜</div>
                                                                                )}
                                                                            </>
                                                                        ) : isOtherLiability ? (
                                                                            <>
                                                                                <div className="font-medium text-slate-700">å¹´æ¯ {otherAnnualRate.toFixed(2)}%</div>
                                                                                <div className="text-[10px] text-slate-400">åˆ°æœŸ {item.otherDueDate || 'æœªè¨­å®š'}</div>
                                                                            </>
                                                                        ) : isReceivableItem ? (
                                                                            <>
                                                                                <div className="font-medium text-slate-700">åˆ°æœŸ {item.receivableDueDate || 'æœªè¨­å®š'}</div>
                                                                                <div className="text-[10px] text-slate-400">{item.receivableParty ? `å°è±¡ ${item.receivableParty}` : 'æœªå¡«å°è±¡'}</div>
                                                                            </>
                                                                        ) : isFixedItem ? (
                                                                            <>
                                                                                <div className="font-medium text-slate-700">è³¼å…¥ {item.fixedPurchaseDate || 'æœªè¨­å®š'}</div>
                                                                                <div className="text-[10px] text-slate-400">{item.fixedNote ? `å‚™è¨» ${item.fixedNote}` : 'æœªå¡«å‚™è¨»'}</div>
                                                                            </>
                                                                        ) : (
                                                                            <>
                                                                                <div className="font-medium text-slate-700">{formatAmount(item.currentPrice)}</div>
                                                                                <div className="text-[10px] text-slate-400">{formatAmount(item.costBasis)} <span className="text-[9px]">{item.currency}</span></div>
                                                                            </>
                                                                        )}
                                                                    </td>
                                                                    {isInsuranceCategory && (
                                                                        <td className="px-6 py-4 text-right">
                                                                            {hasPremiumPlan ? (
                                                                                <>
                                                                                    <div className="font-bold text-slate-800">{formatAmount(premiumTotalDisplay)} <span className="text-[9px] text-slate-400">{displayCurrency}</span></div>
                                                                                    <div className="text-[10px] text-slate-400">{formatAmount(premiumTotalOrig)} {item.currency}</div>
                                                                                </>
                                                                            ) : (
                                                                                <>
                                                                                    <div className="font-bold text-slate-800">{formatAmount(mktValDisplay)} <span className="text-[9px] text-slate-400">{displayCurrency}</span></div>
                                                                                    <div className="text-[10px] text-slate-400">{formatAmount(mktValOrig)} {item.currency}</div>
                                                                                </>
                                                                            )}
                                                                        </td>
                                                                    )}
                                                                    {isInvestCategory && (
                                                                        <td className="px-6 py-4 text-right">
                                                                            <>
                                                                                <div className={`font-bold ${profitOrig >= 0 ? 'text-emerald-500' : 'text-rose-500'}`}>
                                                                                    {profitOrig >= 0 ? '+' : ''}{formatAmount(profitOrig)} {item.currency}
                                                                                </div>
                                                                                <div className="text-[10px] text-slate-400">
                                                                                    ç´„ {formatAmount(profitDisplay)} {displayCurrency}
                                                                                </div>
                                                                            </>
                                                                        </td>
                                                                    )}
                                                                    {isInvestCategory && (
                                                                        <td className="px-6 py-4 text-right">
                                                                            <div className={`inline-flex items-center gap-1.5 text-xs font-black px-2.5 py-1.5 rounded-full ring-1 ${perfClass}`}>
                                                                                <span className="text-[11px] leading-none">{perfIcon}</span>
                                                                                <span>{perf >= 0 ? '+' : ''}{perf.toFixed(2)}%</span>
                                                                            </div>
                                                                        </td>
                                                                    )}
                                                                </tr>
                                                            );
                                                        })}
                                                    </tbody>
                                                </table>
                                                </div>
                                            </div>
                                            </>
                                            )}
                                        </div>
                                    )})}
                                </div>
                            ))}
                        </div>
                    )}

                    <AssetModalView
                        isModalOpen={isModalOpen}
                        editingId={editingId}
                        onClose={() => setIsModalOpen(false)}
                        handleSubmit={handleSubmit}
                        FIELD_LABEL_CLASS={FIELD_LABEL_CLASS}
                        MODAL_INPUT_CLASS={MODAL_INPUT_CLASS}
                        MODAL_INPUT_FOCUS_CLASS={MODAL_INPUT_FOCUS_CLASS}
                        MODAL_OUTPUT_CLASS={MODAL_OUTPUT_CLASS}
                        MODAL_GROUP_CLASS={MODAL_GROUP_CLASS}
                        isLiquidForm={isLiquidForm}
                        isInvestForm={isInvestForm}
                        isCryptoForm={isCryptoForm}
                        isStockForm={isStockForm}
                        isFundForm={isFundForm}
                        isFixedDepositForm={isFixedDepositForm}
                        isMortgageForm={isMortgageForm}
                        isLoanForm={isLoanForm}
                        isCreditCardForm={isCreditCardForm}
                        isPayableForm={isPayableForm}
                        isOtherLiabilityForm={isOtherLiabilityForm}
                        isLiabilityForm={isLiabilityForm}
                        isReceivableForm={isReceivableForm}
                        isFixedForm={isFixedForm}
                        needsPremium={needsPremium}
                        formData={formData}
                        updateFormField={updateFormField}
                        updateFormFieldUpper={updateFormFieldUpper}
                        CATEGORIES={CATEGORIES}
                        onCategoryChange={handleAssetCategoryChange}
                        onSubtypeChange={handleAssetSubtypeChange}
                        fixedDepositMetrics={fixedDepositMetrics}
                        mortgageMetrics={mortgageMetrics}
                        loanMetrics={loanMetrics}
                        formatAmount={formatAmount}
                        premiumTotal={premiumTotal}
                        CURRENCIES={CURRENCIES}
                        handleDelete={handleDelete}
                    />

                    <div className="hidden md:block fixed right-4 bottom-5 z-30 pointer-events-none">
                        <div className="max-w-[250px] rounded-2xl theme-surface backdrop-blur-sm shadow-lg px-3 py-2 prince-talk">
                            <div className="text-[11px] leading-5 font-black theme-text-main">{princeHintMessage}</div>
                        </div>
                        <div className="mt-2 flex items-end justify-end gap-1">
                            <div className="text-2xl prince-sparkle">âœ¨</div>
                            <div className="prince-float w-16 h-16 rounded-2xl theme-prince-avatar shadow-md flex items-center justify-center text-3xl">ðŸ¤´ðŸ»</div>
                        </div>
                    </div>

                    <footer className="mt-20 text-center theme-text-sub text-[10px] font-bold uppercase tracking-[0.22em] pb-10">
                        {appName}
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>